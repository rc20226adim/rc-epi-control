<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RC EPI Control - Sistema de Gest√£o de EPIs</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de Controle de EPIs - RC Engenharia">
    <meta name="theme-color" content="#1d4ed8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RC EPI">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Icons para diferentes plataformas -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231d4ed8' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>üõ°Ô∏è</text></svg>">
    
    <!-- Manifest inline via data URI -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUkMgRVBJIENvbnRyb2wgLSBTaXN0ZW1hIGRlIEdlc3TDo28gZGUgRVBJcyIsInNob3J0X25hbWUiOiJSQyBFUEkiLCJkZXNjcmlwdGlvbiI6IlNpc3RlbWEgZGUgQ29udHJvbGUgZGUgRXF1aXBhbWVudG9zIGRlIFByb3Rlw6fDo28gSW5kaXZpZHVhbCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGExNjI4IiwidGhlbWVfY29sb3IiOiIjMWQ0ZWQ4Iiwib3JpZW50YXRpb24iOiJhbnkiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHJlY3QgZmlsbD0nJTIzMWQ0ZWQ4JyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgcng9JzIwJy8+PHRleHQgeD0nNTAnIHk9JzY1JyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSd3aGl0ZSc+8J+boe+4jzwvdGV4dD48L3N2Zz4iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19">
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a1628 0%, #1e3a5f 50%, #0a1628 100%);
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
        }
        
        /* ==================== TELA DE LOGIN ==================== */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1628 0%, #1e3a5f 50%, #0a1628 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-overlay.hidden { display: none; }
        
        .login-container {
            background: #1e3a5f;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 400px;
            border: 1px solid #2d4a6f;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-logo .icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2.5rem;
        }
        
        .login-logo h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            color: #fff;
            margin-bottom: 0.25rem;
        }
        
        .login-logo p {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .login-form .form-group {
            margin-bottom: 1.25rem;
        }
        
        .login-form label {
            display: block;
            color: #94a3b8;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .login-form input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: #0f172a;
            border: 2px solid #2d4a6f;
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        .login-form input::placeholder {
            color: #475569;
        }
        
        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 0.5rem;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }
        
        .login-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            display: none;
        }
        
        .login-error.show { display: block; }
        
        .login-footer {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #2d4a6f;
        }
        
        .login-footer p {
            color: #64748b;
            font-size: 0.75rem;
        }
        
        .user-badge {
            background: #0f172a;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        
        .user-badge .role {
            background: #2563eb;
            color: #fff;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .user-badge .role.dev {
            background: #10b981;
        }
        
        .btn-logout {
            background: #ef4444;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-logout:hover {
            background: #dc2626;
        }
        
        .dev-only { display: none; }
        .is-dev .dev-only { display: block; }
        .is-dev .dev-only-inline { display: inline-flex; }
        
        /* Bot√£o Instalar App */
        .install-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }
        
        .install-btn.show { display: inline-flex; }
        
        .header {
            background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%);
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: #0f172a;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
        }
        
        .logo span {
            display: block;
            font-size: 0.85rem;
            color: #bfdbfe;
            opacity: 0.9;
        }
        
        .stats-badges {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .stats-badge {
            background: #0f172a;
            padding: 0.75rem 1.25rem;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: #60a5fa;
        }
        
        .stats-badge.bio { color: #10b981; }
        
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            padding: 1.5rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 0.875rem 1.5rem;
            border: none;
            background: #1e3a5f;
            color: #94a3b8;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-tab:hover { background: #2563eb; color: #e2e8f0; }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: #ffffff;
        }
        
        .main-content {
            padding: 0 2rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background: #1e3a5f;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 1px solid #2d4a6f;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #2d4a6f;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group.full-width { grid-column: 1 / -1; }
        
        .field-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .field-input {
            padding: 0.875rem 1rem;
            background: #0f172a;
            border: 2px solid #2d4a6f;
            border-radius: 10px;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .field-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        .field-input::placeholder { color: #64748b; }
        
        textarea.field-input { resize: vertical; min-height: 80px; }
        
        /* Biometria */
        .biometria-section {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%);
            border: 2px solid #2d4a6f;
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .biometria-section.success { border-color: #10b981; }
        
        .biometria-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .camera-video {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1);
        }
        
        .face-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 220px;
            border: 3px dashed #2563eb;
            border-radius: 50%;
            opacity: 0.7;
            pointer-events: none;
        }
        
        .camera-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .photo-options {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .photo-option {
            background: #0f172a;
            border: 2px solid #2d4a6f;
            border-radius: 12px;
            padding: 1.25rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 120px;
            max-width: 160px;
        }
        
        .photo-option:hover {
            border-color: #2563eb;
            background: #1e3a5f;
        }
        
        .photo-option svg {
            margin-bottom: 0.5rem;
            color: #2563eb;
            width: 36px;
            height: 36px;
        }
        
        .photo-option p {
            font-size: 0.85rem;
            color: #e2e8f0;
            font-weight: 500;
        }
        
        .photo-option small {
            font-size: 0.7rem;
            color: #64748b;
            display: block;
            margin-top: 0.25rem;
        }
        
        .photo-preview-area {
            text-align: center;
            padding: 1rem;
        }
        
        .photo-preview-area img {
            max-width: 200px;
            max-height: 250px;
            border-radius: 12px;
            border: 3px solid #10b981;
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: #fca5a5;
            font-size: 0.9rem;
        }
        
        .error-message strong {
            display: block;
            margin-bottom: 0.5rem;
            color: #ef4444;
        }
        
        .signature-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #2d4a6f;
        }
        
        .signature-canvas {
            border: 2px solid #2d3748;
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none;
            width: 100%;
            max-width: 500px;
            height: 150px;
            background: #fff;
            display: block;
        }
        
        .signature-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .btn-primary, .btn-secondary, .btn-danger, .btn-success {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: #ffffff;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }
        
        .btn-secondary {
            background: #2d4a6f;
            color: #e2e8f0;
        }
        
        .btn-secondary:hover { background: #3d5a7f; }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-submit {
            margin-top: 2rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 400px;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .signature-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: #0f172a;
            border-radius: 8px;
            border: 2px solid #10b981;
            display: none;
        }
        
        .signature-preview.show { display: block; }
        
        .signature-preview img {
            max-width: 200px;
            border-radius: 4px;
        }
        
        /* Logo Upload */
        .logo-upload-section {
            background: #0f172a;
            border: 2px dashed #2d4a6f;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 1.5rem;
        }
        
        .logo-upload-section:hover { border-color: #2563eb; }
        .logo-upload-section.has-logo { border-style: solid; border-color: #10b981; }
        
        .logo-preview {
            max-width: 200px;
            max-height: 80px;
            margin: 1rem auto;
            display: block;
            border-radius: 8px;
        }
        
        /* Funcion√°rios */
        .funcionario-card {
            background: #0f172a;
            border: 1px solid #2d4a6f;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .funcionario-card:hover { border-color: #2563eb; }
        
        .funcionario-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .funcionario-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .funcionario-photo {
            width: 60px;
            height: 75px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #10b981;
        }
        
        .funcionario-photo.no-photo {
            background: #2d4a6f;
            display: flex;
            align-items: center;
            justify-content: center;
            border-color: #2d4a6f;
        }
        
        .funcionario-details h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 0.25rem;
        }
        
        .funcionario-details p {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: #94a3b8;
        }
        
        .funcionario-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: #1e3a5f;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-item .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: #2563eb;
        }
        
        .stat-item .label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
        }
        
        .funcionario-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .entregas-list {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #2d4a6f;
        }
        
        .entrega-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #1e3a5f;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .badge-ca {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge-bio {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .search-wrapper {
            position: relative;
            flex: 1;
            min-width: 250px;
        }
        
        .search-input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 2.75rem;
            background: #0f172a;
            border: 2px solid #2d4a6f;
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 1rem;
        }
        
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }
        
        .filter-select {
            padding: 0.875rem 1rem;
            background: #0f172a;
            border: 2px solid #2d4a6f;
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 1rem;
            min-width: 200px;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }
        
        .empty-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: #2d4a6f;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .notification.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-overlay.show { display: flex; }
        
        .modal-content {
            background: #1e3a5f;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 2px solid #2d4a6f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-family: 'JetBrains Mono', monospace;
            color: #2563eb;
        }
        
        .modal-body { padding: 2rem; }
        
        .action-btn {
            padding: 0.5rem;
            border: none;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 6px;
        }
        
        .action-btn:hover { background: #2d4a6f; color: #e2e8f0; }
        
        .hidden { display: none !important; }
        
        .info-box {
            background: #0f172a;
            border-left: 4px solid #8b5cf6;
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin-bottom: 1.5rem;
        }
        
        .info-box p { color: #94a3b8; font-size: 0.9rem; }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #0f172a;
            border: 2px solid #2d4a6f;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }
        
        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #2d4a6f;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .autocomplete-item:hover { background: #2d4a6f; }
        
        .autocomplete-item img {
            width: 40px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        /* Hist√≥rico com assinatura */
        .historico-item {
            background: #0f172a;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #2563eb;
        }
        
        .historico-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .historico-epi {
            font-weight: 600;
            color: #e2e8f0;
            font-size: 1rem;
        }
        
        .historico-data {
            background: #2d4a6f;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            color: #94a3b8;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .historico-detalhes {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .historico-assinatura {
            background: #1e3a5f;
            border-radius: 8px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .historico-assinatura img {
            max-width: 150px;
            max-height: 50px;
            border-radius: 4px;
            background: white;
            padding: 4px;
        }
        
        .historico-assinatura-info {
            font-size: 0.8rem;
            color: #64748b;
        }
        
        .historico-assinatura-info strong {
            color: #10b981;
            display: block;
        }
        
        /* Estoque */
        .estoque-card {
            background: #0f172a;
            border: 1px solid #2d4a6f;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .estoque-card:hover { border-color: #2563eb; }
        
        .estoque-card.baixo {
            border-left: 4px solid #ef4444;
            background: linear-gradient(90deg, rgba(239,68,68,0.1) 0%, #0f172a 20%);
        }
        
        .estoque-card.zerado {
            border-left: 4px solid #64748b;
            opacity: 0.7;
        }
        
        .estoque-card.ok {
            border-left: 4px solid #10b981;
        }
        
        .estoque-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .estoque-info h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 0.25rem;
        }
        
        .estoque-info p {
            font-size: 0.85rem;
            color: #64748b;
        }
        
        .estoque-numeros {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        
        .estoque-numero {
            text-align: center;
        }
        
        .estoque-numero .valor {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .estoque-numero .valor.ok { color: #10b981; }
        .estoque-numero .valor.baixo { color: #ef4444; }
        .estoque-numero .valor.zerado { color: #64748b; }
        
        .estoque-numero .label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
        }
        
        .estoque-barra {
            height: 8px;
            background: #2d4a6f;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .estoque-barra-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .estoque-barra-fill.ok { background: linear-gradient(90deg, #10b981, #059669); }
        .estoque-barra-fill.baixo { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .estoque-barra-fill.zerado { background: #64748b; }
        
        .estoque-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-small.entrada {
            background: #10b981;
            color: white;
        }
        
        .btn-small.saida {
            background: #2563eb;
            color: #1e3a5f;
        }
        
        .btn-small.editar {
            background: #3b82f6;
            color: white;
        }
        
        .btn-small.excluir {
            background: #ef4444;
            color: white;
        }
        
        .badge-validade {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .badge-validade.vencido {
            background: #ef4444;
            color: white;
        }
        
        .badge-validade.proximo {
            background: #2563eb;
            color: #1e3a5f;
        }
        
        .badge-validade.ok {
            background: #10b981;
            color: white;
        }
        
        @media (max-width: 768px) {
            .header-content { flex-direction: column; }
            .nav-tabs { padding: 1rem; }
            .main-content { padding: 0 1rem 1rem; }
            .card { padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-container">
            <div class="login-logo">
                <div class="icon">üõ°Ô∏è</div>
                <h1>RC EPI Control</h1>
                <p>Sistema de Gest√£o de EPIs</p>
            </div>
            
            <div id="login-error" class="login-error">
                Usu√°rio ou senha incorretos
            </div>
            
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Usu√°rio</label>
                    <input type="text" id="login-user" placeholder="Digite seu usu√°rio" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="login-pass" placeholder="Digite sua senha" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">
                    üîê Entrar no Sistema
                </button>
            </form>
            
            <div class="login-footer">
                <p>RC Engenharia Sa√∫de e Seguran√ßa Ocupacional</p>
                <p>¬© 2026 - Todos os direitos reservados</p>
            </div>
        </div>
    </div>

    <!-- Notifica√ß√£o -->
    <div id="notification" class="notification success">
        <span id="notification-text"></span>
    </div>

    <!-- Header -->
    <header class="header" id="main-header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                </div>
                <div>
                    <h1>RC EPI CONTROL</h1>
                    <span>Sistema de Gest√£o de EPIs</span>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
                <button id="install-btn" class="install-btn" onclick="installApp()">
                    üì≤ Instalar App
                </button>
                <div class="stats-badges">
                    <div class="stats-badge">
                        <span id="stats-count">0</span> entregas
                    </div>
                    <div class="stats-badge bio">
                        <span id="stats-bio">0</span> funcion√°rios
                    </div>
                    <div class="stats-badge" id="badge-estoque-baixo" style="display:none;color:#ef4444;">
                        <span id="stats-estoque-baixo">0</span> estoque baixo
                    </div>
                </div>
                <div class="user-badge">
                    <span>üë§</span>
                    <span id="logged-user">Usu√°rio</span>
                    <span id="user-role" class="role">USER</span>
                </div>
                <button class="btn-logout" onclick="handleLogout()">Sair</button>
            </div>
        </div>
    </header>

    <!-- Navega√ß√£o -->
    <nav class="nav-tabs">
        <button class="nav-tab active" data-tab="cadastro" onclick="showTab('cadastro')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
            </svg>
            Entrega
        </button>
        <button class="nav-tab" data-tab="devolucao" onclick="showTab('devolucao')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
            </svg>
            Devolu√ß√£o
        </button>
        <button class="nav-tab" data-tab="estoque" onclick="showTab('estoque')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                <path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/>
            </svg>
            Estoque
        </button>
        <button class="nav-tab" data-tab="funcionarios" onclick="showTab('funcionarios')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
            </svg>
            Funcion√°rios
        </button>
        <button class="nav-tab" data-tab="empresas" onclick="showTab('empresas')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 21h18"/>
                <path d="M5 21V7l8-4v18"/>
                <path d="M19 21V11l-6-4"/>
                <path d="M9 9h1M9 13h1M9 17h1"/>
            </svg>
            Empresas
        </button>
        <button class="nav-tab" data-tab="config" onclick="showTab('config')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
            Config
        </button>
    </nav>

    <!-- Conte√∫do Principal -->
    <main class="main-content">
        <!-- Tab Cadastro -->
        <div id="tab-cadastro" class="card">
            <h2 class="card-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    <path d="M20 8v6M23 11h-6"/>
                </svg>
                Registrar Entrega de EPI
            </h2>
            
            <div class="info-box">
                <p>‚úçÔ∏è <strong>Assinatura por Entrega:</strong> Cada EPI entregue ter√° sua pr√≥pria assinatura com data e hora registradas no PDF.</p>
            </div>
            
            <form id="form-epi" onsubmit="handleSubmit(event)">
                <div class="form-grid">
                    <div class="form-group" style="position: relative;">
                        <label class="field-label">CPF do Trabalhador *</label>
                        <input type="text" id="cpf" class="field-input" placeholder="000.000.000-00" oninput="formatCPF(this); searchFuncionario(this.value)" required>
                        <div id="autocomplete-list" class="autocomplete-list hidden"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Nome do Trabalhador *</label>
                        <input type="text" id="trabalhador" class="field-input" placeholder="Nome completo" required>
                    </div>
                    
                    <div class="form-group" style="position:relative;">
                        <label class="field-label">Empresa *</label>
                        <input type="text" id="empresa" class="field-input" placeholder="Digite ou selecione uma empresa" oninput="buscarEmpresa(this.value)" onfocus="mostrarEmpresas()" required autocomplete="off">
                        <div id="autocomplete-empresa" class="autocomplete-list hidden"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">CNPJ *</label>
                        <input type="text" id="cnpj" class="field-input" placeholder="00.000.000/0000-00" oninput="formatCNPJ(this)" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Fun√ß√£o/Cargo</label>
                        <input type="text" id="funcao" class="field-input" placeholder="Ex: Operador de M√°quinas">
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Setor</label>
                        <input type="text" id="setor" class="field-input" placeholder="Ex: Produ√ß√£o">
                    </div>
                    
                    <div class="form-group" style="position:relative;">
                        <label class="field-label">Descri√ß√£o do EPI *</label>
                        <div style="position:relative;">
                            <input type="text" id="descricaoEPI" class="field-input" placeholder="Digite ou selecione do estoque..." oninput="buscarEPIEstoque(this.value)" onfocus="mostrarEPIsEstoque()" required>
                            <button type="button" onclick="mostrarTodosEPIs()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:#2563eb;border:none;border-radius:6px;padding:0.4rem 0.6rem;cursor:pointer;color:#1e3a5f;font-size:0.75rem;font-weight:600;" title="Ver EPIs do estoque">
                                üì¶ Estoque
                            </button>
                        </div>
                        <div id="autocomplete-epi" class="autocomplete-list hidden" style="max-height:250px;"></div>
                        <small id="dica-estoque" style="color:#64748b;font-size:0.75rem;">üí° Cadastre EPIs na aba <strong>Estoque</strong> para selecionar automaticamente</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">N√∫mero do CA *</label>
                        <input type="text" id="numeroCA" class="field-input" placeholder="Ex: 12345" required>
                        <small id="estoque-disponivel" style="color:#64748b;font-size:0.75rem;"></small>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Data da Entrega *</label>
                        <input type="date" id="dataEntrega" class="field-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Quantidade</label>
                        <input type="number" id="quantidade" class="field-input" value="1" min="1">
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="field-label">Observa√ß√µes</label>
                        <textarea id="observacoes" class="field-input" placeholder="Informa√ß√µes adicionais..."></textarea>
                    </div>
                </div>
                
                <!-- Se√ß√£o de Foto -->
                <div class="biometria-section" id="biometria-section">
                    <div class="biometria-title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                        Foto do Trabalhador (Opcional)
                    </div>
                    
                    <div id="photo-options">
                        <div class="photo-options">
                            <div class="photo-option" onclick="startCamera()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                                    <circle cx="12" cy="13" r="4"/>
                                </svg>
                                <p>Usar Webcam</p>
                                <small>C√¢mera do PC</small>
                            </div>
                            
                            <div class="photo-option" onclick="document.getElementById('photo-upload-camera').click()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="2" y="3" width="20" height="14" rx="2"/>
                                    <line x1="8" y1="21" x2="16" y2="21"/>
                                    <line x1="12" y1="17" x2="12" y2="21"/>
                                </svg>
                                <p>üì± Celular</p>
                                <small>Tirar foto agora</small>
                            </div>
                            
                            <div class="photo-option" onclick="document.getElementById('photo-upload').click()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <path d="M21 15l-5-5L5 21"/>
                                </svg>
                                <p>Galeria</p>
                                <small>Foto existente</small>
                            </div>
                        </div>
                        <!-- Input para c√¢mera do celular (abre c√¢mera diretamente) -->
                        <input type="file" id="photo-upload-camera" accept="image/*" capture="user" style="display: none" onchange="handlePhotoUpload(event)">
                        <!-- Input para galeria/arquivos -->
                        <input type="file" id="photo-upload" accept="image/*" style="display: none" onchange="handlePhotoUpload(event)">
                    </div>
                    
                    <div id="camera-area" class="hidden">
                        <div class="camera-container" id="camera-container">
                            <video id="camera-video" class="camera-video" autoplay playsinline muted></video>
                            <div class="face-guide"></div>
                        </div>
                        
                        <div id="camera-error" class="error-message hidden">
                            <strong>‚ö†Ô∏è Erro na c√¢mera</strong>
                            <span id="camera-error-text"></span>
                            <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(239,68,68,0.3);">
                                <p style="margin-bottom:0.75rem;color:#e2e8f0;font-weight:500;">Use uma destas alternativas:</p>
                                <button type="button" onclick="cancelCamera();document.getElementById('photo-upload-camera').click();" class="btn-success" style="width:100%;margin-bottom:0.5rem;">
                                    üì± Tirar Foto com Celular
                                </button>
                                <button type="button" onclick="cancelCamera();document.getElementById('photo-upload').click();" class="btn-secondary" style="width:100%;margin-bottom:0.5rem;">
                                    üìÅ Selecionar da Galeria
                                </button>
                            </div>
                        </div>
                        
                        <div class="camera-buttons">
                            <button type="button" class="btn-success" id="btn-capture" onclick="capturePhoto()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                Capturar Foto
                            </button>
                            <button type="button" class="btn-secondary" onclick="cancelCamera()">Cancelar</button>
                        </div>
                    </div>
                    
                    <div id="photo-preview-area" class="photo-preview-area hidden">
                        <img id="captured-photo" src="" alt="Foto">
                        <p style="color: #10b981; margin-top: 0.75rem; font-weight: 500;">‚úì Foto capturada</p>
                        <button type="button" class="btn-secondary" onclick="removePhoto()" style="margin-top: 0.5rem;">Remover</button>
                    </div>
                    
                    <canvas id="camera-canvas" style="display: none;"></canvas>
                </div>
                
                <div class="signature-container">
                    <label class="field-label">Assinatura do Trabalhador * (ser√° vinculada a esta entrega)</label>
                    <canvas id="signature-canvas" class="signature-canvas" width="500" height="150"></canvas>
                    <div class="signature-buttons">
                        <button type="button" class="btn-secondary" onclick="clearSignature()">Limpar</button>
                        <button type="button" class="btn-primary" onclick="confirmSignature()">Confirmar Assinatura</button>
                    </div>
                </div>
                
                <div id="signature-preview" class="signature-preview">
                    <p style="font-size: 0.85rem; color: #10b981; margin-bottom: 0.5rem; font-weight: 600;">
                        ‚úì Assinatura confirmada - ser√° registrada com data e hora
                    </p>
                    <img id="signature-img" src="" alt="Assinatura">
                </div>
                
                <button type="submit" class="btn-submit">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                    </svg>
                    REGISTRAR E GERAR PDF
                </button>
            </form>
        </div>

        <!-- Tab Devolu√ß√£o -->
        <div id="tab-devolucao" class="card hidden">
            <h2 class="card-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
                Devolu√ß√£o de EPI
            </h2>
            
            <div class="info-box" style="border-left-color:#10b981;">
                <p>üîÑ Registre aqui a devolu√ß√£o de EPIs pelo funcion√°rio (troca, desligamento, fim da vida √∫til, etc.)</p>
            </div>
            
            <form id="form-devolucao" onsubmit="handleDevolucao(event)">
                <div class="form-grid">
                    <div class="form-group" style="position: relative;">
                        <label class="field-label">CPF do Trabalhador *</label>
                        <input type="text" id="dev-cpf" class="field-input" placeholder="000.000.000-00" oninput="formatCPF(this); buscarFuncionarioDevolucao(this.value)" required>
                        <div id="autocomplete-devolucao" class="autocomplete-list hidden"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Nome do Trabalhador</label>
                        <input type="text" id="dev-trabalhador" class="field-input" placeholder="Selecione pelo CPF" readonly>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="field-label">EPI a Devolver *</label>
                        <select id="dev-epi" class="field-input" required onchange="selecionarEPIDevolucao()">
                            <option value="">Selecione o EPI entregue</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Data da Devolu√ß√£o *</label>
                        <input type="date" id="dev-data" class="field-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Motivo da Devolu√ß√£o *</label>
                        <select id="dev-motivo" class="field-input" required>
                            <option value="">Selecione o motivo</option>
                            <option value="troca">Troca por desgaste/dano</option>
                            <option value="vencimento">Vencimento do CA</option>
                            <option value="desligamento">Desligamento do funcion√°rio</option>
                            <option value="mudanca_funcao">Mudan√ßa de fun√ß√£o</option>
                            <option value="inadequado">EPI inadequado</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Estado do EPI</label>
                        <select id="dev-estado" class="field-input">
                            <option value="bom">Bom estado (reutiliz√°vel)</option>
                            <option value="danificado">Danificado</option>
                            <option value="desgastado">Desgastado</option>
                            <option value="descarte">Para descarte</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Retornar ao Estoque?</label>
                        <select id="dev-retornar" class="field-input">
                            <option value="nao">N√£o</option>
                            <option value="sim">Sim</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="field-label">Observa√ß√µes</label>
                        <textarea id="dev-observacoes" class="field-input" placeholder="Informa√ß√µes adicionais sobre a devolu√ß√£o..."></textarea>
                    </div>
                </div>
                
                <div class="signature-container">
                    <label class="field-label">Assinatura do Trabalhador (Confirmando Devolu√ß√£o) *</label>
                    <canvas id="signature-devolucao" class="signature-canvas" width="500" height="150"></canvas>
                    <div class="signature-buttons">
                        <button type="button" class="btn-secondary" onclick="clearSignatureDevolucao()">Limpar</button>
                        <button type="button" class="btn-primary" onclick="confirmSignatureDevolucao()">Confirmar Assinatura</button>
                    </div>
                </div>
                
                <div id="signature-preview-dev" class="signature-preview">
                    <p style="font-size: 0.85rem; color: #10b981; margin-bottom: 0.5rem; font-weight: 600;">
                        ‚úì Assinatura confirmada
                    </p>
                    <img id="signature-img-dev" src="" alt="Assinatura">
                </div>
                
                <button type="submit" class="btn-submit" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                    </svg>
                    REGISTRAR DEVOLU√á√ÉO
                </button>
            </form>
        </div>

        <!-- Tab Estoque -->
        <div id="tab-estoque" class="card hidden">
            <h2 class="card-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                </svg>
                Gest√£o de Estoque de EPIs
            </h2>
            
            <!-- Resumo do Estoque -->
            <div id="estoque-resumo" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1.5rem;">
                <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:#2563eb;font-family:'JetBrains Mono',monospace;" id="total-itens-estoque">0</div>
                    <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Itens Cadastrados</div>
                </div>
                <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:#10b981;font-family:'JetBrains Mono',monospace;" id="total-em-estoque">0</div>
                    <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Total em Estoque</div>
                </div>
                <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:#ef4444;font-family:'JetBrains Mono',monospace;" id="itens-abaixo-minimo">0</div>
                    <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Abaixo do M√≠nimo</div>
                </div>
            </div>
            
            <!-- Alertas de Estoque Baixo -->
            <div id="alertas-estoque" class="hidden" style="background:rgba(239,68,68,0.1);border:1px solid #ef4444;border-radius:10px;padding:1rem;margin-bottom:1.5rem;">
                <h4 style="color:#ef4444;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    EPIs com Estoque Baixo
                </h4>
                <div id="lista-alertas"></div>
            </div>
            
            <!-- Formul√°rio de Cadastro de EPI -->
            <div style="background:#0f172a;border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;">
                <h3 style="color:#2563eb;margin-bottom:1rem;font-size:1rem;">Cadastrar Novo EPI no Estoque</h3>
                <form id="form-estoque" onsubmit="cadastrarEPIEstoque(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="field-label">Descri√ß√£o do EPI *</label>
                            <input type="text" id="est-descricao" class="field-input" placeholder="Ex: Capacete de Seguran√ßa" required>
                        </div>
                        <div class="form-group">
                            <label class="field-label">N√∫mero do CA *</label>
                            <input type="text" id="est-ca" class="field-input" placeholder="Ex: 12345" required>
                        </div>
                        <div class="form-group">
                            <label class="field-label">Quantidade Inicial *</label>
                            <input type="number" id="est-quantidade" class="field-input" placeholder="0" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="field-label">Estoque de Seguran√ßa *</label>
                            <input type="number" id="est-minimo" class="field-input" placeholder="Qtd m√≠nima" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="field-label">Unidade</label>
                            <select id="est-unidade" class="field-input">
                                <option value="UN">Unidade (UN)</option>
                                <option value="PAR">Par (PAR)</option>
                                <option value="CX">Caixa (CX)</option>
                                <option value="PCT">Pacote (PCT)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="field-label">Validade do CA</label>
                            <input type="date" id="est-validade" class="field-input">
                        </div>
                    </div>
                    <button type="submit" class="btn-success" style="margin-top:1rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Cadastrar EPI
                    </button>
                </form>
            </div>
            
            <!-- Busca e Filtros -->
            <div class="search-bar">
                <div class="search-wrapper">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" id="busca-estoque" class="search-input" placeholder="Buscar EPI..." oninput="filtrarEstoque()">
                </div>
                <select id="filtro-estoque" class="filter-select" onchange="filtrarEstoque()">
                    <option value="">Todos</option>
                    <option value="baixo">Estoque Baixo</option>
                    <option value="ok">Estoque OK</option>
                    <option value="zerado">Zerado</option>
                </select>
            </div>
            
            <!-- Lista de EPIs -->
            <div id="lista-estoque"></div>
            
            <div id="empty-estoque" class="empty-state hidden">
                <div class="empty-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="1.5">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                    </svg>
                </div>
                <h3>Nenhum EPI cadastrado</h3>
                <p>Cadastre EPIs para controlar o estoque</p>
            </div>
        </div>

        <!-- Tab Funcion√°rios -->
        <div id="tab-funcionarios" class="card hidden">
            <h2 class="card-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                </svg>
                Funcion√°rios e Hist√≥rico
            </h2>
            
            <div class="search-bar">
                <div class="search-wrapper">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" id="search-funcionario" class="search-input" placeholder="Buscar..." oninput="filterFuncionarios()">
                </div>
                
                <select id="filter-empresa" class="filter-select" onchange="filterFuncionarios()">
                    <option value="">Todas as empresas</option>
                </select>
                
                <button class="btn-primary" onclick="exportAllToCSV()">Exportar CSV</button>
            </div>
            
            <div id="funcionarios-list"></div>
            
            <div id="empty-state-func" class="empty-state hidden">
                <div class="empty-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                    </svg>
                </div>
                <h3>Nenhum funcion√°rio</h3>
            </div>
        </div>

        <!-- Tab Empresas -->
        <div id="tab-empresas" class="card hidden">
            <h2 class="card-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 21h18"/>
                    <path d="M5 21V7l8-4v18"/>
                    <path d="M19 21V11l-6-4"/>
                </svg>
                Cadastro de Empresas
            </h2>
            
            <!-- Seletor de Empresa Ativa -->
            <div class="info-box" style="border-left-color:#2563eb;margin-bottom:1.5rem;">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
                    <div>
                        <p style="font-weight:600;margin-bottom:0.25rem;">üè¢ Empresa Ativa</p>
                        <p style="font-size:0.85rem;color:#64748b;">Selecione a empresa para visualizar entregas e gerar PDFs</p>
                    </div>
                    <select id="empresa-ativa-select" class="field-input" style="max-width:300px;" onchange="selecionarEmpresaAtiva()">
                        <option value="">Todas as empresas</option>
                    </select>
                </div>
            </div>
            
            <!-- Resumo -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1.5rem;">
                <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:#2563eb;font-family:'JetBrains Mono',monospace;" id="total-empresas">0</div>
                    <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Empresas</div>
                </div>
                <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:#10b981;font-family:'JetBrains Mono',monospace;" id="total-entregas-empresas">0</div>
                    <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Entregas</div>
                </div>
            </div>
            
            <!-- Formul√°rio de Nova Empresa -->
            <div style="background:#0f172a;padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;">
                <h3 style="color:#60a5fa;font-size:1rem;margin-bottom:1rem;font-family:'JetBrains Mono',monospace;">‚ûï Cadastrar Nova Empresa</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="field-label">Raz√£o Social *</label>
                        <input type="text" id="emp-razao" class="field-input" placeholder="Nome da empresa">
                    </div>
                    <div class="form-group">
                        <label class="field-label">Nome Fantasia</label>
                        <input type="text" id="emp-fantasia" class="field-input" placeholder="Nome fantasia (opcional)">
                    </div>
                    <div class="form-group">
                        <label class="field-label">CNPJ *</label>
                        <input type="text" id="emp-cnpj" class="field-input" placeholder="00.000.000/0000-00" oninput="formatCNPJ(this)">
                    </div>
                    <div class="form-group">
                        <label class="field-label">Telefone</label>
                        <input type="text" id="emp-telefone" class="field-input" placeholder="(00) 00000-0000">
                    </div>
                    <div class="form-group full-width">
                        <label class="field-label">Endere√ßo</label>
                        <input type="text" id="emp-endereco" class="field-input" placeholder="Rua, n√∫mero, bairro, cidade - UF">
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">üé® Paleta de Cores do PDF *</label>
                        <select id="emp-paleta" class="field-input" onchange="previewPaleta()">
                            <option value="azul">üîµ Azul Corporativo</option>
                            <option value="verde">üü¢ Verde Seguran√ßa</option>
                            <option value="vermelho">üî¥ Vermelho Alerta</option>
                            <option value="laranja">üü† Laranja Energia</option>
                            <option value="roxo">üü£ Roxo Premium</option>
                            <option value="cinza">‚ö´ Cinza Neutro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Preview da Cor</label>
                        <div id="paleta-preview" style="display:flex;gap:0.5rem;align-items:center;height:45px;">
                            <div style="width:40px;height:40px;background:rgb(30,58,95);border-radius:8px;" id="cor-primaria"></div>
                            <div style="width:40px;height:40px;background:rgb(37,99,235);border-radius:8px;" id="cor-secundaria"></div>
                            <div style="width:40px;height:40px;background:rgb(96,165,250);border-radius:8px;" id="cor-accent"></div>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="field-label">Logo da Empresa</label>
                        <div style="display:flex;gap:1rem;align-items:center;">
                            <input type="file" id="emp-logo-input" accept="image/*" style="display:none" onchange="handleEmpresaLogoUpload(event)">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('emp-logo-input').click()">
                                üìÅ Selecionar Logo
                            </button>
                            <img id="emp-logo-preview" src="" alt="" style="max-height:50px;max-width:150px;display:none;border-radius:8px;">
                        </div>
                    </div>
                </div>
                
                <button class="btn-submit" style="margin-top:1rem;" onclick="cadastrarEmpresa()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    CADASTRAR EMPRESA
                </button>
            </div>
            
            <!-- Lista de Empresas -->
            <h3 style="color:#60a5fa;font-size:1rem;margin-bottom:1rem;font-family:'JetBrains Mono',monospace;">üìã Empresas Cadastradas</h3>
            <div id="empresas-lista"></div>
            
            <!-- Sincroniza√ß√£o -->
            <div style="background:#0f172a;padding:1.5rem;border-radius:12px;margin-top:1.5rem;">
                <h3 style="color:#10b981;font-size:1rem;margin-bottom:1rem;font-family:'JetBrains Mono',monospace;">üîÑ Sincroniza√ß√£o entre Dispositivos</h3>
                <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem;">
                    Exporte os dados para compartilhar com outros dispositivos ou fazer backup na nuvem.
                </p>
                
                <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem;">
                    <button class="btn-success" onclick="exportarSincronizacao()">
                        üì§ Exportar Tudo para Sincronizar
                    </button>
                    <button class="btn-secondary" onclick="document.getElementById('import-sync').click()">
                        üì• Importar Sincroniza√ß√£o
                    </button>
                    <input type="file" id="import-sync" accept=".json" style="display:none" onchange="importarSincronizacao(event)">
                </div>
                
                <div class="info-box" style="border-left-color:#f59e0b;margin-top:1rem;">
                    <p style="font-size:0.85rem;">
                        <strong>üí° Dica:</strong> Salve o arquivo de sincroniza√ß√£o no Google Drive, OneDrive ou envie por WhatsApp 
                        para acessar de outros dispositivos. Importe o arquivo em cada dispositivo para manter os dados atualizados.
                    </p>
                </div>
            </div>
        </div>

        <!-- Tab Configura√ß√µes -->
        <div id="tab-config" class="card hidden">
            <h2 class="card-title">Configura√ß√µes</h2>
            
            <div class="form-group" style="margin-bottom: 2rem;">
                <label class="field-label">Logo da Empresa</label>
                <div class="logo-upload-section" id="logo-upload" onclick="document.getElementById('logo-input').click()">
                    <input type="file" id="logo-input" accept="image/*" style="display: none" onchange="handleLogoUpload(event)">
                    <div id="logo-placeholder">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <path d="M21 15l-5-5L5 21"/>
                        </svg>
                        <p style="color: #94a3b8;">Clique para carregar</p>
                    </div>
                    <img id="logo-preview" class="logo-preview hidden" src="" alt="Logo">
                </div>
                <button type="button" id="btn-remove-logo" class="btn-danger hidden" onclick="removeLogo()" style="margin-top: 0.5rem;">Remover</button>
            </div>
            
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="field-label">Nome da Empresa</label>
                    <input type="text" id="config-empresa" class="field-input" placeholder="Cabe√ßalho do PDF" onchange="saveConfig()">
                </div>
                <div class="form-group full-width">
                    <label class="field-label">Rodap√©</label>
                    <input type="text" id="config-rodape" class="field-input" placeholder="www.empresa.com | telefone" onchange="saveConfig()">
                </div>
            </div>
            
            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #2d4a6f;">
                <h3 style="color:#64748b;margin-bottom:1rem;">Backup de Seguran√ßa</h3>
                <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:2rem;">
                    <button class="btn-success" onclick="exportBackup()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                        Exportar Backup
                    </button>
                    <button class="btn-secondary" onclick="document.getElementById('import-backup').click()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                        Importar Backup
                    </button>
                    <input type="file" id="import-backup" accept=".json" style="display:none" onchange="importBackup(event)">
                </div>
                
                <h3 style="color:#2563eb;margin-bottom:1rem;">üë• Gerenciar Usu√°rios</h3>
                <div style="background:#0f172a;padding:1.25rem;border-radius:10px;margin-bottom:2rem;">
                    <div id="users-list" style="margin-bottom:1rem;"></div>
                    
                    <div style="border-top:1px solid #2d4a6f;padding-top:1rem;margin-top:1rem;">
                        <h4 style="color:#94a3b8;font-size:0.9rem;margin-bottom:1rem;">Alterar Senha</h4>
                        <div style="display:grid;gap:0.75rem;">
                            <select id="user-select" class="field-input" style="padding:0.75rem;">
                                <option value="">Selecione o usu√°rio</option>
                            </select>
                            <input type="password" id="new-password" class="field-input" placeholder="Nova senha (m√≠n. 6 caracteres)">
                            <input type="password" id="confirm-password" class="field-input" placeholder="Confirmar nova senha">
                            <button class="btn-primary" onclick="changeUserPassword()">
                                üîê Alterar Senha
                            </button>
                        </div>
                    </div>
                    
                    <div style="border-top:1px solid #2d4a6f;padding-top:1rem;margin-top:1rem;">
                        <h4 style="color:#94a3b8;font-size:0.9rem;margin-bottom:1rem;">Adicionar Novo Usu√°rio</h4>
                        <div style="display:grid;gap:0.75rem;">
                            <input type="text" id="new-user-name" class="field-input" placeholder="Nome completo">
                            <input type="text" id="new-user-username" class="field-input" placeholder="Nome de usu√°rio (login)">
                            <input type="password" id="new-user-password" class="field-input" placeholder="Senha (m√≠n. 6 caracteres)">
                            <select id="new-user-role" class="field-input" style="padding:0.75rem;">
                                <option value="user">Usu√°rio (acesso b√°sico)</option>
                                <option value="dev">Desenvolvedor (acesso total)</option>
                            </select>
                            <button class="btn-success" onclick="addNewUser()">
                                ‚ûï Adicionar Usu√°rio
                            </button>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #ef4444; margin-bottom: 1rem;">‚ö†Ô∏è Zona de Perigo</h3>
                <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem;">A√ß√µes irrevers√≠veis. Fa√ßa backup antes de prosseguir.</p>
                <button class="btn-danger" onclick="clearAllData()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                    Apagar Todos os Dados
                </button>
            </div>
        </div>
    </main>
    
    <!-- Rodap√© do Software -->
    <footer style="background:#0a1628;padding:1.5rem;text-align:center;border-top:2px solid #2563eb;margin-top:2rem;">
        <p style="color:#60a5fa;font-weight:700;font-size:1rem;margin-bottom:0.25rem;">RC Engenharia Sa√∫de e Seguran√ßa Ocupacional</p>
        <p style="color:#64748b;font-size:0.8rem;">¬© 2026 - Todos os direitos reservados</p>
    </footer>

    <!-- Modal -->
    <div id="modal-historico" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-titulo">Hist√≥rico</h3>
                <button class="action-btn" onclick="document.getElementById('modal-historico').classList.remove('show')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modal-content"></div>
        </div>
    </div>

    <script>
        // ==================== SISTEMA DE AUTENTICA√á√ÉO ====================
        const AUTH_KEY = 'epi-auth-session';
        const USERS_KEY = 'epi-users-db';
        
        // Usu√°rios padr√£o (senha em hash simples - em produ√ß√£o usar bcrypt)
        const DEFAULT_USERS = [
            { 
                username: 'admin', 
                password: 'rc2026admin', 
                role: 'dev', 
                name: 'Administrador',
                permissions: ['all']
            },
            { 
                username: 'usuario', 
                password: 'rc2026user', 
                role: 'user', 
                name: 'Operador',
                permissions: ['cadastro', 'consulta', 'devolucao']
            }
        ];
        
        let currentUser = null;
        let deferredPrompt = null;
        
        // Inicializar usu√°rios no localStorage
        function initUsers() {
            if (!localStorage.getItem(USERS_KEY)) {
                localStorage.setItem(USERS_KEY, JSON.stringify(DEFAULT_USERS));
            }
        }
        
        // Verificar autentica√ß√£o ao carregar
        function checkAuth() {
            const session = localStorage.getItem(AUTH_KEY);
            if (session) {
                try {
                    currentUser = JSON.parse(session);
                    showMainApp();
                    return true;
                } catch(e) {
                    localStorage.removeItem(AUTH_KEY);
                }
            }
            showLoginScreen();
            return false;
        }
        
        // Mostrar tela de login
        function showLoginScreen() {
            document.getElementById('login-overlay').classList.remove('hidden');
            document.getElementById('main-header').style.display = 'none';
            document.querySelector('.nav-tabs').style.display = 'none';
            document.querySelector('.main-content').style.display = 'none';
            document.querySelector('footer').style.display = 'none';
        }
        
        // Mostrar aplicativo principal
        function showMainApp() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('main-header').style.display = 'block';
            document.querySelector('.nav-tabs').style.display = 'flex';
            document.querySelector('.main-content').style.display = 'block';
            document.querySelector('footer').style.display = 'block';
            
            // Atualizar info do usu√°rio
            document.getElementById('logged-user').textContent = currentUser.name;
            const roleEl = document.getElementById('user-role');
            roleEl.textContent = currentUser.role === 'dev' ? 'DEV' : 'USER';
            roleEl.classList.toggle('dev', currentUser.role === 'dev');
            
            // Aplicar permiss√µes
            if (currentUser.role === 'dev') {
                document.body.classList.add('is-dev');
            } else {
                document.body.classList.remove('is-dev');
            }
            
            // Esconder aba Config para usu√°rios normais
            const configTab = document.querySelector('[data-tab="config"]');
            if (configTab) {
                configTab.style.display = currentUser.role === 'dev' ? 'flex' : 'none';
            }
            
            // Inicializar elementos da UI
            setTimeout(() => {
                initSignaturePad();
                const dataEntrega = document.getElementById('dataEntrega');
                if (dataEntrega) dataEntrega.value = new Date().toISOString().split('T')[0];
                updateUI();
            }, 100);
        }
        
        // Processar login
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('login-user').value.trim().toLowerCase();
            const password = document.getElementById('login-pass').value;
            
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            const user = users.find(u => u.username.toLowerCase() === username && u.password === password);
            
            if (user) {
                currentUser = {
                    username: user.username,
                    name: user.name,
                    role: user.role,
                    permissions: user.permissions,
                    loginTime: new Date().toISOString()
                };
                
                localStorage.setItem(AUTH_KEY, JSON.stringify(currentUser));
                
                document.getElementById('login-error').classList.remove('show');
                showMainApp();
                showNotification(`Bem-vindo, ${user.name}!`, 'success');
            } else {
                document.getElementById('login-error').classList.add('show');
                document.getElementById('login-pass').value = '';
            }
        }
        
        // Logout
        function handleLogout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                currentUser = null;
                localStorage.removeItem(AUTH_KEY);
                document.getElementById('login-user').value = '';
                document.getElementById('login-pass').value = '';
                showLoginScreen();
                showNotification('Sess√£o encerrada', 'success');
            }
        }
        
        // ==================== PWA - INSTALA√á√ÉO ====================
        
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Service Worker inline via data URI n√£o funciona bem, vamos usar cache API diretamente
                console.log('PWA: Aplicativo pronto para instala√ß√£o');
            });
        }
        
        // Capturar evento de instala√ß√£o
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').classList.add('show');
        });
        
        // Instalar App
        async function installApp() {
            if (!deferredPrompt) {
                // Mostrar instru√ß√µes manuais
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isAndroid = /Android/.test(navigator.userAgent);
                
                let instructions = '';
                if (isIOS) {
                    instructions = 'üì± No Safari:\n1. Toque no bot√£o Compartilhar (‚¨ÜÔ∏è)\n2. Role e toque em "Adicionar √† Tela de In√≠cio"\n3. Toque em "Adicionar"';
                } else if (isAndroid) {
                    instructions = 'üì± No Chrome:\n1. Toque no menu (‚ãÆ)\n2. Toque em "Adicionar √† tela inicial"\n3. Toque em "Adicionar"';
                } else {
                    instructions = 'üíª No Chrome/Edge:\n1. Clique no √≠cone de instala√ß√£o (‚äï) na barra de endere√ßo\n2. Ou v√° em Menu > Instalar aplicativo';
                }
                
                alert('Como instalar o aplicativo:\n\n' + instructions);
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                showNotification('Aplicativo instalado com sucesso!', 'success');
            }
            
            deferredPrompt = null;
            document.getElementById('install-btn').classList.remove('show');
        }
        
        // Detectar se j√° est√° instalado
        window.addEventListener('appinstalled', () => {
            document.getElementById('install-btn').classList.remove('show');
            showNotification('RC EPI Control instalado!', 'success');
        });
        
        // ==================== DADOS DO SISTEMA ====================
        const STORAGE_KEY = 'epi-entregas-v4';
        const CONFIG_KEY = 'epi-config-v4';
        const ESTOQUE_KEY = 'epi-estoque-v1';
        const EMPRESAS_KEY = 'epi-empresas-v1';
        const SYNC_KEY = 'epi-sync-config';
        
        let entregas = [];
        let estoque = [];
        let empresas = [];
        let empresaAtual = null;
        let config = { logo: null, empresa: '', rodape: '' };
        let signatureData = null;
        let capturedPhotoData = null;
        let currentFuncionarioPhoto = null;
        let isDrawing = false;
        let lastPos = { x: 0, y: 0 };
        let videoStream = null;
        
        // Paletas de cores predefinidas
        const PALETAS_CORES = {
            azul: {
                nome: 'Azul Corporativo',
                primaria: [30, 58, 95],
                secundaria: [37, 99, 235],
                accent: [96, 165, 250],
                texto: [50, 50, 50],
                fundo: [245, 248, 252]
            },
            verde: {
                nome: 'Verde Seguran√ßa',
                primaria: [6, 78, 59],
                secundaria: [16, 185, 129],
                accent: [52, 211, 153],
                texto: [50, 50, 50],
                fundo: [240, 253, 244]
            },
            vermelho: {
                nome: 'Vermelho Alerta',
                primaria: [127, 29, 29],
                secundaria: [220, 38, 38],
                accent: [248, 113, 113],
                texto: [50, 50, 50],
                fundo: [254, 242, 242]
            },
            laranja: {
                nome: 'Laranja Energia',
                primaria: [124, 45, 18],
                secundaria: [234, 88, 12],
                accent: [251, 146, 60],
                texto: [50, 50, 50],
                fundo: [255, 247, 237]
            },
            roxo: {
                nome: 'Roxo Premium',
                primaria: [76, 29, 149],
                secundaria: [139, 92, 246],
                accent: [167, 139, 250],
                texto: [50, 50, 50],
                fundo: [245, 243, 255]
            },
            cinza: {
                nome: 'Cinza Neutro',
                primaria: [31, 41, 55],
                secundaria: [75, 85, 99],
                accent: [156, 163, 175],
                texto: [50, 50, 50],
                fundo: [249, 250, 251]
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar usu√°rios
            initUsers();
            
            // Verificar se est√° logado
            checkAuth();
            
            // Carregar dados sempre (ser√£o exibidos ap√≥s login)
            loadData();
            loadConfig();
            loadEstoque();
            loadEmpresas();
            
            document.addEventListener('click', function(e) {
                const autocompleteList = document.getElementById('autocomplete-list');
                const autocompleteEpi = document.getElementById('autocomplete-epi');
                
                if (!e.target.closest('#cpf') && !e.target.closest('#autocomplete-list')) {
                    autocompleteList?.classList.add('hidden');
                }
                
                if (!e.target.closest('#descricaoEPI') && !e.target.closest('#autocomplete-epi') && !e.target.closest('[onclick*="mostrarTodosEPIs"]')) {
                    autocompleteEpi?.classList.add('hidden');
                }
            });
        });
        
        function loadData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) entregas = JSON.parse(data);
            } catch (e) {}
            updateUI();
        }
        
        function loadConfig() {
            try {
                const data = localStorage.getItem(CONFIG_KEY);
                if (data) {
                    config = JSON.parse(data);
                    if (config.logo) {
                        document.getElementById('logo-preview').src = config.logo;
                        document.getElementById('logo-preview').classList.remove('hidden');
                        document.getElementById('logo-placeholder').classList.add('hidden');
                        document.getElementById('logo-upload').classList.add('has-logo');
                        document.getElementById('btn-remove-logo').classList.remove('hidden');
                    }
                    if (config.empresa) document.getElementById('config-empresa').value = config.empresa;
                    if (config.rodape) document.getElementById('config-rodape').value = config.rodape;
                }
            } catch (e) {}
        }
        
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(entregas));
                return true;
            } catch (e) { return false; }
        }
        
        function loadEstoque() {
            try {
                const data = localStorage.getItem(ESTOQUE_KEY);
                if (data) estoque = JSON.parse(data);
            } catch (e) {}
            updateEstoqueUI();
        }
        
        function saveEstoque() {
            try {
                localStorage.setItem(ESTOQUE_KEY, JSON.stringify(estoque));
                return true;
            } catch (e) { return false; }
        }
        
        function updateEstoqueUI() {
            // Resumo
            document.getElementById('total-itens-estoque').textContent = estoque.length;
            document.getElementById('total-em-estoque').textContent = estoque.reduce((sum, e) => sum + e.quantidade, 0);
            
            const abaixoMinimo = estoque.filter(e => e.quantidade < e.estoqueMinimo);
            document.getElementById('itens-abaixo-minimo').textContent = abaixoMinimo.length;
            
            // Badge no header
            const badgeEstoque = document.getElementById('badge-estoque-baixo');
            const statsEstoque = document.getElementById('stats-estoque-baixo');
            if (abaixoMinimo.length > 0) {
                badgeEstoque.style.display = 'flex';
                statsEstoque.textContent = abaixoMinimo.length;
            } else {
                badgeEstoque.style.display = 'none';
            }
            
            // Atualizar dica no formul√°rio de entrega
            const dica = document.getElementById('dica-estoque');
            if (dica) {
                if (estoque.length > 0) {
                    dica.innerHTML = `<span style="color:#10b981;">‚úì ${estoque.length} EPI(s) no estoque - clique no campo ou no bot√£o üì¶ Estoque</span>`;
                } else {
                    dica.innerHTML = 'üí° Cadastre EPIs na aba <strong>Estoque</strong> para selecionar automaticamente';
                }
            }
            
            // Alertas
            const alertasDiv = document.getElementById('alertas-estoque');
            const listaAlertas = document.getElementById('lista-alertas');
            
            if (abaixoMinimo.length > 0) {
                alertasDiv.classList.remove('hidden');
                listaAlertas.innerHTML = abaixoMinimo.map(e => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;background:rgba(239,68,68,0.1);border-radius:6px;margin-bottom:0.5rem;">
                        <span><strong>${e.descricao}</strong> (CA ${e.ca})</span>
                        <span style="color:#ef4444;font-weight:600;">${e.quantidade}/${e.estoqueMinimo} ${e.unidade}</span>
                    </div>
                `).join('');
            } else {
                alertasDiv.classList.add('hidden');
            }
            
            // Lista de EPIs
            filtrarEstoque();
        }
        
        function filtrarEstoque() {
            const busca = document.getElementById('busca-estoque')?.value.toLowerCase() || '';
            const filtro = document.getElementById('filtro-estoque')?.value || '';
            
            let itens = estoque.filter(e => {
                const matchBusca = e.descricao.toLowerCase().includes(busca) || e.ca.includes(busca);
                let matchFiltro = true;
                
                if (filtro === 'baixo') matchFiltro = e.quantidade < e.estoqueMinimo && e.quantidade > 0;
                if (filtro === 'ok') matchFiltro = e.quantidade >= e.estoqueMinimo;
                if (filtro === 'zerado') matchFiltro = e.quantidade === 0;
                
                return matchBusca && matchFiltro;
            });
            
            const container = document.getElementById('lista-estoque');
            const empty = document.getElementById('empty-estoque');
            
            if (itens.length === 0 && estoque.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            if (itens.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#64748b;padding:2rem;">Nenhum item encontrado</p>';
                return;
            }
            
            container.innerHTML = itens.map(e => {
                let status = 'ok';
                if (e.quantidade === 0) status = 'zerado';
                else if (e.quantidade < e.estoqueMinimo) status = 'baixo';
                
                const porcentagem = e.estoqueMinimo > 0 ? Math.min(100, (e.quantidade / (e.estoqueMinimo * 2)) * 100) : 100;
                
                // Verificar validade
                let validadeBadge = '';
                if (e.validade) {
                    const hoje = new Date();
                    const validade = new Date(e.validade);
                    const diasRestantes = Math.ceil((validade - hoje) / (1000 * 60 * 60 * 24));
                    
                    if (diasRestantes < 0) {
                        validadeBadge = '<span class="badge-validade vencido">CA VENCIDO</span>';
                    } else if (diasRestantes <= 90) {
                        validadeBadge = `<span class="badge-validade proximo">Vence em ${diasRestantes} dias</span>`;
                    } else {
                        validadeBadge = `<span class="badge-validade ok">V√°lido at√© ${formatDate(e.validade)}</span>`;
                    }
                }
                
                return `
                    <div class="estoque-card ${status}">
                        <div class="estoque-header">
                            <div class="estoque-info">
                                <h4>${e.descricao}</h4>
                                <p>CA: ${e.ca} ${validadeBadge}</p>
                            </div>
                            <div class="estoque-numeros">
                                <div class="estoque-numero">
                                    <div class="valor ${status}">${e.quantidade}</div>
                                    <div class="label">Em Estoque</div>
                                </div>
                                <div class="estoque-numero">
                                    <div class="valor" style="color:#64748b;">${e.estoqueMinimo}</div>
                                    <div class="label">M√≠nimo</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="estoque-barra">
                            <div class="estoque-barra-fill ${status}" style="width:${porcentagem}%"></div>
                        </div>
                        
                        <div class="estoque-actions">
                            <button class="btn-small entrada" onclick="movimentarEstoque('${e.id}', 'entrada')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                                Entrada
                            </button>
                            <button class="btn-small saida" onclick="movimentarEstoque('${e.id}', 'saida')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>
                                Sa√≠da
                            </button>
                            <button class="btn-small" style="background:#8b5cf6;color:white;" onclick="verHistoricoEstoque('${e.id}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                Hist√≥rico
                            </button>
                            <button class="btn-small editar" onclick="editarEPIEstoque('${e.id}')" title="Editar EPI">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                Editar
                            </button>
                            <button class="btn-small excluir" onclick="excluirEPIEstoque('${e.id}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function cadastrarEPIEstoque(e) {
            e.preventDefault();
            
            const novoEPI = {
                id: Date.now().toString(),
                descricao: document.getElementById('est-descricao').value,
                ca: document.getElementById('est-ca').value,
                quantidade: parseInt(document.getElementById('est-quantidade').value) || 0,
                estoqueMinimo: parseInt(document.getElementById('est-minimo').value) || 0,
                unidade: document.getElementById('est-unidade').value,
                validade: document.getElementById('est-validade').value || null,
                historico: [{
                    tipo: 'inicial',
                    quantidade: parseInt(document.getElementById('est-quantidade').value) || 0,
                    data: new Date().toISOString(),
                    obs: 'Cadastro inicial'
                }],
                dataCadastro: new Date().toISOString()
            };
            
            // Verificar se CA j√° existe
            if (estoque.some(e => e.ca === novoEPI.ca)) {
                showNotification('CA j√° cadastrado!', 'error');
                return;
            }
            
            estoque.push(novoEPI);
            
            if (saveEstoque()) {
                showNotification('EPI cadastrado no estoque!', 'success');
                document.getElementById('form-estoque').reset();
                updateEstoqueUI();
            }
        }
        
        function movimentarEstoque(id, tipo) {
            const epi = estoque.find(e => e.id === id);
            if (!epi) return;
            
            const qtd = prompt(`${tipo === 'entrada' ? 'üì• ENTRADA' : 'üì§ SA√çDA'} de Estoque\n\n${epi.descricao}\nEstoque atual: ${epi.quantidade} ${epi.unidade}\n\nQuantidade:`);
            
            if (!qtd || isNaN(qtd) || parseInt(qtd) <= 0) {
                if (qtd !== null) showNotification('Quantidade inv√°lida', 'error');
                return;
            }
            
            const quantidade = parseInt(qtd);
            
            if (tipo === 'saida' && quantidade > epi.quantidade) {
                showNotification('Quantidade maior que estoque dispon√≠vel!', 'error');
                return;
            }
            
            const obs = prompt('Observa√ß√£o (opcional):') || '';
            
            if (tipo === 'entrada') {
                epi.quantidade += quantidade;
            } else {
                epi.quantidade -= quantidade;
            }
            
            epi.historico.push({
                tipo: tipo,
                quantidade: quantidade,
                data: new Date().toISOString(),
                obs: obs
            });
            
            if (saveEstoque()) {
                showNotification(`${tipo === 'entrada' ? 'Entrada' : 'Sa√≠da'} registrada!`, 'success');
                updateEstoqueUI();
            }
        }
        
        function editarEPIEstoque(id) {
            const epi = estoque.find(e => e.id === id);
            if (!epi) return;
            
            document.getElementById('modal-titulo').textContent = `Editar: ${epi.descricao}`;
            
            document.getElementById('modal-content').innerHTML = `
                <form id="form-editar-epi" onsubmit="salvarEdicaoEPI(event, '${id}')">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="field-label">Descri√ß√£o do EPI *</label>
                            <input type="text" id="edit-descricao" class="field-input" value="${epi.descricao}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="field-label">N√∫mero do CA *</label>
                            <input type="text" id="edit-ca" class="field-input" value="${epi.ca}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="field-label">Validade do CA</label>
                            <input type="date" id="edit-validade" class="field-input" value="${epi.validade || ''}">
                        </div>
                        
                        <div class="form-group">
                            <label class="field-label">Estoque de Seguran√ßa (M√≠nimo) *</label>
                            <input type="number" id="edit-minimo" class="field-input" value="${epi.estoqueMinimo}" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="field-label">Unidade</label>
                            <select id="edit-unidade" class="field-input">
                                <option value="UN" ${epi.unidade === 'UN' ? 'selected' : ''}>Unidade (UN)</option>
                                <option value="PAR" ${epi.unidade === 'PAR' ? 'selected' : ''}>Par (PAR)</option>
                                <option value="CX" ${epi.unidade === 'CX' ? 'selected' : ''}>Caixa (CX)</option>
                                <option value="PCT" ${epi.unidade === 'PCT' ? 'selected' : ''}>Pacote (PCT)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="field-label">Quantidade Atual</label>
                            <input type="number" id="edit-quantidade" class="field-input" value="${epi.quantidade}" min="0" required>
                            <small style="color:#64748b;font-size:0.75rem;">‚ö†Ô∏è Alterar aqui N√ÉO registra no hist√≥rico. Use Entrada/Sa√≠da.</small>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:0.75rem;margin-top:1.5rem;flex-wrap:wrap;">
                        <button type="submit" class="btn-success" style="flex:1;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
                            Salvar Altera√ß√µes
                        </button>
                        <button type="button" class="btn-secondary" onclick="document.getElementById('modal-historico').classList.remove('show')">
                            Cancelar
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('modal-historico').classList.add('show');
        }
        
        function salvarEdicaoEPI(e, id) {
            e.preventDefault();
            
            const epi = estoque.find(e => e.id === id);
            if (!epi) return;
            
            const novoCA = document.getElementById('edit-ca').value;
            
            // Verificar se CA j√° existe em outro EPI
            const caExistente = estoque.find(e => e.ca === novoCA && e.id !== id);
            if (caExistente) {
                showNotification('Este CA j√° est√° cadastrado em outro EPI!', 'error');
                return;
            }
            
            // Atualizar dados
            epi.descricao = document.getElementById('edit-descricao').value;
            epi.ca = novoCA;
            epi.validade = document.getElementById('edit-validade').value || null;
            epi.estoqueMinimo = parseInt(document.getElementById('edit-minimo').value) || 0;
            epi.unidade = document.getElementById('edit-unidade').value;
            epi.quantidade = parseInt(document.getElementById('edit-quantidade').value) || 0;
            
            if (saveEstoque()) {
                showNotification('EPI atualizado com sucesso!', 'success');
                updateEstoqueUI();
                document.getElementById('modal-historico').classList.remove('show');
            }
        }
        
        function excluirEPIEstoque(id) {
            const epi = estoque.find(e => e.id === id);
            if (!epi) return;
            
            if (!confirm(`‚ö†Ô∏è Excluir "${epi.descricao}" do estoque?\n\nTodo o hist√≥rico ser√° perdido.`)) return;
            if (!confirm('üî¥ Tem certeza? Esta a√ß√£o n√£o pode ser desfeita!')) return;
            
            estoque = estoque.filter(e => e.id !== id);
            
            if (saveEstoque()) {
                showNotification('EPI exclu√≠do do estoque', 'success');
                updateEstoqueUI();
            }
        }
        
        function verHistoricoEstoque(id) {
            const epi = estoque.find(e => e.id === id);
            if (!epi) return;
            
            document.getElementById('modal-titulo').textContent = `Hist√≥rico: ${epi.descricao}`;
            
            const historico = epi.historico || [];
            
            document.getElementById('modal-content').innerHTML = `
                <div style="background:#0f172a;padding:1rem;border-radius:8px;margin-bottom:1.5rem;">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;text-align:center;">
                        <div>
                            <div style="font-size:1.5rem;font-weight:700;color:#2563eb;">${epi.quantidade}</div>
                            <div style="font-size:0.75rem;color:#64748b;">ATUAL</div>
                        </div>
                        <div>
                            <div style="font-size:1.5rem;font-weight:700;color:#10b981;">${epi.estoqueMinimo}</div>
                            <div style="font-size:0.75rem;color:#64748b;">M√çNIMO</div>
                        </div>
                        <div>
                            <div style="font-size:1.5rem;font-weight:700;color:#3b82f6;">CA ${epi.ca}</div>
                            <div style="font-size:0.75rem;color:#64748b;">CERTIFICADO</div>
                        </div>
                    </div>
                </div>
                
                <h4 style="color:#2563eb;margin-bottom:1rem;">Movimenta√ß√µes</h4>
                
                <div style="max-height:350px;overflow-y:auto;">
                    ${historico.length === 0 ? '<p style="color:#64748b;text-align:center;">Nenhuma movimenta√ß√£o registrada</p>' : 
                    historico.slice().reverse().map(h => {
                        const data = new Date(h.data);
                        let icon = 'üì¶';
                        let cor = '#64748b';
                        
                        if (h.tipo === 'entrada') { icon = 'üì•'; cor = '#10b981'; }
                        else if (h.tipo === 'saida') { icon = 'üì§'; cor = '#ef4444'; }
                        else if (h.tipo === 'inicial') { icon = 'üÜï'; cor = '#3b82f6'; }
                        
                        return `
                            <div style="background:#0f172a;padding:1rem;border-radius:8px;margin-bottom:0.5rem;border-left:3px solid ${cor};">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                                    <span style="font-weight:600;color:${cor};">${icon} ${h.tipo.toUpperCase()}</span>
                                    <span style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700;color:${cor};">
                                        ${h.tipo === 'saida' ? '-' : '+'}${h.quantidade} ${epi.unidade}
                                    </span>
                                </div>
                                <div style="font-size:0.8rem;color:#64748b;">
                                    ${data.toLocaleDateString('pt-BR')} √†s ${data.toLocaleTimeString('pt-BR')}
                                    ${h.obs ? ` ‚Ä¢ ${h.obs}` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="display:flex;gap:0.5rem;margin-top:1.5rem;">
                    <button class="btn-success" onclick="movimentarEstoque('${id}', 'entrada');verHistoricoEstoque('${id}');" style="flex:1;">
                        üì• Nova Entrada
                    </button>
                    <button class="btn-primary" onclick="movimentarEstoque('${id}', 'saida');verHistoricoEstoque('${id}');" style="flex:1;background:linear-gradient(135deg,#2563eb,#1d4ed8);">
                        üì§ Nova Sa√≠da
                    </button>
                </div>
            `;
            
            document.getElementById('modal-historico').classList.add('show');
        }
        
        // Fun√ß√£o para baixar estoque automaticamente ao registrar entrega
        function baixarEstoqueEntrega(ca, quantidade) {
            const epi = estoque.find(e => e.ca === ca);
            if (!epi) return;
            
            if (epi.quantidade >= quantidade) {
                epi.quantidade -= quantidade;
                epi.historico.push({
                    tipo: 'saida',
                    quantidade: quantidade,
                    data: new Date().toISOString(),
                    obs: 'Baixa autom√°tica - Entrega de EPI'
                });
                saveEstoque();
                updateEstoqueUI();
            }
        }
        
        // Buscar EPI do estoque para autocomplete
        function buscarEPIEstoque(termo) {
            const lista = document.getElementById('autocomplete-epi');
            const dica = document.getElementById('dica-estoque');
            
            if (estoque.length === 0) {
                lista.classList.add('hidden');
                dica.innerHTML = 'üí° Cadastre EPIs na aba <strong>Estoque</strong> para selecionar automaticamente';
                return;
            }
            
            dica.innerHTML = '';
            
            if (termo.length < 1) {
                lista.classList.add('hidden');
                return;
            }
            
            const matches = estoque.filter(e => 
                e.descricao.toLowerCase().includes(termo.toLowerCase()) || 
                e.ca.includes(termo)
            );
            
            if (matches.length === 0) {
                lista.innerHTML = `
                    <div style="padding:1rem;text-align:center;color:#64748b;">
                        <p>Nenhum EPI encontrado no estoque</p>
                        <button type="button" onclick="showTab('estoque')" style="margin-top:0.5rem;background:#2563eb;color:#1e3a5f;border:none;padding:0.5rem 1rem;border-radius:6px;cursor:pointer;font-weight:600;">
                            + Cadastrar no Estoque
                        </button>
                    </div>
                `;
                lista.classList.remove('hidden');
                return;
            }
            
            renderizarListaEPIs(matches);
        }
        
        function mostrarEPIsEstoque() {
            if (estoque.length > 0 && document.getElementById('descricaoEPI').value === '') {
                mostrarTodosEPIs();
            }
        }
        
        function mostrarTodosEPIs() {
            const lista = document.getElementById('autocomplete-epi');
            
            if (estoque.length === 0) {
                lista.innerHTML = `
                    <div style="padding:1.5rem;text-align:center;color:#64748b;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 0.75rem;">
                            <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                        </svg>
                        <p style="margin-bottom:0.75rem;">Nenhum EPI cadastrado no estoque</p>
                        <button type="button" onclick="showTab('estoque');document.getElementById('autocomplete-epi').classList.add('hidden');" style="background:#2563eb;color:#1e3a5f;border:none;padding:0.5rem 1rem;border-radius:6px;cursor:pointer;font-weight:600;">
                            üì¶ Ir para Estoque
                        </button>
                    </div>
                `;
                lista.classList.remove('hidden');
                return;
            }
            
            renderizarListaEPIs(estoque);
        }
        
        function renderizarListaEPIs(itens) {
            const lista = document.getElementById('autocomplete-epi');
            
            lista.innerHTML = `
                <div style="padding:0.5rem 1rem;background:#1e3a5f;border-bottom:1px solid #2d4a6f;font-size:0.75rem;color:#94a3b8;font-weight:600;">
                    üì¶ SELECIONE DO ESTOQUE (${itens.length} ${itens.length === 1 ? 'item' : 'itens'})
                </div>
                ${itens.map(e => {
                    let status = 'ok';
                    let statusText = 'Dispon√≠vel';
                    let statusColor = '#10b981';
                    
                    if (e.quantidade === 0) { 
                        status = 'zerado'; 
                        statusText = 'ZERADO';
                        statusColor = '#64748b';
                    } else if (e.quantidade < e.estoqueMinimo) { 
                        status = 'baixo'; 
                        statusText = 'Estoque baixo';
                        statusColor = '#ef4444';
                    }
                    
                    return `
                        <div class="autocomplete-item" onclick="selecionarEPIEstoque('${e.id}')" style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;border-left:3px solid ${statusColor};">
                            <div style="flex:1;">
                                <div style="font-weight:600;color:#e2e8f0;margin-bottom:0.25rem;">${e.descricao}</div>
                                <div style="font-size:0.8rem;color:#64748b;">
                                    <span style="background:#2d4a6f;padding:0.15rem 0.5rem;border-radius:4px;margin-right:0.5rem;">CA ${e.ca}</span>
                                    ${e.unidade}
                                </div>
                            </div>
                            <div style="text-align:right;min-width:80px;">
                                <div style="font-size:1.2rem;font-weight:700;color:${statusColor};">${e.quantidade}</div>
                                <div style="font-size:0.7rem;color:${statusColor};">${statusText}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
                <div style="padding:0.75rem 1rem;background:#1e3a5f;border-top:1px solid #2d4a6f;text-align:center;">
                    <button type="button" onclick="showTab('estoque');document.getElementById('autocomplete-epi').classList.add('hidden');" style="background:transparent;color:#2563eb;border:1px solid #2563eb;padding:0.4rem 0.75rem;border-radius:6px;cursor:pointer;font-size:0.8rem;font-weight:600;">
                        + Cadastrar Novo EPI
                    </button>
                </div>
            `;
            lista.classList.remove('hidden');
        }
        
        function selecionarEPIEstoque(id) {
            const epi = estoque.find(e => e.id === id);
            if (!epi) return;
            
            document.getElementById('descricaoEPI').value = epi.descricao;
            document.getElementById('numeroCA').value = epi.ca;
            document.getElementById('autocomplete-epi').classList.add('hidden');
            document.getElementById('dica-estoque').innerHTML = '';
            
            // Mostrar estoque dispon√≠vel
            const info = document.getElementById('estoque-disponivel');
            if (epi.quantidade === 0) {
                info.innerHTML = `<span style="color:#ef4444;">‚ö†Ô∏è ESTOQUE ZERADO - N√£o h√° unidades dispon√≠veis</span>`;
            } else if (epi.quantidade < epi.estoqueMinimo) {
                info.innerHTML = `<span style="color:#2563eb;">‚ö†Ô∏è Estoque baixo: ${epi.quantidade} ${epi.unidade} (m√≠n: ${epi.estoqueMinimo})</span>`;
            } else {
                info.innerHTML = `<span style="color:#10b981;">‚úì Dispon√≠vel: ${epi.quantidade} ${epi.unidade}</span>`;
            }
        }
        
        function saveConfig() {
            config.empresa = document.getElementById('config-empresa').value;
            config.rodape = document.getElementById('config-rodape').value;
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            showNotification('Salvo!', 'success');
        }
        
        function updateUI() {
            document.getElementById('stats-count').textContent = entregas.length;
            const funcionarios = new Set(entregas.map(e => e.cpf)).size;
            document.getElementById('stats-bio').textContent = funcionarios;
            updateFuncionariosList();
            updateEmpresaFilter();
        }
        
        function showTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            document.getElementById('tab-cadastro').classList.toggle('hidden', tab !== 'cadastro');
            document.getElementById('tab-devolucao').classList.toggle('hidden', tab !== 'devolucao');
            document.getElementById('tab-estoque').classList.toggle('hidden', tab !== 'estoque');
            document.getElementById('tab-funcionarios').classList.toggle('hidden', tab !== 'funcionarios');
            document.getElementById('tab-empresas').classList.toggle('hidden', tab !== 'empresas');
            document.getElementById('tab-config').classList.toggle('hidden', tab !== 'config');
            
            if (tab !== 'cadastro') stopCamera();
            if (tab === 'funcionarios') updateFuncionariosList();
            if (tab === 'estoque') updateEstoqueUI();
            if (tab === 'devolucao') {
                initSignatureDevolucao();
                document.getElementById('dev-data').value = new Date().toISOString().split('T')[0];
            }
            if (tab === 'config') {
                loadUsersList();
            }
            if (tab === 'empresas') {
                updateEmpresasUI();
            }
        }
        
        // ==================== GERENCIAMENTO DE USU√ÅRIOS ====================
        
        function loadUsersList() {
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            const container = document.getElementById('users-list');
            const select = document.getElementById('user-select');
            
            if (!container || !select) return;
            
            // Lista de usu√°rios
            container.innerHTML = users.map(u => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;background:#1e3a5f;border-radius:8px;margin-bottom:0.5rem;">
                    <div>
                        <span style="font-weight:600;color:#e2e8f0;">${u.name}</span>
                        <span style="color:#64748b;font-size:0.85rem;margin-left:0.5rem;">@${u.username}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <span style="background:${u.role === 'dev' ? '#10b981' : '#2563eb'};color:#fff;padding:0.2rem 0.6rem;border-radius:4px;font-size:0.7rem;font-weight:600;">
                            ${u.role === 'dev' ? 'DEV' : 'USER'}
                        </span>
                        ${u.username !== 'admin' ? `
                            <button onclick="deleteUser('${u.username}')" style="background:#ef4444;color:#fff;border:none;padding:0.3rem 0.5rem;border-radius:4px;cursor:pointer;font-size:0.75rem;" title="Remover usu√°rio">‚úï</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            // Select de usu√°rios para altera√ß√£o de senha
            select.innerHTML = '<option value="">Selecione o usu√°rio</option>' + 
                users.map(u => `<option value="${u.username}">${u.name} (@${u.username})</option>`).join('');
        }
        
        function changeUserPassword() {
            const username = document.getElementById('user-select').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            
            if (!username) {
                showNotification('Selecione um usu√°rio', 'error');
                return;
            }
            
            if (newPass.length < 6) {
                showNotification('A senha deve ter no m√≠nimo 6 caracteres', 'error');
                return;
            }
            
            if (newPass !== confirmPass) {
                showNotification('As senhas n√£o conferem', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            const userIndex = users.findIndex(u => u.username === username);
            
            if (userIndex === -1) {
                showNotification('Usu√°rio n√£o encontrado', 'error');
                return;
            }
            
            users[userIndex].password = newPass;
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
            
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('user-select').value = '';
            
            showNotification(`Senha de ${users[userIndex].name} alterada com sucesso!`, 'success');
        }
        
        function addNewUser() {
            const name = document.getElementById('new-user-name').value.trim();
            const username = document.getElementById('new-user-username').value.trim().toLowerCase();
            const password = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;
            
            if (!name || !username || !password) {
                showNotification('Preencha todos os campos', 'error');
                return;
            }
            
            if (username.length < 3) {
                showNotification('Nome de usu√°rio deve ter no m√≠nimo 3 caracteres', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('A senha deve ter no m√≠nimo 6 caracteres', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            
            if (users.find(u => u.username === username)) {
                showNotification('Nome de usu√°rio j√° existe', 'error');
                return;
            }
            
            users.push({
                username,
                password,
                role,
                name,
                permissions: role === 'dev' ? ['all'] : ['cadastro', 'consulta', 'devolucao']
            });
            
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
            
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-username').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-role').value = 'user';
            
            loadUsersList();
            showNotification(`Usu√°rio ${name} criado com sucesso!`, 'success');
        }
        
        function deleteUser(username) {
            if (username === 'admin') {
                showNotification('N√£o √© poss√≠vel remover o usu√°rio admin', 'error');
                return;
            }
            
            if (!confirm(`Deseja realmente remover o usu√°rio @${username}?`)) return;
            
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            const newUsers = users.filter(u => u.username !== username);
            localStorage.setItem(USERS_KEY, JSON.stringify(newUsers));
            
            loadUsersList();
            showNotification('Usu√°rio removido', 'success');
        }
        
        // ==================== GERENCIAMENTO DE EMPRESAS ====================
        
        let empresaLogoTemp = null;
        
        function loadEmpresas() {
            try {
                const data = localStorage.getItem(EMPRESAS_KEY);
                empresas = data ? JSON.parse(data) : [];
            } catch(e) {
                empresas = [];
            }
        }
        
        function saveEmpresas() {
            localStorage.setItem(EMPRESAS_KEY, JSON.stringify(empresas));
            atualizarSelectsEmpresa();
        }
        
        function atualizarSelectsEmpresa() {
            // Atualizar todos os selects de empresa
            const selects = [
                document.getElementById('empresa-ativa-select'),
                document.getElementById('empresa') // No form de entrega, se existir como select
            ];
            
            const selectAtiva = document.getElementById('empresa-ativa-select');
            if (selectAtiva) {
                const valorAtual = selectAtiva.value;
                selectAtiva.innerHTML = '<option value="">Todas as empresas</option>' + 
                    empresas.map(e => `<option value="${e.cnpj}" ${e.cnpj === valorAtual ? 'selected' : ''}>${e.fantasia || e.razao}</option>`).join('');
            }
        }
        
        function updateEmpresasUI() {
            loadEmpresas();
            
            // Atualizar contadores
            document.getElementById('total-empresas').textContent = empresas.length;
            document.getElementById('total-entregas-empresas').textContent = entregas.length;
            
            // Atualizar select
            atualizarSelectsEmpresa();
            
            // Atualizar lista
            const lista = document.getElementById('empresas-lista');
            if (!lista) return;
            
            if (empresas.length === 0) {
                lista.innerHTML = '<p style="text-align:center;color:#64748b;padding:2rem;">Nenhuma empresa cadastrada</p>';
                return;
            }
            
            lista.innerHTML = empresas.map(emp => {
                const entregasEmp = entregas.filter(e => e.cnpj === emp.cnpj);
                const funcionariosEmp = [...new Set(entregasEmp.map(e => e.cpf))].length;
                const paleta = PALETAS_CORES[emp.paleta] || PALETAS_CORES.azul;
                
                return `
                    <div style="background:#1e3a5f;border-radius:12px;padding:1.25rem;margin-bottom:1rem;border-left:4px solid rgb(${paleta.secundaria.join(',')});">
                        <div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:1rem;">
                            <div style="display:flex;gap:1rem;align-items:center;">
                                ${emp.logo ? `<img src="${emp.logo}" style="width:60px;height:60px;object-fit:contain;background:#fff;border-radius:8px;padding:5px;">` : 
                                `<div style="width:60px;height:60px;background:rgb(${paleta.secundaria.join(',')});border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;">üè¢</div>`}
                                <div>
                                    <h4 style="color:#e2e8f0;font-size:1.1rem;margin-bottom:0.25rem;">${emp.razao}</h4>
                                    ${emp.fantasia ? `<p style="color:#94a3b8;font-size:0.85rem;">${emp.fantasia}</p>` : ''}
                                    <p style="color:#64748b;font-size:0.8rem;font-family:'JetBrains Mono',monospace;">${emp.cnpj}</p>
                                </div>
                            </div>
                            <div style="display:flex;gap:1rem;text-align:center;">
                                <div style="background:#0f172a;padding:0.75rem 1rem;border-radius:8px;">
                                    <div style="font-size:1.25rem;font-weight:700;color:#2563eb;">${entregasEmp.length}</div>
                                    <div style="font-size:0.7rem;color:#64748b;">Entregas</div>
                                </div>
                                <div style="background:#0f172a;padding:0.75rem 1rem;border-radius:8px;">
                                    <div style="font-size:1.25rem;font-weight:700;color:#10b981;">${funcionariosEmp}</div>
                                    <div style="font-size:0.7rem;color:#64748b;">Funcion√°rios</div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap;align-items:center;">
                            <span style="background:rgb(${paleta.secundaria.join(',')});color:#fff;padding:0.25rem 0.75rem;border-radius:50px;font-size:0.75rem;">
                                üé® ${paleta.nome}
                            </span>
                            ${emp.telefone ? `<span style="color:#64748b;font-size:0.8rem;">üìû ${emp.telefone}</span>` : ''}
                            <div style="flex:1;"></div>
                            <button class="btn-secondary" onclick="editarEmpresa('${emp.cnpj}')" style="padding:0.4rem 0.75rem;font-size:0.8rem;">‚úèÔ∏è Editar</button>
                            <button class="btn-danger" onclick="excluirEmpresa('${emp.cnpj}')" style="padding:0.4rem 0.75rem;font-size:0.8rem;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function previewPaleta() {
            const paleta = document.getElementById('emp-paleta').value;
            const cores = PALETAS_CORES[paleta];
            if (!cores) return;
            
            document.getElementById('cor-primaria').style.background = `rgb(${cores.primaria.join(',')})`;
            document.getElementById('cor-secundaria').style.background = `rgb(${cores.secundaria.join(',')})`;
            document.getElementById('cor-accent').style.background = `rgb(${cores.accent.join(',')})`;
        }
        
        function handleEmpresaLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const max = 300;
                    if (w > max || h > max) {
                        if (w > h) { h = (h / w) * max; w = max; }
                        else { w = (w / h) * max; h = max; }
                    }
                    canvas.width = w;
                    canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    empresaLogoTemp = canvas.toDataURL('image/png', 0.9);
                    document.getElementById('emp-logo-preview').src = empresaLogoTemp;
                    document.getElementById('emp-logo-preview').style.display = 'block';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function cadastrarEmpresa() {
            const razao = document.getElementById('emp-razao').value.trim();
            const fantasia = document.getElementById('emp-fantasia').value.trim();
            const cnpj = document.getElementById('emp-cnpj').value.trim();
            const telefone = document.getElementById('emp-telefone').value.trim();
            const endereco = document.getElementById('emp-endereco').value.trim();
            const paleta = document.getElementById('emp-paleta').value;
            
            if (!razao || !cnpj) {
                showNotification('Preencha Raz√£o Social e CNPJ', 'error');
                return;
            }
            
            if (cnpj.replace(/\D/g, '').length !== 14) {
                showNotification('CNPJ inv√°lido', 'error');
                return;
            }
            
            // Verificar duplicidade
            if (empresas.find(e => e.cnpj === cnpj)) {
                showNotification('CNPJ j√° cadastrado', 'error');
                return;
            }
            
            const novaEmpresa = {
                id: Date.now().toString(),
                razao,
                fantasia,
                cnpj,
                telefone,
                endereco,
                paleta,
                logo: empresaLogoTemp,
                dataCadastro: new Date().toISOString()
            };
            
            empresas.push(novaEmpresa);
            saveEmpresas();
            
            // Limpar formul√°rio
            document.getElementById('emp-razao').value = '';
            document.getElementById('emp-fantasia').value = '';
            document.getElementById('emp-cnpj').value = '';
            document.getElementById('emp-telefone').value = '';
            document.getElementById('emp-endereco').value = '';
            document.getElementById('emp-paleta').value = 'azul';
            document.getElementById('emp-logo-preview').style.display = 'none';
            empresaLogoTemp = null;
            previewPaleta();
            
            updateEmpresasUI();
            showNotification('Empresa cadastrada com sucesso!', 'success');
        }
        
        function editarEmpresa(cnpj) {
            const emp = empresas.find(e => e.cnpj === cnpj);
            if (!emp) return;
            
            const novaPaleta = prompt(`Paleta atual: ${PALETAS_CORES[emp.paleta]?.nome || 'Azul'}\n\nDigite a nova paleta:\nazul, verde, vermelho, laranja, roxo, cinza`, emp.paleta);
            
            if (novaPaleta && PALETAS_CORES[novaPaleta]) {
                emp.paleta = novaPaleta;
                saveEmpresas();
                updateEmpresasUI();
                showNotification('Paleta atualizada!', 'success');
            } else if (novaPaleta) {
                showNotification('Paleta inv√°lida', 'error');
            }
        }
        
        function excluirEmpresa(cnpj) {
            const emp = empresas.find(e => e.cnpj === cnpj);
            if (!emp) return;
            
            const entregasEmp = entregas.filter(e => e.cnpj === cnpj).length;
            
            if (!confirm(`Excluir empresa "${emp.razao}"?\n\n‚ö†Ô∏è Esta empresa tem ${entregasEmp} entregas registradas.\nAs entregas N√ÉO ser√£o exclu√≠das.`)) return;
            
            empresas = empresas.filter(e => e.cnpj !== cnpj);
            saveEmpresas();
            updateEmpresasUI();
            showNotification('Empresa removida', 'success');
        }
        
        function selecionarEmpresaAtiva() {
            const cnpj = document.getElementById('empresa-ativa-select').value;
            empresaAtual = cnpj ? empresas.find(e => e.cnpj === cnpj) : null;
            updateUI();
            updateFuncionariosList();
        }
        
        function getEmpresaPorCNPJ(cnpj) {
            return empresas.find(e => e.cnpj === cnpj);
        }
        
        function getCoresEmpresa(cnpj) {
            const emp = getEmpresaPorCNPJ(cnpj);
            const paleta = emp?.paleta || 'azul';
            return PALETAS_CORES[paleta] || PALETAS_CORES.azul;
        }
        
        // ==================== SINCRONIZA√á√ÉO ====================
        
        function exportarSincronizacao() {
            const dataExport = {
                versao: '5.0',
                tipo: 'sincronizacao_completa',
                dataExportacao: new Date().toISOString(),
                dados: {
                    entregas: entregas,
                    estoque: estoque,
                    empresas: empresas,
                    config: config,
                    usuarios: JSON.parse(localStorage.getItem(USERS_KEY) || '[]')
                }
            };
            
            const blob = new Blob([JSON.stringify(dataExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const dataStr = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `rc_epi_sync_${dataStr}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Arquivo de sincroniza√ß√£o exportado!', 'success');
        }
        
        function importarSincronizacao(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.dados) {
                        throw new Error('Formato inv√°lido');
                    }
                    
                    const info = `üì¶ SINCRONIZA√á√ÉO\n\nArquivo: ${file.name}\nData: ${data.dataExportacao ? new Date(data.dataExportacao).toLocaleString('pt-BR') : 'N/A'}\n\nConte√∫do:\n- Entregas: ${data.dados.entregas?.length || 0}\n- Estoque: ${data.dados.estoque?.length || 0}\n- Empresas: ${data.dados.empresas?.length || 0}\n- Usu√°rios: ${data.dados.usuarios?.length || 0}\n\n‚ö†Ô∏è Isso IR√Å SUBSTITUIR todos os dados atuais!\nDeseja continuar?`;
                    
                    if (!confirm(info)) {
                        showNotification('Sincroniza√ß√£o cancelada', 'error');
                        return;
                    }
                    
                    if (!confirm('‚ö†Ô∏è √öLTIMA CONFIRMA√á√ÉO\n\nTem certeza? Esta a√ß√£o n√£o pode ser desfeita!')) {
                        showNotification('Sincroniza√ß√£o cancelada', 'error');
                        return;
                    }
                    
                    // Importar dados
                    if (data.dados.entregas) {
                        entregas = data.dados.entregas;
                        saveData();
                    }
                    
                    if (data.dados.estoque) {
                        estoque = data.dados.estoque;
                        saveEstoque();
                    }
                    
                    if (data.dados.empresas) {
                        empresas = data.dados.empresas;
                        saveEmpresas();
                    }
                    
                    if (data.dados.config) {
                        config = data.dados.config;
                        localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
                        loadConfig();
                    }
                    
                    if (data.dados.usuarios && data.dados.usuarios.length > 0) {
                        // Mesclar usu√°rios mantendo admin local
                        const usuariosAtuais = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
                        const adminLocal = usuariosAtuais.find(u => u.username === 'admin');
                        const usuariosImportados = data.dados.usuarios.filter(u => u.username !== 'admin');
                        
                        const usuariosMesclados = adminLocal ? [adminLocal, ...usuariosImportados] : data.dados.usuarios;
                        localStorage.setItem(USERS_KEY, JSON.stringify(usuariosMesclados));
                    }
                    
                    updateUI();
                    updateEmpresasUI();
                    updateEstoqueUI();
                    
                    showNotification('Sincroniza√ß√£o conclu√≠da com sucesso!', 'success');
                    
                } catch(err) {
                    console.error('Erro na sincroniza√ß√£o:', err);
                    showNotification('Arquivo de sincroniza√ß√£o inv√°lido', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // ==================== FORMATA√á√ÉO ====================
        function formatCPF(input) {
            let v = input.value.replace(/\D/g, '').slice(0, 11);
            v = v.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            input.value = v;
        }
        
        function formatCNPJ(input) {
            let v = input.value.replace(/\D/g, '').slice(0, 14);
            v = v.replace(/^(\d{2})(\d)/, '$1.$2').replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3').replace(/\.(\d{3})(\d)/, '.$1/$2').replace(/(\d{4})(\d)/, '$1-$2');
            input.value = v;
        }
        
        // ==================== BUSCA DE EMPRESA ====================
        
        function buscarEmpresa(texto) {
            const lista = document.getElementById('autocomplete-empresa');
            if (!lista) return;
            
            if (texto.length < 2) {
                lista.classList.add('hidden');
                return;
            }
            
            const textoLower = texto.toLowerCase();
            const matches = empresas.filter(e => 
                e.razao.toLowerCase().includes(textoLower) ||
                (e.fantasia && e.fantasia.toLowerCase().includes(textoLower)) ||
                e.cnpj.includes(texto)
            );
            
            if (matches.length === 0) {
                lista.classList.add('hidden');
                return;
            }
            
            lista.innerHTML = matches.map(e => `
                <div class="autocomplete-item" onclick="selecionarEmpresa('${e.cnpj}')">
                    <strong>${e.fantasia || e.razao}</strong>
                    <small style="color:#64748b;display:block;">${e.cnpj}</small>
                </div>
            `).join('');
            lista.classList.remove('hidden');
        }
        
        function mostrarEmpresas() {
            const lista = document.getElementById('autocomplete-empresa');
            if (!lista || empresas.length === 0) return;
            
            lista.innerHTML = empresas.slice(0, 10).map(e => `
                <div class="autocomplete-item" onclick="selecionarEmpresa('${e.cnpj}')">
                    <strong>${e.fantasia || e.razao}</strong>
                    <small style="color:#64748b;display:block;">${e.cnpj}</small>
                </div>
            `).join('');
            lista.classList.remove('hidden');
        }
        
        function selecionarEmpresa(cnpj) {
            const emp = empresas.find(e => e.cnpj === cnpj);
            if (!emp) return;
            
            document.getElementById('empresa').value = emp.fantasia || emp.razao;
            document.getElementById('cnpj').value = emp.cnpj;
            document.getElementById('autocomplete-empresa').classList.add('hidden');
        }
        
        // Fechar autocomplete de empresa ao clicar fora
        document.addEventListener('click', function(e) {
            const lista = document.getElementById('autocomplete-empresa');
            if (lista && !e.target.closest('#empresa') && !e.target.closest('#autocomplete-empresa')) {
                lista.classList.add('hidden');
            }
        });
        
        // ====================
        function searchFuncionario(cpf) {
            const clean = cpf.replace(/\D/g, '');
            const list = document.getElementById('autocomplete-list');
            
            if (clean.length < 3) {
                list.classList.add('hidden');
                resetPhotoSection();
                return;
            }
            
            const funcionarios = {};
            entregas.forEach(e => {
                if (!funcionarios[e.cpf]) funcionarios[e.cpf] = e;
            });
            
            const matches = Object.values(funcionarios).filter(f => 
                f.cpf.replace(/\D/g, '').includes(clean) || f.trabalhador.toLowerCase().includes(cpf.toLowerCase())
            );
            
            if (matches.length === 0) {
                list.classList.add('hidden');
                resetPhotoSection();
                return;
            }
            
            list.innerHTML = matches.slice(0, 5).map(f => `
                <div class="autocomplete-item" onclick="selectFuncionario('${f.cpf}')">
                    ${f.fotoFacial ? `<img src="${f.fotoFacial}" alt="">` : '<div style="width:40px;height:50px;background:#2d4a6f;border-radius:6px;"></div>'}
                    <div>
                        <div style="font-weight:500;color:#e2e8f0;">${f.trabalhador}</div>
                        <div style="font-size:0.85rem;color:#64748b;">${f.cpf}</div>
                    </div>
                </div>
            `).join('');
            
            list.classList.remove('hidden');
        }
        
        function selectFuncionario(cpf) {
            const f = entregas.find(e => e.cpf === cpf);
            if (f) {
                document.getElementById('cpf').value = f.cpf;
                document.getElementById('trabalhador').value = f.trabalhador;
                document.getElementById('empresa').value = f.empresa;
                document.getElementById('cnpj').value = f.cnpj;
                document.getElementById('funcao').value = f.funcao || '';
                document.getElementById('setor').value = f.setor || '';
                
                if (f.fotoFacial) {
                    currentFuncionarioPhoto = f.fotoFacial;
                    capturedPhotoData = f.fotoFacial;
                    document.getElementById('captured-photo').src = f.fotoFacial;
                    document.getElementById('photo-options').classList.add('hidden');
                    document.getElementById('photo-preview-area').classList.remove('hidden');
                    document.getElementById('biometria-section').classList.add('success');
                }
            }
            document.getElementById('autocomplete-list').classList.add('hidden');
        }
        
        function resetPhotoSection() {
            currentFuncionarioPhoto = null;
            capturedPhotoData = null;
            document.getElementById('photo-options').classList.remove('hidden');
            document.getElementById('camera-area').classList.add('hidden');
            document.getElementById('photo-preview-area').classList.add('hidden');
            document.getElementById('biometria-section').className = 'biometria-section';
        }
        
        async function startCamera() {
            document.getElementById('photo-options').classList.add('hidden');
            document.getElementById('camera-area').classList.remove('hidden');
            document.getElementById('camera-error').classList.add('hidden');
            document.getElementById('btn-capture').classList.remove('hidden');
            
            const video = document.getElementById('camera-video');
            
            // Verificar se API est√° dispon√≠vel
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                mostrarErroCameraNova('Seu navegador n√£o suporta acesso √† c√¢mera. Use a op√ß√£o "Carregar Foto".');
                return;
            }
            
            try {
                // Parar stream anterior se existir
                stopCamera();
                
                // Tentar diferentes configura√ß√µes de c√¢mera
                const configuracoes = [
                    // Configura√ß√£o 1: C√¢mera frontal (celular)
                    { video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } } },
                    // Configura√ß√£o 2: C√¢mera traseira (celular)
                    { video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } } },
                    // Configura√ß√£o 3: Qualquer c√¢mera dispon√≠vel
                    { video: true },
                    // Configura√ß√£o 4: M√≠nima
                    { video: { width: 320, height: 240 } }
                ];
                
                let streamObtido = null;
                let erroFinal = null;
                
                for (const config of configuracoes) {
                    try {
                        streamObtido = await navigator.mediaDevices.getUserMedia(config);
                        break; // Sucesso, sair do loop
                    } catch (err) {
                        erroFinal = err;
                        console.log('Tentativa falhou:', config, err.name);
                    }
                }
                
                if (!streamObtido) {
                    throw erroFinal || new Error('N√£o foi poss√≠vel acessar a c√¢mera');
                }
                
                videoStream = streamObtido;
                video.srcObject = videoStream;
                
                // Aguardar v√≠deo carregar
                video.onloadedmetadata = function() {
                    video.play().catch(e => console.log('Autoplay bloqueado:', e));
                };
                
                showNotification('C√¢mera ativada!', 'success');
                
            } catch (error) {
                console.error('Erro c√¢mera:', error);
                
                let mensagem = 'Erro ao acessar a c√¢mera.';
                
                switch (error.name) {
                    case 'NotAllowedError':
                    case 'PermissionDeniedError':
                        mensagem = 'Permiss√£o negada. Clique no √≠cone de c√¢mera/cadeado na barra de endere√ßo e permita o acesso.';
                        break;
                    case 'NotFoundError':
                    case 'DevicesNotFoundError':
                        mensagem = 'Nenhuma c√¢mera encontrada no dispositivo.';
                        break;
                    case 'NotReadableError':
                    case 'TrackStartError':
                        mensagem = 'A c√¢mera est√° sendo usada por outro aplicativo. Feche outros apps e tente novamente.';
                        break;
                    case 'OverconstrainedError':
                        mensagem = 'Configura√ß√£o de c√¢mera n√£o suportada.';
                        break;
                    case 'NotSupportedError':
                        mensagem = 'C√¢mera n√£o suportada neste navegador.';
                        break;
                    case 'TypeError':
                        mensagem = 'Erro de configura√ß√£o da c√¢mera.';
                        break;
                    default:
                        if (location.protocol === 'file:') {
                            mensagem = 'Arquivos abertos localmente (file://) t√™m restri√ß√µes de c√¢mera em alguns navegadores.';
                        } else {
                            mensagem = error.message || 'Erro desconhecido ao acessar a c√¢mera.';
                        }
                }
                
                mostrarErroCameraNova(mensagem);
            }
        }
        
        function mostrarErroCameraNova(mensagem) {
            document.getElementById('camera-error-text').textContent = mensagem;
            document.getElementById('camera-error').classList.remove('hidden');
            document.getElementById('btn-capture').classList.add('hidden');
        }
        
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            const video = document.getElementById('camera-video');
            if (video) {
                video.srcObject = null;
            }
        }
        
        function capturePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const ctx = canvas.getContext('2d');
            
            // Verificar se v√≠deo est√° tocando
            if (video.readyState < 2) {
                showNotification('Aguarde a c√¢mera carregar...', 'error');
                return;
            }
            
            // Usar dimens√µes reais do v√≠deo
            const width = video.videoWidth || 640;
            const height = video.videoHeight || 480;
            
            canvas.width = width;
            canvas.height = height;
            
            // Espelhar imagem (c√¢mera frontal)
            ctx.translate(width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, width, height);
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            
            capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            
            stopCamera();
            
            document.getElementById('captured-photo').src = capturedPhotoData;
            document.getElementById('camera-area').classList.add('hidden');
            document.getElementById('photo-preview-area').classList.remove('hidden');
            document.getElementById('biometria-section').classList.add('success');
            
            showNotification('Foto capturada!', 'success');
        }
        
        function cancelCamera() {
            stopCamera();
            document.getElementById('camera-area').classList.add('hidden');
            document.getElementById('photo-options').classList.remove('hidden');
        }
        
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Verificar se √© imagem
            if (!file.type.startsWith('image/')) {
                showNotification('Selecione um arquivo de imagem', 'error');
                return;
            }
            
            // Verificar tamanho (m√°x 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('Arquivo muito grande (m√°x 10MB)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    
                    // Limitar tamanho m√°ximo mantendo propor√ß√£o
                    const maxSize = 800;
                    if (w > maxSize || h > maxSize) {
                        if (w > h) { 
                            h = Math.round((h / w) * maxSize); 
                            w = maxSize; 
                        } else { 
                            w = Math.round((w / h) * maxSize); 
                            h = maxSize; 
                        }
                    }
                    
                    canvas.width = w;
                    canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    
                    capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('captured-photo').src = capturedPhotoData;
                    document.getElementById('photo-options').classList.add('hidden');
                    document.getElementById('camera-area').classList.add('hidden');
                    document.getElementById('photo-preview-area').classList.remove('hidden');
                    document.getElementById('biometria-section').classList.add('success');
                    
                    showNotification('Foto carregada!', 'success');
                };
                img.onerror = function() {
                    showNotification('Erro ao carregar imagem', 'error');
                };
                img.src = e.target.result;
            };
            reader.onerror = function() {
                showNotification('Erro ao ler arquivo', 'error');
            };
            reader.readAsDataURL(file);
            
            event.target.value = '';
        }
        
        function removePhoto() {
            capturedPhotoData = null;
            currentFuncionarioPhoto = null;
            document.getElementById('photo-preview-area').classList.add('hidden');
            document.getElementById('photo-options').classList.remove('hidden');
            document.getElementById('biometria-section').classList.remove('success');
        }
        
        function initSignaturePad() {
            const canvas = document.getElementById('signature-canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.touches ? e.touches[0].clientX : e.clientX;
                const y = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: (x - rect.left) * (canvas.width / rect.width),
                    y: (y - rect.top) * (canvas.height / rect.height)
                };
            }
            
            function start(e) { e.preventDefault(); isDrawing = true; lastPos = getPos(e); }
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastPos.x, lastPos.y);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                lastPos = pos;
            }
            function stop() { isDrawing = false; }
            
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stop);
            canvas.addEventListener('mouseleave', stop);
            canvas.addEventListener('touchstart', start);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stop);
        }
        
        function clearSignature() {
            const canvas = document.getElementById('signature-canvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#000000';
            signatureData = null;
            document.getElementById('signature-preview').classList.remove('show');
        }
        
        function confirmSignature() {
            signatureData = document.getElementById('signature-canvas').toDataURL('image/png');
            document.getElementById('signature-img').src = signatureData;
            document.getElementById('signature-preview').classList.add('show');
            showNotification('Assinatura confirmada!', 'success');
        }
        
        function handleSubmit(e) {
            e.preventDefault();
            
            if (!signatureData) {
                showNotification('Colete a assinatura!', 'error');
                return;
            }
            
            // Registrar data e hora exata da assinatura
            const agora = new Date();
            
            const entrega = {
                id: Date.now().toString(),
                trabalhador: document.getElementById('trabalhador').value,
                cpf: document.getElementById('cpf').value,
                empresa: document.getElementById('empresa').value,
                cnpj: document.getElementById('cnpj').value,
                funcao: document.getElementById('funcao').value,
                setor: document.getElementById('setor').value,
                descricaoEPI: document.getElementById('descricaoEPI').value,
                numeroCA: document.getElementById('numeroCA').value,
                dataEntrega: document.getElementById('dataEntrega').value,
                quantidade: document.getElementById('quantidade').value || '1',
                observacoes: document.getElementById('observacoes').value,
                assinatura: signatureData,
                dataHoraAssinatura: agora.toISOString(), // Data e hora da assinatura
                fotoFacial: capturedPhotoData,
                dataRegistro: agora.toISOString()
            };
            
            entregas.unshift(entrega);
            
            // Baixar do estoque automaticamente
            baixarEstoqueEntrega(entrega.numeroCA, parseInt(entrega.quantidade) || 1);
            
            if (saveData()) {
                generatePDF(entrega.cpf);
                showNotification('Registrado! PDF gerado.', 'success');
                
                document.getElementById('descricaoEPI').value = '';
                document.getElementById('numeroCA').value = '';
                document.getElementById('quantidade').value = '1';
                document.getElementById('observacoes').value = '';
                document.getElementById('dataEntrega').value = new Date().toISOString().split('T')[0];
                document.getElementById('estoque-disponivel').innerHTML = '';
                clearSignature();
                updateUI();
                updateEstoqueUI();
            } else {
                showNotification('Erro ao salvar!', 'error');
            }
        }
        
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file || file.size > 500000) { showNotification('M√°x 500KB', 'error'); return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                config.logo = e.target.result;
                localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
                document.getElementById('logo-preview').src = config.logo;
                document.getElementById('logo-preview').classList.remove('hidden');
                document.getElementById('logo-placeholder').classList.add('hidden');
                document.getElementById('logo-upload').classList.add('has-logo');
                document.getElementById('btn-remove-logo').classList.remove('hidden');
                showNotification('Logo salva!', 'success');
            };
            reader.readAsDataURL(file);
        }
        
        function removeLogo() {
            config.logo = null;
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            document.getElementById('logo-preview').classList.add('hidden');
            document.getElementById('logo-placeholder').classList.remove('hidden');
            document.getElementById('logo-upload').classList.remove('has-logo');
            document.getElementById('btn-remove-logo').classList.add('hidden');
            showNotification('Logo removida', 'success');
        }
        
        function updateFuncionariosList() {
            const search = document.getElementById('search-funcionario')?.value.toLowerCase() || '';
            const filterEmp = document.getElementById('filter-empresa')?.value || '';
            
            // Filtrar por empresa ativa (se selecionada na aba Empresas)
            let entregasFiltradas = entregas;
            if (empresaAtual) {
                entregasFiltradas = entregas.filter(e => e.cnpj === empresaAtual.cnpj);
            }
            
            const map = {};
            entregasFiltradas.forEach(e => {
                if (!map[e.cpf]) map[e.cpf] = { ...e, entregas: [], emUso: 0, devolvidos: 0 };
                map[e.cpf].entregas.push(e);
                if (e.devolvido) {
                    map[e.cpf].devolvidos++;
                } else {
                    map[e.cpf].emUso++;
                }
                if (!map[e.cpf].fotoFacial && e.fotoFacial) map[e.cpf].fotoFacial = e.fotoFacial;
            });
            
            let funcs = Object.values(map).filter(f => {
                const matchS = f.trabalhador.toLowerCase().includes(search) || f.cpf.includes(search);
                const matchE = !filterEmp || f.empresa === filterEmp;
                return matchS && matchE;
            });
            
            const container = document.getElementById('funcionarios-list');
            const empty = document.getElementById('empty-state-func');
            
            if (funcs.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            container.innerHTML = funcs.map(f => {
                // Buscar cores da empresa
                const emp = getEmpresaPorCNPJ(f.cnpj);
                const paleta = PALETAS_CORES[emp?.paleta] || PALETAS_CORES.azul;
                
                return `
                <div class="funcionario-card" style="border-left:4px solid rgb(${paleta.secundaria.join(',')});">
                    <div class="funcionario-header">
                        <div class="funcionario-info">
                            ${f.fotoFacial ? 
                                `<img src="${f.fotoFacial}" class="funcionario-photo">` : 
                                `<div class="funcionario-photo no-photo"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>`
                            }
                            <div class="funcionario-details">
                                <h3>${f.trabalhador}</h3>
                                <p>${f.cpf} | ${f.empresa}</p>
                                <p style="font-size:0.75rem;color:#64748b;">${f.funcao || '-'} | ${f.setor || '-'}</p>
                            </div>
                        </div>
                        <div class="funcionario-stats">
                            <div class="stat-item">
                                <div class="value" style="color:rgb(${paleta.secundaria.join(',')});">${f.entregas.length}</div>
                                <div class="label">Total</div>
                            </div>
                            <div class="stat-item">
                                <div class="value" style="color:#10b981;">${f.emUso}</div>
                                <div class="label">Em Uso</div>
                            </div>
                            <div class="stat-item">
                                <div class="value" style="color:#f59e0b;">${f.devolvidos}</div>
                                <div class="label">Devolvidos</div>
                            </div>
                        </div>
                    </div>
                    <div class="funcionario-actions">
                        <button class="btn-primary" onclick="generatePDF('${f.cpf}')">üìÑ PDF</button>
                        <button class="btn-secondary" onclick="showHistorico('${f.cpf}')">üìã Hist√≥rico</button>
                        <button class="btn-danger" onclick="deleteFuncionario('${f.cpf}')">üóëÔ∏è</button>
                    </div>
                </div>
            `}).join('');
        }
        
        function filterFuncionarios() { updateFuncionariosList(); }
        
        function updateEmpresaFilter() {
            const empresas = [...new Set(entregas.map(e => e.empresa))];
            const select = document.getElementById('filter-empresa');
            const val = select.value;
            select.innerHTML = '<option value="">Todas</option>' + empresas.map(e => `<option value="${e}">${e}</option>`).join('');
            select.value = val;
        }
        
        // Gerar PDF com assinatura por entrega
        function generatePDF(cpf) {
            const funcs = entregas.filter(e => e.cpf === cpf);
            if (funcs.length === 0) return;
            
            const f = funcs[0];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            let y = margin;
            
            // Buscar cores da empresa
            const empresaData = getEmpresaPorCNPJ(f.cnpj);
            const paletaKey = empresaData?.paleta || 'azul';
            const paleta = PALETAS_CORES[paletaKey] || PALETAS_CORES.azul;
            
            // Cores do tema (baseadas na empresa)
            const azulEscuro = paleta.primaria;
            const azulMedio = paleta.secundaria;
            const azulClaro = paleta.accent;
            const cinzaEscuro = paleta.texto;
            const cinzaClaro = [100, 116, 139];
            
            // Logo da empresa (prioridade: empresa cadastrada > config global)
            const logoEmpresa = empresaData?.logo || config.logo;
            
            function addHeader() {
                // Faixa superior
                doc.setFillColor(...azulEscuro);
                doc.rect(0, 0, pageWidth, 42, 'F');
                
                // Logo
                let logoWidth = 0;
                if (logoEmpresa) {
                    try { 
                        doc.addImage(logoEmpresa, 'PNG', margin, 6, 30, 30); 
                        logoWidth = 35;
                    } catch(e) {}
                }
                
                // T√≠tulo
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('FICHA DE CONTROLE DE EPI', margin + logoWidth, 18);
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text('Equipamento de Prote√ß√£o Individual - NR 6', margin + logoWidth, 26);
                
                doc.setFontSize(9);
                // Usar nome da empresa cadastrada ou do config
                const nomeEmpresa = empresaData?.razao || empresaData?.fantasia || f.empresa || config.empresa || 'Empresa n√£o configurada';
                doc.text(nomeEmpresa, margin + logoWidth, 34);
                
                // Data de emiss√£o
                doc.setFontSize(8);
                doc.text(`Emitido: ${new Date().toLocaleString('pt-BR')}`, pageWidth - margin, 10, { align: 'right' });
            }
            
            addHeader();
            y = 50;
            
            // Foto do trabalhador
            const foto = funcs.find(e => e.fotoFacial)?.fotoFacial;
            
            // Se√ß√£o: Dados do Trabalhador
            doc.setFillColor(...azulMedio);
            doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('IDENTIFICA√á√ÉO DO TRABALHADOR', margin + 3, y + 5.5);
            y += 12;
            
            // Dados em grid - cada campo em linha separada para evitar sobreposi√ß√£o
            doc.setTextColor(...cinzaEscuro);
            doc.setFontSize(9);
            
            // Nome completo em linha pr√≥pria
            doc.setFont('helvetica', 'bold');
            doc.text('Nome:', margin, y);
            doc.setFont('helvetica', 'normal');
            doc.text(f.trabalhador, margin + 18, y);
            
            y += 6;
            doc.setFont('helvetica', 'bold');
            doc.text('CPF:', margin, y);
            doc.setFont('helvetica', 'normal');
            doc.text(f.cpf, margin + 18, y);
            
            // Foto ao lado dos dados
            if (foto) {
                try { 
                    doc.addImage(foto, 'JPEG', pageWidth - margin - 25, y - 11, 25, 32); 
                    doc.setDrawColor(...azulMedio);
                    doc.setLineWidth(0.5);
                    doc.rect(pageWidth - margin - 25, y - 11, 25, 32);
                } catch(e) {}
            }
            
            y += 6;
            doc.setFont('helvetica', 'bold');
            doc.text('Empresa:', margin, y);
            doc.setFont('helvetica', 'normal');
            doc.text(f.empresa || '-', margin + 22, y);
            
            y += 6;
            doc.setFont('helvetica', 'bold');
            doc.text('CNPJ:', margin, y);
            doc.setFont('helvetica', 'normal');
            doc.text(f.cnpj || '-', margin + 18, y);
            
            y += 6;
            doc.setFont('helvetica', 'bold');
            doc.text('Fun√ß√£o:', margin, y);
            doc.setFont('helvetica', 'normal');
            doc.text(f.funcao || '-', margin + 20, y);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Setor:', margin + 80, y);
            doc.setFont('helvetica', 'normal');
            doc.text(f.setor || '-', margin + 96, y);
            
            y += 12;
            
            // Se√ß√£o: Registro de Entregas
            doc.setFillColor(...azulMedio);
            doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('REGISTRO DE ENTREGAS DE EPI', margin + 3, y + 5.5);
            y += 12;
            
            // Ordenar por data
            const sorted = [...funcs].sort((a, b) => new Date(a.dataEntrega) - new Date(b.dataEntrega));
            
            // Listar cada entrega
            sorted.forEach((entrega, idx) => {
                if (y > pageHeight - 80) {
                    doc.addPage();
                    addHeader();
                    y = 50;
                }
                
                // Box da entrega
                doc.setFillColor(245, 248, 252);
                doc.setDrawColor(...azulClaro);
                doc.setLineWidth(0.3);
                doc.roundedRect(margin, y, pageWidth - margin * 2, 48, 2, 2, 'FD');
                
                // N√∫mero
                doc.setFillColor(...azulMedio);
                doc.circle(margin + 8, y + 8, 5, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(String(idx + 1), margin + 8, y + 9.5, { align: 'center' });
                
                // Descri√ß√£o do EPI
                doc.setTextColor(...azulEscuro);
                doc.setFontSize(10);
                doc.text(entrega.descricaoEPI, margin + 18, y + 9);
                
                // Status de devolu√ß√£o
                if (entrega.devolvido) {
                    doc.setFillColor(16, 185, 129);
                    doc.roundedRect(pageWidth - margin - 25, y + 3, 22, 6, 1, 1, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.text('DEVOLVIDO', pageWidth - margin - 14, y + 7, { align: 'center' });
                }
                
                // Detalhes
                doc.setTextColor(...cinzaEscuro);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                
                const dataEntrega = new Date(entrega.dataEntrega + 'T00:00:00');
                doc.text(`CA: ${entrega.numeroCA}`, margin + 5, y + 18);
                doc.text(`Quantidade: ${entrega.quantidade}`, margin + 45, y + 18);
                doc.text(`Data Entrega: ${dataEntrega.toLocaleDateString('pt-BR')}`, margin + 85, y + 18);
                
                if (entrega.observacoes) {
                    doc.setTextColor(...cinzaClaro);
                    doc.text(`Obs: ${entrega.observacoes.substring(0, 50)}`, margin + 5, y + 24);
                }
                
                // Assinatura
                doc.setTextColor(...cinzaEscuro);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(7);
                doc.text('ASSINATURA DO TRABALHADOR:', margin + 5, y + 32);
                
                if (entrega.assinatura) {
                    try {
                        // Fundo branco para a assinatura
                        doc.setFillColor(255, 255, 255);
                        doc.rect(margin + 5, y + 33, 47, 14, 'F');
                        doc.addImage(entrega.assinatura, 'PNG', margin + 5, y + 33, 45, 13);
                    } catch(e) {}
                }
                
                // Data/hora da assinatura
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...cinzaClaro);
                const dataAssinatura = new Date(entrega.dataHoraAssinatura || entrega.dataRegistro);
                doc.text(`Assinado em: ${dataAssinatura.toLocaleDateString('pt-BR')} √†s ${dataAssinatura.toLocaleTimeString('pt-BR')}`, margin + 55, y + 40);
                
                y += 52;
            });
            
            // Se√ß√£o de Devolu√ß√µes
            const devolucoes = sorted.filter(e => e.devolvido);
            
            if (devolucoes.length > 0) {
                if (y > pageHeight - 80) {
                    doc.addPage();
                    addHeader();
                    y = 50;
                }
                
                y += 5;
                doc.setFillColor(245, 158, 11); // Laranja para devolu√ß√µes
                doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
                doc.setTextColor(30, 58, 95);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(`HIST√ìRICO DE DEVOLU√á√ïES (${devolucoes.length})`, margin + 3, y + 5.5);
                y += 12;
                
                const motivos = {
                    'troca': 'Troca por desgaste/dano',
                    'vencimento': 'Vencimento do CA',
                    'desligamento': 'Desligamento',
                    'mudanca_funcao': 'Mudan√ßa de fun√ß√£o',
                    'inadequado': 'EPI inadequado',
                    'outro': 'Outro'
                };
                
                const estados = {
                    'bom': 'Bom estado',
                    'danificado': 'Danificado',
                    'desgastado': 'Desgastado',
                    'descarte': 'Para descarte'
                };
                
                devolucoes.forEach((entrega, idx) => {
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        addHeader();
                        y = 50;
                    }
                    
                    // Box da devolu√ß√£o
                    doc.setFillColor(255, 251, 235); // Fundo amarelo claro
                    doc.setDrawColor(245, 158, 11);
                    doc.setLineWidth(0.3);
                    doc.roundedRect(margin, y, pageWidth - margin * 2, 35, 2, 2, 'FD');
                    
                    // Descri√ß√£o do EPI
                    doc.setTextColor(...azulEscuro);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(entrega.descricaoEPI, margin + 5, y + 7);
                    
                    // Badge devolvido
                    doc.setFillColor(245, 158, 11);
                    doc.roundedRect(pageWidth - margin - 28, y + 2, 25, 6, 1, 1, 'F');
                    doc.setTextColor(30, 58, 95);
                    doc.setFontSize(6);
                    doc.text('DEVOLVIDO', pageWidth - margin - 15.5, y + 6, { align: 'center' });
                    
                    // Detalhes
                    doc.setTextColor(...cinzaEscuro);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    
                    const dataEntrega = new Date(entrega.dataEntrega + 'T00:00:00');
                    const dataDev = entrega.devolucao ? new Date(entrega.devolucao.dataDevolucao) : null;
                    
                    doc.text(`CA: ${entrega.numeroCA}`, margin + 5, y + 14);
                    doc.text(`Entrega: ${dataEntrega.toLocaleDateString('pt-BR')}`, margin + 45, y + 14);
                    doc.text(`Devolu√ß√£o: ${dataDev ? dataDev.toLocaleDateString('pt-BR') : '-'}`, margin + 95, y + 14);
                    
                    doc.text(`Motivo: ${entrega.devolucao ? (motivos[entrega.devolucao.motivo] || entrega.devolucao.motivo) : '-'}`, margin + 5, y + 21);
                    doc.text(`Estado: ${entrega.devolucao ? (estados[entrega.devolucao.estado] || entrega.devolucao.estado) : '-'}`, margin + 95, y + 21);
                    
                    // Assinatura de devolu√ß√£o
                    if (entrega.devolucao?.assinaturaDevolucao) {
                        try {
                            // Fundo branco para a assinatura
                            doc.setFillColor(255, 255, 255);
                            doc.rect(margin + 5, y + 22, 32, 12, 'F');
                            doc.addImage(entrega.devolucao.assinaturaDevolucao, 'PNG', margin + 5, y + 23, 30, 10);
                        } catch(e) {}
                    }
                    
                    const dataAssinaturaDev = entrega.devolucao?.dataHoraDevolucao ? new Date(entrega.devolucao.dataHoraDevolucao) : null;
                    doc.setFontSize(6);
                    doc.setTextColor(...cinzaClaro);
                    doc.text(`Assinado: ${dataAssinaturaDev ? dataAssinaturaDev.toLocaleDateString('pt-BR') + ' ' + dataAssinaturaDev.toLocaleTimeString('pt-BR') : '-'}`, margin + 40, y + 31);
                    
                    y += 38;
                });
            }
            
            // Declara√ß√£o conforme NR-06
            if (y > pageHeight - 120) {
                doc.addPage();
                addHeader();
                y = 50;
            }
            
            y += 5;
            doc.setFillColor(...azulEscuro);
            doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('TERMO DE RESPONSABILIDADE - NR 06', margin + 3, y + 5.5);
            y += 14;
            
            doc.setTextColor(...cinzaEscuro);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            
            // Par√°grafo inicial
            const intro = 'DECLARO, para os devidos fins, que recebi gratuitamente os Equipamentos de Prote√ß√£o Individual (EPIs) acima relacionados, em perfeito estado de conserva√ß√£o e funcionamento, e COMPROMETO-ME a:';
            const introLines = doc.splitTextToSize(intro, pageWidth - margin * 2);
            doc.text(introLines, margin, y);
            y += introLines.length * 4.5 + 4;
            
            // Lista de compromissos com indenta√ß√£o
            const compromissos = [
                'Utilizar os EPIs apenas para a finalidade a que se destinam, durante toda a jornada de trabalho;',
                'Responsabilizar-me pela guarda, conserva√ß√£o e higieniza√ß√£o dos equipamentos;',
                'Comunicar imediatamente ao empregador qualquer altera√ß√£o que torne o EPI impr√≥prio para uso;',
                'Cumprir as determina√ß√µes do empregador sobre o uso adequado dos equipamentos;',
                'N√£o modificar, alterar ou danificar intencionalmente os EPIs recebidos;',
                'Devolver os EPIs ao empregador quando solicitado ou ao t√©rmino do contrato de trabalho.'
            ];
            
            compromissos.forEach(item => {
                doc.setFont('helvetica', 'bold');
                doc.text('‚Ä¢', margin + 5, y);
                doc.setFont('helvetica', 'normal');
                const itemLines = doc.splitTextToSize(item, pageWidth - margin * 2 - 12);
                doc.text(itemLines, margin + 10, y);
                y += itemLines.length * 4 + 2;
            });
            
            y += 4;
            
            // Par√°grafo sobre recusa
            doc.setFont('helvetica', 'normal');
            const recusa = 'Estou ciente de que a recusa injustificada ao uso dos EPIs constitui ato faltoso, conforme art. 158 da CLT e item 6.7.1 da NR 06, podendo acarretar san√ß√µes disciplinares.';
            const recusaLines = doc.splitTextToSize(recusa, pageWidth - margin * 2);
            doc.text(recusaLines, margin, y);
            y += recusaLines.length * 4.5 + 4;
            
            // Par√°grafo sobre treinamento
            const treinamento = 'Declaro ainda ter recebido treinamento sobre o uso correto, guarda e conserva√ß√£o dos EPIs, bem como sobre suas limita√ß√µes de prote√ß√£o, conforme estabelecido na Norma Regulamentadora n¬∫ 06.';
            const treinamentoLines = doc.splitTextToSize(treinamento, pageWidth - margin * 2);
            doc.text(treinamentoLines, margin, y);
            y += treinamentoLines.length * 4.5 + 8;
            
            // Linha de assinatura
            doc.setDrawColor(...azulMedio);
            doc.setLineWidth(0.3);
            doc.line(margin, y, margin + 70, y);
            doc.setFontSize(8);
            doc.setTextColor(...cinzaClaro);
            doc.text(`${f.trabalhador}`, margin, y + 5);
            doc.text(`CPF: ${f.cpf}`, margin, y + 10);
            
            // Rodap√© em todas as p√°ginas
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                
                // Faixa inferior
                doc.setFillColor(...azulEscuro);
                doc.rect(0, pageHeight - 18, pageWidth, 18, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('RC Engenharia Sa√∫de e Seguran√ßa Ocupacional', pageWidth / 2, pageHeight - 12, { align: 'center' });
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text('¬© 2026 - Todos os direitos reservados', pageWidth / 2, pageHeight - 7, { align: 'center' });
                
                doc.text(`P√°gina ${i}/${totalPages}`, margin, pageHeight - 7);
                doc.text(`${new Date().toLocaleString('pt-BR')}`, pageWidth - margin, pageHeight - 7, { align: 'right' });
            }
            
            doc.save(`EPI_${f.trabalhador.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('PDF gerado!', 'success');
        }
        
        function showHistorico(cpf) {
            const funcs = entregas.filter(e => e.cpf === cpf);
            if (funcs.length === 0) return;
            
            const f = funcs[0];
            const foto = funcs.find(e => e.fotoFacial)?.fotoFacial;
            
            document.getElementById('modal-titulo').textContent = f.trabalhador;
            
            const sorted = [...funcs].sort((a, b) => new Date(b.dataEntrega) - new Date(a.dataEntrega));
            const entregasAtivas = sorted.filter(e => !e.devolvido);
            const devolucoes = sorted.filter(e => e.devolvido);
            
            const motivos = {
                'troca': 'Troca por desgaste/dano',
                'vencimento': 'Vencimento do CA',
                'desligamento': 'Desligamento do funcion√°rio',
                'mudanca_funcao': 'Mudan√ßa de fun√ß√£o',
                'inadequado': 'EPI inadequado',
                'outro': 'Outro'
            };
            
            const estados = {
                'bom': 'Bom estado',
                'danificado': 'Danificado',
                'desgastado': 'Desgastado',
                'descarte': 'Para descarte'
            };
            
            document.getElementById('modal-content').innerHTML = `
                <div style="display:flex;gap:1rem;padding:1rem;background:#0f172a;border-radius:8px;margin-bottom:1.5rem;align-items:center;flex-wrap:wrap;">
                    ${foto ? `
                        <div style="text-align:center;">
                            <img src="${foto}" style="width:80px;height:100px;object-fit:cover;border-radius:8px;border:2px solid #10b981;">
                            <p style="font-size:0.7rem;color:#64748b;margin-top:0.5rem;">
                                ${new Date(funcs.find(e => e.fotoFacial).dataRegistro).toLocaleString('pt-BR')}
                            </p>
                        </div>
                    ` : ''}
                    <div style="flex:1;">
                        <p><strong>CPF:</strong> ${f.cpf}</p>
                        <p><strong>Empresa:</strong> ${f.empresa}</p>
                        <p><strong>Fun√ß√£o:</strong> ${f.funcao || '-'} | <strong>Setor:</strong> ${f.setor || '-'}</p>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;text-align:center;">
                        <div style="background:#1e3a5f;padding:0.5rem;border-radius:6px;">
                            <div style="font-size:1.25rem;font-weight:700;color:#2563eb;">${funcs.length}</div>
                            <div style="font-size:0.65rem;color:#64748b;">TOTAL</div>
                        </div>
                        <div style="background:#1e3a5f;padding:0.5rem;border-radius:6px;">
                            <div style="font-size:1.25rem;font-weight:700;color:#10b981;">${entregasAtivas.length}</div>
                            <div style="font-size:0.65rem;color:#64748b;">EM USO</div>
                        </div>
                        <div style="background:#1e3a5f;padding:0.5rem;border-radius:6px;">
                            <div style="font-size:1.25rem;font-weight:700;color:#f59e0b;">${devolucoes.length}</div>
                            <div style="font-size:0.65rem;color:#64748b;">DEVOLVIDOS</div>
                        </div>
                    </div>
                </div>
                
                <!-- EPIs em Uso -->
                <h4 style="color:#10b981;margin-bottom:1rem;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:0.5rem;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    EPIs EM USO (${entregasAtivas.length})
                </h4>
                
                <div style="max-height:250px;overflow-y:auto;margin-bottom:1.5rem;">
                    ${entregasAtivas.length === 0 ? '<p style="color:#64748b;text-align:center;padding:1rem;">Nenhum EPI em uso</p>' : 
                    entregasAtivas.map((e, i) => {
                        const dataAssinatura = new Date(e.dataHoraAssinatura || e.dataRegistro);
                        return `
                            <div class="historico-item" style="border-left:3px solid #10b981;">
                                <div class="historico-header">
                                    <div>
                                        <span class="historico-epi">${e.descricaoEPI}</span>
                                        <span class="badge-ca" style="margin-left:0.5rem;">CA ${e.numeroCA}</span>
                                    </div>
                                    <div style="display:flex;align-items:center;gap:0.5rem;">
                                        <span class="historico-data">${formatDate(e.dataEntrega)}</span>
                                        <button onclick="deleteEntregaIndividual('${e.id}')" style="background:#ef4444;color:white;border:none;padding:0.25rem 0.5rem;border-radius:4px;cursor:pointer;font-size:0.7rem;" title="Excluir esta entrega">‚úï</button>
                                    </div>
                                </div>
                                <div class="historico-detalhes">
                                    Quantidade: ${e.quantidade} | ${e.observacoes || 'Sem observa√ß√µes'}
                                </div>
                                <div class="historico-assinatura">
                                    ${e.assinatura ? `<img src="${e.assinatura}" alt="Assinatura">` : '<span style="color:#ef4444;">Sem assinatura</span>'}
                                    <div class="historico-assinatura-info">
                                        <strong>‚úì Assinado em:</strong>
                                        ${dataAssinatura.toLocaleDateString('pt-BR')} √†s ${dataAssinatura.toLocaleTimeString('pt-BR')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Hist√≥rico de Devolu√ß√µes -->
                <h4 style="color:#f59e0b;margin-bottom:1rem;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:0.5rem;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5"/>
                    </svg>
                    HIST√ìRICO DE DEVOLU√á√ïES (${devolucoes.length})
                </h4>
                
                <div style="max-height:250px;overflow-y:auto;">
                    ${devolucoes.length === 0 ? '<p style="color:#64748b;text-align:center;padding:1rem;">Nenhuma devolu√ß√£o registrada</p>' : 
                    devolucoes.map(e => {
                        const dataDev = e.devolucao ? new Date(e.devolucao.dataDevolucao) : null;
                        const dataAssinaturaDev = e.devolucao?.dataHoraDevolucao ? new Date(e.devolucao.dataHoraDevolucao) : null;
                        return `
                            <div class="historico-item" style="border-left:3px solid #f59e0b;background:rgba(245,158,11,0.05);">
                                <div class="historico-header">
                                    <div>
                                        <span class="historico-epi">${e.descricaoEPI}</span>
                                        <span style="background:#f59e0b;color:#1e3a5f;padding:0.15rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:600;margin-left:0.5rem;">DEVOLVIDO</span>
                                    </div>
                                </div>
                                <div class="historico-detalhes" style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-top:0.5rem;">
                                    <div>
                                        <span style="color:#64748b;font-size:0.75rem;">Entrega:</span>
                                        <span style="color:#e2e8f0;">${formatDate(e.dataEntrega)}</span>
                                    </div>
                                    <div>
                                        <span style="color:#64748b;font-size:0.75rem;">Devolu√ß√£o:</span>
                                        <span style="color:#f59e0b;font-weight:600;">${dataDev ? dataDev.toLocaleDateString('pt-BR') : '-'}</span>
                                    </div>
                                    <div>
                                        <span style="color:#64748b;font-size:0.75rem;">Motivo:</span>
                                        <span style="color:#e2e8f0;">${e.devolucao ? (motivos[e.devolucao.motivo] || e.devolucao.motivo) : '-'}</span>
                                    </div>
                                    <div>
                                        <span style="color:#64748b;font-size:0.75rem;">Estado:</span>
                                        <span style="color:#e2e8f0;">${e.devolucao ? (estados[e.devolucao.estado] || e.devolucao.estado) : '-'}</span>
                                    </div>
                                </div>
                                ${e.devolucao?.observacoesDevolucao ? `
                                    <div style="margin-top:0.5rem;font-size:0.8rem;color:#94a3b8;">
                                        <strong>Obs:</strong> ${e.devolucao.observacoesDevolucao}
                                    </div>
                                ` : ''}
                                ${e.devolucao?.assinaturaDevolucao ? `
                                    <div class="historico-assinatura" style="margin-top:0.75rem;">
                                        <img src="${e.devolucao.assinaturaDevolucao}" alt="Assinatura Devolu√ß√£o" style="border:1px solid #f59e0b;">
                                        <div class="historico-assinatura-info">
                                            <strong style="color:#f59e0b;">‚úì Devolu√ß√£o assinada em:</strong>
                                            ${dataAssinaturaDev ? dataAssinaturaDev.toLocaleDateString('pt-BR') + ' √†s ' + dataAssinaturaDev.toLocaleTimeString('pt-BR') : '-'}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="display:flex;gap:0.5rem;margin-top:1.5rem;flex-wrap:wrap;">
                    <button class="btn-primary" onclick="generatePDF('${cpf}')" style="flex:1;">
                        üìÑ Gerar PDF Completo
                    </button>
                    <button class="btn-danger" onclick="deleteFuncionario('${cpf}')" style="flex:1;">
                        üóëÔ∏è Excluir Funcion√°rio
                    </button>
                </div>
            `;
            document.getElementById('modal-historico').classList.add('show');
        }
        
        function closeModal(e) {
            if (e.target.id === 'modal-historico') e.target.classList.remove('show');
        }
        
        function deleteFuncionario(cpf) {
            const f = entregas.find(e => e.cpf === cpf);
            const totalEntregas = entregas.filter(e => e.cpf === cpf).length;
            
            // Primeira confirma√ß√£o
            if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a excluir:\n\nüë§ ${f.trabalhador}\nüìã ${totalEntregas} entrega(s) de EPI\n\nDeseja continuar?`)) return;
            
            // Segunda confirma√ß√£o
            if (!confirm(`üî¥ CONFIRMA√á√ÉO FINAL\n\nTem CERTEZA que deseja excluir permanentemente?\n\nEsta a√ß√£o N√ÉO pode ser desfeita!`)) return;
            
            // Terceira verifica√ß√£o - digitar nome
            const nomeDigitado = prompt(`Para confirmar a exclus√£o, digite o nome do funcion√°rio:\n\n"${f.trabalhador}"`);
            
            if (!nomeDigitado) {
                showNotification('Exclus√£o cancelada', 'error');
                return;
            }
            
            if (nomeDigitado.trim().toLowerCase() !== f.trabalhador.trim().toLowerCase()) {
                showNotification('Nome incorreto. Exclus√£o cancelada.', 'error');
                return;
            }
            
            entregas = entregas.filter(e => e.cpf !== cpf);
            if (saveData()) { 
                showNotification('Funcion√°rio exclu√≠do', 'success'); 
                updateUI(); 
                // Fechar modal se estiver aberto
                document.getElementById('modal-historico').classList.remove('show');
            }
        }
        
        function deleteEntregaIndividual(id) {
            const entrega = entregas.find(e => e.id === id);
            if (!entrega) return;
            
            // Primeira confirma√ß√£o
            if (!confirm(`‚ö†Ô∏è Excluir esta entrega?\n\nüì¶ ${entrega.descricaoEPI}\nüìÖ ${formatDate(entrega.dataEntrega)}\n\nA assinatura tamb√©m ser√° exclu√≠da.`)) return;
            
            // Segunda confirma√ß√£o
            if (!confirm(`üî¥ CONFIRMA√á√ÉO FINAL\n\nTem certeza? Esta a√ß√£o n√£o pode ser desfeita!`)) return;
            
            entregas = entregas.filter(e => e.id !== id);
            if (saveData()) {
                showNotification('Entrega exclu√≠da', 'success');
                updateUI();
                // Atualizar modal se aberto
                const cpf = entrega.cpf;
                if (entregas.some(e => e.cpf === cpf)) {
                    showHistorico(cpf);
                } else {
                    document.getElementById('modal-historico').classList.remove('show');
                }
            }
        }
        
        function exportAllToCSV() {
            if (entregas.length === 0) { showNotification('Nada para exportar', 'error'); return; }
            
            const h = ['Data Entrega', 'Data/Hora Assinatura', 'Nome', 'CPF', 'Empresa', 'EPI', 'CA', 'Qtd'];
            const r = entregas.map(e => {
                const dt = new Date(e.dataHoraAssinatura || e.dataRegistro);
                return [e.dataEntrega, dt.toLocaleString('pt-BR'), e.trabalhador, e.cpf, e.empresa, e.descricaoEPI, e.numeroCA, e.quantidade];
            });
            const csv = [h, ...r].map(row => row.map(c => `"${c}"`).join(';')).join('\n');
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' }));
            a.download = `epi_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showNotification('Exportado!', 'success');
        }
        
        function clearAllData() {
            const totalEntregas = entregas.length;
            const totalFuncionarios = new Set(entregas.map(e => e.cpf)).size;
            const totalEstoque = estoque.length;
            
            if (totalEntregas === 0 && totalEstoque === 0) {
                showNotification('N√£o h√° dados para apagar', 'error');
                return;
            }
            
            // Primeira confirma√ß√£o
            if (!confirm(`üö® ATEN√á√ÉO M√ÅXIMA!\n\nVoc√™ est√° prestes a APAGAR PERMANENTEMENTE:\n\nüìã ${totalEntregas} entrega(s) de EPI\nüë• ${totalFuncionarios} funcion√°rio(s)\nüì¶ ${totalEstoque} item(ns) de estoque\n‚úçÔ∏è Todas as assinaturas\nüì∑ Todas as fotos\n\nDeseja continuar?`)) return;
            
            // Segunda confirma√ß√£o
            if (!confirm(`‚õî √öLTIMA CHANCE!\n\nTodos os dados ser√£o PERDIDOS PARA SEMPRE!\n\nN√£o ser√° poss√≠vel recuperar!\n\nTem CERTEZA ABSOLUTA?`)) return;
            
            // Terceira verifica√ß√£o - digitar c√≥digo
            const codigo = prompt(`üîê VERIFICA√á√ÉO DE SEGURAN√áA\n\nPara confirmar a exclus√£o TOTAL, digite:\n\n"APAGAR TUDO"\n\n(exatamente como mostrado acima)`);
            
            if (!codigo) {
                showNotification('Opera√ß√£o cancelada', 'error');
                return;
            }
            
            if (codigo.trim().toUpperCase() !== 'APAGAR TUDO') {
                showNotification('C√≥digo incorreto. Opera√ß√£o cancelada.', 'error');
                return;
            }
            
            // Quarta verifica√ß√£o - confirma√ß√£o num√©rica
            const numeroAleatorio = Math.floor(1000 + Math.random() * 9000);
            const numeroDigitado = prompt(`üî¢ √öLTIMA VERIFICA√á√ÉO\n\nDigite o n√∫mero abaixo para confirmar:\n\n${numeroAleatorio}`);
            
            if (!numeroDigitado || numeroDigitado.trim() !== numeroAleatorio.toString()) {
                showNotification('N√∫mero incorreto. Opera√ß√£o cancelada.', 'error');
                return;
            }
            
            // Fazer backup antes de apagar
            const backup = JSON.stringify({ entregas, estoque, config });
            console.log('BACKUP DOS DADOS (copie se necess√°rio):', backup);
            
            entregas = [];
            estoque = [];
            saveData();
            saveEstoque();
            updateUI();
            updateEstoqueUI();
            showNotification('Todos os dados foram apagados', 'success');
        }
        
        function exportBackup() {
            if (entregas.length === 0 && estoque.length === 0 && empresas.length === 0) {
                showNotification('N√£o h√° dados para backup', 'error');
                return;
            }
            
            const backup = {
                versao: '5.0',
                dataExportacao: new Date().toISOString(),
                totalEntregas: entregas.length,
                totalFuncionarios: new Set(entregas.map(e => e.cpf)).size,
                totalEstoque: estoque.length,
                totalEmpresas: empresas.length,
                config: config,
                entregas: entregas,
                estoque: estoque,
                empresas: empresas
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_epi_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification(`Backup exportado: ${entregas.length} entregas, ${estoque.length} itens, ${empresas.length} empresas`, 'success');
        }
        
        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.entregas || !Array.isArray(backup.entregas)) {
                        throw new Error('Formato inv√°lido');
                    }
                    
                    const estoqueInfo = backup.estoque ? `\nItens Estoque: ${backup.estoque.length}` : '';
                    const empresasInfo = backup.empresas ? `\nEmpresas: ${backup.empresas.length}` : '';
                    const msg = `üì¶ IMPORTAR BACKUP\n\nArquivo: ${file.name}\nData: ${backup.dataExportacao ? new Date(backup.dataExportacao).toLocaleString('pt-BR') : 'Desconhecida'}\nEntregas: ${backup.entregas.length}${estoqueInfo}${empresasInfo}\n\nIsso IR√Å SUBSTITUIR todos os dados atuais!\n\nDeseja continuar?`;
                    
                    if (!confirm(msg)) {
                        showNotification('Importa√ß√£o cancelada', 'error');
                        return;
                    }
                    
                    if (!confirm('‚ö†Ô∏è Tem certeza? Os dados atuais ser√£o perdidos!')) {
                        showNotification('Importa√ß√£o cancelada', 'error');
                        return;
                    }
                    
                    entregas = backup.entregas;
                    
                    if (backup.estoque && Array.isArray(backup.estoque)) {
                        estoque = backup.estoque;
                        saveEstoque();
                    }
                    
                    if (backup.empresas && Array.isArray(backup.empresas)) {
                        empresas = backup.empresas;
                        saveEmpresas();
                    }
                    
                    if (backup.config) {
                        config = backup.config;
                        localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
                        loadConfig();
                    }
                    
                    saveData();
                    updateUI();
                    updateEstoqueUI();
                    updateEmpresasUI();
                    
                    showNotification(`Backup importado: ${entregas.length} entregas, ${estoque.length} itens, ${empresas.length} empresas`, 'success');
                    
                } catch (err) {
                    console.error('Erro ao importar:', err);
                    showNotification('Arquivo de backup inv√°lido', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // ==================== FUN√á√ïES DE DEVOLU√á√ÉO ====================
        
        let signaturePadDevolucao = null;
        let signatureDataDevolucao = null;
        let selectedEntregaDevolucao = null;
        
        function initSignatureDevolucao() {
            const canvas = document.getElementById('signature-devolucao');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0, lastY = 0;
            
            // Fundo branco e tra√ßo preto
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                if (e.touches) {
                    return { x: (e.touches[0].clientX - rect.left) * scaleX, y: (e.touches[0].clientY - rect.top) * scaleY };
                }
                return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
            }
            
            function startDraw(e) { 
                e.preventDefault();
                isDrawing = true; 
                const pos = getPos(e); 
                lastX = pos.x; 
                lastY = pos.y; 
            }
            
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                lastX = pos.x;
                lastY = pos.y;
            }
            
            function stopDraw() { isDrawing = false; }
            
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            canvas.addEventListener('touchstart', startDraw);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDraw);
            
            signaturePadDevolucao = { canvas, ctx };
        }
        
        function clearSignatureDevolucao() {
            if (!signaturePadDevolucao) return;
            const { canvas, ctx } = signaturePadDevolucao;
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#000000';
            signatureDataDevolucao = null;
            document.getElementById('signature-preview-dev').style.display = 'none';
        }
        
        function confirmSignatureDevolucao() {
            if (!signaturePadDevolucao) return;
            signatureDataDevolucao = signaturePadDevolucao.canvas.toDataURL('image/png');
            document.getElementById('signature-img-dev').src = signatureDataDevolucao;
            document.getElementById('signature-preview-dev').style.display = 'block';
            showNotification('Assinatura de devolu√ß√£o confirmada!', 'success');
        }
        
        function buscarFuncionarioDevolucao(cpf) {
            const lista = document.getElementById('autocomplete-devolucao');
            const cpfLimpo = cpf.replace(/\D/g, '');
            
            if (cpfLimpo.length < 3) {
                lista.classList.add('hidden');
                return;
            }
            
            const funcionarios = [...new Map(entregas.map(e => [e.cpf, e])).values()];
            const matches = funcionarios.filter(f => f.cpf.replace(/\D/g, '').includes(cpfLimpo));
            
            if (matches.length === 0) {
                lista.classList.add('hidden');
                return;
            }
            
            lista.innerHTML = matches.slice(0, 5).map(f => `
                <div class="autocomplete-item" onclick="selecionarFuncionarioDevolucao('${f.cpf}')">
                    ${f.fotoFacial ? `<img src="${f.fotoFacial}" alt="">` : '<div style="width:40px;height:50px;background:#2d4a6f;border-radius:6px;"></div>'}
                    <div>
                        <div style="font-weight:500;color:#e2e8f0;">${f.trabalhador}</div>
                        <div style="font-size:0.85rem;color:#64748b;">${f.cpf}</div>
                    </div>
                </div>
            `).join('');
            
            lista.classList.remove('hidden');
        }
        
        function selecionarFuncionarioDevolucao(cpf) {
            const f = entregas.find(e => e.cpf === cpf);
            if (f) {
                document.getElementById('dev-cpf').value = f.cpf;
                document.getElementById('dev-trabalhador').value = f.trabalhador;
                
                // Listar EPIs entregues a este funcion√°rio (n√£o devolvidos)
                const episFuncionario = entregas.filter(e => e.cpf === cpf && !e.devolvido);
                const selectEPI = document.getElementById('dev-epi');
                selectEPI.innerHTML = '<option value="">Selecione o EPI entregue</option>';
                
                episFuncionario.forEach(e => {
                    selectEPI.innerHTML += `<option value="${e.id}">${e.descricaoEPI} - CA ${e.numeroCA} (Entregue: ${formatDate(e.dataEntrega)})</option>`;
                });
            }
            document.getElementById('autocomplete-devolucao').classList.add('hidden');
        }
        
        function selecionarEPIDevolucao() {
            const id = document.getElementById('dev-epi').value;
            selectedEntregaDevolucao = entregas.find(e => e.id === id);
        }
        
        function handleDevolucao(e) {
            e.preventDefault();
            
            if (!signatureDataDevolucao) {
                showNotification('Confirme a assinatura de devolu√ß√£o!', 'error');
                return;
            }
            
            const entregaId = document.getElementById('dev-epi').value;
            const entrega = entregas.find(e => e.id === entregaId);
            
            if (!entrega) {
                showNotification('Selecione um EPI para devolver!', 'error');
                return;
            }
            
            const devolucao = {
                dataDevolucao: document.getElementById('dev-data').value,
                motivo: document.getElementById('dev-motivo').value,
                estado: document.getElementById('dev-estado').value,
                observacoesDevolucao: document.getElementById('dev-observacoes').value,
                assinaturaDevolucao: signatureDataDevolucao,
                dataHoraDevolucao: new Date().toISOString()
            };
            
            // Marcar entrega como devolvida
            entrega.devolvido = true;
            entrega.devolucao = devolucao;
            
            // Retornar ao estoque se solicitado
            if (document.getElementById('dev-retornar').value === 'sim') {
                const epi = estoque.find(e => e.ca === entrega.numeroCA);
                if (epi) {
                    epi.quantidade += parseInt(entrega.quantidade) || 1;
                    epi.historico.push({
                        tipo: 'entrada',
                        quantidade: parseInt(entrega.quantidade) || 1,
                        data: new Date().toISOString(),
                        obs: `Devolu√ß√£o - ${entrega.trabalhador}`
                    });
                    saveEstoque();
                }
            }
            
            if (saveData()) {
                generatePDFDevolucao(entrega);
                showNotification('Devolu√ß√£o registrada! PDF gerado.', 'success');
                
                // Limpar formul√°rio
                document.getElementById('form-devolucao').reset();
                document.getElementById('dev-data').value = new Date().toISOString().split('T')[0];
                document.getElementById('dev-epi').innerHTML = '<option value="">Selecione o EPI entregue</option>';
                clearSignatureDevolucao();
                updateUI();
            }
        }
        
        function generatePDFDevolucao(entrega) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            let y = margin;
            
            // Buscar cores da empresa
            const empresaData = getEmpresaPorCNPJ(entrega.cnpj);
            const paletaKey = empresaData?.paleta || 'azul';
            const paleta = PALETAS_CORES[paletaKey] || PALETAS_CORES.azul;
            
            // Cores do tema (baseadas na empresa)
            const azulEscuro = paleta.primaria;
            const azulMedio = paleta.secundaria;
            const verde = [16, 185, 129];
            
            // Logo da empresa
            const logoEmpresa = empresaData?.logo || config.logo;
            
            // Cabe√ßalho
            doc.setFillColor(...azulEscuro);
            doc.rect(0, 0, pageWidth, 45, 'F');
            
            if (logoEmpresa) {
                try { doc.addImage(logoEmpresa, 'PNG', margin, 8, 30, 30); } catch(e) {}
            }
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('TERMO DE DEVOLU√á√ÉO DE EPI', logoEmpresa ? 55 : margin, 20);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const nomeEmpresa = empresaData?.razao || empresaData?.fantasia || entrega.empresa || config.empresa || 'Empresa n√£o configurada';
            doc.text(nomeEmpresa, logoEmpresa ? 55 : margin, 28);
            doc.text(`Emitido em: ${new Date().toLocaleString('pt-BR')}`, logoEmpresa ? 55 : margin, 35);
            
            y = 55;
            
            // Dados do funcion√°rio
            doc.setFillColor(...azulMedio);
            doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('DADOS DO TRABALHADOR', margin + 3, y + 5.5);
            y += 12;
            
            doc.setTextColor(50, 50, 50);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            doc.text(`Nome: ${entrega.trabalhador}`, margin, y);
            doc.text(`CPF: ${entrega.cpf}`, pageWidth/2, y);
            y += 6;
            doc.text(`Fun√ß√£o: ${entrega.funcao || '-'}`, margin, y);
            doc.text(`Setor: ${entrega.setor || '-'}`, pageWidth/2, y);
            y += 6;
            doc.text(`Empresa: ${entrega.empresa}`, margin, y);
            y += 12;
            
            // EPI Devolvido
            doc.setFillColor(...verde);
            doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.text('EPI DEVOLVIDO', margin + 3, y + 5.5);
            y += 12;
            
            doc.setTextColor(50, 50, 50);
            doc.setFont('helvetica', 'normal');
            doc.text(`Descri√ß√£o: ${entrega.descricaoEPI}`, margin, y);
            y += 6;
            doc.text(`CA: ${entrega.numeroCA}`, margin, y);
            doc.text(`Quantidade: ${entrega.quantidade}`, pageWidth/2, y);
            y += 6;
            doc.text(`Data da Entrega: ${formatDate(entrega.dataEntrega)}`, margin, y);
            doc.text(`Data da Devolu√ß√£o: ${formatDate(entrega.devolucao.dataDevolucao)}`, pageWidth/2, y);
            y += 6;
            
            const motivos = {
                'troca': 'Troca por desgaste/dano',
                'vencimento': 'Vencimento do CA',
                'desligamento': 'Desligamento do funcion√°rio',
                'mudanca_funcao': 'Mudan√ßa de fun√ß√£o',
                'inadequado': 'EPI inadequado',
                'outro': 'Outro'
            };
            
            const estados = {
                'bom': 'Bom estado (reutiliz√°vel)',
                'danificado': 'Danificado',
                'desgastado': 'Desgastado',
                'descarte': 'Para descarte'
            };
            
            doc.text(`Motivo: ${motivos[entrega.devolucao.motivo] || entrega.devolucao.motivo}`, margin, y);
            y += 6;
            doc.text(`Estado do EPI: ${estados[entrega.devolucao.estado] || entrega.devolucao.estado}`, margin, y);
            y += 6;
            if (entrega.devolucao.observacoesDevolucao) {
                doc.text(`Observa√ß√µes: ${entrega.devolucao.observacoesDevolucao}`, margin, y);
                y += 6;
            }
            
            y += 10;
            
            // Assinatura
            doc.setDrawColor(...azulMedio);
            doc.setLineWidth(0.5);
            doc.rect(margin, y, pageWidth - margin * 2, 45);
            
            doc.setTextColor(...azulMedio);
            doc.setFont('helvetica', 'bold');
            doc.text('CONFIRMA√á√ÉO DE DEVOLU√á√ÉO', margin + 3, y + 6);
            
            doc.setTextColor(50, 50, 50);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Declaro ter devolvido o EPI acima descrito, estando ciente de que a empresa proceder√°', margin + 3, y + 14);
            doc.text('com a destina√ß√£o adequada conforme o estado do equipamento.', margin + 3, y + 19);
            
            if (entrega.devolucao.assinaturaDevolucao) {
                try { 
                    // Fundo branco para a assinatura
                    doc.setFillColor(255, 255, 255);
                    doc.rect(margin + 5, y + 22, 52, 20, 'F');
                    doc.addImage(entrega.devolucao.assinaturaDevolucao, 'PNG', margin + 5, y + 23, 50, 18); 
                } catch(e) {}
            }
            
            const dataAssinatura = new Date(entrega.devolucao.dataHoraDevolucao);
            doc.setFontSize(8);
            doc.text(`Assinado em: ${dataAssinatura.toLocaleDateString('pt-BR')} √†s ${dataAssinatura.toLocaleTimeString('pt-BR')}`, margin + 5, y + 43);
            
            // Rodap√©
            doc.setFillColor(...azulEscuro);
            doc.rect(0, pageHeight - 20, pageWidth, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('RC Engenharia Sa√∫de e Seguran√ßa Ocupacional', pageWidth/2, pageHeight - 12, { align: 'center' });
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text('¬© 2026 - Todos os direitos reservados', pageWidth/2, pageHeight - 6, { align: 'center' });
            
            doc.save(`devolucao_epi_${entrega.cpf.replace(/\D/g, '')}_${Date.now()}.pdf`);
        }
        
        function formatDate(d) { return new Date(d + 'T00:00:00').toLocaleDateString('pt-BR'); }
        
        function showNotification(msg, type = 'success') {
            const n = document.getElementById('notification');
            n.className = `notification ${type}`;
            document.getElementById('notification-text').textContent = msg;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
