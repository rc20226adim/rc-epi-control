<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RC EPI Control - Sistema de Gest√£o de EPIs</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de Controle de EPIs - RC Engenharia">
    <meta name="theme-color" content="#1d4ed8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RC EPI">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Icons para diferentes plataformas -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231d4ed8' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>üõ°Ô∏è</text></svg>">
    
    <!-- Manifest inline via data URI -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUkMgRVBJIENvbnRyb2wgLSBTaXN0ZW1hIGRlIEdlc3TDo28gZGUgRVBJcyIsInNob3J0X25hbWUiOiJSQyBFUEkiLCJkZXNjcmlwdGlvbiI6IlNpc3RlbWEgZGUgQ29udHJvbGUgZGUgRXF1aXBhbWVudG9zIGRlIFByb3Rlw6fDo28gSW5kaXZpZHVhbCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGExNjI4IiwidGhlbWVfY29sb3IiOiIjMWQ0ZWQ4Iiwib3JpZW50YXRpb24iOiJhbnkiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHJlY3QgZmlsbD0nJTIzMWQ0ZWQ4JyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgcng9JzIwJy8+PHRleHQgeD0nNTAnIHk9JzY1JyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSd3aGl0ZSc+8J+boe+4jzwvdGV4dD48L3N2Zz4iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19">
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a1628 0%, #1e3a5f 50%, #0a1628 100%);
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
        }
        
        /* ==================== TELA DE LOGIN PROFISSIONAL ==================== */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1628 0%, #1e3a5f 50%, #0a1628 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 1rem;
        }
        
        .login-overlay.hidden { display: none; }
        
        .login-wrapper {
            display: flex;
            width: 100%;
            max-width: 1100px;
            min-height: 600px;
            background: #0f172a;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0,0,0,0.6);
            border: 1px solid #1e3a5f;
        }
        
        /* Lado Esquerdo - Apresenta√ß√£o da Empresa */
        .login-brand {
            flex: 1;
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 50%, #1e3a8a 100%);
            padding: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .login-brand::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        }
        
        .login-brand::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -30%;
            width: 80%;
            height: 80%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 50%);
        }
        
        .brand-content {
            position: relative;
            z-index: 1;
        }
        
        .brand-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .brand-logo .icon {
            width: 70px;
            height: 70px;
            background: rgba(255,255,255,0.2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            backdrop-filter: blur(10px);
        }
        
        .brand-logo h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            color: #fff;
            line-height: 1.2;
        }
        
        .brand-logo h1 span {
            display: block;
            font-size: 0.9rem;
            font-weight: 400;
            color: rgba(255,255,255,0.8);
            font-family: 'Inter', sans-serif;
        }
        
        .brand-description {
            color: rgba(255,255,255,0.9);
            font-size: 1rem;
            line-height: 1.8;
            margin-bottom: 2rem;
        }
        
        .brand-features {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .brand-feature {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: rgba(255,255,255,0.9);
            font-size: 0.95rem;
        }
        
        .brand-feature .icon {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        
        .brand-contact {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .brand-contact p {
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .brand-contact a {
            color: #fff;
            text-decoration: none;
            font-weight: 600;
        }
        
        /* Lado Direito - Formul√°rio */
        .login-container {
            flex: 1;
            max-width: 450px;
            padding: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: #0f172a;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-header h2 {
            font-size: 1.5rem;
            color: #e2e8f0;
            margin-bottom: 0.5rem;
        }
        
        .login-header p {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .login-form .form-group {
            margin-bottom: 1.25rem;
        }
        
        .login-form label {
            display: block;
            color: #94a3b8;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .login-form input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        .login-form input::placeholder {
            color: #475569;
        }
        
        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 0.5rem;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }
        
        .login-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            display: none;
        }
        
        .login-error.show { display: block; }
        
        .login-footer {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #2d4a6f;
        }
        
        .login-footer p {
            color: #64748b;
            font-size: 0.75rem;
        }
        
        /* Google Sign-In */
        .google-signin-divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            color: #64748b;
            font-size: 0.85rem;
        }
        
        .google-signin-divider::before,
        .google-signin-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #2d4a6f;
        }
        
        .google-signin-divider span {
            padding: 0 1rem;
        }
        
        .btn-google {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            background: white;
            color: #1f2937;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-google:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
        }
        
        .btn-google:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-google svg {
            width: 20px;
            height: 20px;
        }
        
        /* Sync Status Indicator */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-left: auto;
        }
        
        .sync-status.synced {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .sync-status.syncing {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
        }
        
        .sync-status.error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .sync-status.offline {
            background: rgba(100, 116, 139, 0.1);
            color: #64748b;
        }
        
        .sync-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .google-user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .google-user-info img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }
        
        .google-user-info .info {
            flex: 1;
        }
        
        .google-user-info .name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.9rem;
        }
        
        .google-user-info .email {
            color: #64748b;
            font-size: 0.75rem;
        }
        
        .google-config-section {
            background: #0f172a;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .google-config-section h4 {
            color: #60a5fa;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .user-badge {
            background: #0f172a;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        
        .user-badge .role {
            background: #2563eb;
            color: #fff;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .user-badge .role.dev {
            background: #10b981;
        }
        
        .btn-logout {
            background: #ef4444;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-logout:hover {
            background: #dc2626;
        }
        
        .dev-only { display: none; }
        .is-dev .dev-only { display: block; }
        .is-dev .dev-only-inline { display: inline-flex; }
        
        /* Bot√£o Instalar App */
        .install-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }
        
        .install-btn.show { display: inline-flex; }
        
        .header {
            background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%);
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: #0f172a;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
        }
        
        .logo span {
            display: block;
            font-size: 0.85rem;
            color: #bfdbfe;
            opacity: 0.9;
        }
        
        .stats-badges {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .stats-badge {
            background: #0f172a;
            padding: 0.75rem 1.25rem;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: #60a5fa;
        }
        
        .stats-badge.bio { color: #10b981; }
        
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            padding: 1.5rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 0.875rem 1.5rem;
            border: none;
            background: #1e3a5f;
            color: #94a3b8;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-tab:hover { background: #2563eb; color: #e2e8f0; }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: #ffffff;
        }
        
        .main-content {
            padding: 0 2rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background: #1e3a5f;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 1px solid #2d4a6f;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #2d4a6f;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group.full-width { grid-column: 1 / -1; }
        
        .field-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .field-input {
            padding: 0.875rem 1rem;
            background: #0f172a;
            border: 2px solid #2d4a6f;
            border-radius: 10px;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .field-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        .field-input::placeholder { color: #64748b; }
        
        textarea.field-input { resize: vertical; min-height: 80px; }
        
        /* Biometria */
        .biometria-section {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%);
            border: 2px solid #2d4a6f;
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .biometria-section.success { border-color: #10b981; }
        
        .biometria-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .camera-video {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1);
        }
        
        .face-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 220px;
            border: 3px dashed #2563eb;
            border-radius: 50%;
            opacity: 0.7;
            pointer-events: none;
        }
        
        .camera-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .photo-options {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .photo-option {
            background: #0f172a;
            border: 2px solid #2d4a6f;
            border-radius: 12px;
            padding: 1.25rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 120px;
            max-width: 160px;
        }
        
        .photo-option:hover {
            border-color: #2563eb;
            background: #1e3a5f;
        }
        
        .photo-option svg {
            margin-bottom: 0.5rem;
            color: #2563eb;
            width: 36px;
            height: 36px;
        }
        
        .photo-option p {
            font-size: 0.85rem;
            color: #e2e8f0;
            font-weight: 500;
        }
        
        .photo-option small {
            font-size: 0.7rem;
            color: #64748b;
            display: block;
            margin-top: 0.25rem;
        }
        
        .photo-preview-area {
            text-align: center;
            padding: 1rem;
        }
        
        .photo-preview-area img {
            max-width: 200px;
            max-height: 250px;
            border-radius: 12px;
            border: 3px solid #10b981;
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: #fca5a5;
            font-size: 0.9rem;
        }
        
        .error-message strong {
            display: block;
            margin-bottom: 0.5rem;
            color: #ef4444;
        }
        
        .signature-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #2d4a6f;
        }
        
        .signature-canvas {
            border: 2px solid #2d3748;
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none;
            width: 100%;
            max-width: 500px;
            height: 150px;
            background: #fff;
            display: block;
        }
        
        .signature-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .btn-primary, .btn-secondary, .btn-danger, .btn-success {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: #ffffff;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }
        
        .btn-secondary {
            background: #2d4a6f;
            color: #e2e8f0;
        }
        
        .btn-secondary:hover { background: #3d5a7f; }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-submit {
            margin-top: 2rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 400px;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .signature-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: #0f172a;
            border-radius: 8px;
            border: 2px solid #10b981;
            display: none;
        }
        
        .signature-preview.show { display: block; }
        
        .signature-preview img {
            max-width: 200px;
            border-radius: 4px;
        }
        
        /* Logo Upload */
        .logo-upload-section {
            background: #0f172a;
            border: 2px dashed #2d4a6f;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 1.5rem;
        }
        
        .logo-upload-section:hover { border-color: #2563eb; }
        .logo-upload-section.has-logo { border-style: solid; border-color: #10b981; }
        
        .logo-preview {
            max-width: 200px;
            max-height: 80px;
            margin: 1rem auto;
            display: block;
            border-radius: 8px;
        }
        
        /* Funcion√°rios */
        .funcionario-card {
            background: #0f172a;
            border: 1px solid #2d4a6f;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .funcionario-card:hover { border-color: #2563eb; }
        
        .funcionario-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .funcionario-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .funcionario-photo {
            width: 60px;
            height: 75px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #10b981;
        }
        
        .funcionario-photo.no-photo {
            background: #2d4a6f;
            display: flex;
            align-items: center;
            justify-content: center;
            border-color: #2d4a6f;
        }
        
        .funcionario-details h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 0.25rem;
        }
        
        .funcionario-details p {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: #94a3b8;
        }
        
        .funcionario-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: #1e3a5f;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-item .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: #2563eb;
        }
        
        .stat-item .label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
        }
        
        .funcionario-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .entregas-list {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #2d4a6f;
        }
        
        .entrega-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #1e3a5f;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .badge-ca {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge-bio {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .search-wrapper {
            position: relative;
            flex: 1;
            min-width: 250px;
        }
        
        .search-input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 2.75rem;
            background: #0f172a;
            border: 2px solid #2d4a6f;
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 1rem;
        }
        
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }
        
        .filter-select {
            padding: 0.875rem 1rem;
            background: #0f172a;
            border: 2px solid #2d4a6f;
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 1rem;
            min-width: 200px;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }
        
        .empty-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: #2d4a6f;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .notification.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-overlay.show { display: flex; }
        
        .modal-content {
            background: #1e3a5f;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 2px solid #2d4a6f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-family: 'JetBrains Mono', monospace;
            color: #2563eb;
        }
        
        .modal-body { padding: 2rem; }
        
        .action-btn {
            padding: 0.5rem;
            border: none;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 6px;
        }
        
        .action-btn:hover { background: #2d4a6f; color: #e2e8f0; }
        
        .hidden { display: none !important; }
        
        .info-box {
            background: #0f172a;
            border-left: 4px solid #8b5cf6;
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin-bottom: 1.5rem;
        }
        
        .info-box p { color: #94a3b8; font-size: 0.9rem; }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #0f172a;
            border: 2px solid #2d4a6f;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }
        
        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #2d4a6f;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .autocomplete-item:hover { background: #2d4a6f; }
        
        .autocomplete-item img {
            width: 40px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        /* Hist√≥rico com assinatura */
        .historico-item {
            background: #0f172a;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #2563eb;
        }
        
        .historico-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .historico-epi {
            font-weight: 600;
            color: #e2e8f0;
            font-size: 1rem;
        }
        
        .historico-data {
            background: #2d4a6f;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            color: #94a3b8;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .historico-detalhes {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .historico-assinatura {
            background: #1e3a5f;
            border-radius: 8px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .historico-assinatura img {
            max-width: 150px;
            max-height: 50px;
            border-radius: 4px;
            background: white;
            padding: 4px;
        }
        
        .historico-assinatura-info {
            font-size: 0.8rem;
            color: #64748b;
        }
        
        .historico-assinatura-info strong {
            color: #10b981;
            display: block;
        }
        
        /* Estoque */
        .estoque-card {
            background: #0f172a;
            border: 1px solid #2d4a6f;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .estoque-card:hover { border-color: #2563eb; }
        
        .estoque-card.baixo {
            border-left: 4px solid #ef4444;
            background: linear-gradient(90deg, rgba(239,68,68,0.1) 0%, #0f172a 20%);
        }
        
        .estoque-card.zerado {
            border-left: 4px solid #64748b;
            opacity: 0.7;
        }
        
        .estoque-card.ok {
            border-left: 4px solid #10b981;
        }
        
        .estoque-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .estoque-info h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 0.25rem;
        }
        
        .estoque-info p {
            font-size: 0.85rem;
            color: #64748b;
        }
        
        .estoque-numeros {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        
        .estoque-numero {
            text-align: center;
        }
        
        .estoque-numero .valor {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .estoque-numero .valor.ok { color: #10b981; }
        .estoque-numero .valor.baixo { color: #ef4444; }
        .estoque-numero .valor.zerado { color: #64748b; }
        
        .estoque-numero .label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
        }
        
        .estoque-barra {
            height: 8px;
            background: #2d4a6f;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .estoque-barra-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .estoque-barra-fill.ok { background: linear-gradient(90deg, #10b981, #059669); }
        .estoque-barra-fill.baixo { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .estoque-barra-fill.zerado { background: #64748b; }
        
        .estoque-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-small.entrada {
            background: #10b981;
            color: white;
        }
        
        .btn-small.saida {
            background: #2563eb;
            color: #1e3a5f;
        }
        
        .btn-small.editar {
            background: #3b82f6;
            color: white;
        }
        
        .btn-small.excluir {
            background: #ef4444;
            color: white;
        }
        
        .badge-validade {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .badge-validade.vencido {
            background: #ef4444;
            color: white;
        }
        
        .badge-validade.proximo {
            background: #2563eb;
            color: #1e3a5f;
        }
        
        .badge-validade.ok {
            background: #10b981;
            color: white;
        }
        
        /* Responsividade da Tela de Login */
        @media (max-width: 900px) {
            .login-wrapper {
                flex-direction: column;
                max-width: 500px;
                min-height: auto;
            }
            
            .login-brand {
                padding: 2rem;
            }
            
            .brand-description {
                display: none;
            }
            
            .brand-features {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .brand-feature {
                font-size: 0.8rem;
            }
            
            .brand-feature .icon {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }
            
            .brand-contact {
                display: none;
            }
            
            .login-container {
                padding: 2rem;
                max-width: 100%;
            }
        }
        
        @media (max-width: 500px) {
            .login-overlay {
                padding: 0;
            }
            
            .login-wrapper {
                border-radius: 0;
                min-height: 100vh;
            }
            
            .login-brand {
                padding: 1.5rem;
            }
            
            .brand-logo .icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .brand-logo h1 {
                font-size: 1.25rem;
            }
            
            .login-container {
                padding: 1.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .header-content { flex-direction: column; }
            .nav-tabs { padding: 1rem; }
            .main-content { padding: 0 1rem 1rem; }
            .card { padding: 1.5rem; }
        }
    </style>
    
    <!-- Google API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
    <!-- Tela de Login Profissional -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-wrapper">
            <!-- Lado Esquerdo - Apresenta√ß√£o da Empresa -->
            <div class="login-brand">
                <div class="brand-content">
                    <div class="brand-logo">
                        <div class="icon">üõ°Ô∏è</div>
                        <h1>
                            RC Engenharia
                            <span>Sa√∫de e Seguran√ßa do Trabalho</span>
                        </h1>
                    </div>
                    
                    <p class="brand-description">
                        Somos uma empresa especializada em <strong>Seguran√ßa e Sa√∫de Ocupacional</strong>, 
                        oferecendo solu√ß√µes completas para proteger o que h√° de mais valioso: a vida dos trabalhadores.
                        <br><br>
                        Com profissionais qualificados e tecnologia de ponta, garantimos conformidade legal 
                        e ambientes de trabalho mais seguros para sua empresa.
                    </p>
                    
                    <div class="brand-features">
                        <div class="brand-feature">
                            <div class="icon">üìã</div>
                            <span>PGR / GRO / PCMSO</span>
                        </div>
                        <div class="brand-feature">
                            <div class="icon">üéì</div>
                            <span>Treinamentos NRs</span>
                        </div>
                        <div class="brand-feature">
                            <div class="icon">üìä</div>
                            <span>LTCAT / PPP</span>
                        </div>
                        <div class="brand-feature">
                            <div class="icon">üî•</div>
                            <span>Brigada de Inc√™ndio</span>
                        </div>
                        <div class="brand-feature">
                            <div class="icon">‚öñÔ∏è</div>
                            <span>Per√≠cias T√©cnicas</span>
                        </div>
                        <div class="brand-feature">
                            <div class="icon">ü¶∫</div>
                            <span>Gest√£o de EPIs</span>
                        </div>
                    </div>
                    
                    <div class="brand-contact">
                        <p>üìç Maranguape - CE</p>
                        <p>üìß <a href="mailto:contato@rcengenhariasst.com">contato@rcengenhariasst.com</a></p>
                        <p>üì± <a href="tel:+5585992728108">(85) 99272-8108</a></p>
                    </div>
                </div>
            </div>
            
            <!-- Lado Direito - Formul√°rio de Login -->
            <div class="login-container">
                <div class="login-header">
                    <h2>üîê Acesso ao Sistema</h2>
                    <p>RC EPI Control - Gest√£o de Equipamentos</p>
                </div>
                
                <div id="login-error" class="login-error">
                    Usu√°rio ou senha incorretos
                </div>
                
                <form class="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>E-mail ou Usu√°rio</label>
                        <input type="text" id="login-user" placeholder="Digite seu e-mail ou usu√°rio" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="login-pass" placeholder="Digite sua senha" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="login-btn">
                        üîê Entrar no Sistema
                    </button>
                </form>
                
                <!-- Google Sign-In -->
                <div class="google-signin-divider">
                    <span>ou entre com</span>
                </div>
                
                <button type="button" class="btn-google" onclick="handleGoogleSignIn()" id="btn-google-signin">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    Entrar com Google
                </button>
                
                <!-- Login por E-mail Firebase -->
                <div id="email-login-section" style="margin-top:1rem;">
                    <button type="button" onclick="toggleEmailLogin()" style="width:100%;padding:0.75rem;background:#1e293b;border:1px solid #334155;border-radius:8px;color:#60a5fa;font-size:0.9rem;cursor:pointer;">
                        ‚úâÔ∏è Entrar com E-mail
                    </button>
                    
                    <div id="email-login-form" style="display:none;margin-top:1rem;padding:1rem;background:#1e293b;border-radius:8px;border:1px solid #334155;">
                        <div class="form-group" style="margin-bottom:1rem;">
                            <label style="display:block;color:#94a3b8;font-size:0.85rem;margin-bottom:0.5rem;">E-mail</label>
                            <input type="email" id="firebase-email" placeholder="seu@email.com" style="width:100%;padding:0.75rem;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;font-size:1rem;">
                        </div>
                        <div class="form-group" style="margin-bottom:1rem;">
                            <label style="display:block;color:#94a3b8;font-size:0.85rem;margin-bottom:0.5rem;">Senha</label>
                            <input type="password" id="firebase-password" placeholder="Sua senha" style="width:100%;padding:0.75rem;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;font-size:1rem;">
                        </div>
                        <div id="firebase-login-error" style="color:#ef4444;font-size:0.85rem;margin-bottom:1rem;display:none;"></div>
                        <div style="display:flex;gap:0.5rem;">
                            <button type="button" onclick="loginComEmail()" style="flex:1;padding:0.75rem;background:#2563eb;border:none;border-radius:8px;color:white;font-size:0.9rem;cursor:pointer;font-weight:600;">
                                üîê Entrar
                            </button>
                            <button type="button" onclick="criarContaEmail()" style="flex:1;padding:0.75rem;background:#10b981;border:none;border-radius:8px;color:white;font-size:0.9rem;cursor:pointer;font-weight:600;">
                                ‚ûï Criar Conta
                            </button>
                        </div>
                        <button type="button" onclick="recuperarSenha()" style="width:100%;margin-top:0.5rem;padding:0.5rem;background:transparent;border:none;color:#64748b;font-size:0.8rem;cursor:pointer;">
                            Esqueceu a senha?
                        </button>
                    </div>
                </div>
                
                <p style="color:#64748b;font-size:0.75rem;text-align:center;margin-top:1rem;">
                    ‚òÅÔ∏è Seus dados s√£o sincronizados na nuvem
                </p>
                
                <div style="margin-top:1.5rem;padding-top:1rem;border-top:1px solid #334155;">
                    <p style="color:#64748b;font-size:0.8rem;text-align:center;margin-bottom:0.75rem;">
                        üì± Primeiro acesso neste dispositivo?
                    </p>
                    <button type="button" onclick="document.getElementById('import-sync-login').click()" style="width:100%;padding:0.75rem;background:#1e293b;border:1px solid #334155;border-radius:8px;color:#60a5fa;font-size:0.9rem;cursor:pointer;">
                        üì• Importar Dados de Outro Dispositivo
                    </button>
                    <input type="file" id="import-sync-login" accept=".json" style="display:none" onchange="importarSincronizacaoLogin(event)">
                </div>
                
                <div class="login-footer" style="text-align:center;margin-top:1.5rem;padding-top:1rem;border-top:1px solid #334155;">
                    <p style="color:#64748b;font-size:0.75rem;">¬© 2026 RC Engenharia SST</p>
                    <p style="color:#475569;font-size:0.7rem;">Todos os direitos reservados</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifica√ß√£o -->
    <div id="notification" class="notification success">
        <span id="notification-text"></span>
    </div>

    <!-- Header -->
    <header class="header" id="main-header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                </div>
                <div>
                    <h1>RC EPI CONTROL</h1>
                    <span>Sistema de Gest√£o de EPIs</span>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
                <button id="install-btn" class="install-btn" onclick="installApp()">
                    üì≤ Instalar App
                </button>
                <div class="stats-badges">
                    <div class="stats-badge">
                        <span id="stats-count">0</span> entregas
                    </div>
                    <div class="stats-badge bio">
                        <span id="stats-bio">0</span> funcion√°rios
                    </div>
                    <div class="stats-badge" id="badge-estoque-baixo" style="display:none;color:#ef4444;">
                        <span id="stats-estoque-baixo">0</span> estoque baixo
                    </div>
                </div>
                
                <!-- Sync Status -->
                <div id="sync-status" class="sync-status offline" style="display:none;">
                    <span id="sync-icon">‚òÅÔ∏è</span>
                    <span id="sync-text">Offline</span>
                </div>
                
                <div class="user-badge">
                    <span>üë§</span>
                    <span id="logged-user">Usu√°rio</span>
                    <span id="user-role" class="role">USER</span>
                </div>
                <button class="btn-logout" onclick="handleLogout()">Sair</button>
            </div>
        </div>
    </header>

    <!-- Navega√ß√£o -->
    <nav class="nav-tabs">
        <button class="nav-tab active" data-tab="cadastro" onclick="showTab('cadastro')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
            </svg>
            Entrega
        </button>
        <button class="nav-tab" data-tab="devolucao" onclick="showTab('devolucao')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
            </svg>
            Devolu√ß√£o
        </button>
        <button class="nav-tab" data-tab="estoque" onclick="showTab('estoque')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                <path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/>
            </svg>
            Estoque
        </button>
        <button class="nav-tab" data-tab="funcionarios" onclick="showTab('funcionarios')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
            </svg>
            Funcion√°rios
        </button>
        <button class="nav-tab" data-tab="empresas" onclick="showTab('empresas')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 21h18"/>
                <path d="M5 21V7l8-4v18"/>
                <path d="M19 21V11l-6-4"/>
                <path d="M9 9h1M9 13h1M9 17h1"/>
            </svg>
            Empresas
        </button>
        <button class="nav-tab" data-tab="config" onclick="showTab('config')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
            Config
        </button>
    </nav>

    <!-- Conte√∫do Principal -->
    <main class="main-content">
        <!-- Tab Cadastro -->
        <div id="tab-cadastro" class="card">
            <h2 class="card-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    <path d="M20 8v6M23 11h-6"/>
                </svg>
                Registrar Entrega de EPI
            </h2>
            
            <!-- Banner de Sincroniza√ß√£o -->
            <div id="sync-banner" class="info-box hidden" style="border-left-color:#f59e0b;background:rgba(245,158,11,0.1);margin-bottom:1rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;">
                    <div>
                        <p style="font-weight:600;color:#f59e0b;">üîÑ Novo dispositivo detectado</p>
                        <p style="font-size:0.85rem;color:#94a3b8;">Se voc√™ j√° tem dados em outro dispositivo, importe o arquivo de sincroniza√ß√£o.</p>
                    </div>
                    <div style="display:flex;gap:0.5rem;">
                        <button type="button" class="btn-primary" onclick="document.getElementById('import-sync-banner').click()" style="background:#f59e0b;">
                            üì• Importar Dados
                        </button>
                        <button type="button" class="btn-secondary" onclick="fecharBannerSync()" style="padding:0.5rem;">
                            ‚úï
                        </button>
                    </div>
                </div>
                <input type="file" id="import-sync-banner" accept=".json" style="display:none" onchange="importarSincronizacao(event)">
            </div>
            
            <div class="info-box">
                <p>‚úçÔ∏è <strong>Assinatura por Entrega:</strong> Cada EPI entregue ter√° sua pr√≥pria assinatura com data e hora registradas no PDF.</p>
            </div>
            
            <form id="form-epi" onsubmit="handleSubmit(event)">
                <div class="form-grid">
                    <div class="form-group" style="position: relative;">
                        <label class="field-label">CPF do Trabalhador *</label>
                        <input type="text" id="cpf" class="field-input" placeholder="000.000.000-00" oninput="formatCPF(this); searchFuncionario(this.value)" required>
                        <div id="autocomplete-list" class="autocomplete-list hidden"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Nome do Trabalhador *</label>
                        <input type="text" id="trabalhador" class="field-input" placeholder="Nome completo" required>
                    </div>
                    
                    <div class="form-group" style="position:relative;">
                        <label class="field-label">Empresa *</label>
                        <input type="text" id="empresa" class="field-input" placeholder="Digite ou selecione uma empresa" oninput="buscarEmpresa(this.value)" onfocus="mostrarEmpresas()" required autocomplete="off">
                        <div id="autocomplete-empresa" class="autocomplete-list hidden"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">CNPJ *</label>
                        <input type="text" id="cnpj" class="field-input" placeholder="00.000.000/0000-00" oninput="formatCNPJ(this)" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Fun√ß√£o/Cargo</label>
                        <input type="text" id="funcao" class="field-input" placeholder="Ex: Operador de M√°quinas">
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Setor</label>
                        <input type="text" id="setor" class="field-input" placeholder="Ex: Produ√ß√£o">
                    </div>
                    
                    <div class="form-group" style="position:relative;">
                        <label class="field-label">Descri√ß√£o do EPI *</label>
                        <div style="position:relative;">
                            <input type="text" id="descricaoEPI" class="field-input" placeholder="Digite ou selecione do estoque..." oninput="buscarEPIEstoque(this.value)" onfocus="mostrarEPIsEstoque()" required>
                            <button type="button" onclick="mostrarTodosEPIs()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:#2563eb;border:none;border-radius:6px;padding:0.4rem 0.6rem;cursor:pointer;color:#1e3a5f;font-size:0.75rem;font-weight:600;" title="Ver EPIs do estoque">
                                üì¶ Estoque
                            </button>
                        </div>
                        <div id="autocomplete-epi" class="autocomplete-list hidden" style="max-height:250px;"></div>
                        <small id="dica-estoque" style="color:#64748b;font-size:0.75rem;">üí° Cadastre EPIs na aba <strong>Estoque</strong> para selecionar automaticamente</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">N√∫mero do CA *</label>
                        <input type="text" id="numeroCA" class="field-input" placeholder="Ex: 12345" required>
                        <small id="estoque-disponivel" style="color:#64748b;font-size:0.75rem;"></small>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Data da Entrega *</label>
                        <input type="date" id="dataEntrega" class="field-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Quantidade</label>
                        <input type="number" id="quantidade" class="field-input" value="1" min="1">
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="field-label">Observa√ß√µes</label>
                        <textarea id="observacoes" class="field-input" placeholder="Informa√ß√µes adicionais..."></textarea>
                    </div>
                </div>
                
                <!-- Se√ß√£o de Foto -->
                <div class="biometria-section" id="biometria-section">
                    <div class="biometria-title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                        Foto do Trabalhador (Opcional)
                    </div>
                    
                    <div id="photo-options">
                        <div class="photo-options">
                            <div class="photo-option" onclick="startCamera()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                                    <circle cx="12" cy="13" r="4"/>
                                </svg>
                                <p>Usar Webcam</p>
                                <small>C√¢mera do PC</small>
                            </div>
                            
                            <div class="photo-option" onclick="document.getElementById('photo-upload-camera').click()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="2" y="3" width="20" height="14" rx="2"/>
                                    <line x1="8" y1="21" x2="16" y2="21"/>
                                    <line x1="12" y1="17" x2="12" y2="21"/>
                                </svg>
                                <p>üì± Celular</p>
                                <small>Tirar foto agora</small>
                            </div>
                            
                            <div class="photo-option" onclick="document.getElementById('photo-upload').click()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <path d="M21 15l-5-5L5 21"/>
                                </svg>
                                <p>Galeria</p>
                                <small>Foto existente</small>
                            </div>
                        </div>
                        <!-- Input para c√¢mera do celular (abre c√¢mera diretamente) -->
                        <input type="file" id="photo-upload-camera" accept="image/*" capture="user" style="display: none" onchange="handlePhotoUpload(event)">
                        <!-- Input para galeria/arquivos -->
                        <input type="file" id="photo-upload" accept="image/*" style="display: none" onchange="handlePhotoUpload(event)">
                    </div>
                    
                    <div id="camera-area" class="hidden">
                        <div class="camera-container" id="camera-container">
                            <video id="camera-video" class="camera-video" autoplay playsinline muted></video>
                            <div class="face-guide"></div>
                        </div>
                        
                        <div id="camera-error" class="error-message hidden">
                            <strong>‚ö†Ô∏è Erro na c√¢mera</strong>
                            <span id="camera-error-text"></span>
                            <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(239,68,68,0.3);">
                                <p style="margin-bottom:0.75rem;color:#e2e8f0;font-weight:500;">Use uma destas alternativas:</p>
                                <button type="button" onclick="cancelCamera();document.getElementById('photo-upload-camera').click();" class="btn-success" style="width:100%;margin-bottom:0.5rem;">
                                    üì± Tirar Foto com Celular
                                </button>
                                <button type="button" onclick="cancelCamera();document.getElementById('photo-upload').click();" class="btn-secondary" style="width:100%;margin-bottom:0.5rem;">
                                    üìÅ Selecionar da Galeria
                                </button>
                            </div>
                        </div>
                        
                        <div class="camera-buttons">
                            <button type="button" class="btn-success" id="btn-capture" onclick="capturePhoto()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                Capturar Foto
                            </button>
                            <button type="button" class="btn-secondary" onclick="cancelCamera()">Cancelar</button>
                        </div>
                    </div>
                    
                    <div id="photo-preview-area" class="photo-preview-area hidden">
                        <img id="captured-photo" src="" alt="Foto">
                        <p style="color: #10b981; margin-top: 0.75rem; font-weight: 500;">‚úì Foto capturada</p>
                        <button type="button" class="btn-secondary" onclick="removePhoto()" style="margin-top: 0.5rem;">Remover</button>
                    </div>
                    
                    <canvas id="camera-canvas" style="display: none;"></canvas>
                </div>
                
                <div class="signature-container">
                    <label class="field-label">Assinatura do Trabalhador * (ser√° vinculada a esta entrega)</label>
                    <canvas id="signature-canvas" class="signature-canvas" width="500" height="150"></canvas>
                    <div class="signature-buttons">
                        <button type="button" class="btn-secondary" onclick="clearSignature()">Limpar</button>
                        <button type="button" class="btn-primary" onclick="confirmSignature()">Confirmar Assinatura</button>
                    </div>
                </div>
                
                <div id="signature-preview" class="signature-preview">
                    <p style="font-size: 0.85rem; color: #10b981; margin-bottom: 0.5rem; font-weight: 600;">
                        ‚úì Assinatura confirmada - ser√° registrada com data e hora
                    </p>
                    <img id="signature-img" src="" alt="Assinatura">
                </div>
                
                <button type="submit" class="btn-submit">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                    </svg>
                    REGISTRAR E GERAR PDF
                </button>
            </form>
        </div>

        <!-- Tab Devolu√ß√£o -->
        <div id="tab-devolucao" class="card hidden">
            <h2 class="card-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
                Devolu√ß√£o de EPI
            </h2>
            
            <div class="info-box" style="border-left-color:#10b981;">
                <p>üîÑ Registre aqui a devolu√ß√£o de EPIs pelo funcion√°rio (troca, desligamento, fim da vida √∫til, etc.)</p>
            </div>
            
            <form id="form-devolucao" onsubmit="handleDevolucao(event)">
                <div class="form-grid">
                    <div class="form-group" style="position: relative;">
                        <label class="field-label">CPF do Trabalhador *</label>
                        <input type="text" id="dev-cpf" class="field-input" placeholder="000.000.000-00" oninput="formatCPF(this); buscarFuncionarioDevolucao(this.value)" required>
                        <div id="autocomplete-devolucao" class="autocomplete-list hidden"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Nome do Trabalhador</label>
                        <input type="text" id="dev-trabalhador" class="field-input" placeholder="Selecione pelo CPF" readonly>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="field-label">EPI a Devolver *</label>
                        <select id="dev-epi" class="field-input" required onchange="selecionarEPIDevolucao()">
                            <option value="">Selecione o EPI entregue</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Data da Devolu√ß√£o *</label>
                        <input type="date" id="dev-data" class="field-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Motivo da Devolu√ß√£o *</label>
                        <select id="dev-motivo" class="field-input" required>
                            <option value="">Selecione o motivo</option>
                            <option value="troca">Troca por desgaste/dano</option>
                            <option value="vencimento">Vencimento do CA</option>
                            <option value="desligamento">Desligamento do funcion√°rio</option>
                            <option value="mudanca_funcao">Mudan√ßa de fun√ß√£o</option>
                            <option value="inadequado">EPI inadequado</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Estado do EPI</label>
                        <select id="dev-estado" class="field-input">
                            <option value="bom">Bom estado (reutiliz√°vel)</option>
                            <option value="danificado">Danificado</option>
                            <option value="desgastado">Desgastado</option>
                            <option value="descarte">Para descarte</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Retornar ao Estoque?</label>
                        <select id="dev-retornar" class="field-input">
                            <option value="nao">N√£o</option>
                            <option value="sim">Sim</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="field-label">Observa√ß√µes</label>
                        <textarea id="dev-observacoes" class="field-input" placeholder="Informa√ß√µes adicionais sobre a devolu√ß√£o..."></textarea>
                    </div>
                </div>
                
                <div class="signature-container">
                    <label class="field-label">Assinatura do Trabalhador (Confirmando Devolu√ß√£o) *</label>
                    <canvas id="signature-devolucao" class="signature-canvas" width="500" height="150"></canvas>
                    <div class="signature-buttons">
                        <button type="button" class="btn-secondary" onclick="clearSignatureDevolucao()">Limpar</button>
                        <button type="button" class="btn-primary" onclick="confirmSignatureDevolucao()">Confirmar Assinatura</button>
                    </div>
                </div>
                
                <div id="signature-preview-dev" class="signature-preview">
                    <p style="font-size: 0.85rem; color: #10b981; margin-bottom: 0.5rem; font-weight: 600;">
                        ‚úì Assinatura confirmada
                    </p>
                    <img id="signature-img-dev" src="" alt="Assinatura">
                </div>
                
                <button type="submit" class="btn-submit" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                    </svg>
                    REGISTRAR DEVOLU√á√ÉO
                </button>
            </form>
        </div>

        <!-- Tab Estoque -->
        <div id="tab-estoque" class="card hidden">
            <h2 class="card-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                </svg>
                Gest√£o de Estoque de EPIs
            </h2>
            
            <!-- Filtro por Empresa -->
            <div class="info-box" style="border-left-color:#2563eb;margin-bottom:1.5rem;">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
                    <div>
                        <p style="font-weight:600;margin-bottom:0.25rem;">üè¢ Estoque por Empresa</p>
                        <p style="font-size:0.85rem;color:#64748b;">Cada empresa possui seu pr√≥prio estoque de EPIs</p>
                    </div>
                    <select id="estoque-empresa-select" class="field-input" style="max-width:300px;" onchange="filtrarEstoquePorEmpresa()">
                        <option value="">Selecione uma empresa...</option>
                    </select>
                </div>
            </div>
            
            <!-- Resumo do Estoque -->
            <div id="estoque-resumo" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1.5rem;">
                <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:#2563eb;font-family:'JetBrains Mono',monospace;" id="total-itens-estoque">0</div>
                    <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Itens Cadastrados</div>
                </div>
                <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:#10b981;font-family:'JetBrains Mono',monospace;" id="total-em-estoque">0</div>
                    <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Total em Estoque</div>
                </div>
                <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:#ef4444;font-family:'JetBrains Mono',monospace;" id="itens-abaixo-minimo">0</div>
                    <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Abaixo do M√≠nimo</div>
                </div>
            </div>
            
            <!-- Aviso sem empresa selecionada -->
            <div id="estoque-sem-empresa" style="background:#0f172a;border-radius:12px;padding:2rem;text-align:center;margin-bottom:1.5rem;">
                <div style="font-size:3rem;margin-bottom:1rem;">üè¢</div>
                <h3 style="color:#e2e8f0;margin-bottom:0.5rem;">Selecione uma Empresa</h3>
                <p style="color:#64748b;">Para gerenciar o estoque, primeiro selecione a empresa acima.</p>
            </div>
            
            <!-- Alertas de Estoque Baixo -->
            <div id="alertas-estoque" class="hidden" style="background:rgba(239,68,68,0.1);border:1px solid #ef4444;border-radius:10px;padding:1rem;margin-bottom:1.5rem;">
                <h4 style="color:#ef4444;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    EPIs com Estoque Baixo
                </h4>
                <div id="lista-alertas"></div>
            </div>
            
            <!-- Formul√°rio de Cadastro de EPI -->
            <div id="form-estoque-container" class="hidden" style="background:#0f172a;border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;">
                <h3 style="color:#2563eb;margin-bottom:1rem;font-size:1rem;">Cadastrar Novo EPI no Estoque</h3>
                <form id="form-estoque" onsubmit="cadastrarEPIEstoque(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="field-label">Descri√ß√£o do EPI *</label>
                            <input type="text" id="est-descricao" class="field-input" placeholder="Ex: Capacete de Seguran√ßa" required>
                        </div>
                        <div class="form-group">
                            <label class="field-label">N√∫mero do CA *</label>
                            <input type="text" id="est-ca" class="field-input" placeholder="Ex: 12345" required>
                        </div>
                        <div class="form-group">
                            <label class="field-label">Quantidade Inicial *</label>
                            <input type="number" id="est-quantidade" class="field-input" placeholder="0" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="field-label">Estoque de Seguran√ßa *</label>
                            <input type="number" id="est-minimo" class="field-input" placeholder="Qtd m√≠nima" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="field-label">Unidade</label>
                            <select id="est-unidade" class="field-input">
                                <option value="UN">Unidade (UN)</option>
                                <option value="PAR">Par (PAR)</option>
                                <option value="CX">Caixa (CX)</option>
                                <option value="PCT">Pacote (PCT)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="field-label">Validade do CA</label>
                            <input type="date" id="est-validade" class="field-input">
                        </div>
                    </div>
                    <button type="submit" class="btn-success" style="margin-top:1rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Cadastrar EPI
                    </button>
                </form>
            </div>
            
            <!-- Busca e Filtros -->
            <div class="search-bar">
                <div class="search-wrapper">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" id="busca-estoque" class="search-input" placeholder="Buscar EPI..." oninput="filtrarEstoque()">
                </div>
                <select id="filtro-estoque" class="filter-select" onchange="filtrarEstoque()">
                    <option value="">Todos</option>
                    <option value="baixo">Estoque Baixo</option>
                    <option value="ok">Estoque OK</option>
                    <option value="zerado">Zerado</option>
                </select>
            </div>
            
            <!-- Lista de EPIs -->
            <div id="lista-estoque"></div>
            
            <div id="empty-estoque" class="empty-state hidden">
                <div class="empty-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="1.5">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                    </svg>
                </div>
                <h3>Nenhum EPI cadastrado</h3>
                <p>Cadastre EPIs para controlar o estoque</p>
            </div>
        </div>

        <!-- Tab Funcion√°rios -->
        <div id="tab-funcionarios" class="card hidden">
            <h2 class="card-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                </svg>
                Funcion√°rios e Hist√≥rico
            </h2>
            
            <div class="search-bar">
                <div class="search-wrapper">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" id="search-funcionario" class="search-input" placeholder="Buscar..." oninput="filterFuncionarios()">
                </div>
                
                <select id="filter-empresa" class="filter-select" onchange="filterFuncionarios()">
                    <option value="">Todas as empresas</option>
                </select>
                
                <button class="btn-primary" onclick="exportAllToCSV()">Exportar CSV</button>
            </div>
            
            <div id="funcionarios-list"></div>
            
            <div id="empty-state-func" class="empty-state hidden">
                <div class="empty-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                    </svg>
                </div>
                <h3>Nenhum funcion√°rio encontrado</h3>
                <p style="color:#94a3b8;font-size:0.9rem;margin-top:0.5rem;max-width:400px;">
                    Se voc√™ j√° tem dados em outro dispositivo, importe o arquivo de sincroniza√ß√£o.
                </p>
                <div style="display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap;justify-content:center;">
                    <button class="btn-primary" onclick="document.getElementById('import-sync-func').click()">
                        üì• Importar Dados
                    </button>
                    <button class="btn-secondary" onclick="showTab('cadastro')">
                        ‚ûï Cadastrar Entrega
                    </button>
                </div>
                <input type="file" id="import-sync-func" accept=".json" style="display:none" onchange="importarSincronizacao(event)">
            </div>
        </div>

        <!-- Tab Empresas -->
        <div id="tab-empresas" class="card hidden">
            <h2 class="card-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 21h18"/>
                    <path d="M5 21V7l8-4v18"/>
                    <path d="M19 21V11l-6-4"/>
                </svg>
                Cadastro de Empresas
            </h2>
            
            <!-- Seletor de Empresa Ativa -->
            <div class="info-box" style="border-left-color:#2563eb;margin-bottom:1.5rem;">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
                    <div>
                        <p style="font-weight:600;margin-bottom:0.25rem;">üè¢ Empresa Ativa</p>
                        <p style="font-size:0.85rem;color:#64748b;">Selecione a empresa para visualizar entregas e gerar PDFs</p>
                    </div>
                    <select id="empresa-ativa-select" class="field-input" style="max-width:300px;" onchange="selecionarEmpresaAtiva()">
                        <option value="">Todas as empresas</option>
                    </select>
                </div>
            </div>
            
            <!-- Resumo -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:1rem;margin-bottom:1.5rem;">
                <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:#2563eb;font-family:'JetBrains Mono',monospace;" id="total-empresas">0</div>
                    <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Empresas</div>
                </div>
                <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                    <div style="font-size:2rem;font-weight:700;color:#10b981;font-family:'JetBrains Mono',monospace;" id="total-entregas-empresas">0</div>
                    <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Entregas</div>
                </div>
                <div id="empresas-stats-extra" style="display:contents;">
                    <!-- Estat√≠sticas extras ser√£o inseridas via JS -->
                </div>
            </div>
            
            <!-- Comparativo de Planos -->
            <div style="background:linear-gradient(135deg,#1e3a5f 0%,#0f172a 100%);padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;border:1px solid #2d4a6f;">
                <h3 style="color:#60a5fa;font-size:1rem;margin-bottom:1rem;font-family:'JetBrains Mono',monospace;">üìä Planos Dispon√≠veis</h3>
                <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1.5rem;">Escolha o plano ideal para sua empresa</p>
                
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;">
                    <!-- Plano B√°sico -->
                    <div style="background:#1e293b;border-radius:12px;padding:1.5rem;border:2px solid #3b82f6;position:relative;">
                        <div style="text-align:center;margin-bottom:1rem;">
                            <span style="background:#3b82f6;color:white;padding:0.5rem 1.5rem;border-radius:20px;font-weight:600;">üîµ B√ÅSICO</span>
                            <div style="font-size:2.5rem;font-weight:700;color:#3b82f6;margin-top:1rem;">R$ 199,99</div>
                            <div style="font-size:0.9rem;color:#64748b;">/m√™s</div>
                        </div>
                        <ul style="list-style:none;color:#94a3b8;font-size:0.85rem;">
                            <li style="padding:0.5rem 0;border-bottom:1px solid #334155;">‚úÖ At√© <strong style="color:white;">3 usu√°rios</strong></li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #334155;">‚úÖ At√© <strong style="color:white;">50 itens</strong> no estoque</li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #334155;">‚úÖ At√© <strong style="color:white;">100 entregas</strong>/m√™s</li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #334155;">‚úÖ Hist√≥rico de <strong style="color:white;">6 meses</strong></li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #334155;">‚úÖ Assinatura digital</li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #334155;">‚úÖ Foto do funcion√°rio</li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #334155;">‚úÖ PDF com logo da empresa</li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #334155;">‚ùå <span style="color:#64748b;">Relat√≥rios avan√ßados</span></li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #334155;">‚ùå <span style="color:#64748b;">Exporta√ß√£o Excel</span></li>
                            <li style="padding:0.5rem 0;">‚ùå <span style="color:#64748b;">Suporte priorit√°rio</span></li>
                        </ul>
                    </div>
                    
                    <!-- Plano Premium -->
                    <div style="background:linear-gradient(135deg,#1e3a5f 0%,#2d4a6f 100%);border-radius:12px;padding:1.5rem;border:2px solid #f59e0b;position:relative;">
                        <div style="position:absolute;top:-10px;right:20px;background:#f59e0b;color:#000;padding:0.25rem 0.75rem;border-radius:4px;font-size:0.7rem;font-weight:700;">‚≠ê RECOMENDADO</div>
                        <div style="text-align:center;margin-bottom:1rem;">
                            <span style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:0.5rem 1.5rem;border-radius:20px;font-weight:600;">‚≠ê PREMIUM</span>
                            <div style="font-size:2.5rem;font-weight:700;color:#fbbf24;margin-top:1rem;">R$ 399,99</div>
                            <div style="font-size:0.9rem;color:#94a3b8;">/m√™s</div>
                        </div>
                        <ul style="list-style:none;color:#e2e8f0;font-size:0.85rem;">
                            <li style="padding:0.5rem 0;border-bottom:1px solid #3b5a80;">‚úÖ Usu√°rios <strong style="color:#fbbf24;">ilimitados</strong></li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #3b5a80;">‚úÖ Estoque <strong style="color:#fbbf24;">ilimitado</strong></li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #3b5a80;">‚úÖ Entregas <strong style="color:#fbbf24;">ilimitadas</strong></li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #3b5a80;">‚úÖ Hist√≥rico <strong style="color:#fbbf24;">completo</strong></li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #3b5a80;">‚úÖ Assinatura digital</li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #3b5a80;">‚úÖ Foto do funcion√°rio</li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #3b5a80;">‚úÖ PDF com logo da empresa</li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #3b5a80;">‚úÖ <strong style="color:#fbbf24;">Relat√≥rios avan√ßados</strong></li>
                            <li style="padding:0.5rem 0;border-bottom:1px solid #3b5a80;">‚úÖ <strong style="color:#fbbf24;">Exporta√ß√£o Excel</strong></li>
                            <li style="padding:0.5rem 0;">‚úÖ <strong style="color:#fbbf24;">Suporte priorit√°rio</strong></li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top:1.5rem;padding:1rem;background:rgba(59,130,246,0.1);border-radius:8px;border-left:3px solid #3b82f6;">
                    <p style="color:#60a5fa;font-size:0.9rem;">
                        üí° <strong>D√∫vidas?</strong> Entre em contato: <a href="mailto:contato@rcengenhariasst.com" style="color:#fbbf24;">contato@rcengenhariasst.com</a>
                    </p>
                </div>
            </div>
            
            <!-- Formul√°rio de Nova Empresa -->
            <div style="background:#0f172a;padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;">
                <h3 style="color:#60a5fa;font-size:1rem;margin-bottom:1rem;font-family:'JetBrains Mono',monospace;">‚ûï Cadastrar Nova Empresa</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="field-label">Raz√£o Social *</label>
                        <input type="text" id="emp-razao" class="field-input" placeholder="Nome da empresa">
                    </div>
                    <div class="form-group">
                        <label class="field-label">Nome Fantasia</label>
                        <input type="text" id="emp-fantasia" class="field-input" placeholder="Nome fantasia (opcional)">
                    </div>
                    <div class="form-group">
                        <label class="field-label">CNPJ *</label>
                        <input type="text" id="emp-cnpj" class="field-input" placeholder="00.000.000/0000-00" oninput="formatCNPJ(this)">
                    </div>
                    <div class="form-group">
                        <label class="field-label">Telefone</label>
                        <input type="text" id="emp-telefone" class="field-input" placeholder="(00) 00000-0000">
                    </div>
                    <div class="form-group full-width">
                        <label class="field-label">Endere√ßo</label>
                        <input type="text" id="emp-endereco" class="field-input" placeholder="Rua, n√∫mero, bairro, cidade - UF">
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">üé® Paleta de Cores do PDF *</label>
                        <select id="emp-paleta" class="field-input" onchange="previewPaleta()">
                            <option value="azul">üîµ Azul Corporativo</option>
                            <option value="verde">üü¢ Verde Seguran√ßa</option>
                            <option value="vermelho">üî¥ Vermelho Alerta</option>
                            <option value="laranja">üü† Laranja Energia</option>
                            <option value="roxo">üü£ Roxo Premium</option>
                            <option value="cinza">‚ö´ Cinza Neutro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">üìä Plano</label>
                        <select id="emp-plano" class="field-input">
                            <option value="basico">üîµ B√°sico (R$ 199,99/m√™s)</option>
                            <option value="premium">‚≠ê Premium (R$ 399,99/m√™s)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Preview da Cor</label>
                        <div id="paleta-preview" style="display:flex;gap:0.5rem;align-items:center;height:45px;">
                            <div style="width:40px;height:40px;background:rgb(30,58,95);border-radius:8px;" id="cor-primaria"></div>
                            <div style="width:40px;height:40px;background:rgb(37,99,235);border-radius:8px;" id="cor-secundaria"></div>
                            <div style="width:40px;height:40px;background:rgb(96,165,250);border-radius:8px;" id="cor-accent"></div>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="field-label">Logo da Empresa</label>
                        <div style="display:flex;gap:1rem;align-items:center;">
                            <input type="file" id="emp-logo-input" accept="image/*" style="display:none" onchange="handleEmpresaLogoUpload(event)">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('emp-logo-input').click()">
                                üìÅ Selecionar Logo
                            </button>
                            <img id="emp-logo-preview" src="" alt="" style="max-height:50px;max-width:150px;display:none;border-radius:8px;">
                        </div>
                    </div>
                </div>
                
                <button class="btn-submit" style="margin-top:1rem;" onclick="cadastrarEmpresa()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    CADASTRAR EMPRESA
                </button>
            </div>
            
            <!-- Lista de Empresas -->
            <h3 style="color:#60a5fa;font-size:1rem;margin-bottom:1rem;font-family:'JetBrains Mono',monospace;">üìã Empresas Cadastradas</h3>
            <div id="empresas-lista"></div>
            
            <!-- Sincroniza√ß√£o -->
            <div style="background:#0f172a;padding:1.5rem;border-radius:12px;margin-top:1.5rem;">
                <h3 style="color:#10b981;font-size:1rem;margin-bottom:1rem;font-family:'JetBrains Mono',monospace;">üîÑ Sincroniza√ß√£o entre Dispositivos</h3>
                <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem;">
                    Exporte os dados para compartilhar com outros dispositivos ou fazer backup na nuvem.
                </p>
                
                <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem;">
                    <button class="btn-success" onclick="exportarSincronizacao()">
                        üì§ Exportar Tudo para Sincronizar
                    </button>
                    <button class="btn-secondary" onclick="document.getElementById('import-sync').click()">
                        üì• Importar Sincroniza√ß√£o
                    </button>
                    <input type="file" id="import-sync" accept=".json" style="display:none" onchange="importarSincronizacao(event)">
                </div>
                
                <div class="info-box" style="border-left-color:#f59e0b;margin-top:1rem;">
                    <p style="font-size:0.85rem;">
                        <strong>üí° Dica:</strong> Salve o arquivo de sincroniza√ß√£o no Google Drive, OneDrive ou envie por WhatsApp 
                        para acessar de outros dispositivos. Importe o arquivo em cada dispositivo para manter os dados atualizados.
                    </p>
                </div>
            </div>
        </div>

        <!-- Tab Configura√ß√µes -->
        <div id="tab-config" class="card hidden">
            <h2 class="card-title">Configura√ß√µes</h2>
            
            <div class="form-group" style="margin-bottom: 2rem;">
                <label class="field-label">Logo da Empresa</label>
                <div class="logo-upload-section" id="logo-upload" onclick="document.getElementById('logo-input').click()">
                    <input type="file" id="logo-input" accept="image/*" style="display: none" onchange="handleLogoUpload(event)">
                    <div id="logo-placeholder">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <path d="M21 15l-5-5L5 21"/>
                        </svg>
                        <p style="color: #94a3b8;">Clique para carregar</p>
                    </div>
                    <img id="logo-preview" class="logo-preview hidden" src="" alt="Logo">
                </div>
                <button type="button" id="btn-remove-logo" class="btn-danger hidden" onclick="removeLogo()" style="margin-top: 0.5rem;">Remover</button>
            </div>
            
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="field-label">Nome da Empresa</label>
                    <input type="text" id="config-empresa" class="field-input" placeholder="Cabe√ßalho do PDF" onchange="saveConfig()">
                </div>
                <div class="form-group full-width">
                    <label class="field-label">Rodap√©</label>
                    <input type="text" id="config-rodape" class="field-input" placeholder="www.empresa.com | telefone" onchange="saveConfig()">
                </div>
            </div>
            
            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #2d4a6f;">
                <h3 style="color:#64748b;margin-bottom:1rem;">Backup de Seguran√ßa</h3>
                <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:2rem;">
                    <button class="btn-success" onclick="exportBackup()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                        Exportar Backup
                    </button>
                    <button class="btn-secondary" onclick="document.getElementById('import-backup').click()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                        Importar Backup
                    </button>
                    <input type="file" id="import-backup" accept=".json" style="display:none" onchange="importBackup(event)">
                </div>
                
                <h3 style="color:#2563eb;margin-bottom:1rem;">üë• Gerenciar Usu√°rios</h3>
                <div style="background:#0f172a;padding:1.25rem;border-radius:10px;margin-bottom:2rem;">
                    <div id="users-list" style="margin-bottom:1rem;"></div>
                    
                    <div style="border-top:1px solid #2d4a6f;padding-top:1rem;margin-top:1rem;">
                        <h4 style="color:#94a3b8;font-size:0.9rem;margin-bottom:1rem;">Alterar Senha</h4>
                        <div style="display:grid;gap:0.75rem;">
                            <select id="user-select" class="field-input" style="padding:0.75rem;">
                                <option value="">Selecione o usu√°rio</option>
                            </select>
                            <input type="password" id="new-password" class="field-input" placeholder="Nova senha (m√≠n. 6 caracteres)">
                            <input type="password" id="confirm-password" class="field-input" placeholder="Confirmar nova senha">
                            <button class="btn-primary" onclick="changeUserPassword()">
                                üîê Alterar Senha
                            </button>
                        </div>
                    </div>
                    
                    <div style="border-top:1px solid #2d4a6f;padding-top:1rem;margin-top:1rem;">
                        <h4 style="color:#94a3b8;font-size:0.9rem;margin-bottom:1rem;">Adicionar Novo Usu√°rio</h4>
                        <div style="display:grid;gap:0.75rem;">
                            <input type="text" id="new-user-name" class="field-input" placeholder="Nome completo">
                            <input type="email" id="new-user-email" class="field-input" placeholder="E-mail (para login web)">
                            <input type="text" id="new-user-username" class="field-input" placeholder="Nome de usu√°rio (login local)">
                            <input type="password" id="new-user-password" class="field-input" placeholder="Senha (m√≠n. 6 caracteres)">
                            <select id="new-user-role" class="field-input" style="padding:0.75rem;" onchange="toggleEmpresaSelect()">
                                <option value="user">Usu√°rio (acesso b√°sico)</option>
                                <option value="dev">Desenvolvedor (acesso total)</option>
                            </select>
                            <div id="empresa-select-container">
                                <label style="color:#94a3b8;font-size:0.8rem;margin-bottom:0.25rem;display:block;">üè¢ Vincular a Empresa</label>
                                <select id="new-user-empresa" class="field-input" style="padding:0.75rem;">
                                    <option value="">Selecione a empresa...</option>
                                </select>
                            </div>
                            <button class="btn-success" onclick="addNewUser()">
                                ‚ûï Adicionar Usu√°rio
                            </button>
                            <p style="color:#64748b;font-size:0.75rem;margin-top:0.25rem;">
                                üí° O usu√°rio poder√° fazer login com o e-mail cadastrado ou com o nome de usu√°rio.
                            </p>
                        </div>
                    </div>
                    
                    <div style="border-top:1px solid #2d4a6f;padding-top:1rem;margin-top:1rem;">
                        <h4 style="color:#94a3b8;font-size:0.9rem;margin-bottom:0.75rem;">üîß Ferramentas</h4>
                        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                            <button class="btn-secondary" onclick="verificarUsuariosCadastrados()" style="font-size:0.8rem;">
                                üîç Verificar Usu√°rios
                            </button>
                            <button class="btn-secondary" onclick="testarLoginUsuario()" style="font-size:0.8rem;">
                                üß™ Testar Login
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Google Cloud Sync -->
                <h3 style="color:#2563eb;margin-bottom:1rem;">‚òÅÔ∏è Sincroniza√ß√£o Google Drive</h3>
                <div class="google-config-section">
                    <div id="google-not-connected" style="display:block;">
                        <div style="text-align:center;padding:1rem;">
                            <div style="font-size:3rem;margin-bottom:1rem;">‚òÅÔ∏è</div>
                            <h4 style="color:#e2e8f0;margin-bottom:0.5rem;">Sincroniza√ß√£o na Nuvem</h4>
                            <p style="color:#64748b;font-size:0.85rem;margin-bottom:1.5rem;">
                                Conecte sua conta Google para sincronizar automaticamente seus dados entre todos os dispositivos.
                            </p>
                            <button class="btn-google" onclick="handleGoogleSignIn()" style="max-width:300px;margin:0 auto;">
                                <svg viewBox="0 0 24 24" width="20" height="20">
                                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                                </svg>
                                Conectar com Google
                            </button>
                        </div>
                        
                        <div style="border-top:1px solid #2d4a6f;margin-top:1.5rem;padding-top:1.5rem;">
                            <h4 style="color:#94a3b8;font-size:0.9rem;margin-bottom:1rem;">‚öôÔ∏è Configura√ß√£o do Google Cloud (Admin)</h4>
                            <p style="color:#64748b;font-size:0.8rem;margin-bottom:1rem;">
                                Para ativar a sincroniza√ß√£o, configure o Client ID do seu projeto Google Cloud:
                            </p>
                            <div style="display:flex;gap:0.5rem;">
                                <input type="text" id="google-client-id" class="field-input" placeholder="Cole aqui seu Google Client ID" style="flex:1;">
                                <button class="btn-primary" onclick="salvarGoogleClientId()" style="white-space:nowrap;">
                                    üíæ Salvar
                                </button>
                            </div>
                            <p style="color:#64748b;font-size:0.75rem;margin-top:0.5rem;">
                                üìñ <a href="#" onclick="mostrarGuiaGoogle();return false;" style="color:#60a5fa;">Ver guia de configura√ß√£o</a>
                            </p>
                        </div>
                    </div>
                    
                    <div id="google-connected" style="display:none;">
                        <div class="google-user-info">
                            <img id="google-user-photo" src="" alt="Foto">
                            <div class="info">
                                <div class="name" id="google-user-name">Usu√°rio Google</div>
                                <div class="email" id="google-user-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e58088848c89a58288848c89cb868a88">[email&#160;protected]</a></div>
                            </div>
                            <button onclick="handleGoogleSignOut()" style="background:#ef4444;color:white;border:none;padding:0.5rem 1rem;border-radius:6px;font-size:0.8rem;">
                                Desconectar
                            </button>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1rem;">
                            <div style="background:#0f172a;padding:1rem;border-radius:8px;text-align:center;">
                                <div style="font-size:1.5rem;margin-bottom:0.25rem;" id="sync-last-time">--:--</div>
                                <div style="font-size:0.75rem;color:#64748b;">√öltima Sincroniza√ß√£o</div>
                            </div>
                            <div style="background:#0f172a;padding:1rem;border-radius:8px;text-align:center;">
                                <div style="font-size:1.5rem;margin-bottom:0.25rem;" id="sync-file-size">0 KB</div>
                                <div style="font-size:0.75rem;color:#64748b;">Tamanho do Backup</div>
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                            <button class="btn-primary" onclick="forcarSincronizacao()">
                                üîÑ Sincronizar Agora
                            </button>
                            <button class="btn-secondary" onclick="baixarBackupDrive()">
                                üì• Baixar do Drive
                            </button>
                            <button class="btn-secondary" onclick="verArquivoDrive()">
                                üìÇ Ver no Drive
                            </button>
                        </div>
                        
                        <div style="margin-top:1rem;padding:0.75rem;background:rgba(16,185,129,0.1);border-radius:8px;border-left:3px solid #10b981;">
                            <p style="color:#10b981;font-size:0.85rem;">
                                ‚úÖ Sincroniza√ß√£o autom√°tica ativa. Os dados s√£o salvos no Google Drive a cada altera√ß√£o.
                            </p>
                        </div>
                        
                        <!-- Sincroniza√ß√£o em Equipe -->
                        <div style="margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid #2d4a6f;">
                            <h4 style="color:#8b5cf6;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;">
                                üë• Sincroniza√ß√£o em Equipe
                            </h4>
                            <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem;">
                                Compartilhe um link para que outros dispositivos acessem os mesmos dados <strong>automaticamente</strong>.
                            </p>
                            
                            <div id="team-code-section">
                                <button class="btn-primary" onclick="gerarCodigoEquipe()" style="margin-bottom:1rem;">
                                    üîë Gerar Link de Equipe
                                </button>
                                
                                <div id="team-link-section" style="display:none;">
                                    <div style="background:#0f172a;padding:1rem;border-radius:8px;margin-bottom:1rem;">
                                        <label style="color:#94a3b8;font-size:0.8rem;display:block;margin-bottom:0.5rem;">üîó Link para Equipe (envie este link!):</label>
                                        <div style="display:flex;gap:0.5rem;align-items:center;">
                                            <input type="text" id="team-link-display" class="field-input" readonly 
                                                   style="font-size:0.85rem;background:#1e3a5f;flex:1;" 
                                                   placeholder="Link ser√° gerado aqui">
                                            <button class="btn-primary" onclick="copiarLinkEquipe()" style="white-space:nowrap;">
                                                üìã Copiar Link
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div style="background:#0f172a;padding:1rem;border-radius:8px;margin-bottom:1rem;">
                                        <label style="color:#94a3b8;font-size:0.8rem;display:block;margin-bottom:0.5rem;">üîë C√≥digo (alternativo):</label>
                                        <div style="display:flex;gap:0.5rem;align-items:center;">
                                            <input type="text" id="team-code-display" class="field-input" readonly 
                                                   style="font-family:monospace;font-size:0.8rem;background:#1e3a5f;" 
                                                   placeholder="C√≥digo">
                                            <button class="btn-secondary" onclick="copiarCodigoEquipe()" style="white-space:nowrap;">
                                                üìã
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div style="background:rgba(139,92,246,0.1);padding:0.75rem;border-radius:8px;border-left:3px solid #8b5cf6;">
                                        <p style="color:#a78bfa;font-size:0.8rem;">
                                            <strong>üì¢ Como compartilhar:</strong><br>
                                            1. Copie o <strong>Link</strong> acima<br>
                                            2. Envie para os funcion√°rios (WhatsApp, E-mail, etc)<br>
                                            3. Eles clicam no link e os dados sincronizam <strong>automaticamente!</strong><br>
                                            4. Atualiza√ß√£o autom√°tica a cada 2 minutos
                                        </p>
                                    </div>
                                    
                                    <!-- Adicionar membro por e-mail -->
                                    <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid #2d4a6f;">
                                        <label style="color:#94a3b8;font-size:0.85rem;display:block;margin-bottom:0.5rem;">
                                            üìß Adicionar membro por e-mail (mais confi√°vel):
                                        </label>
                                        <div style="display:flex;gap:0.5rem;">
                                            <input type="email" id="team-member-email" class="field-input" 
                                                   placeholder="email@funcionario.com" style="flex:1;">
                                            <button class="btn-secondary" onclick="adicionarMembroEquipe()" style="white-space:nowrap;">
                                                ‚ûï Convidar
                                            </button>
                                        </div>
                                        <p style="color:#64748b;font-size:0.75rem;margin-top:0.5rem;">
                                            O funcion√°rio receber√° acesso direto ao arquivo de sincroniza√ß√£o.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Entrada de C√≥digo de Equipe (para outros dispositivos) -->
                <div class="google-config-section" style="margin-top:1rem;">
                    <h4 style="color:#8b5cf6;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;">
                        üì• Entrar em uma Equipe
                    </h4>
                    
                    <div style="display:grid;grid-template-columns:1fr;gap:1rem;">
                        <!-- Op√ß√£o 1: Conectar com Google (se foi convidado por e-mail) -->
                        <div style="background:#0f172a;padding:1rem;border-radius:8px;">
                            <p style="color:#10b981;font-size:0.9rem;margin-bottom:0.75rem;">
                                <strong>‚úÖ Op√ß√£o 1: Foi convidado por e-mail?</strong>
                            </p>
                            <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:0.75rem;">
                                Se o administrador adicionou seu e-mail, conecte-se ao Google:
                            </p>
                            <button class="btn-google" onclick="entrarEquipeViaGoogle()" style="max-width:280px;">
                                <svg viewBox="0 0 24 24" width="18" height="18">
                                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                                </svg>
                                Conectar com Google
                            </button>
                        </div>
                        
                        <!-- Op√ß√£o 2: Usar c√≥digo -->
                        <div style="background:#0f172a;padding:1rem;border-radius:8px;">
                            <p style="color:#60a5fa;font-size:0.9rem;margin-bottom:0.75rem;">
                                <strong>üìã Op√ß√£o 2: Tem o c√≥digo?</strong>
                            </p>
                            <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:0.75rem;">
                                Cole o c√≥digo recebido do administrador:
                            </p>
                            <div style="display:flex;gap:0.5rem;">
                                <input type="text" id="team-code-input" class="field-input" 
                                       placeholder="Cole o c√≥digo aqui" 
                                       style="font-family:monospace;flex:1;">
                                <button class="btn-primary" onclick="entrarEquipe()" style="white-space:nowrap;">
                                    üîó Conectar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Op√ß√£o 3: Import manual -->
                        <div style="background:#0f172a;padding:1rem;border-radius:8px;">
                            <p style="color:#f59e0b;font-size:0.9rem;margin-bottom:0.75rem;">
                                <strong>üìÅ Op√ß√£o 3: Tem o arquivo JSON?</strong>
                            </p>
                            <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:0.75rem;">
                                Importe diretamente o arquivo de sincroniza√ß√£o:
                            </p>
                            <button class="btn-secondary" onclick="document.getElementById('import-equipe-manual').click()">
                                üì• Importar Arquivo JSON
                            </button>
                            <input type="file" id="import-equipe-manual" accept=".json" style="display:none" onchange="importarArquivoEquipe(event)">
                        </div>
                    </div>
                    
                    <div id="team-status" style="margin-top:1rem;display:none;">
                    </div>
                </div>
                
                <h3 style="color: #ef4444; margin-bottom: 1rem;">‚ö†Ô∏è Zona de Perigo</h3>
                <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem;">A√ß√µes irrevers√≠veis. Fa√ßa backup antes de prosseguir.</p>
                <button class="btn-danger" onclick="clearAllData()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                    Apagar Todos os Dados
                </button>
            </div>
        </div>
    </main>
    
    <!-- Rodap√© do Software -->
    <footer style="background:#0a1628;padding:1.5rem;text-align:center;border-top:2px solid #2563eb;margin-top:2rem;">
        <p style="color:#60a5fa;font-weight:700;font-size:1rem;margin-bottom:0.25rem;">RC Engenharia Sa√∫de e Seguran√ßa Ocupacional</p>
        <p style="color:#64748b;font-size:0.8rem;">¬© 2026 - Todos os direitos reservados</p>
    </footer>

    <!-- Modal -->
    <div id="modal-historico" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-titulo">Hist√≥rico</h3>
                <button class="action-btn" onclick="document.getElementById('modal-historico').classList.remove('show')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modal-content"></div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ==================== FIREBASE (OPCIONAL - SINCRONIZA√á√ÉO NA NUVEM) ====================
        
        // Configura√ß√£o do Firebase - RC EPI System
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAsyyvSx7p1B0W8R-B4TGZukk-nzCr99Sk",
            authDomain: "rc-epi-system-4e47c.firebaseapp.com",
            projectId: "rc-epi-system-4e47c",
            storageBucket: "rc-epi-system-4e47c.firebasestorage.app",
            messagingSenderId: "679187948868",
            appId: "1:679187948868:web:10f47dafa41b085bcf2311"
        };
        
        let firebaseDb = null;
        let firebaseAuth = null;
        let firebaseUser = null;
        let firebaseEnabled = false;
        let isSuperAdmin = false;
        
        // ==================== SISTEMA DE PLANOS ====================
        const PLANOS_CONFIG = {
            basico: {
                nome: 'B√°sico',
                cor: '#3b82f6',
                limites: {
                    usuarios: 3,
                    estoque: 50,
                    entregasMes: 100,
                    historicoMeses: 6
                },
                recursos: {
                    assinaturaDigital: true,
                    fotoFuncionario: true,
                    relatoriosPDF: true,
                    relatoriosAvancados: false,
                    exportacaoExcel: false,
                    alertasEmail: false,
                    dashboardGraficos: false,
                    logoRelatorios: true,
                    suportePrioritario: false
                },
                preco: 'R$ 199,99/m√™s',
                precoNumerico: 199.99
            },
            premium: {
                nome: 'Premium',
                cor: '#f59e0b',
                limites: {
                    usuarios: 999,
                    estoque: 9999,
                    entregasMes: 9999,
                    historicoMeses: 999
                },
                recursos: {
                    assinaturaDigital: true,
                    fotoFuncionario: true,
                    relatoriosPDF: true,
                    relatoriosAvancados: true,
                    exportacaoExcel: true,
                    alertasEmail: true,
                    dashboardGraficos: true,
                    logoRelatorios: true,
                    suportePrioritario: true
                },
                preco: 'R$ 399,99/m√™s',
                precoNumerico: 399.99
            }
        };
        
        // Inicializar Firebase (opcional)
        function initFirebase() {
            try {
                if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                    firebase.initializeApp(FIREBASE_CONFIG);
                    firebaseDb = firebase.firestore();
                    firebaseAuth = firebase.auth();
                    firebaseEnabled = true;
                    console.log('‚úÖ Firebase inicializado com sucesso!');
                    
                    // Listener de autentica√ß√£o Firebase (opcional)
                    firebaseAuth.onAuthStateChanged(handleFirebaseAuthChange);
                }
            } catch(e) {
                console.log('Firebase n√£o dispon√≠vel, usando modo local:', e);
                firebaseEnabled = false;
            }
        }
        
        // Handler de autentica√ß√£o Firebase
        async function handleFirebaseAuthChange(user) {
            if (user) {
                firebaseUser = user;
                // Verificar se √© super admin
                try {
                    const adminDoc = await firebaseDb.collection('superadmins').doc(user.email.toLowerCase()).get();
                    isSuperAdmin = adminDoc.exists && adminDoc.data().ativo === true;
                    if (isSuperAdmin) {
                        console.log('‚úÖ Super Admin Firebase detectado');
                    }
                } catch(e) {
                    isSuperAdmin = false;
                }
            } else {
                firebaseUser = null;
                isSuperAdmin = false;
            }
        }
        
        // Obter plano da empresa
        function getPlanoEmpresa(cnpj) {
            // Tentar buscar do Firebase primeiro
            if (firebaseEnabled && cnpj) {
                // Por enquanto, retornar do localStorage
            }
            
            // Buscar do localStorage
            const empresas = JSON.parse(localStorage.getItem('epi-empresas') || '[]');
            const empresa = empresas.find(e => e.cnpj === cnpj);
            
            if (empresa && empresa.plano && PLANOS_CONFIG[empresa.plano]) {
                return PLANOS_CONFIG[empresa.plano];
            }
            
            return PLANOS_CONFIG.basico;
        }
        
        // Verificar se recurso est√° dispon√≠vel para a empresa
        function recursoDisponivel(cnpj, recurso) {
            const plano = getPlanoEmpresa(cnpj);
            return plano.recursos[recurso] === true;
        }
        
        // Verificar limite
        function verificarLimite(cnpj, tipo, valorAtual) {
            const plano = getPlanoEmpresa(cnpj);
            const limite = plano.limites[tipo];
            
            if (limite >= 9999) return { ok: true, limite: '‚àû', atual: valorAtual };
            
            return {
                ok: valorAtual < limite,
                limite: limite,
                atual: valorAtual,
                mensagem: valorAtual >= limite ? `Limite de ${limite} atingido (Plano ${plano.nome})` : null
            };
        }
        
        // Mostrar modal de upgrade
        function mostrarModalUpgrade(mensagem) {
            const msg = mensagem || 'Este recurso est√° dispon√≠vel apenas no Plano Premium.';
            
            if (confirm(`${msg}\n\nDeseja conhecer o Plano Premium?\n\n‚úÖ Usu√°rios ilimitados\n‚úÖ Estoque ilimitado\n‚úÖ Entregas ilimitadas\n‚úÖ Relat√≥rios avan√ßados\n‚úÖ Exporta√ß√£o Excel\n‚úÖ Alertas por e-mail\n‚úÖ Suporte priorit√°rio\n\nPor apenas R$ 399,99/m√™s`)) {
                showNotification('Entre em contato: contato@rcengenhariasst.com', 'info');
            }
        }
        
        // Sincronizar dados com Firebase (opcional)
        async function syncComFirebase() {
            if (!firebaseEnabled || !firebaseUser) return;
            
            try {
                // Implementar sincroniza√ß√£o bidirecional aqui se necess√°rio
                console.log('Sincroniza√ß√£o com Firebase dispon√≠vel');
            } catch(e) {
                console.error('Erro na sincroniza√ß√£o:', e);
            }
        }
        
        // ==================== SISTEMA DE AUTENTICA√á√ÉO ====================
        const AUTH_KEY = 'epi-auth-session';
        const USERS_KEY = 'epi-users-db';
        
        // Usu√°rios padr√£o (senha em hash simples - em produ√ß√£o usar bcrypt)
        const DEFAULT_USERS = [
            { 
                username: 'admin', 
                password: 'admin', 
                role: 'dev', 
                name: 'Administrador',
                empresaVinculada: null, // null = acesso a todas
                permissions: ['all']
            },
            { 
                username: 'usuario', 
                password: 'usuario', 
                role: 'user', 
                name: 'Operador',
                empresaVinculada: null, // ser√° vinculado a uma empresa
                permissions: ['cadastro', 'consulta', 'devolucao']
            }
        ];
        
        let currentUser = null;
        let deferredPrompt = null;
        
        // Inicializar usu√°rios no localStorage (sempre garante que admin existe)
        function initUsers() {
            let users = [];
            try {
                users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            } catch(e) {
                users = [];
            }
            
            // Sempre garantir que admin existe com senha correta
            const adminExists = users.find(u => u.username === 'admin');
            if (!adminExists) {
                users.push(DEFAULT_USERS[0]);
            } else {
                // Atualizar senha do admin para garantir acesso
                adminExists.password = 'admin';
            }
            
            // Garantir que usuario padr√£o existe
            const userExists = users.find(u => u.username === 'usuario');
            if (!userExists) {
                users.push(DEFAULT_USERS[1]);
            } else {
                userExists.password = 'usuario';
            }
            
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
        }
        
        // Acesso r√°pido (para desenvolvimento/emerg√™ncia)
        function acessoRapido() {
            currentUser = {
                username: 'admin',
                name: 'Administrador',
                role: 'dev',
                empresaVinculada: null,
                permissions: ['all'],
                loginTime: new Date().toISOString()
            };
            localStorage.setItem(AUTH_KEY, JSON.stringify(currentUser));
            showMainApp();
            showNotification('Bem-vindo, Administrador!', 'success');
        }
        
        // ==================== LOGIN POR E-MAIL FIREBASE ====================
        
        // Toggle formul√°rio de e-mail
        function toggleEmailLogin() {
            const form = document.getElementById('email-login-form');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
        
        // Mostrar erro do Firebase
        function mostrarErroFirebase(erro) {
            const errorEl = document.getElementById('firebase-login-error');
            let mensagem = 'Erro ao processar solicita√ß√£o.';
            
            switch(erro.code) {
                case 'auth/invalid-email':
                    mensagem = 'E-mail inv√°lido.';
                    break;
                case 'auth/user-disabled':
                    mensagem = 'Usu√°rio desativado.';
                    break;
                case 'auth/user-not-found':
                    mensagem = 'Usu√°rio n√£o encontrado. Crie uma conta.';
                    break;
                case 'auth/wrong-password':
                    mensagem = 'Senha incorreta.';
                    break;
                case 'auth/email-already-in-use':
                    mensagem = 'Este e-mail j√° est√° em uso.';
                    break;
                case 'auth/weak-password':
                    mensagem = 'Senha muito fraca. Use pelo menos 6 caracteres.';
                    break;
                case 'auth/too-many-requests':
                    mensagem = 'Muitas tentativas. Tente novamente mais tarde.';
                    break;
                case 'auth/invalid-credential':
                    mensagem = 'E-mail ou senha incorretos.';
                    break;
                default:
                    mensagem = erro.message || 'Erro desconhecido.';
            }
            
            errorEl.textContent = mensagem;
            errorEl.style.display = 'block';
        }
        
        // Login com e-mail e senha
        async function loginComEmail() {
            const email = document.getElementById('firebase-email').value.trim();
            const password = document.getElementById('firebase-password').value;
            const errorEl = document.getElementById('firebase-login-error');
            errorEl.style.display = 'none';
            
            if (!email || !password) {
                errorEl.textContent = 'Preencha e-mail e senha.';
                errorEl.style.display = 'block';
                return;
            }
            
            if (!firebaseEnabled || !firebaseAuth) {
                errorEl.textContent = 'Firebase n√£o dispon√≠vel. Use o login local.';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                const result = await firebaseAuth.signInWithEmailAndPassword(email, password);
                const user = result.user;
                
                // Criar sess√£o local
                currentUser = {
                    username: user.email,
                    name: user.displayName || user.email.split('@')[0],
                    role: 'dev', // Por padr√£o, usu√°rios Firebase s√£o admins
                    empresaVinculada: null,
                    permissions: ['all'],
                    loginTime: new Date().toISOString(),
                    firebaseUid: user.uid,
                    isFirebaseUser: true
                };
                
                localStorage.setItem(AUTH_KEY, JSON.stringify(currentUser));
                showMainApp();
                showNotification(`Bem-vindo, ${currentUser.name}!`, 'success');
                
            } catch(erro) {
                mostrarErroFirebase(erro);
            }
        }
        
        // Criar conta com e-mail e senha
        async function criarContaEmail() {
            const email = document.getElementById('firebase-email').value.trim();
            const password = document.getElementById('firebase-password').value;
            const errorEl = document.getElementById('firebase-login-error');
            errorEl.style.display = 'none';
            
            if (!email || !password) {
                errorEl.textContent = 'Preencha e-mail e senha.';
                errorEl.style.display = 'block';
                return;
            }
            
            if (password.length < 6) {
                errorEl.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                errorEl.style.display = 'block';
                return;
            }
            
            if (!firebaseEnabled || !firebaseAuth) {
                errorEl.textContent = 'Firebase n√£o dispon√≠vel.';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                const result = await firebaseAuth.createUserWithEmailAndPassword(email, password);
                const user = result.user;
                
                // Atualizar nome do usu√°rio
                await user.updateProfile({
                    displayName: email.split('@')[0]
                });
                
                // Criar sess√£o local
                currentUser = {
                    username: user.email,
                    name: user.displayName || email.split('@')[0],
                    role: 'dev',
                    empresaVinculada: null,
                    permissions: ['all'],
                    loginTime: new Date().toISOString(),
                    firebaseUid: user.uid,
                    isFirebaseUser: true
                };
                
                localStorage.setItem(AUTH_KEY, JSON.stringify(currentUser));
                showMainApp();
                showNotification(`Conta criada com sucesso! Bem-vindo, ${currentUser.name}!`, 'success');
                
            } catch(erro) {
                mostrarErroFirebase(erro);
            }
        }
        
        // Recuperar senha
        async function recuperarSenha() {
            const email = document.getElementById('firebase-email').value.trim();
            const errorEl = document.getElementById('firebase-login-error');
            errorEl.style.display = 'none';
            
            if (!email) {
                errorEl.textContent = 'Digite seu e-mail para recuperar a senha.';
                errorEl.style.display = 'block';
                return;
            }
            
            if (!firebaseEnabled || !firebaseAuth) {
                errorEl.textContent = 'Firebase n√£o dispon√≠vel.';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                await firebaseAuth.sendPasswordResetEmail(email);
                showNotification('E-mail de recupera√ß√£o enviado! Verifique sua caixa de entrada.', 'success');
                errorEl.style.display = 'none';
            } catch(erro) {
                mostrarErroFirebase(erro);
            }
        }
        
        // ==================== FIM LOGIN POR E-MAIL ====================
        
        // Verificar autentica√ß√£o ao carregar
        function checkAuth() {
            const session = localStorage.getItem(AUTH_KEY);
            if (session) {
                try {
                    currentUser = JSON.parse(session);
                    showMainApp();
                    return true;
                } catch(e) {
                    localStorage.removeItem(AUTH_KEY);
                }
            }
            showLoginScreen();
            return false;
        }
        
        // Mostrar tela de login
        function showLoginScreen() {
            document.getElementById('login-overlay').classList.remove('hidden');
            document.getElementById('main-header').style.display = 'none';
            document.querySelector('.nav-tabs').style.display = 'none';
            document.querySelector('.main-content').style.display = 'none';
            document.querySelector('footer').style.display = 'none';
        }
        
        // Mostrar aplicativo principal
        function showMainApp() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('main-header').style.display = 'block';
            document.querySelector('.nav-tabs').style.display = 'flex';
            document.querySelector('.main-content').style.display = 'block';
            document.querySelector('footer').style.display = 'block';
            
            // Atualizar info do usu√°rio
            document.getElementById('logged-user').textContent = currentUser.name;
            const roleEl = document.getElementById('user-role');
            roleEl.textContent = currentUser.role === 'dev' ? 'DEV' : 'USER';
            roleEl.classList.toggle('dev', currentUser.role === 'dev');
            
            // Aplicar permiss√µes
            if (currentUser.role === 'dev') {
                document.body.classList.add('is-dev');
            } else {
                document.body.classList.remove('is-dev');
            }
            
            // Esconder abas baseado em permiss√µes
            const configTab = document.querySelector('[data-tab="config"]');
            const empresasTab = document.querySelector('[data-tab="empresas"]');
            
            if (configTab) {
                configTab.style.display = currentUser.role === 'dev' ? 'flex' : 'none';
            }
            
            if (empresasTab) {
                // Usu√°rios comuns n√£o veem aba de empresas
                empresasTab.style.display = currentUser.role === 'dev' ? 'flex' : 'none';
            }
            
            // Se usu√°rio tem empresa vinculada, aplicar filtro autom√°tico
            if (currentUser.empresaVinculada && currentUser.role !== 'dev') {
                loadEmpresas();
                const emp = empresas.find(e => e.cnpj === currentUser.empresaVinculada);
                if (emp) {
                    empresaAtual = emp;
                    
                    // Preencher automaticamente o formul√°rio de entrega
                    setTimeout(() => {
                        const empresaInput = document.getElementById('empresa');
                        const cnpjInput = document.getElementById('cnpj');
                        if (empresaInput) {
                            empresaInput.value = emp.fantasia || emp.razao;
                            empresaInput.readOnly = true;
                            empresaInput.style.background = '#1e3a5f';
                        }
                        if (cnpjInput) {
                            cnpjInput.value = emp.cnpj;
                            cnpjInput.readOnly = true;
                            cnpjInput.style.background = '#1e3a5f';
                        }
                    }, 100);
                }
            }
            
            // Inicializar elementos da UI
            setTimeout(() => {
                initSignaturePad();
                const dataEntrega = document.getElementById('dataEntrega');
                if (dataEntrega) dataEntrega.value = new Date().toISOString().split('T')[0];
                updateUI();
                
                // Verificar se precisa mostrar banner de sincroniza√ß√£o
                checkSyncBanner();
            }, 100);
        }
        
        function checkSyncBanner() {
            const banner = document.getElementById('sync-banner');
            if (!banner) return;
            
            // Verificar se j√° foi fechado nesta sess√£o
            const bannerClosed = sessionStorage.getItem('sync-banner-closed');
            
            // Mostrar banner se n√£o h√° dados e n√£o foi fechado
            if (entregas.length === 0 && empresas.length === 0 && !bannerClosed) {
                banner.classList.remove('hidden');
            } else {
                banner.classList.add('hidden');
            }
        }
        
        function fecharBannerSync() {
            const banner = document.getElementById('sync-banner');
            if (banner) banner.classList.add('hidden');
            sessionStorage.setItem('sync-banner-closed', 'true');
        }
        
        function importarSincronizacaoLogin(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.dados) {
                        throw new Error('Formato inv√°lido');
                    }
                    
                    const info = `üì¶ IMPORTAR DADOS\n\nArquivo: ${file.name}\nData: ${data.dataExportacao ? new Date(data.dataExportacao).toLocaleString('pt-BR') : 'N/A'}\n\nConte√∫do:\n- Entregas: ${data.dados.entregas?.length || 0}\n- Estoque: ${data.dados.estoque?.length || 0}\n- Empresas: ${data.dados.empresas?.length || 0}\n- Usu√°rios: ${data.dados.usuarios?.length || 0}\n\nDeseja importar estes dados?`;
                    
                    if (!confirm(info)) return;
                    
                    // Importar dados
                    if (data.dados.entregas) {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(data.dados.entregas));
                    }
                    
                    if (data.dados.estoque) {
                        localStorage.setItem(ESTOQUE_KEY, JSON.stringify(data.dados.estoque));
                    }
                    
                    if (data.dados.empresas) {
                        localStorage.setItem(EMPRESAS_KEY, JSON.stringify(data.dados.empresas));
                    }
                    
                    if (data.dados.config) {
                        localStorage.setItem(CONFIG_KEY, JSON.stringify(data.dados.config));
                    }
                    
                    if (data.dados.usuarios && data.dados.usuarios.length > 0) {
                        localStorage.setItem(USERS_KEY, JSON.stringify(data.dados.usuarios));
                    }
                    
                    alert('‚úÖ Dados importados com sucesso!\n\nAgora fa√ßa login para acessar o sistema.');
                    
                    // Recarregar p√°gina para aplicar os dados
                    location.reload();
                    
                } catch(err) {
                    console.error('Erro na importa√ß√£o:', err);
                    alert('‚ùå Arquivo inv√°lido. Verifique se √© um arquivo de sincroniza√ß√£o v√°lido.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // Processar login
        function handleLogin(e) {
            e.preventDefault();
            
            const loginInput = document.getElementById('login-user').value.trim().toLowerCase();
            const password = document.getElementById('login-pass').value;
            
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            
            // Procurar por username OU email
            const user = users.find(u => 
                (u.username && u.username.toLowerCase() === loginInput && u.password === password) ||
                (u.email && u.email.toLowerCase() === loginInput && u.password === password)
            );
            
            if (user) {
                // Verificar se usu√°rio tem empresa vinculada (se n√£o for dev)
                if (user.role !== 'dev' && user.empresaVinculada) {
                    // Verificar se a empresa ainda existe
                    loadEmpresas();
                    const empresaExiste = empresas.find(e => e.cnpj === user.empresaVinculada);
                    if (!empresaExiste) {
                        document.getElementById('login-error').textContent = 'Empresa vinculada n√£o encontrada. Contate o administrador.';
                        document.getElementById('login-error').classList.add('show');
                        return;
                    }
                }
                
                currentUser = {
                    username: user.username,
                    email: user.email || null,
                    name: user.name,
                    role: user.role,
                    empresaVinculada: user.empresaVinculada || null,
                    permissions: user.permissions,
                    loginTime: new Date().toISOString()
                };
                
                localStorage.setItem(AUTH_KEY, JSON.stringify(currentUser));
                
                document.getElementById('login-error').classList.remove('show');
                document.getElementById('login-error').textContent = 'Usu√°rio ou senha incorretos';
                showMainApp();
                
                // Mostrar empresa vinculada
                if (currentUser.empresaVinculada) {
                    const emp = empresas.find(e => e.cnpj === currentUser.empresaVinculada);
                    showNotification(`Bem-vindo, ${user.name}! (${emp?.fantasia || emp?.razao || 'Empresa'})`, 'success');
                } else {
                    showNotification(`Bem-vindo, ${user.name}!`, 'success');
                }
            } else {
                // Verificar se usu√°rio existe para dar feedback mais espec√≠fico
                const userExists = users.find(u => 
                    (u.username && u.username.toLowerCase() === loginInput) ||
                    (u.email && u.email.toLowerCase() === loginInput)
                );
                
                if (userExists) {
                    document.getElementById('login-error').textContent = 'Senha incorreta. Verifique e tente novamente.';
                } else if (users.length === 0) {
                    document.getElementById('login-error').textContent = 'Nenhum usu√°rio cadastrado. Importe os dados primeiro.';
                } else {
                    document.getElementById('login-error').textContent = 'Usu√°rio ou e-mail n√£o encontrado.';
                }
                
                document.getElementById('login-error').classList.add('show');
                document.getElementById('login-pass').value = '';
            }
        }
        
        // Logout
        function handleLogout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                currentUser = null;
                localStorage.removeItem(AUTH_KEY);
                document.getElementById('login-user').value = '';
                document.getElementById('login-pass').value = '';
                showLoginScreen();
                showNotification('Sess√£o encerrada', 'success');
            }
        }
        
        // ==================== PWA - INSTALA√á√ÉO ====================
        
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Service Worker inline via data URI n√£o funciona bem, vamos usar cache API diretamente
                console.log('PWA: Aplicativo pronto para instala√ß√£o');
            });
        }
        
        // Capturar evento de instala√ß√£o
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').classList.add('show');
        });
        
        // Instalar App
        async function installApp() {
            if (!deferredPrompt) {
                // Mostrar instru√ß√µes manuais
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isAndroid = /Android/.test(navigator.userAgent);
                
                let instructions = '';
                if (isIOS) {
                    instructions = 'üì± No Safari:\n1. Toque no bot√£o Compartilhar (‚¨ÜÔ∏è)\n2. Role e toque em "Adicionar √† Tela de In√≠cio"\n3. Toque em "Adicionar"';
                } else if (isAndroid) {
                    instructions = 'üì± No Chrome:\n1. Toque no menu (‚ãÆ)\n2. Toque em "Adicionar √† tela inicial"\n3. Toque em "Adicionar"';
                } else {
                    instructions = 'üíª No Chrome/Edge:\n1. Clique no √≠cone de instala√ß√£o (‚äï) na barra de endere√ßo\n2. Ou v√° em Menu > Instalar aplicativo';
                }
                
                alert('Como instalar o aplicativo:\n\n' + instructions);
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                showNotification('Aplicativo instalado com sucesso!', 'success');
            }
            
            deferredPrompt = null;
            document.getElementById('install-btn').classList.remove('show');
        }
        
        // Detectar se j√° est√° instalado
        window.addEventListener('appinstalled', () => {
            document.getElementById('install-btn').classList.remove('show');
            showNotification('RC EPI Control instalado!', 'success');
        });
        
        // ==================== DADOS DO SISTEMA ====================
        const STORAGE_KEY = 'epi-entregas-v4';
        const CONFIG_KEY = 'epi-config-v4';
        const ESTOQUE_KEY = 'epi-estoque-v1';
        const EMPRESAS_KEY = 'epi-empresas-v1';
        const SYNC_KEY = 'epi-sync-config';
        
        let entregas = [];
        let estoque = [];
        let empresas = [];
        let empresaAtual = null;
        let config = { logo: null, empresa: '', rodape: '' };
        let signatureData = null;
        let capturedPhotoData = null;
        let currentFuncionarioPhoto = null;
        let isDrawing = false;
        let lastPos = { x: 0, y: 0 };
        let videoStream = null;
        
        // Paletas de cores predefinidas
        const PALETAS_CORES = {
            azul: {
                nome: 'Azul Corporativo',
                primaria: [30, 58, 95],
                secundaria: [37, 99, 235],
                accent: [96, 165, 250],
                texto: [50, 50, 50],
                fundo: [245, 248, 252]
            },
            verde: {
                nome: 'Verde Seguran√ßa',
                primaria: [6, 78, 59],
                secundaria: [16, 185, 129],
                accent: [52, 211, 153],
                texto: [50, 50, 50],
                fundo: [240, 253, 244]
            },
            vermelho: {
                nome: 'Vermelho Alerta',
                primaria: [127, 29, 29],
                secundaria: [220, 38, 38],
                accent: [248, 113, 113],
                texto: [50, 50, 50],
                fundo: [254, 242, 242]
            },
            laranja: {
                nome: 'Laranja Energia',
                primaria: [124, 45, 18],
                secundaria: [234, 88, 12],
                accent: [251, 146, 60],
                texto: [50, 50, 50],
                fundo: [255, 247, 237]
            },
            roxo: {
                nome: 'Roxo Premium',
                primaria: [76, 29, 149],
                secundaria: [139, 92, 246],
                accent: [167, 139, 250],
                texto: [50, 50, 50],
                fundo: [245, 243, 255]
            },
            cinza: {
                nome: 'Cinza Neutro',
                primaria: [31, 41, 55],
                secundaria: [75, 85, 99],
                accent: [156, 163, 175],
                texto: [50, 50, 50],
                fundo: [249, 250, 251]
            }
        };
        
        // ==================== GOOGLE DRIVE SYNC ====================
        
        const GOOGLE_CLIENT_ID_KEY = 'epi-google-client-id';
        const GOOGLE_TOKEN_KEY = 'epi-google-token';
        const GOOGLE_USER_KEY = 'epi-google-user';
        const DRIVE_FILE_NAME = 'rc_epi_backup.json';
        const DRIVE_FOLDER_NAME = 'RC_EPI_System';
        
        let googleUser = null;
        let googleToken = null;
        let driveFileId = null;
        let syncTimeout = null;
        let isGoogleApiLoaded = false;
        
        // Inicializar Google API
        function initGoogleAPI() {
            const clientId = localStorage.getItem(GOOGLE_CLIENT_ID_KEY);
            if (!clientId) {
                console.log('Google Client ID n√£o configurado');
                return;
            }
            
            // Verificar se j√° tem token salvo
            const savedToken = localStorage.getItem(GOOGLE_TOKEN_KEY);
            const savedUser = localStorage.getItem(GOOGLE_USER_KEY);
            
            if (savedToken && savedUser) {
                try {
                    googleToken = savedToken;
                    googleUser = JSON.parse(savedUser);
                    
                    // Verificar se token ainda √© v√°lido
                    verificarTokenGoogle().then(valido => {
                        if (valido) {
                            atualizarUIGoogle(true);
                            carregarDoDrive();
                        } else {
                            limparSessaoGoogle();
                        }
                    });
                } catch(e) {
                    limparSessaoGoogle();
                }
            }
            
            isGoogleApiLoaded = true;
        }
        
        // Verificar se token √© v√°lido
        async function verificarTokenGoogle() {
            if (!googleToken) return false;
            
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=' + googleToken);
                return response.ok;
            } catch(e) {
                return false;
            }
        }
        
        // Login com Google
        function handleGoogleSignIn() {
            const clientId = localStorage.getItem(GOOGLE_CLIENT_ID_KEY);
            
            if (!clientId) {
                mostrarGuiaGoogle();
                return;
            }
            
            // Usar Google Identity Services
            const client = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
                callback: (response) => {
                    if (response.access_token) {
                        googleToken = response.access_token;
                        localStorage.setItem(GOOGLE_TOKEN_KEY, googleToken);
                        
                        // Obter info do usu√°rio
                        obterInfoUsuarioGoogle();
                    }
                },
            });
            
            client.requestAccessToken();
        }
        
        // Obter informa√ß√µes do usu√°rio Google
        async function obterInfoUsuarioGoogle() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { 'Authorization': 'Bearer ' + googleToken }
                });
                
                if (response.ok) {
                    googleUser = await response.json();
                    localStorage.setItem(GOOGLE_USER_KEY, JSON.stringify(googleUser));
                    
                    atualizarUIGoogle(true);
                    showNotification(`Conectado como ${googleUser.name}!`, 'success');
                    
                    // Verificar se j√° existe arquivo no Drive
                    await buscarOuCriarArquivoDrive();
                    
                    // Carregar dados do Drive
                    await carregarDoDrive();
                }
            } catch(e) {
                console.error('Erro ao obter info do usu√°rio:', e);
                showNotification('Erro ao conectar com Google', 'error');
            }
        }
        
        // Logout do Google
        function handleGoogleSignOut() {
            if (confirm('Deseja desconectar da conta Google?\n\nOs dados locais ser√£o mantidos, mas a sincroniza√ß√£o autom√°tica ser√° desativada.')) {
                limparSessaoGoogle();
                showNotification('Desconectado do Google', 'success');
            }
        }
        
        function limparSessaoGoogle() {
            googleUser = null;
            googleToken = null;
            driveFileId = null;
            localStorage.removeItem(GOOGLE_TOKEN_KEY);
            localStorage.removeItem(GOOGLE_USER_KEY);
            atualizarUIGoogle(false);
        }
        
        // Atualizar interface com status do Google
        function atualizarUIGoogle(conectado) {
            const notConnected = document.getElementById('google-not-connected');
            const connected = document.getElementById('google-connected');
            const syncStatus = document.getElementById('sync-status');
            
            if (conectado && googleUser) {
                if (notConnected) notConnected.style.display = 'none';
                if (connected) connected.style.display = 'block';
                
                // Atualizar info do usu√°rio
                const photo = document.getElementById('google-user-photo');
                const name = document.getElementById('google-user-name');
                const email = document.getElementById('google-user-email');
                
                if (photo) photo.src = googleUser.picture || '';
                if (name) name.textContent = googleUser.name || 'Usu√°rio';
                if (email) email.textContent = googleUser.email || '';
                
                // Mostrar status de sync
                if (syncStatus) {
                    syncStatus.style.display = 'flex';
                    atualizarStatusSync('synced', '‚òÅÔ∏è', 'Sincronizado');
                }
            } else {
                if (notConnected) notConnected.style.display = 'block';
                if (connected) connected.style.display = 'none';
                
                if (syncStatus) {
                    syncStatus.style.display = 'none';
                }
            }
            
            // Carregar Client ID se existir
            const clientIdInput = document.getElementById('google-client-id');
            if (clientIdInput) {
                clientIdInput.value = localStorage.getItem(GOOGLE_CLIENT_ID_KEY) || '';
            }
        }
        
        // Atualizar indicador de status
        function atualizarStatusSync(status, icon, text) {
            const syncStatus = document.getElementById('sync-status');
            const syncIcon = document.getElementById('sync-icon');
            const syncText = document.getElementById('sync-text');
            
            if (syncStatus) {
                syncStatus.className = 'sync-status ' + status;
                if (syncIcon) syncIcon.innerHTML = icon;
                if (syncText) syncText.textContent = text;
            }
        }
        
        // Buscar ou criar arquivo no Drive
        async function buscarOuCriarArquivoDrive() {
            if (!googleToken) return;
            
            try {
                // Buscar arquivo existente
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='${DRIVE_FILE_NAME}' and trashed=false&spaces=drive`,
                    { headers: { 'Authorization': 'Bearer ' + googleToken } }
                );
                
                if (searchResponse.ok) {
                    const data = await searchResponse.json();
                    if (data.files && data.files.length > 0) {
                        driveFileId = data.files[0].id;
                        console.log('Arquivo encontrado no Drive:', driveFileId);
                        return driveFileId;
                    }
                }
                
                // Criar novo arquivo
                const metadata = {
                    name: DRIVE_FILE_NAME,
                    mimeType: 'application/json'
                };
                
                const createResponse = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + googleToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metadata)
                });
                
                if (createResponse.ok) {
                    const file = await createResponse.json();
                    driveFileId = file.id;
                    console.log('Arquivo criado no Drive:', driveFileId);
                    
                    // Salvar dados iniciais
                    await salvarNoDrive();
                    return driveFileId;
                }
            } catch(e) {
                console.error('Erro ao buscar/criar arquivo:', e);
            }
            
            return null;
        }
        
        // Salvar dados no Drive
        async function salvarNoDrive() {
            if (!googleToken || !driveFileId) {
                console.log('Google n√£o conectado ou arquivo n√£o encontrado');
                return false;
            }
            
            atualizarStatusSync('syncing', '<span class="sync-spinner">üîÑ</span>', 'Salvando...');
            
            try {
                const dados = {
                    versao: '5.0',
                    dataSync: new Date().toISOString(),
                    dados: {
                        entregas: entregas,
                        estoque: estoque,
                        empresas: empresas,
                        config: JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}'),
                        usuarios: JSON.parse(localStorage.getItem(USERS_KEY) || '[]')
                    }
                };
                
                const response = await fetch(
                    `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': 'Bearer ' + googleToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dados)
                    }
                );
                
                if (response.ok) {
                    const agora = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    atualizarStatusSync('synced', '‚òÅÔ∏è', agora);
                    
                    // Atualizar info na tela de config
                    const lastTime = document.getElementById('sync-last-time');
                    const fileSize = document.getElementById('sync-file-size');
                    if (lastTime) lastTime.textContent = agora;
                    if (fileSize) fileSize.textContent = (JSON.stringify(dados).length / 1024).toFixed(1) + ' KB';
                    
                    console.log('Dados salvos no Drive');
                    return true;
                } else {
                    throw new Error('Falha ao salvar');
                }
            } catch(e) {
                console.error('Erro ao salvar no Drive:', e);
                atualizarStatusSync('error', '‚ö†Ô∏è', 'Erro');
                return false;
            }
        }
        
        // Carregar dados do Drive
        async function carregarDoDrive() {
            if (!googleToken) return false;
            
            // Buscar arquivo se n√£o tem ID
            if (!driveFileId) {
                await buscarOuCriarArquivoDrive();
            }
            
            if (!driveFileId) return false;
            
            atualizarStatusSync('syncing', '<span class="sync-spinner">üîÑ</span>', 'Carregando...');
            
            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`,
                    { headers: { 'Authorization': 'Bearer ' + googleToken } }
                );
                
                if (response.ok) {
                    const dados = await response.json();
                    
                    if (dados && dados.dados) {
                        // Verificar se dados do Drive s√£o mais recentes
                        const localDate = localStorage.getItem('epi-last-modified') || '2000-01-01';
                        const driveDate = dados.dataSync || '2000-01-01';
                        
                        if (new Date(driveDate) >= new Date(localDate)) {
                            // Aplicar dados do Drive
                            if (dados.dados.entregas) {
                                entregas = dados.dados.entregas;
                                localStorage.setItem(STORAGE_KEY, JSON.stringify(entregas));
                            }
                            if (dados.dados.estoque) {
                                estoque = dados.dados.estoque;
                                localStorage.setItem(ESTOQUE_KEY, JSON.stringify(estoque));
                            }
                            if (dados.dados.empresas) {
                                empresas = dados.dados.empresas;
                                localStorage.setItem(EMPRESAS_KEY, JSON.stringify(empresas));
                            }
                            if (dados.dados.config) {
                                localStorage.setItem(CONFIG_KEY, JSON.stringify(dados.dados.config));
                            }
                            if (dados.dados.usuarios) {
                                // Mesclar usu√°rios mantendo admin local
                                const usersLocal = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
                                const adminLocal = usersLocal.find(u => u.username === 'admin');
                                let novoUsers = dados.dados.usuarios.filter(u => u.username !== 'admin');
                                if (adminLocal) novoUsers.unshift(adminLocal);
                                localStorage.setItem(USERS_KEY, JSON.stringify(novoUsers));
                            }
                            
                            localStorage.setItem('epi-last-modified', driveDate);
                            
                            // Atualizar UI
                            updateUI();
                            updateEstoqueUI();
                            updateEmpresasUI();
                            
                            console.log('Dados carregados do Drive');
                        }
                    }
                    
                    const agora = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    atualizarStatusSync('synced', '‚òÅÔ∏è', agora);
                    return true;
                }
            } catch(e) {
                console.error('Erro ao carregar do Drive:', e);
                atualizarStatusSync('error', '‚ö†Ô∏è', 'Erro');
            }
            
            return false;
        }
        
        // Auto-sync: salvar no Drive ap√≥s altera√ß√µes
        function agendarSyncDrive() {
            if (!googleToken || !driveFileId) return;
            
            // Cancelar sync anterior pendente
            if (syncTimeout) clearTimeout(syncTimeout);
            
            // Agendar novo sync em 3 segundos (debounce)
            syncTimeout = setTimeout(() => {
                salvarNoDrive();
                localStorage.setItem('epi-last-modified', new Date().toISOString());
            }, 3000);
        }
        
        // Sobrescrever fun√ß√µes de save para incluir sync
        const originalSaveData = typeof saveData === 'function' ? saveData : null;
        const originalSaveEstoque = typeof saveEstoque === 'function' ? saveEstoque : null;
        const originalSaveEmpresas = typeof saveEmpresas === 'function' ? saveEmpresas : null;
        
        // For√ßar sincroniza√ß√£o manual
        function forcarSincronizacao() {
            if (!googleToken) {
                showNotification('Conecte-se ao Google primeiro', 'error');
                return;
            }
            
            salvarNoDrive().then(sucesso => {
                if (sucesso) {
                    showNotification('Sincronizado com sucesso!', 'success');
                } else {
                    showNotification('Erro ao sincronizar', 'error');
                }
            });
        }
        
        // Baixar backup do Drive
        function baixarBackupDrive() {
            if (!googleToken || !driveFileId) {
                showNotification('Conecte-se ao Google primeiro', 'error');
                return;
            }
            
            carregarDoDrive().then(sucesso => {
                if (sucesso) {
                    showNotification('Dados atualizados do Drive!', 'success');
                }
            });
        }
        
        // Ver arquivo no Drive
        function verArquivoDrive() {
            if (driveFileId) {
                window.open(`https://drive.google.com/file/d/${driveFileId}/view`, '_blank');
            } else {
                showNotification('Arquivo n√£o encontrado', 'error');
            }
        }
        
        // Salvar Client ID
        function salvarGoogleClientId() {
            const clientId = document.getElementById('google-client-id').value.trim();
            
            if (!clientId) {
                showNotification('Digite o Client ID', 'error');
                return;
            }
            
            if (!clientId.includes('.apps.googleusercontent.com')) {
                showNotification('Client ID inv√°lido', 'error');
                return;
            }
            
            localStorage.setItem(GOOGLE_CLIENT_ID_KEY, clientId);
            showNotification('Client ID salvo! Agora clique em "Conectar com Google"', 'success');
        }
        
        // Mostrar guia de configura√ß√£o do Google
        function mostrarGuiaGoogle() {
            const guia = `
üìã GUIA DE CONFIGURA√á√ÉO DO GOOGLE CLOUD

Para ativar a sincroniza√ß√£o com Google Drive, siga estes passos:

1Ô∏è‚É£ CRIAR PROJETO NO GOOGLE CLOUD
   ‚Ä¢ Acesse: https://console.cloud.google.com
   ‚Ä¢ Clique em "Criar Projeto"
   ‚Ä¢ Nome: "RC EPI System" (ou outro nome)
   ‚Ä¢ Clique em "Criar"

2Ô∏è‚É£ ATIVAR GOOGLE DRIVE API
   ‚Ä¢ No menu lateral, v√° em "APIs e Servi√ßos" > "Biblioteca"
   ‚Ä¢ Busque "Google Drive API"
   ‚Ä¢ Clique em "Ativar"

3Ô∏è‚É£ CONFIGURAR TELA DE CONSENTIMENTO
   ‚Ä¢ V√° em "APIs e Servi√ßos" > "Tela de consentimento OAuth"
   ‚Ä¢ Selecione "Externo" e clique "Criar"
   ‚Ä¢ Preencha: Nome do app, E-mail de suporte
   ‚Ä¢ Em "Escopos", adicione:
     - .../auth/drive.file
     - .../auth/userinfo.profile
     - .../auth/userinfo.email
   ‚Ä¢ Adicione seu e-mail como "Usu√°rio de teste"
   ‚Ä¢ Salve

4Ô∏è‚É£ CRIAR CREDENCIAIS
   ‚Ä¢ V√° em "APIs e Servi√ßos" > "Credenciais"
   ‚Ä¢ Clique "Criar Credenciais" > "ID do cliente OAuth"
   ‚Ä¢ Tipo: "Aplicativo da Web"
   ‚Ä¢ Nome: "RC EPI Web"
   ‚Ä¢ Origens JavaScript autorizadas:
     - Adicione a URL onde o sistema est√° hospedado
     - Ex: https://seusite.github.io
     - Para teste local: http://localhost
   ‚Ä¢ Clique "Criar"

5Ô∏è‚É£ COPIAR CLIENT ID
   ‚Ä¢ Copie o "ID do cliente" gerado
   ‚Ä¢ Parece com: 123456789-abc123.apps.googleusercontent.com
   ‚Ä¢ Cole no campo "Google Client ID" aqui no sistema
   ‚Ä¢ Clique "Salvar"

‚úÖ Pronto! Agora clique em "Conectar com Google"

üìß D√∫vidas? Contate o suporte t√©cnico.
            `;
            
            alert(guia);
        }
        
        // Modificar fun√ß√µes de save para incluir auto-sync
        function wrapSaveFunction(originalFn, fnName) {
            return function(...args) {
                const result = originalFn ? originalFn.apply(this, args) : true;
                if (result !== false && googleToken) {
                    agendarSyncDrive();
                }
                return result;
            };
        }
        
        // ==================== SINCRONIZA√á√ÉO EM EQUIPE ====================
        
        const TEAM_CODE_KEY = 'epi-team-code';
        const TEAM_FILE_ID_KEY = 'epi-team-file-id';
        let isTeamMember = false;
        let teamSyncInterval = null;
        
        // Gerar c√≥digo de equipe baseado no ID do arquivo
        async function gerarCodigoEquipe() {
            if (!driveFileId) {
                showNotification('Sincronize primeiro com o Google Drive', 'error');
                return;
            }
            
            // Primeiro, tornar o arquivo p√∫blico
            const sucesso = await compartilharArquivoDrive();
            if (!sucesso) {
                showNotification('Erro ao gerar c√≥digo. Tente novamente.', 'error');
                return;
            }
            
            // O "c√≥digo" √© o pr√≥prio file ID (necess√°rio para acesso direto)
            const codigo = driveFileId;
            
            // Salvar mapeamento
            const teamData = {
                code: codigo,
                fileId: driveFileId,
                createdAt: new Date().toISOString(),
                owner: googleUser?.email || 'admin'
            };
            
            localStorage.setItem(TEAM_CODE_KEY, JSON.stringify(teamData));
            
            // Gerar link de equipe
            const linkEquipe = gerarLinkEquipe(driveFileId);
            
            // Mostrar c√≥digo e link
            document.getElementById('team-code-display').value = driveFileId;
            document.getElementById('team-link-display').value = linkEquipe;
            document.getElementById('team-link-section').style.display = 'block';
            
            showNotification('Link de equipe gerado com sucesso!', 'success');
        }
        
        // Gerar link de equipe
        function gerarLinkEquipe(fileId) {
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?team=${fileId}`;
        }
        
        // Compartilhar arquivo do Drive (tornar p√∫blico)
        async function compartilharArquivoDrive() {
            if (!googleToken || !driveFileId) return false;
            
            try {
                // Adicionar permiss√£o de leitura para qualquer pessoa
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${driveFileId}/permissions`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + googleToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            role: 'reader',
                            type: 'anyone'
                        })
                    }
                );
                
                return response.ok;
            } catch(e) {
                console.error('Erro ao compartilhar:', e);
                return false;
            }
        }
        
        // Adicionar membro da equipe por e-mail
        async function adicionarMembroEquipe() {
            const email = document.getElementById('team-member-email').value.trim().toLowerCase();
            
            if (!email || !email.includes('@')) {
                showNotification('Digite um e-mail v√°lido', 'error');
                return;
            }
            
            if (!googleToken || !driveFileId) {
                showNotification('Gere o link de equipe primeiro', 'error');
                return;
            }
            
            try {
                showNotification('Adicionando membro...', 'info');
                
                // Adicionar permiss√£o de leitura para o e-mail espec√≠fico
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${driveFileId}/permissions`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + googleToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            role: 'reader',
                            type: 'user',
                            emailAddress: email
                        })
                    }
                );
                
                if (response.ok) {
                    showNotification(`${email} adicionado √† equipe! Envie o c√≥digo para ele.`, 'success');
                    document.getElementById('team-member-email').value = '';
                } else {
                    const erro = await response.json();
                    console.error('Erro ao adicionar:', erro);
                    showNotification('Erro ao adicionar membro. Verifique o e-mail.', 'error');
                }
            } catch(e) {
                console.error('Erro:', e);
                showNotification('Erro de conex√£o', 'error');
            }
        }
        
        // Copiar link para clipboard
        function copiarLinkEquipe() {
            const link = document.getElementById('team-link-display').value;
            if (!link || link === '') {
                showNotification('Gere um link primeiro', 'error');
                return;
            }
            
            navigator.clipboard.writeText(link).then(() => {
                showNotification('Link copiado! Envie para sua equipe via WhatsApp, e-mail, etc.', 'success');
            }).catch(() => {
                const input = document.getElementById('team-link-display');
                input.select();
                document.execCommand('copy');
                showNotification('Link copiado!', 'success');
            });
        }
        
        // Copiar c√≥digo para clipboard
        function copiarCodigoEquipe() {
            const codigo = document.getElementById('team-code-display').value;
            if (!codigo || codigo === '') {
                showNotification('Gere um c√≥digo primeiro', 'error');
                return;
            }
            
            navigator.clipboard.writeText(codigo).then(() => {
                showNotification('C√≥digo copiado!', 'success');
            }).catch(() => {
                const input = document.getElementById('team-code-display');
                input.select();
                document.execCommand('copy');
                showNotification('C√≥digo copiado!', 'success');
            });
        }
        
        // Verificar se veio por link de equipe (par√¢metro na URL)
        function verificarLinkEquipe() {
            const urlParams = new URLSearchParams(window.location.search);
            const teamFileId = urlParams.get('team');
            
            if (teamFileId && teamFileId.length > 10) {
                console.log('Link de equipe detectado:', teamFileId);
                
                // Salvar file ID da equipe
                localStorage.setItem(TEAM_FILE_ID_KEY, teamFileId);
                isTeamMember = true;
                localStorage.setItem('epi-is-team-member', 'true');
                
                // Baixar dados automaticamente
                baixarDadosEquipe(teamFileId);
                
                // Iniciar sincroniza√ß√£o autom√°tica
                iniciarSyncEquipe(teamFileId);
                
                // Mostrar status de equipe na interface
                mostrarStatusEquipe(teamFileId);
                
                // Limpar URL (remover par√¢metro team)
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            } else {
                // Verificar se j√° √© membro de equipe
                const savedFileId = localStorage.getItem(TEAM_FILE_ID_KEY);
                if (savedFileId) {
                    isTeamMember = true;
                    iniciarSyncEquipe(savedFileId);
                    mostrarStatusEquipe(savedFileId);
                }
            }
        }
        
        // Baixar dados da equipe do Google Drive (arquivo p√∫blico)
        async function baixarDadosEquipe(fileId) {
            try {
                atualizarStatusEquipeUI('syncing', 'üîÑ Sincronizando...');
                
                // M√©todo 1: API direta (funciona para arquivos p√∫blicos pequenos)
                let dados = null;
                
                try {
                    const response = await fetch(
                        `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                        { 
                            method: 'GET',
                            headers: { 'Accept': 'application/json' }
                        }
                    );
                    
                    if (response.ok) {
                        dados = await response.json();
                    }
                } catch(e) {
                    console.log('M√©todo 1 falhou, tentando alternativo...');
                }
                
                // M√©todo 2: Via export link (para arquivos maiores)
                if (!dados) {
                    try {
                        // Usar um endpoint que funciona melhor para CORS
                        const proxyUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                        
                        // Tentar via fetch com modo no-cors n√£o funciona bem,
                        // ent√£o vamos armazenar localmente e usar import manual como backup
                        
                        // Verificar se temos dados em cache
                        const cachedData = localStorage.getItem('epi-team-cache-' + fileId);
                        if (cachedData) {
                            dados = JSON.parse(cachedData);
                            console.log('Usando dados em cache');
                        }
                    } catch(e) {
                        console.log('M√©todo 2 falhou:', e);
                    }
                }
                
                if (dados) {
                    aplicarDadosEquipe(dados);
                    // Salvar em cache para acesso offline
                    localStorage.setItem('epi-team-cache-' + fileId, JSON.stringify(dados));
                    return true;
                }
                
                // Se nenhum m√©todo funcionou, mostrar op√ß√£o de import manual
                mostrarOpcaoImportManual();
                return false;
                
            } catch(e) {
                console.error('Erro ao baixar dados da equipe:', e);
                atualizarStatusEquipeUI('error', '‚ö†Ô∏è Erro de conex√£o');
                mostrarOpcaoImportManual();
                return false;
            }
        }
        
        // Mostrar op√ß√£o de import manual quando auto-sync falha
        function mostrarOpcaoImportManual() {
            const statusDiv = document.getElementById('team-status');
            if (statusDiv) {
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `
                    <div style="background:rgba(245,158,11,0.1);padding:1rem;border-radius:8px;border-left:3px solid #f59e0b;margin-top:1rem;">
                        <p style="color:#fbbf24;font-size:0.9rem;margin-bottom:0.75rem;">
                            <strong>‚ö†Ô∏è Sincroniza√ß√£o autom√°tica indispon√≠vel</strong>
                        </p>
                        <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem;">
                            O Google Drive bloqueou o acesso direto. Use a importa√ß√£o manual:
                        </p>
                        <ol style="color:#94a3b8;font-size:0.85rem;margin-left:1.5rem;margin-bottom:1rem;">
                            <li>O admin exporta os dados (Empresas ‚Üí Exportar Tudo)</li>
                            <li>Envia o arquivo JSON para voc√™</li>
                            <li>Voc√™ importa abaixo:</li>
                        </ol>
                        <button class="btn-primary" onclick="document.getElementById('import-team-manual').click()">
                            üì• Importar Arquivo JSON
                        </button>
                        <input type="file" id="import-team-manual" accept=".json" style="display:none" onchange="importarArquivoEquipe(event)">
                    </div>
                `;
            }
            atualizarStatusEquipeUI('error', '‚ö†Ô∏è Use import manual');
        }
        
        // Aplicar dados recebidos da equipe
        function aplicarDadosEquipe(dados) {
            if (!dados || !dados.dados) {
                console.log('Dados inv√°lidos recebidos');
                return;
            }
            
            const dadosInternos = dados.dados;
            
            // Verificar se dados s√£o mais recentes
            const localDate = localStorage.getItem('epi-last-modified') || '2000-01-01';
            const remoteDate = dados.dataSync || '2000-01-01';
            
            if (new Date(remoteDate) >= new Date(localDate)) {
                // Aplicar dados
                if (dadosInternos.entregas) {
                    entregas = dadosInternos.entregas;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(entregas));
                }
                if (dadosInternos.estoque) {
                    estoque = dadosInternos.estoque;
                    localStorage.setItem(ESTOQUE_KEY, JSON.stringify(estoque));
                }
                if (dadosInternos.empresas) {
                    empresas = dadosInternos.empresas;
                    localStorage.setItem(EMPRESAS_KEY, JSON.stringify(empresas));
                }
                if (dadosInternos.config) {
                    localStorage.setItem(CONFIG_KEY, JSON.stringify(dadosInternos.config));
                }
                if (dadosInternos.usuarios) {
                    // Mesclar usu√°rios mantendo admin local
                    const usersLocal = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
                    const adminLocal = usersLocal.find(u => u.username === 'admin');
                    let novoUsers = dadosInternos.usuarios.filter(u => u.username !== 'admin');
                    if (adminLocal) novoUsers.unshift(adminLocal);
                    localStorage.setItem(USERS_KEY, JSON.stringify(novoUsers));
                }
                
                localStorage.setItem('epi-last-modified', remoteDate);
                
                // Atualizar UI
                updateUI();
                updateEstoqueUI();
                updateEmpresasUI();
                
                const agora = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                atualizarStatusEquipeUI('synced', `‚úÖ Atualizado √†s ${agora}`);
                
                console.log('Dados da equipe aplicados com sucesso');
            } else {
                atualizarStatusEquipeUI('synced', '‚úÖ Dados atualizados');
            }
        }
        
        // Iniciar sincroniza√ß√£o autom√°tica a cada 2 minutos
        function iniciarSyncEquipe(fileId) {
            // Limpar intervalo anterior se existir
            if (teamSyncInterval) {
                clearInterval(teamSyncInterval);
            }
            
            // Sincronizar a cada 2 minutos (120000 ms)
            teamSyncInterval = setInterval(() => {
                console.log('Sincroniza√ß√£o autom√°tica de equipe...');
                baixarDadosEquipe(fileId);
            }, 120000);
            
            console.log('Sincroniza√ß√£o autom√°tica de equipe iniciada (a cada 2 min)');
        }
        
        // Mostrar status de equipe na interface
        function mostrarStatusEquipe(fileId) {
            // Criar ou atualizar elemento de status
            let statusEl = document.getElementById('team-member-status');
            
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = 'team-member-status';
                statusEl.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #1e3a5f;
                    padding: 0.75rem 1rem;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    font-size: 0.85rem;
                    border-left: 3px solid #8b5cf6;
                `;
                document.body.appendChild(statusEl);
            }
            
            statusEl.innerHTML = `
                <span style="color:#a78bfa;">üë•</span>
                <span style="color:#e2e8f0;">Equipe</span>
                <span id="team-sync-status" style="color:#10b981;">‚úÖ Conectado</span>
                <button onclick="sincronizarEquipeManual()" style="background:#8b5cf6;border:none;color:white;padding:0.25rem 0.5rem;border-radius:5px;font-size:0.75rem;cursor:pointer;margin-left:0.5rem;">
                    üîÑ
                </button>
            `;
        }
        
        // Atualizar UI do status da equipe
        function atualizarStatusEquipeUI(status, texto) {
            const statusEl = document.getElementById('team-sync-status');
            if (statusEl) {
                statusEl.textContent = texto;
                statusEl.style.color = status === 'synced' ? '#10b981' : 
                                       status === 'syncing' ? '#60a5fa' : '#ef4444';
            }
        }
        
        // Sincronizar equipe manualmente
        function sincronizarEquipeManual() {
            const fileId = localStorage.getItem(TEAM_FILE_ID_KEY);
            if (fileId) {
                showNotification('Sincronizando...', 'info');
                baixarDadosEquipe(fileId);
            }
        }
        
        // Entrar na equipe via Google (para quem foi convidado por e-mail)
        async function entrarEquipeViaGoogle() {
            const clientId = localStorage.getItem(GOOGLE_CLIENT_ID_KEY);
            
            if (!clientId) {
                // Se n√£o tem client ID configurado, pedir o c√≥digo
                showNotification('Pe√ßa ao administrador o c√≥digo de equipe', 'info');
                return;
            }
            
            const statusDiv = document.getElementById('team-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p style="color:#60a5fa;">üîÑ Conectando ao Google...</p>';
            
            try {
                // Usar Google Identity Services
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.email',
                    callback: async (response) => {
                        if (response.access_token) {
                            const token = response.access_token;
                            
                            // Buscar arquivos compartilhados com o usu√°rio
                            statusDiv.innerHTML = '<p style="color:#60a5fa;">üîÑ Buscando dados da equipe...</p>';
                            
                            try {
                                const searchResponse = await fetch(
                                    `https://www.googleapis.com/drive/v3/files?q=name='rc_epi_backup.json' and trashed=false&spaces=drive`,
                                    { headers: { 'Authorization': 'Bearer ' + token } }
                                );
                                
                                if (searchResponse.ok) {
                                    const data = await searchResponse.json();
                                    
                                    if (data.files && data.files.length > 0) {
                                        // Encontrou arquivo da equipe!
                                        const teamFileId = data.files[0].id;
                                        
                                        // Baixar dados
                                        const downloadResponse = await fetch(
                                            `https://www.googleapis.com/drive/v3/files/${teamFileId}?alt=media`,
                                            { headers: { 'Authorization': 'Bearer ' + token } }
                                        );
                                        
                                        if (downloadResponse.ok) {
                                            const dados = await downloadResponse.json();
                                            
                                            // Salvar configura√ß√µes
                                            localStorage.setItem(TEAM_FILE_ID_KEY, teamFileId);
                                            localStorage.setItem('epi-team-token', token);
                                            isTeamMember = true;
                                            localStorage.setItem('epi-is-team-member', 'true');
                                            
                                            // Aplicar dados
                                            aplicarDadosEquipe(dados);
                                            
                                            // Iniciar sync autom√°tico
                                            iniciarSyncEquipeComToken(teamFileId, token);
                                            mostrarStatusEquipe(teamFileId);
                                            
                                            statusDiv.innerHTML = `
                                                <div style="background:rgba(16,185,129,0.1);padding:1rem;border-radius:8px;border-left:3px solid #10b981;">
                                                    <p style="color:#10b981;font-size:0.9rem;">
                                                        ‚úÖ <strong>Conectado √† equipe!</strong><br>
                                                        Sincroniza√ß√£o autom√°tica ativa a cada 2 minutos.
                                                    </p>
                                                </div>
                                            `;
                                            
                                            showNotification('Conectado √† equipe!', 'success');
                                            return;
                                        }
                                    }
                                    
                                    // N√£o encontrou arquivo
                                    statusDiv.innerHTML = `
                                        <div style="background:rgba(245,158,11,0.1);padding:1rem;border-radius:8px;border-left:3px solid #f59e0b;">
                                            <p style="color:#fbbf24;font-size:0.9rem;">
                                                ‚ö†Ô∏è <strong>Nenhum arquivo encontrado</strong><br>
                                                Pe√ßa ao administrador para adicionar seu e-mail na equipe.
                                            </p>
                                        </div>
                                    `;
                                }
                            } catch(e) {
                                console.error('Erro ao buscar dados:', e);
                                statusDiv.innerHTML = '<p style="color:#ef4444;">‚ùå Erro ao conectar</p>';
                            }
                        }
                    },
                });
                
                client.requestAccessToken();
            } catch(e) {
                console.error('Erro:', e);
                statusDiv.innerHTML = '<p style="color:#ef4444;">‚ùå Erro ao conectar com Google</p>';
            }
        }
        
        // Iniciar sync com token espec√≠fico (para membros da equipe)
        function iniciarSyncEquipeComToken(fileId, token) {
            if (teamSyncInterval) {
                clearInterval(teamSyncInterval);
            }
            
            teamSyncInterval = setInterval(async () => {
                console.log('Sync autom√°tico de equipe...');
                atualizarStatusEquipeUI('syncing', 'üîÑ Atualizando...');
                
                try {
                    const response = await fetch(
                        `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                        { headers: { 'Authorization': 'Bearer ' + token } }
                    );
                    
                    if (response.ok) {
                        const dados = await response.json();
                        aplicarDadosEquipe(dados);
                    }
                } catch(e) {
                    console.error('Erro no sync:', e);
                    atualizarStatusEquipeUI('error', '‚ö†Ô∏è Erro');
                }
            }, 120000); // 2 minutos
        }
        
        // Entrar em uma equipe usando c√≥digo (file ID)
        async function entrarEquipe() {
            const codigoInput = document.getElementById('team-code-input').value.trim();
            
            if (!codigoInput || codigoInput.length < 10) {
                showNotification('Digite um c√≥digo v√°lido', 'error');
                return;
            }
            
            const statusDiv = document.getElementById('team-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p style="color:#60a5fa;">üîÑ Conectando √† equipe...</p>';
            
            // Salvar file ID da equipe
            localStorage.setItem(TEAM_FILE_ID_KEY, codigoInput);
            isTeamMember = true;
            localStorage.setItem('epi-is-team-member', 'true');
            
            // Baixar dados
            const sucesso = await baixarDadosEquipe(codigoInput);
            
            if (sucesso) {
                // Iniciar sync autom√°tico
                iniciarSyncEquipe(codigoInput);
                mostrarStatusEquipe(codigoInput);
                
                statusDiv.innerHTML = `
                    <div style="background:rgba(16,185,129,0.1);padding:1rem;border-radius:8px;border-left:3px solid #10b981;">
                        <p style="color:#10b981;font-size:0.9rem;">
                            ‚úÖ <strong>Conectado √† equipe!</strong><br>
                            Os dados ser√£o atualizados automaticamente a cada 2 minutos.
                        </p>
                    </div>
                `;
                
                showNotification('Conectado √† equipe com sucesso!', 'success');
            } else {
                statusDiv.innerHTML = `
                    <div style="background:rgba(239,68,68,0.1);padding:1rem;border-radius:8px;border-left:3px solid #ef4444;">
                        <p style="color:#ef4444;font-size:0.9rem;">
                            ‚ùå <strong>Erro ao conectar</strong><br>
                            Verifique se o c√≥digo est√° correto e tente novamente.
                        </p>
                    </div>
                `;
            }
        }
        
        // Importar arquivo da equipe (manual)
        function importarArquivoEquipe(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    
                    // Verificar formato (pode ser export direto ou formato sync)
                    let dadosParaAplicar = dados;
                    
                    if (dados.dados) {
                        // Formato de sincroniza√ß√£o (com wrapper)
                        dadosParaAplicar = { dados: dados.dados };
                    } else if (dados.empresas || dados.entregas || dados.estoque) {
                        // Formato de export direto
                        dadosParaAplicar = { dados: dados };
                    }
                    
                    if (dadosParaAplicar.dados) {
                        aplicarDadosEquipe(dadosParaAplicar);
                        
                        // Marcar como membro de equipe
                        isTeamMember = true;
                        localStorage.setItem('epi-is-team-member', 'true');
                        
                        // Atualizar status
                        const statusDiv = document.getElementById('team-status');
                        if (statusDiv) {
                            statusDiv.innerHTML = `
                                <div style="background:rgba(16,185,129,0.1);padding:1rem;border-radius:8px;border-left:3px solid #10b981;">
                                    <p style="color:#10b981;font-size:0.9rem;">
                                        ‚úÖ <strong>Dados importados com sucesso!</strong><br>
                                        Solicite atualiza√ß√µes periodicamente ao administrador.
                                    </p>
                                </div>
                            `;
                        }
                        
                        showNotification('Dados da equipe importados!', 'success');
                    } else {
                        showNotification('Formato de arquivo inv√°lido', 'error');
                    }
                } catch(err) {
                    console.error('Erro ao importar:', err);
                    showNotification('Erro ao ler arquivo JSON', 'error');
                }
            };
            reader.readAsText(file);
            
            // Limpar input para permitir reimporta√ß√£o
            event.target.value = '';
        }
        
        // Sair da equipe
        function sairEquipe() {
            if (confirm('Deseja sair da equipe? Os dados locais ser√£o mantidos.')) {
                localStorage.removeItem(TEAM_FILE_ID_KEY);
                localStorage.removeItem('epi-is-team-member');
                isTeamMember = false;
                
                if (teamSyncInterval) {
                    clearInterval(teamSyncInterval);
                }
                
                const statusEl = document.getElementById('team-member-status');
                if (statusEl) statusEl.remove();
                
                showNotification('Voc√™ saiu da equipe', 'success');
            }
        }
        
        // Verificar se √© membro de equipe ao iniciar
        function verificarMembroEquipe() {
            // Verificar link de equipe primeiro
            verificarLinkEquipe();
            
            // Carregar c√≥digo existente se houver
            const teamData = localStorage.getItem(TEAM_CODE_KEY);
            if (teamData) {
                try {
                    const team = JSON.parse(teamData);
                    const codeDisplay = document.getElementById('team-code-display');
                    if (codeDisplay && team.code) {
                        codeDisplay.value = team.code;
                        // Gerar link tamb√©m
                        const linkDisplay = document.getElementById('team-link-display');
                        if (linkDisplay) {
                            linkDisplay.value = gerarLinkEquipe(team.code);
                            document.getElementById('team-link-section').style.display = 'block';
                        }
                    }
                } catch(e) {}
            }
        }
        
        // ==================== FIM GOOGLE DRIVE SYNC ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar usu√°rios
            initUsers();
            
            // Inicializar Firebase (opcional - n√£o bloqueia o sistema)
            setTimeout(initFirebase, 500);
            
            // Verificar se est√° logado
            checkAuth();
            
            // Carregar dados sempre (ser√£o exibidos ap√≥s login)
            loadData();
            loadConfig();
            loadEstoque();
            loadEmpresas();
            
            // Inicializar Google API ap√≥s carregar dados locais
            setTimeout(initGoogleAPI, 1000);
            
            // Verificar se √© membro de equipe
            setTimeout(verificarMembroEquipe, 1500);
            
            document.addEventListener('click', function(e) {
                const autocompleteList = document.getElementById('autocomplete-list');
                const autocompleteEpi = document.getElementById('autocomplete-epi');
                
                if (!e.target.closest('#cpf') && !e.target.closest('#autocomplete-list')) {
                    autocompleteList?.classList.add('hidden');
                }
                
                if (!e.target.closest('#descricaoEPI') && !e.target.closest('#autocomplete-epi') && !e.target.closest('[onclick*="mostrarTodosEPIs"]')) {
                    autocompleteEpi?.classList.add('hidden');
                }
            });
        });
        
        function loadData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) entregas = JSON.parse(data);
            } catch (e) {}
            updateUI();
        }
        
        function loadConfig() {
            try {
                const data = localStorage.getItem(CONFIG_KEY);
                if (data) {
                    config = JSON.parse(data);
                    if (config.logo) {
                        document.getElementById('logo-preview').src = config.logo;
                        document.getElementById('logo-preview').classList.remove('hidden');
                        document.getElementById('logo-placeholder').classList.add('hidden');
                        document.getElementById('logo-upload').classList.add('has-logo');
                        document.getElementById('btn-remove-logo').classList.remove('hidden');
                    }
                    if (config.empresa) document.getElementById('config-empresa').value = config.empresa;
                    if (config.rodape) document.getElementById('config-rodape').value = config.rodape;
                }
            } catch (e) {}
        }
        
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(entregas));
                localStorage.setItem('epi-last-modified', new Date().toISOString());
                // Auto-sync com Google Drive
                if (googleToken) agendarSyncDrive();
                return true;
            } catch (e) { return false; }
        }
        
        function loadEstoque() {
            try {
                const data = localStorage.getItem(ESTOQUE_KEY);
                if (data) estoque = JSON.parse(data);
            } catch (e) {}
            updateEstoqueUI();
        }
        
        function saveEstoque() {
            try {
                localStorage.setItem(ESTOQUE_KEY, JSON.stringify(estoque));
                localStorage.setItem('epi-last-modified', new Date().toISOString());
                // Auto-sync com Google Drive
                if (googleToken) agendarSyncDrive();
                return true;
            } catch (e) { return false; }
        }
        
        let estoqueEmpresaSelecionada = null;
        
        function filtrarEstoquePorEmpresa() {
            const select = document.getElementById('estoque-empresa-select');
            const cnpj = select ? select.value : '';
            estoqueEmpresaSelecionada = cnpj || null;
            
            const semEmpresa = document.getElementById('estoque-sem-empresa');
            const formContainer = document.getElementById('form-estoque-container');
            const listaContainer = document.getElementById('lista-estoque');
            const emptyEstoque = document.getElementById('empty-estoque');
            
            if (!cnpj) {
                // Nenhuma empresa selecionada
                if (semEmpresa) semEmpresa.style.display = 'block';
                if (formContainer) formContainer.classList.add('hidden');
                if (listaContainer) listaContainer.innerHTML = '';
                if (emptyEstoque) emptyEstoque.classList.add('hidden');
                
                // Zerar estat√≠sticas
                document.getElementById('total-itens-estoque').textContent = '0';
                document.getElementById('total-em-estoque').textContent = '0';
                document.getElementById('itens-abaixo-minimo').textContent = '0';
                document.getElementById('alertas-estoque').classList.add('hidden');
            } else {
                // Empresa selecionada
                if (semEmpresa) semEmpresa.style.display = 'none';
                if (formContainer) formContainer.classList.remove('hidden');
                updateEstoqueUI();
            }
        }
        
        function getEstoqueEmpresa() {
            if (!estoqueEmpresaSelecionada) return [];
            return estoque.filter(e => e.cnpj === estoqueEmpresaSelecionada);
        }
        
        function updateEstoqueUI() {
            // Atualizar select de empresas
            const selectEstoque = document.getElementById('estoque-empresa-select');
            if (selectEstoque && empresas.length > 0) {
                const valorAtual = selectEstoque.value;
                selectEstoque.innerHTML = '<option value="">Selecione uma empresa...</option>' +
                    empresas.map(e => `<option value="${e.cnpj}" ${e.cnpj === valorAtual ? 'selected' : ''}>${e.fantasia || e.razao}</option>`).join('');
            }
            
            // Se n√£o h√° empresa selecionada, n√£o continuar
            if (!estoqueEmpresaSelecionada) {
                filtrarEstoquePorEmpresa();
                return;
            }
            
            // Filtrar estoque pela empresa selecionada
            const estoqueEmpresa = getEstoqueEmpresa();
            
            // Resumo
            document.getElementById('total-itens-estoque').textContent = estoqueEmpresa.length;
            document.getElementById('total-em-estoque').textContent = estoqueEmpresa.reduce((sum, e) => sum + e.quantidade, 0);
            
            const abaixoMinimo = estoqueEmpresa.filter(e => e.quantidade < e.estoqueMinimo);
            document.getElementById('itens-abaixo-minimo').textContent = abaixoMinimo.length;
            
            // Badge no header (considera todas empresas)
            const todoAbaixoMinimo = estoque.filter(e => e.quantidade < e.estoqueMinimo);
            const badgeEstoque = document.getElementById('badge-estoque-baixo');
            const statsEstoque = document.getElementById('stats-estoque-baixo');
            if (todoAbaixoMinimo.length > 0) {
                badgeEstoque.style.display = 'flex';
                statsEstoque.textContent = todoAbaixoMinimo.length;
            } else {
                badgeEstoque.style.display = 'none';
            }
            
            // Atualizar dica no formul√°rio de entrega
            const dica = document.getElementById('dica-estoque');
            if (dica) {
                if (estoque.length > 0) {
                    dica.innerHTML = `<span style="color:#10b981;">‚úì ${estoque.length} EPI(s) no estoque - clique no campo ou no bot√£o üì¶ Estoque</span>`;
                } else {
                    dica.innerHTML = 'üí° Cadastre EPIs na aba <strong>Estoque</strong> para selecionar automaticamente';
                }
            }
            
            // Alertas
            const alertasDiv = document.getElementById('alertas-estoque');
            const listaAlertas = document.getElementById('lista-alertas');
            
            if (abaixoMinimo.length > 0) {
                alertasDiv.classList.remove('hidden');
                listaAlertas.innerHTML = abaixoMinimo.map(e => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;background:rgba(239,68,68,0.1);border-radius:6px;margin-bottom:0.5rem;">
                        <span><strong>${e.descricao}</strong> (CA ${e.ca})</span>
                        <span style="color:#ef4444;font-weight:600;">${e.quantidade}/${e.estoqueMinimo} ${e.unidade}</span>
                    </div>
                `).join('');
            } else {
                alertasDiv.classList.add('hidden');
            }
            
            // Lista de EPIs
            filtrarEstoque();
        }
        
        function filtrarEstoque() {
            const busca = document.getElementById('busca-estoque')?.value.toLowerCase() || '';
            const filtro = document.getElementById('filtro-estoque')?.value || '';
            
            // Filtrar pelo estoque da empresa selecionada
            const estoqueEmpresa = getEstoqueEmpresa();
            
            let itens = estoqueEmpresa.filter(e => {
                const matchBusca = e.descricao.toLowerCase().includes(busca) || e.ca.includes(busca);
                let matchFiltro = true;
                
                if (filtro === 'baixo') matchFiltro = e.quantidade < e.estoqueMinimo && e.quantidade > 0;
                if (filtro === 'ok') matchFiltro = e.quantidade >= e.estoqueMinimo;
                if (filtro === 'zerado') matchFiltro = e.quantidade === 0;
                
                return matchBusca && matchFiltro;
            });
            
            const container = document.getElementById('lista-estoque');
            const empty = document.getElementById('empty-estoque');
            
            if (itens.length === 0 && estoqueEmpresa.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            if (itens.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#64748b;padding:2rem;">Nenhum item encontrado</p>';
                return;
            }
            
            container.innerHTML = itens.map(e => {
                let status = 'ok';
                if (e.quantidade === 0) status = 'zerado';
                else if (e.quantidade < e.estoqueMinimo) status = 'baixo';
                
                const porcentagem = e.estoqueMinimo > 0 ? Math.min(100, (e.quantidade / (e.estoqueMinimo * 2)) * 100) : 100;
                
                // Verificar validade
                let validadeBadge = '';
                if (e.validade) {
                    const hoje = new Date();
                    const validade = new Date(e.validade);
                    const diasRestantes = Math.ceil((validade - hoje) / (1000 * 60 * 60 * 24));
                    
                    if (diasRestantes < 0) {
                        validadeBadge = '<span class="badge-validade vencido">CA VENCIDO</span>';
                    } else if (diasRestantes <= 90) {
                        validadeBadge = `<span class="badge-validade proximo">Vence em ${diasRestantes} dias</span>`;
                    } else {
                        validadeBadge = `<span class="badge-validade ok">V√°lido at√© ${formatDate(e.validade)}</span>`;
                    }
                }
                
                return `
                    <div class="estoque-card ${status}">
                        <div class="estoque-header">
                            <div class="estoque-info">
                                <h4>${e.descricao}</h4>
                                <p>CA: ${e.ca} ${validadeBadge}</p>
                            </div>
                            <div class="estoque-numeros">
                                <div class="estoque-numero">
                                    <div class="valor ${status}">${e.quantidade}</div>
                                    <div class="label">Em Estoque</div>
                                </div>
                                <div class="estoque-numero">
                                    <div class="valor" style="color:#64748b;">${e.estoqueMinimo}</div>
                                    <div class="label">M√≠nimo</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="estoque-barra">
                            <div class="estoque-barra-fill ${status}" style="width:${porcentagem}%"></div>
                        </div>
                        
                        <div class="estoque-actions">
                            <button class="btn-small entrada" onclick="movimentarEstoque('${e.id}', 'entrada')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                                Entrada
                            </button>
                            <button class="btn-small saida" onclick="movimentarEstoque('${e.id}', 'saida')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>
                                Sa√≠da
                            </button>
                            <button class="btn-small" style="background:#8b5cf6;color:white;" onclick="verHistoricoEstoque('${e.id}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                Hist√≥rico
                            </button>
                            <button class="btn-small editar" onclick="editarEPIEstoque('${e.id}')" title="Editar EPI">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                Editar
                            </button>
                            <button class="btn-small excluir" onclick="excluirEPIEstoque('${e.id}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function cadastrarEPIEstoque(e) {
            e.preventDefault();
            
            // Verificar se empresa est√° selecionada
            if (!estoqueEmpresaSelecionada) {
                showNotification('Selecione uma empresa primeiro!', 'error');
                return;
            }
            
            const novoEPI = {
                id: Date.now().toString(),
                cnpj: estoqueEmpresaSelecionada, // Vincular √† empresa
                descricao: document.getElementById('est-descricao').value,
                ca: document.getElementById('est-ca').value,
                quantidade: parseInt(document.getElementById('est-quantidade').value) || 0,
                estoqueMinimo: parseInt(document.getElementById('est-minimo').value) || 0,
                unidade: document.getElementById('est-unidade').value,
                validade: document.getElementById('est-validade').value || null,
                historico: [{
                    tipo: 'inicial',
                    quantidade: parseInt(document.getElementById('est-quantidade').value) || 0,
                    data: new Date().toISOString(),
                    obs: 'Cadastro inicial'
                }],
                dataCadastro: new Date().toISOString()
            };
            
            // Verificar se CA j√° existe NESTA EMPRESA
            if (estoque.some(e => e.ca === novoEPI.ca && e.cnpj === estoqueEmpresaSelecionada)) {
                showNotification('CA j√° cadastrado nesta empresa!', 'error');
                return;
            }
            
            estoque.push(novoEPI);
            
            if (saveEstoque()) {
                showNotification('EPI cadastrado no estoque!', 'success');
                document.getElementById('form-estoque').reset();
                updateEstoqueUI();
            }
        }
        
        function movimentarEstoque(id, tipo) {
            const epi = estoque.find(e => e.id === id);
            if (!epi) return;
            
            const qtd = prompt(`${tipo === 'entrada' ? 'üì• ENTRADA' : 'üì§ SA√çDA'} de Estoque\n\n${epi.descricao}\nEstoque atual: ${epi.quantidade} ${epi.unidade}\n\nQuantidade:`);
            
            if (!qtd || isNaN(qtd) || parseInt(qtd) <= 0) {
                if (qtd !== null) showNotification('Quantidade inv√°lida', 'error');
                return;
            }
            
            const quantidade = parseInt(qtd);
            
            if (tipo === 'saida' && quantidade > epi.quantidade) {
                showNotification('Quantidade maior que estoque dispon√≠vel!', 'error');
                return;
            }
            
            const obs = prompt('Observa√ß√£o (opcional):') || '';
            
            if (tipo === 'entrada') {
                epi.quantidade += quantidade;
            } else {
                epi.quantidade -= quantidade;
            }
            
            epi.historico.push({
                tipo: tipo,
                quantidade: quantidade,
                data: new Date().toISOString(),
                obs: obs
            });
            
            if (saveEstoque()) {
                showNotification(`${tipo === 'entrada' ? 'Entrada' : 'Sa√≠da'} registrada!`, 'success');
                updateEstoqueUI();
            }
        }
        
        function editarEPIEstoque(id) {
            const epi = estoque.find(e => e.id === id);
            if (!epi) return;
            
            document.getElementById('modal-titulo').textContent = `Editar: ${epi.descricao}`;
            
            document.getElementById('modal-content').innerHTML = `
                <form id="form-editar-epi" onsubmit="salvarEdicaoEPI(event, '${id}')">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="field-label">Descri√ß√£o do EPI *</label>
                            <input type="text" id="edit-descricao" class="field-input" value="${epi.descricao}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="field-label">N√∫mero do CA *</label>
                            <input type="text" id="edit-ca" class="field-input" value="${epi.ca}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="field-label">Validade do CA</label>
                            <input type="date" id="edit-validade" class="field-input" value="${epi.validade || ''}">
                        </div>
                        
                        <div class="form-group">
                            <label class="field-label">Estoque de Seguran√ßa (M√≠nimo) *</label>
                            <input type="number" id="edit-minimo" class="field-input" value="${epi.estoqueMinimo}" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="field-label">Unidade</label>
                            <select id="edit-unidade" class="field-input">
                                <option value="UN" ${epi.unidade === 'UN' ? 'selected' : ''}>Unidade (UN)</option>
                                <option value="PAR" ${epi.unidade === 'PAR' ? 'selected' : ''}>Par (PAR)</option>
                                <option value="CX" ${epi.unidade === 'CX' ? 'selected' : ''}>Caixa (CX)</option>
                                <option value="PCT" ${epi.unidade === 'PCT' ? 'selected' : ''}>Pacote (PCT)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="field-label">Quantidade Atual</label>
                            <input type="number" id="edit-quantidade" class="field-input" value="${epi.quantidade}" min="0" required>
                            <small style="color:#64748b;font-size:0.75rem;">‚ö†Ô∏è Alterar aqui N√ÉO registra no hist√≥rico. Use Entrada/Sa√≠da.</small>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:0.75rem;margin-top:1.5rem;flex-wrap:wrap;">
                        <button type="submit" class="btn-success" style="flex:1;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
                            Salvar Altera√ß√µes
                        </button>
                        <button type="button" class="btn-secondary" onclick="document.getElementById('modal-historico').classList.remove('show')">
                            Cancelar
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('modal-historico').classList.add('show');
        }
        
        function salvarEdicaoEPI(e, id) {
            e.preventDefault();
            
            const epi = estoque.find(e => e.id === id);
            if (!epi) return;
            
            const novoCA = document.getElementById('edit-ca').value;
            
            // Verificar se CA j√° existe em outro EPI
            const caExistente = estoque.find(e => e.ca === novoCA && e.id !== id);
            if (caExistente) {
                showNotification('Este CA j√° est√° cadastrado em outro EPI!', 'error');
                return;
            }
            
            // Atualizar dados
            epi.descricao = document.getElementById('edit-descricao').value;
            epi.ca = novoCA;
            epi.validade = document.getElementById('edit-validade').value || null;
            epi.estoqueMinimo = parseInt(document.getElementById('edit-minimo').value) || 0;
            epi.unidade = document.getElementById('edit-unidade').value;
            epi.quantidade = parseInt(document.getElementById('edit-quantidade').value) || 0;
            
            if (saveEstoque()) {
                showNotification('EPI atualizado com sucesso!', 'success');
                updateEstoqueUI();
                document.getElementById('modal-historico').classList.remove('show');
            }
        }
        
        function excluirEPIEstoque(id) {
            const epi = estoque.find(e => e.id === id);
            if (!epi) return;
            
            if (!confirm(`‚ö†Ô∏è Excluir "${epi.descricao}" do estoque?\n\nTodo o hist√≥rico ser√° perdido.`)) return;
            if (!confirm('üî¥ Tem certeza? Esta a√ß√£o n√£o pode ser desfeita!')) return;
            
            estoque = estoque.filter(e => e.id !== id);
            
            if (saveEstoque()) {
                showNotification('EPI exclu√≠do do estoque', 'success');
                updateEstoqueUI();
            }
        }
        
        function verHistoricoEstoque(id) {
            const epi = estoque.find(e => e.id === id);
            if (!epi) return;
            
            document.getElementById('modal-titulo').textContent = `Hist√≥rico: ${epi.descricao}`;
            
            const historico = epi.historico || [];
            
            document.getElementById('modal-content').innerHTML = `
                <div style="background:#0f172a;padding:1rem;border-radius:8px;margin-bottom:1.5rem;">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;text-align:center;">
                        <div>
                            <div style="font-size:1.5rem;font-weight:700;color:#2563eb;">${epi.quantidade}</div>
                            <div style="font-size:0.75rem;color:#64748b;">ATUAL</div>
                        </div>
                        <div>
                            <div style="font-size:1.5rem;font-weight:700;color:#10b981;">${epi.estoqueMinimo}</div>
                            <div style="font-size:0.75rem;color:#64748b;">M√çNIMO</div>
                        </div>
                        <div>
                            <div style="font-size:1.5rem;font-weight:700;color:#3b82f6;">CA ${epi.ca}</div>
                            <div style="font-size:0.75rem;color:#64748b;">CERTIFICADO</div>
                        </div>
                    </div>
                </div>
                
                <h4 style="color:#2563eb;margin-bottom:1rem;">Movimenta√ß√µes</h4>
                
                <div style="max-height:350px;overflow-y:auto;">
                    ${historico.length === 0 ? '<p style="color:#64748b;text-align:center;">Nenhuma movimenta√ß√£o registrada</p>' : 
                    historico.slice().reverse().map(h => {
                        const data = new Date(h.data);
                        let icon = 'üì¶';
                        let cor = '#64748b';
                        
                        if (h.tipo === 'entrada') { icon = 'üì•'; cor = '#10b981'; }
                        else if (h.tipo === 'saida') { icon = 'üì§'; cor = '#ef4444'; }
                        else if (h.tipo === 'inicial') { icon = 'üÜï'; cor = '#3b82f6'; }
                        
                        return `
                            <div style="background:#0f172a;padding:1rem;border-radius:8px;margin-bottom:0.5rem;border-left:3px solid ${cor};">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                                    <span style="font-weight:600;color:${cor};">${icon} ${h.tipo.toUpperCase()}</span>
                                    <span style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700;color:${cor};">
                                        ${h.tipo === 'saida' ? '-' : '+'}${h.quantidade} ${epi.unidade}
                                    </span>
                                </div>
                                <div style="font-size:0.8rem;color:#64748b;">
                                    ${data.toLocaleDateString('pt-BR')} √†s ${data.toLocaleTimeString('pt-BR')}
                                    ${h.obs ? ` ‚Ä¢ ${h.obs}` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="display:flex;gap:0.5rem;margin-top:1.5rem;">
                    <button class="btn-success" onclick="movimentarEstoque('${id}', 'entrada');verHistoricoEstoque('${id}');" style="flex:1;">
                        üì• Nova Entrada
                    </button>
                    <button class="btn-primary" onclick="movimentarEstoque('${id}', 'saida');verHistoricoEstoque('${id}');" style="flex:1;background:linear-gradient(135deg,#2563eb,#1d4ed8);">
                        üì§ Nova Sa√≠da
                    </button>
                </div>
            `;
            
            document.getElementById('modal-historico').classList.add('show');
        }
        
        // Fun√ß√£o para baixar estoque automaticamente ao registrar entrega
        function baixarEstoqueEntrega(ca, quantidade, cnpj) {
            // Buscar EPI da empresa espec√≠fica
            const epi = estoque.find(e => e.ca === ca && e.cnpj === cnpj);
            if (!epi) {
                // Se n√£o encontrar da empresa, buscar de qualquer uma (compatibilidade)
                const epiGeral = estoque.find(e => e.ca === ca);
                if (!epiGeral) return;
                
                if (epiGeral.quantidade >= quantidade) {
                    epiGeral.quantidade -= quantidade;
                    epiGeral.historico.push({
                        tipo: 'saida',
                        quantidade: quantidade,
                        data: new Date().toISOString(),
                        obs: 'Baixa autom√°tica - Entrega de EPI'
                    });
                    saveEstoque();
                    updateEstoqueUI();
                }
                return;
            }
            
            if (epi.quantidade >= quantidade) {
                epi.quantidade -= quantidade;
                epi.historico.push({
                    tipo: 'saida',
                    quantidade: quantidade,
                    data: new Date().toISOString(),
                    obs: 'Baixa autom√°tica - Entrega de EPI'
                });
                saveEstoque();
                updateEstoqueUI();
            }
        }
        
        // Buscar EPI do estoque para autocomplete
        function getEstoqueDaEmpresaEntrega() {
            // Pegar o CNPJ do formul√°rio de entrega
            const cnpjInput = document.getElementById('cnpj');
            const cnpj = cnpjInput ? cnpjInput.value : '';
            
            if (!cnpj) return estoque; // Se n√£o tem CNPJ, mostrar todos
            
            // Filtrar estoque pela empresa
            const estoqueEmp = estoque.filter(e => e.cnpj === cnpj);
            return estoqueEmp.length > 0 ? estoqueEmp : estoque; // Se n√£o tem estoque da empresa, mostrar todos
        }
        
        function buscarEPIEstoque(termo) {
            const lista = document.getElementById('autocomplete-epi');
            const dica = document.getElementById('dica-estoque');
            
            const estoqueDisponivel = getEstoqueDaEmpresaEntrega();
            
            if (estoqueDisponivel.length === 0) {
                lista.classList.add('hidden');
                dica.innerHTML = 'üí° Cadastre EPIs na aba <strong>Estoque</strong> para selecionar automaticamente';
                return;
            }
            
            dica.innerHTML = '';
            
            if (termo.length < 1) {
                lista.classList.add('hidden');
                return;
            }
            
            const matches = estoqueDisponivel.filter(e => 
                e.descricao.toLowerCase().includes(termo.toLowerCase()) || 
                e.ca.includes(termo)
            );
            
            if (matches.length === 0) {
                lista.innerHTML = `
                    <div style="padding:1rem;text-align:center;color:#64748b;">
                        <p>Nenhum EPI encontrado no estoque</p>
                        <button type="button" onclick="showTab('estoque')" style="margin-top:0.5rem;background:#2563eb;color:#1e3a5f;border:none;padding:0.5rem 1rem;border-radius:6px;cursor:pointer;font-weight:600;">
                            + Cadastrar no Estoque
                        </button>
                    </div>
                `;
                lista.classList.remove('hidden');
                return;
            }
            
            renderizarListaEPIs(matches);
        }
        
        function mostrarEPIsEstoque() {
            const estoqueDisponivel = getEstoqueDaEmpresaEntrega();
            if (estoqueDisponivel.length > 0 && document.getElementById('descricaoEPI').value === '') {
                mostrarTodosEPIs();
            }
        }
        
        function mostrarTodosEPIs() {
            const lista = document.getElementById('autocomplete-epi');
            const estoqueDisponivel = getEstoqueDaEmpresaEntrega();
            
            if (estoqueDisponivel.length === 0) {
                lista.innerHTML = `
                    <div style="padding:1.5rem;text-align:center;color:#64748b;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 0.75rem;">
                            <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                        </svg>
                        <p style="margin-bottom:0.75rem;">Nenhum EPI cadastrado no estoque desta empresa</p>
                        <button type="button" onclick="showTab('estoque');document.getElementById('autocomplete-epi').classList.add('hidden');" style="background:#2563eb;color:#1e3a5f;border:none;padding:0.5rem 1rem;border-radius:6px;cursor:pointer;font-weight:600;">
                            üì¶ Ir para Estoque
                        </button>
                    </div>
                `;
                lista.classList.remove('hidden');
                return;
            }
            
            renderizarListaEPIs(estoqueDisponivel);
        }
        
        function renderizarListaEPIs(itens) {
            const lista = document.getElementById('autocomplete-epi');
            
            lista.innerHTML = `
                <div style="padding:0.5rem 1rem;background:#1e3a5f;border-bottom:1px solid #2d4a6f;font-size:0.75rem;color:#94a3b8;font-weight:600;">
                    üì¶ SELECIONE DO ESTOQUE (${itens.length} ${itens.length === 1 ? 'item' : 'itens'})
                </div>
                ${itens.map(e => {
                    let status = 'ok';
                    let statusText = 'Dispon√≠vel';
                    let statusColor = '#10b981';
                    
                    if (e.quantidade === 0) { 
                        status = 'zerado'; 
                        statusText = 'ZERADO';
                        statusColor = '#64748b';
                    } else if (e.quantidade < e.estoqueMinimo) { 
                        status = 'baixo'; 
                        statusText = 'Estoque baixo';
                        statusColor = '#ef4444';
                    }
                    
                    return `
                        <div class="autocomplete-item" onclick="selecionarEPIEstoque('${e.id}')" style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;border-left:3px solid ${statusColor};">
                            <div style="flex:1;">
                                <div style="font-weight:600;color:#e2e8f0;margin-bottom:0.25rem;">${e.descricao}</div>
                                <div style="font-size:0.8rem;color:#64748b;">
                                    <span style="background:#2d4a6f;padding:0.15rem 0.5rem;border-radius:4px;margin-right:0.5rem;">CA ${e.ca}</span>
                                    ${e.unidade}
                                </div>
                            </div>
                            <div style="text-align:right;min-width:80px;">
                                <div style="font-size:1.2rem;font-weight:700;color:${statusColor};">${e.quantidade}</div>
                                <div style="font-size:0.7rem;color:${statusColor};">${statusText}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
                <div style="padding:0.75rem 1rem;background:#1e3a5f;border-top:1px solid #2d4a6f;text-align:center;">
                    <button type="button" onclick="showTab('estoque');document.getElementById('autocomplete-epi').classList.add('hidden');" style="background:transparent;color:#2563eb;border:1px solid #2563eb;padding:0.4rem 0.75rem;border-radius:6px;cursor:pointer;font-size:0.8rem;font-weight:600;">
                        + Cadastrar Novo EPI
                    </button>
                </div>
            `;
            lista.classList.remove('hidden');
        }
        
        function selecionarEPIEstoque(id) {
            const epi = estoque.find(e => e.id === id);
            if (!epi) return;
            
            document.getElementById('descricaoEPI').value = epi.descricao;
            document.getElementById('numeroCA').value = epi.ca;
            document.getElementById('autocomplete-epi').classList.add('hidden');
            document.getElementById('dica-estoque').innerHTML = '';
            
            // Mostrar estoque dispon√≠vel
            const info = document.getElementById('estoque-disponivel');
            if (epi.quantidade === 0) {
                info.innerHTML = `<span style="color:#ef4444;">‚ö†Ô∏è ESTOQUE ZERADO - N√£o h√° unidades dispon√≠veis</span>`;
            } else if (epi.quantidade < epi.estoqueMinimo) {
                info.innerHTML = `<span style="color:#2563eb;">‚ö†Ô∏è Estoque baixo: ${epi.quantidade} ${epi.unidade} (m√≠n: ${epi.estoqueMinimo})</span>`;
            } else {
                info.innerHTML = `<span style="color:#10b981;">‚úì Dispon√≠vel: ${epi.quantidade} ${epi.unidade}</span>`;
            }
        }
        
        function saveConfig() {
            config.empresa = document.getElementById('config-empresa').value;
            config.rodape = document.getElementById('config-rodape').value;
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            showNotification('Salvo!', 'success');
        }
        
        function updateUI() {
            // Filtrar entregas por empresa do usu√°rio
            let entregasFiltradas = entregas;
            if (currentUser && currentUser.empresaVinculada && currentUser.role !== 'dev') {
                entregasFiltradas = entregas.filter(e => e.cnpj === currentUser.empresaVinculada);
            }
            
            document.getElementById('stats-count').textContent = entregasFiltradas.length;
            const funcionarios = new Set(entregasFiltradas.map(e => e.cpf)).size;
            document.getElementById('stats-bio').textContent = funcionarios;
            updateFuncionariosList();
            updateEmpresaFilter();
        }
        
        function showTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            document.getElementById('tab-cadastro').classList.toggle('hidden', tab !== 'cadastro');
            document.getElementById('tab-devolucao').classList.toggle('hidden', tab !== 'devolucao');
            document.getElementById('tab-estoque').classList.toggle('hidden', tab !== 'estoque');
            document.getElementById('tab-funcionarios').classList.toggle('hidden', tab !== 'funcionarios');
            document.getElementById('tab-empresas').classList.toggle('hidden', tab !== 'empresas');
            document.getElementById('tab-config').classList.toggle('hidden', tab !== 'config');
            
            if (tab !== 'cadastro') stopCamera();
            if (tab === 'funcionarios') updateFuncionariosList();
            if (tab === 'estoque') {
                // Se usu√°rio tem empresa vinculada, selecionar automaticamente
                if (currentUser && currentUser.empresaVinculada && currentUser.role !== 'dev') {
                    const selectEstoque = document.getElementById('estoque-empresa-select');
                    if (selectEstoque) {
                        // Atualizar op√ß√µes primeiro
                        selectEstoque.innerHTML = '<option value="">Selecione uma empresa...</option>' +
                            empresas.map(e => `<option value="${e.cnpj}">${e.fantasia || e.razao}</option>`).join('');
                        // Selecionar empresa do usu√°rio
                        selectEstoque.value = currentUser.empresaVinculada;
                        estoqueEmpresaSelecionada = currentUser.empresaVinculada;
                    }
                }
                updateEstoqueUI();
            }
            if (tab === 'devolucao') {
                initSignatureDevolucao();
                document.getElementById('dev-data').value = new Date().toISOString().split('T')[0];
            }
            if (tab === 'config') {
                loadUsersList();
            }
            if (tab === 'empresas') {
                updateEmpresasUI();
            }
        }
        
        // ==================== GERENCIAMENTO DE USU√ÅRIOS ====================
        
        function loadUsersList() {
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            const container = document.getElementById('users-list');
            const select = document.getElementById('user-select');
            
            if (!container || !select) return;
            
            // Garantir que empresas estejam carregadas
            loadEmpresas();
            
            // Atualizar select de empresas para novo usu√°rio
            const empresaSelect = document.getElementById('new-user-empresa');
            if (empresaSelect) {
                empresaSelect.innerHTML = '<option value="">Selecione a empresa...</option>' +
                    empresas.map(e => `<option value="${e.cnpj}">${e.fantasia || e.razao}</option>`).join('');
            }
            
            // Lista de usu√°rios
            container.innerHTML = users.map(u => {
                const empVinculada = u.empresaVinculada ? empresas.find(e => e.cnpj === u.empresaVinculada) : null;
                const isUser = u.role !== 'dev';
                const canVincular = u.username !== 'admin' && isUser;
                
                return `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;background:#1e3a5f;border-radius:8px;margin-bottom:0.5rem;flex-wrap:wrap;gap:0.5rem;">
                    <div style="flex:1;min-width:200px;">
                        <span style="font-weight:600;color:#e2e8f0;">${u.name}</span>
                        <span style="color:#64748b;font-size:0.85rem;margin-left:0.5rem;">@${u.username}</span>
                        ${u.email ? `
                            <div style="font-size:0.75rem;color:#60a5fa;margin-top:0.25rem;">
                                ‚úâÔ∏è ${u.email}
                            </div>
                        ` : ''}
                        ${empVinculada ? `
                            <div style="font-size:0.75rem;color:#10b981;margin-top:0.25rem;">
                                üè¢ ${empVinculada.fantasia || empVinculada.razao}
                            </div>
                        ` : (u.role === 'dev' ? `
                            <div style="font-size:0.75rem;color:#60a5fa;margin-top:0.25rem;">
                                üîì Acesso a todas empresas
                            </div>
                        ` : `
                            <div style="font-size:0.75rem;color:#f59e0b;margin-top:0.25rem;">
                                ‚ö†Ô∏è Sem empresa vinculada
                            </div>
                        `)}
                    </div>
                    <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
                        <span style="background:${u.role === 'dev' ? '#10b981' : '#2563eb'};color:#fff;padding:0.2rem 0.6rem;border-radius:4px;font-size:0.7rem;font-weight:600;">
                            ${u.role === 'dev' ? 'DEV' : 'USER'}
                        </span>
                        ${canVincular ? `
                            <button onclick="vincularEmpresaUsuario('${u.username}')" style="background:${empVinculada ? '#10b981' : '#f59e0b'};color:#fff;border:none;padding:0.4rem 0.75rem;border-radius:6px;cursor:pointer;font-size:0.8rem;font-weight:600;display:flex;align-items:center;gap:0.25rem;" title="${empVinculada ? 'Alterar empresa' : 'Vincular empresa'}">
                                üè¢ ${empVinculada ? 'Alterar' : 'Vincular'}
                            </button>
                        ` : ''}
                        ${u.username !== 'admin' ? `
                            <button onclick="deleteUser('${u.username}')" style="background:#ef4444;color:#fff;border:none;padding:0.4rem 0.5rem;border-radius:6px;cursor:pointer;font-size:0.8rem;" title="Remover usu√°rio">‚úï</button>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
            
            // Select de usu√°rios para altera√ß√£o de senha
            select.innerHTML = '<option value="">Selecione o usu√°rio</option>' + 
                users.map(u => `<option value="${u.username}">${u.name} (@${u.username})${u.email ? ' - ' + u.email : ''}</option>`).join('');
        }
        
        function toggleEmpresaSelect() {
            const role = document.getElementById('new-user-role').value;
            const container = document.getElementById('empresa-select-container');
            if (container) {
                container.style.display = role === 'dev' ? 'none' : 'block';
            }
        }
        
        function vincularEmpresaUsuario(username) {
            loadEmpresas();
            
            if (empresas.length === 0) {
                showNotification('Cadastre uma empresa primeiro na aba Empresas', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            // Criar modal de sele√ß√£o de empresa
            const empresaAtualVinculada = user.empresaVinculada ? empresas.find(e => e.cnpj === user.empresaVinculada) : null;
            
            // Criar op√ß√µes numeradas para facilitar a sele√ß√£o
            let options = empresas.map((e, i) => 
                `${i + 1}. ${e.fantasia || e.razao}`
            ).join('\n');
            
            const msg = `üè¢ VINCULAR EMPRESA AO USU√ÅRIO\n\n` +
                `Usu√°rio: ${user.name} (@${user.username})\n` +
                (empresaAtualVinculada ? `Empresa atual: ${empresaAtualVinculada.fantasia || empresaAtualVinculada.razao}\n` : '') +
                `\nüìã Empresas dispon√≠veis:\n${options}\n\n` +
                `Digite o N√öMERO da empresa (1-${empresas.length})\nou deixe vazio para remover v√≠nculo:`;
            
            const input = prompt(msg);
            
            if (input === null) return; // Cancelou
            
            if (input.trim() === '') {
                // Remover v√≠nculo
                user.empresaVinculada = null;
                localStorage.setItem(USERS_KEY, JSON.stringify(users));
                loadUsersList();
                showNotification(`V√≠nculo de empresa removido de ${user.name}`, 'success');
                return;
            }
            
            const numero = parseInt(input.trim());
            
            if (isNaN(numero) || numero < 1 || numero > empresas.length) {
                showNotification('N√∫mero inv√°lido. Tente novamente.', 'error');
                return;
            }
            
            const empresaSelecionada = empresas[numero - 1];
            
            user.empresaVinculada = empresaSelecionada.cnpj;
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
            loadUsersList();
            showNotification(`‚úÖ ${user.name} vinculado a ${empresaSelecionada.fantasia || empresaSelecionada.razao}`, 'success');
        }
        
        function changeUserPassword() {
            const username = document.getElementById('user-select').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            
            if (!username) {
                showNotification('Selecione um usu√°rio', 'error');
                return;
            }
            
            if (newPass.length < 6) {
                showNotification('A senha deve ter no m√≠nimo 6 caracteres', 'error');
                return;
            }
            
            if (newPass !== confirmPass) {
                showNotification('As senhas n√£o conferem', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            const userIndex = users.findIndex(u => u.username === username);
            
            if (userIndex === -1) {
                showNotification('Usu√°rio n√£o encontrado', 'error');
                return;
            }
            
            users[userIndex].password = newPass;
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
            
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('user-select').value = '';
            
            showNotification(`Senha de ${users[userIndex].name} alterada com sucesso!`, 'success');
        }
        
        function addNewUser() {
            const name = document.getElementById('new-user-name').value.trim();
            const email = document.getElementById('new-user-email').value.trim().toLowerCase();
            const username = document.getElementById('new-user-username').value.trim().toLowerCase();
            const password = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;
            const empresaSelect = document.getElementById('new-user-empresa');
            const empresaVinculada = empresaSelect ? empresaSelect.value : null;
            
            if (!name || !password) {
                showNotification('Preencha nome e senha', 'error');
                return;
            }
            
            if (!email && !username) {
                showNotification('Preencha e-mail ou nome de usu√°rio', 'error');
                return;
            }
            
            if (email && !email.includes('@')) {
                showNotification('E-mail inv√°lido', 'error');
                return;
            }
            
            if (username && username.length < 3) {
                showNotification('Nome de usu√°rio deve ter no m√≠nimo 3 caracteres', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('A senha deve ter no m√≠nimo 6 caracteres', 'error');
                return;
            }
            
            // Validar empresa para usu√°rios n√£o-dev
            if (role === 'user' && !empresaVinculada) {
                if (!confirm('‚ö†Ô∏è Usu√°rio sem empresa vinculada n√£o ter√° acesso a nenhum dado.\n\nDeseja continuar assim mesmo?')) {
                    return;
                }
            }
            
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            
            // Verificar duplicidade de username
            if (username && users.find(u => u.username === username)) {
                showNotification('Nome de usu√°rio j√° existe', 'error');
                return;
            }
            
            // Verificar duplicidade de email
            if (email && users.find(u => u.email === email)) {
                showNotification('E-mail j√° cadastrado', 'error');
                return;
            }
            
            const newUser = {
                username: username || email.split('@')[0],
                email: email || null,
                password,
                role,
                name,
                empresaVinculada: role === 'dev' ? null : (empresaVinculada || null),
                permissions: role === 'dev' ? ['all'] : ['cadastro', 'consulta', 'devolucao'],
                dataCriacao: new Date().toISOString()
            };
            
            users.push(newUser);
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
            
            // Limpar formul√°rio
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-username').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-role').value = 'user';
            if (empresaSelect) empresaSelect.value = '';
            
            loadUsersList();
            
            const emp = empresaVinculada ? empresas.find(e => e.cnpj === empresaVinculada) : null;
            const empNome = emp ? ` (${emp.fantasia || emp.razao})` : '';
            showNotification(`Usu√°rio ${name}${empNome} criado com sucesso!`, 'success');
            
            // Se tem e-mail, oferecer criar conta Firebase
            if (email && firebaseEnabled) {
                if (confirm(`Deseja criar a conta Firebase para ${email}?\n\nIsso permitir√° login pela web.`)) {
                    criarContaFirebaseParaUsuario(email, password, name);
                }
            }
        }
        
        // Criar conta Firebase para usu√°rio
        async function criarContaFirebaseParaUsuario(email, password, name) {
            if (!firebaseEnabled || !firebaseAuth) {
                showNotification('Firebase n√£o dispon√≠vel', 'error');
                return;
            }
            
            try {
                const result = await firebaseAuth.createUserWithEmailAndPassword(email, password);
                await result.user.updateProfile({ displayName: name });
                
                // Deslogar do Firebase (s√≥ criamos a conta)
                await firebaseAuth.signOut();
                
                showNotification(`Conta Firebase criada para ${email}!`, 'success');
            } catch(erro) {
                if (erro.code === 'auth/email-already-in-use') {
                    showNotification('E-mail j√° tem conta Firebase', 'info');
                } else {
                    showNotification('Erro ao criar conta Firebase: ' + erro.message, 'error');
                }
            }
        }
        
        function verificarUsuariosCadastrados() {
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            
            if (users.length === 0) {
                alert('‚ùå Nenhum usu√°rio cadastrado!\n\nO sistema ir√° criar os usu√°rios padr√£o.');
                initUsers();
                loadUsersList();
                return;
            }
            
            let info = 'üìã USU√ÅRIOS CADASTRADOS\n\n';
            users.forEach((u, i) => {
                const emp = u.empresaVinculada ? empresas.find(e => e.cnpj === u.empresaVinculada) : null;
                info += `${i + 1}. ${u.name}\n`;
                info += `   Login: ${u.username}\n`;
                info += `   Tipo: ${u.role === 'dev' ? 'DEV' : 'USER'}\n`;
                info += `   Empresa: ${emp ? emp.fantasia || emp.razao : 'Nenhuma'}\n`;
                info += `   Senha: ${u.password.substring(0, 3)}***\n\n`;
            });
            
            info += 'üí° Se a senha est√° incorreta, use "Alterar Senha" acima.';
            
            alert(info);
        }
        
        function testarLoginUsuario() {
            const username = prompt('Digite o nome de usu√°rio (login):');
            if (!username) return;
            
            const senha = prompt('Digite a senha:');
            if (!senha) return;
            
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            const user = users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === senha);
            
            if (user) {
                alert(`‚úÖ LOGIN V√ÅLIDO!\n\nUsu√°rio: ${user.name}\nLogin: ${user.username}\nTipo: ${user.role}\n\nO login est√° funcionando corretamente.`);
            } else {
                // Verificar se usu√°rio existe
                const userExists = users.find(u => u.username.toLowerCase() === username.toLowerCase());
                
                if (userExists) {
                    alert(`‚ùå SENHA INCORRETA!\n\nO usu√°rio "${username}" existe, mas a senha est√° errada.\n\nSenha cadastrada come√ßa com: ${userExists.password.substring(0, 3)}***\n\nüí° Use "Alterar Senha" para redefinir.`);
                } else {
                    alert(`‚ùå USU√ÅRIO N√ÉO ENCONTRADO!\n\nO usu√°rio "${username}" n√£o est√° cadastrado neste dispositivo.\n\nUsu√°rios dispon√≠veis:\n${users.map(u => '‚Ä¢ ' + u.username).join('\n')}\n\nüí° Se voc√™ cadastrou em outro dispositivo, importe os dados primeiro.`);
                }
            }
        }
        
        function deleteUser(username) {
            if (username === 'admin') {
                showNotification('N√£o √© poss√≠vel remover o usu√°rio admin', 'error');
                return;
            }
            
            if (!confirm(`Deseja realmente remover o usu√°rio @${username}?`)) return;
            
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            const newUsers = users.filter(u => u.username !== username);
            localStorage.setItem(USERS_KEY, JSON.stringify(newUsers));
            
            loadUsersList();
            showNotification('Usu√°rio removido', 'success');
        }
        
        // ==================== GERENCIAMENTO DE EMPRESAS ====================
        
        let empresaLogoTemp = null;
        
        function loadEmpresas() {
            try {
                const data = localStorage.getItem(EMPRESAS_KEY);
                empresas = data ? JSON.parse(data) : [];
            } catch(e) {
                empresas = [];
            }
        }
        
        function saveEmpresas() {
            localStorage.setItem(EMPRESAS_KEY, JSON.stringify(empresas));
            localStorage.setItem('epi-last-modified', new Date().toISOString());
            atualizarSelectsEmpresa();
            // Auto-sync com Google Drive
            if (googleToken) agendarSyncDrive();
        }
        
        function atualizarSelectsEmpresa() {
            // Atualizar todos os selects de empresa
            const selects = [
                document.getElementById('empresa-ativa-select'),
                document.getElementById('empresa') // No form de entrega, se existir como select
            ];
            
            const selectAtiva = document.getElementById('empresa-ativa-select');
            if (selectAtiva) {
                const valorAtual = selectAtiva.value;
                selectAtiva.innerHTML = '<option value="">Todas as empresas</option>' + 
                    empresas.map(e => `<option value="${e.cnpj}" ${e.cnpj === valorAtual ? 'selected' : ''}>${e.fantasia || e.razao}</option>`).join('');
            }
        }
        
        function updateEmpresasUI() {
            loadEmpresas();
            
            // Verificar empresa selecionada no filtro
            const selectEmpresa = document.getElementById('empresa-ativa-select');
            const cnpjSelecionado = selectEmpresa ? selectEmpresa.value : '';
            const empresaSelecionada = cnpjSelecionado ? empresas.find(e => e.cnpj === cnpjSelecionado) : null;
            
            // Filtrar entregas pela empresa selecionada
            let entregasFiltradas = entregas;
            let empresasFiltradas = empresas;
            
            if (empresaSelecionada) {
                entregasFiltradas = entregas.filter(e => e.cnpj === cnpjSelecionado);
                empresasFiltradas = [empresaSelecionada];
            }
            
            // Calcular estat√≠sticas
            const totalFuncionarios = [...new Set(entregasFiltradas.map(e => e.cpf))].length;
            const totalDevolvidos = entregasFiltradas.filter(e => e.devolvido).length;
            const totalEmUso = entregasFiltradas.filter(e => !e.devolvido).length;
            
            // Atualizar contadores
            document.getElementById('total-empresas').textContent = empresaSelecionada ? '1' : empresas.length;
            document.getElementById('total-entregas-empresas').textContent = entregasFiltradas.length;
            
            // Atualizar/Adicionar contadores extras
            const statsContainer = document.getElementById('empresas-stats-extra');
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                        <div style="font-size:2rem;font-weight:700;color:#8b5cf6;font-family:'JetBrains Mono',monospace;">${totalFuncionarios}</div>
                        <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Funcion√°rios</div>
                    </div>
                    <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                        <div style="font-size:2rem;font-weight:700;color:#10b981;font-family:'JetBrains Mono',monospace;">${totalEmUso}</div>
                        <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Em Uso</div>
                    </div>
                    <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                        <div style="font-size:2rem;font-weight:700;color:#f59e0b;font-family:'JetBrains Mono',monospace;">${totalDevolvidos}</div>
                        <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Devolvidos</div>
                    </div>
                `;
            }
            
            // Atualizar select (mantendo valor selecionado)
            atualizarSelectsEmpresa();
            
            // Atualizar lista
            const lista = document.getElementById('empresas-lista');
            if (!lista) return;
            
            if (empresasFiltradas.length === 0) {
                lista.innerHTML = '<p style="text-align:center;color:#64748b;padding:2rem;">Nenhuma empresa cadastrada</p>';
                return;
            }
            
            lista.innerHTML = empresasFiltradas.map(emp => {
                const entregasEmp = entregas.filter(e => e.cnpj === emp.cnpj);
                const funcionariosEmp = [...new Set(entregasEmp.map(e => e.cpf))].length;
                const emUsoEmp = entregasEmp.filter(e => !e.devolvido).length;
                const devolvidosEmp = entregasEmp.filter(e => e.devolvido).length;
                const paleta = PALETAS_CORES[emp.paleta] || PALETAS_CORES.azul;
                
                return `
                    <div style="background:#1e3a5f;border-radius:12px;padding:1.25rem;margin-bottom:1rem;border-left:4px solid rgb(${paleta.secundaria.join(',')});">
                        <div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:1rem;">
                            <div style="display:flex;gap:1rem;align-items:center;">
                                ${emp.logo ? `<img src="${emp.logo}" style="width:60px;height:60px;object-fit:contain;background:#fff;border-radius:8px;padding:5px;">` : 
                                `<div style="width:60px;height:60px;background:rgb(${paleta.secundaria.join(',')});border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;">üè¢</div>`}
                                <div>
                                    <h4 style="color:#e2e8f0;font-size:1.1rem;margin-bottom:0.25rem;">${emp.razao}</h4>
                                    ${emp.fantasia ? `<p style="color:#94a3b8;font-size:0.85rem;">${emp.fantasia}</p>` : ''}
                                    <p style="color:#64748b;font-size:0.8rem;font-family:'JetBrains Mono',monospace;">${emp.cnpj}</p>
                                    ${emp.endereco ? `<p style="color:#64748b;font-size:0.75rem;margin-top:0.25rem;">üìç ${emp.endereco}</p>` : ''}
                                </div>
                            </div>
                            <div style="display:flex;gap:0.5rem;text-align:center;flex-wrap:wrap;">
                                <div style="background:#0f172a;padding:0.5rem 0.75rem;border-radius:8px;min-width:60px;">
                                    <div style="font-size:1.1rem;font-weight:700;color:#2563eb;">${entregasEmp.length}</div>
                                    <div style="font-size:0.65rem;color:#64748b;">Entregas</div>
                                </div>
                                <div style="background:#0f172a;padding:0.5rem 0.75rem;border-radius:8px;min-width:60px;">
                                    <div style="font-size:1.1rem;font-weight:700;color:#8b5cf6;">${funcionariosEmp}</div>
                                    <div style="font-size:0.65rem;color:#64748b;">Funcion.</div>
                                </div>
                                <div style="background:#0f172a;padding:0.5rem 0.75rem;border-radius:8px;min-width:60px;">
                                    <div style="font-size:1.1rem;font-weight:700;color:#10b981;">${emUsoEmp}</div>
                                    <div style="font-size:0.65rem;color:#64748b;">Em Uso</div>
                                </div>
                                <div style="background:#0f172a;padding:0.5rem 0.75rem;border-radius:8px;min-width:60px;">
                                    <div style="font-size:1.1rem;font-weight:700;color:#f59e0b;">${devolvidosEmp}</div>
                                    <div style="font-size:0.65rem;color:#64748b;">Devolv.</div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap;align-items:center;">
                            <span style="background:rgb(${paleta.secundaria.join(',')});color:#fff;padding:0.25rem 0.75rem;border-radius:50px;font-size:0.75rem;">
                                üé® ${paleta.nome}
                            </span>
                            <span style="background:${(PLANOS_CONFIG[emp.plano] || PLANOS_CONFIG.basico).cor};color:#fff;padding:0.25rem 0.75rem;border-radius:50px;font-size:0.75rem;">
                                ${emp.plano === 'premium' ? '‚≠ê Premium' : 'üîµ B√°sico'}
                            </span>
                            ${emp.telefone ? `<span style="color:#64748b;font-size:0.8rem;">üìû ${emp.telefone}</span>` : ''}
                            <div style="flex:1;"></div>
                            <button class="btn-secondary" onclick="alterarPlanoEmpresa('${emp.cnpj}')" style="padding:0.4rem 0.75rem;font-size:0.8rem;" title="Alterar Plano">üìä</button>
                            <button class="btn-secondary" onclick="editarEmpresa('${emp.cnpj}')" style="padding:0.4rem 0.75rem;font-size:0.8rem;">‚úèÔ∏è Editar</button>
                            <button class="btn-danger" onclick="excluirEmpresa('${emp.cnpj}')" style="padding:0.4rem 0.75rem;font-size:0.8rem;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Fun√ß√£o para alterar plano da empresa
        function alterarPlanoEmpresa(cnpj) {
            const emp = empresas.find(e => e.cnpj === cnpj);
            if (!emp) return;
            
            const planoAtual = emp.plano || 'basico';
            const novoPlano = planoAtual === 'premium' ? 'basico' : 'premium';
            const nomePlano = novoPlano === 'premium' ? 'Premium (R$ 399,99/m√™s)' : 'B√°sico (R$ 199,99/m√™s)';
            
            if (confirm(`Alterar plano de "${emp.razao}" para ${nomePlano}?`)) {
                emp.plano = novoPlano;
                saveEmpresas();
                updateEmpresasUI();
                showNotification(`Plano alterado para ${nomePlano}!`, 'success');
            }
        }
        
        function previewPaleta() {
            const paleta = document.getElementById('emp-paleta').value;
            const cores = PALETAS_CORES[paleta];
            if (!cores) return;
            
            document.getElementById('cor-primaria').style.background = `rgb(${cores.primaria.join(',')})`;
            document.getElementById('cor-secundaria').style.background = `rgb(${cores.secundaria.join(',')})`;
            document.getElementById('cor-accent').style.background = `rgb(${cores.accent.join(',')})`;
        }
        
        function handleEmpresaLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const max = 300;
                    if (w > max || h > max) {
                        if (w > h) { h = (h / w) * max; w = max; }
                        else { w = (w / h) * max; h = max; }
                    }
                    canvas.width = w;
                    canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    empresaLogoTemp = canvas.toDataURL('image/png', 0.9);
                    document.getElementById('emp-logo-preview').src = empresaLogoTemp;
                    document.getElementById('emp-logo-preview').style.display = 'block';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function cadastrarEmpresa() {
            const razao = document.getElementById('emp-razao').value.trim();
            const fantasia = document.getElementById('emp-fantasia').value.trim();
            const cnpj = document.getElementById('emp-cnpj').value.trim();
            const telefone = document.getElementById('emp-telefone').value.trim();
            const endereco = document.getElementById('emp-endereco').value.trim();
            const paleta = document.getElementById('emp-paleta').value;
            const plano = document.getElementById('emp-plano')?.value || 'basico';
            
            if (!razao || !cnpj) {
                showNotification('Preencha Raz√£o Social e CNPJ', 'error');
                return;
            }
            
            if (cnpj.replace(/\D/g, '').length !== 14) {
                showNotification('CNPJ inv√°lido', 'error');
                return;
            }
            
            // Verificar duplicidade
            if (empresas.find(e => e.cnpj === cnpj)) {
                showNotification('CNPJ j√° cadastrado', 'error');
                return;
            }
            
            const novaEmpresa = {
                id: Date.now().toString(),
                razao,
                fantasia,
                cnpj,
                telefone,
                endereco,
                paleta,
                plano,
                logo: empresaLogoTemp,
                dataCadastro: new Date().toISOString()
            };
            
            empresas.push(novaEmpresa);
            saveEmpresas();
            
            // Limpar formul√°rio
            document.getElementById('emp-razao').value = '';
            document.getElementById('emp-fantasia').value = '';
            document.getElementById('emp-cnpj').value = '';
            document.getElementById('emp-telefone').value = '';
            document.getElementById('emp-endereco').value = '';
            document.getElementById('emp-paleta').value = 'azul';
            if (document.getElementById('emp-plano')) document.getElementById('emp-plano').value = 'basico';
            document.getElementById('emp-logo-preview').style.display = 'none';
            empresaLogoTemp = null;
            previewPaleta();
            
            updateEmpresasUI();
            showNotification('Empresa cadastrada com sucesso!', 'success');
        }
        
        function editarEmpresa(cnpj) {
            const emp = empresas.find(e => e.cnpj === cnpj);
            if (!emp) return;
            
            const novaPaleta = prompt(`Paleta atual: ${PALETAS_CORES[emp.paleta]?.nome || 'Azul'}\n\nDigite a nova paleta:\nazul, verde, vermelho, laranja, roxo, cinza`, emp.paleta);
            
            if (novaPaleta && PALETAS_CORES[novaPaleta]) {
                emp.paleta = novaPaleta;
                saveEmpresas();
                updateEmpresasUI();
                showNotification('Paleta atualizada!', 'success');
            } else if (novaPaleta) {
                showNotification('Paleta inv√°lida', 'error');
            }
        }
        
        function excluirEmpresa(cnpj) {
            const emp = empresas.find(e => e.cnpj === cnpj);
            if (!emp) return;
            
            const entregasEmp = entregas.filter(e => e.cnpj === cnpj).length;
            
            if (!confirm(`Excluir empresa "${emp.razao}"?\n\n‚ö†Ô∏è Esta empresa tem ${entregasEmp} entregas registradas.\nAs entregas N√ÉO ser√£o exclu√≠das.`)) return;
            
            empresas = empresas.filter(e => e.cnpj !== cnpj);
            saveEmpresas();
            updateEmpresasUI();
            showNotification('Empresa removida', 'success');
        }
        
        function selecionarEmpresaAtiva() {
            const cnpj = document.getElementById('empresa-ativa-select').value;
            empresaAtual = cnpj ? empresas.find(e => e.cnpj === cnpj) : null;
            
            // Atualizar todas as UIs
            updateUI();
            updateFuncionariosList();
            
            // Atualizar lista e estat√≠sticas de empresas (sem recarregar select)
            updateEmpresasStats();
        }
        
        function updateEmpresasStats() {
            // Verificar empresa selecionada no filtro
            const selectEmpresa = document.getElementById('empresa-ativa-select');
            const cnpjSelecionado = selectEmpresa ? selectEmpresa.value : '';
            const empresaSelecionada = cnpjSelecionado ? empresas.find(e => e.cnpj === cnpjSelecionado) : null;
            
            // Filtrar entregas pela empresa selecionada
            let entregasFiltradas = entregas;
            let empresasFiltradas = empresas;
            
            if (empresaSelecionada) {
                entregasFiltradas = entregas.filter(e => e.cnpj === cnpjSelecionado);
                empresasFiltradas = [empresaSelecionada];
            }
            
            // Calcular estat√≠sticas
            const totalFuncionarios = [...new Set(entregasFiltradas.map(e => e.cpf))].length;
            const totalDevolvidos = entregasFiltradas.filter(e => e.devolvido).length;
            const totalEmUso = entregasFiltradas.filter(e => !e.devolvido).length;
            
            // Atualizar contadores principais
            document.getElementById('total-empresas').textContent = empresaSelecionada ? '1' : empresas.length;
            document.getElementById('total-entregas-empresas').textContent = entregasFiltradas.length;
            
            // Atualizar/Adicionar contadores extras
            const statsContainer = document.getElementById('empresas-stats-extra');
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                        <div style="font-size:2rem;font-weight:700;color:#8b5cf6;font-family:'JetBrains Mono',monospace;">${totalFuncionarios}</div>
                        <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Funcion√°rios</div>
                    </div>
                    <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                        <div style="font-size:2rem;font-weight:700;color:#22c55e;font-family:'JetBrains Mono',monospace;">${totalEmUso}</div>
                        <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Em Uso</div>
                    </div>
                    <div style="background:#0f172a;padding:1rem;border-radius:10px;text-align:center;">
                        <div style="font-size:2rem;font-weight:700;color:#f59e0b;font-family:'JetBrains Mono',monospace;">${totalDevolvidos}</div>
                        <div style="font-size:0.8rem;color:#64748b;text-transform:uppercase;">Devolvidos</div>
                    </div>
                `;
            }
            
            // Atualizar lista de empresas
            const lista = document.getElementById('empresas-lista');
            if (!lista) return;
            
            if (empresasFiltradas.length === 0) {
                lista.innerHTML = '<p style="text-align:center;color:#64748b;padding:2rem;">Nenhuma empresa cadastrada</p>';
                return;
            }
            
            lista.innerHTML = empresasFiltradas.map(emp => {
                const entregasEmp = entregas.filter(e => e.cnpj === emp.cnpj);
                const funcionariosEmp = [...new Set(entregasEmp.map(e => e.cpf))].length;
                const emUsoEmp = entregasEmp.filter(e => !e.devolvido).length;
                const devolvidosEmp = entregasEmp.filter(e => e.devolvido).length;
                const paleta = PALETAS_CORES[emp.paleta] || PALETAS_CORES.azul;
                
                return `
                    <div style="background:#1e3a5f;border-radius:12px;padding:1.25rem;margin-bottom:1rem;border-left:4px solid rgb(${paleta.secundaria.join(',')});">
                        <div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:1rem;">
                            <div style="display:flex;gap:1rem;align-items:center;">
                                ${emp.logo ? `<img src="${emp.logo}" style="width:60px;height:60px;object-fit:contain;background:#fff;border-radius:8px;padding:5px;">` : 
                                `<div style="width:60px;height:60px;background:rgb(${paleta.secundaria.join(',')});border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;">üè¢</div>`}
                                <div>
                                    <h4 style="color:#e2e8f0;font-size:1.1rem;margin-bottom:0.25rem;">${emp.razao}</h4>
                                    ${emp.fantasia ? `<p style="color:#94a3b8;font-size:0.85rem;">${emp.fantasia}</p>` : ''}
                                    <p style="color:#64748b;font-size:0.8rem;font-family:'JetBrains Mono',monospace;">${emp.cnpj}</p>
                                    ${emp.endereco ? `<p style="color:#64748b;font-size:0.75rem;margin-top:0.25rem;">üìç ${emp.endereco}</p>` : ''}
                                </div>
                            </div>
                            <div style="display:flex;gap:0.5rem;text-align:center;flex-wrap:wrap;">
                                <div style="background:#0f172a;padding:0.5rem 0.75rem;border-radius:8px;min-width:60px;">
                                    <div style="font-size:1.1rem;font-weight:700;color:#2563eb;">${entregasEmp.length}</div>
                                    <div style="font-size:0.65rem;color:#64748b;">Entregas</div>
                                </div>
                                <div style="background:#0f172a;padding:0.5rem 0.75rem;border-radius:8px;min-width:60px;">
                                    <div style="font-size:1.1rem;font-weight:700;color:#8b5cf6;">${funcionariosEmp}</div>
                                    <div style="font-size:0.65rem;color:#64748b;">Funcion.</div>
                                </div>
                                <div style="background:#0f172a;padding:0.5rem 0.75rem;border-radius:8px;min-width:60px;">
                                    <div style="font-size:1.1rem;font-weight:700;color:#10b981;">${emUsoEmp}</div>
                                    <div style="font-size:0.65rem;color:#64748b;">Em Uso</div>
                                </div>
                                <div style="background:#0f172a;padding:0.5rem 0.75rem;border-radius:8px;min-width:60px;">
                                    <div style="font-size:1.1rem;font-weight:700;color:#f59e0b;">${devolvidosEmp}</div>
                                    <div style="font-size:0.65rem;color:#64748b;">Devolv.</div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap;align-items:center;">
                            <span style="background:rgb(${paleta.secundaria.join(',')});color:#fff;padding:0.25rem 0.75rem;border-radius:50px;font-size:0.75rem;">
                                üé® ${paleta.nome}
                            </span>
                            ${emp.telefone ? `<span style="color:#64748b;font-size:0.8rem;">üìû ${emp.telefone}</span>` : ''}
                            <div style="flex:1;"></div>
                            <button class="btn-secondary" onclick="editarEmpresa('${emp.cnpj}')" style="padding:0.4rem 0.75rem;font-size:0.8rem;">‚úèÔ∏è Editar</button>
                            <button class="btn-danger" onclick="excluirEmpresa('${emp.cnpj}')" style="padding:0.4rem 0.75rem;font-size:0.8rem;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getEmpresaPorCNPJ(cnpj) {
            return empresas.find(e => e.cnpj === cnpj);
        }
        
        function getCoresEmpresa(cnpj) {
            const emp = getEmpresaPorCNPJ(cnpj);
            const paleta = emp?.paleta || 'azul';
            return PALETAS_CORES[paleta] || PALETAS_CORES.azul;
        }
        
        // ==================== SINCRONIZA√á√ÉO ====================
        
        function exportarSincronizacao() {
            const dataExport = {
                versao: '5.0',
                tipo: 'sincronizacao_completa',
                dataExportacao: new Date().toISOString(),
                dados: {
                    entregas: entregas,
                    estoque: estoque,
                    empresas: empresas,
                    config: config,
                    usuarios: JSON.parse(localStorage.getItem(USERS_KEY) || '[]')
                }
            };
            
            const blob = new Blob([JSON.stringify(dataExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const dataStr = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `rc_epi_sync_${dataStr}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Arquivo de sincroniza√ß√£o exportado!', 'success');
        }
        
        function importarSincronizacao(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.dados) {
                        throw new Error('Formato inv√°lido');
                    }
                    
                    const info = `üì¶ SINCRONIZA√á√ÉO\n\nArquivo: ${file.name}\nData: ${data.dataExportacao ? new Date(data.dataExportacao).toLocaleString('pt-BR') : 'N/A'}\n\nConte√∫do:\n- Entregas: ${data.dados.entregas?.length || 0}\n- Estoque: ${data.dados.estoque?.length || 0}\n- Empresas: ${data.dados.empresas?.length || 0}\n- Usu√°rios: ${data.dados.usuarios?.length || 0}\n\n‚ö†Ô∏è Isso IR√Å SUBSTITUIR todos os dados atuais!\nDeseja continuar?`;
                    
                    if (!confirm(info)) {
                        showNotification('Sincroniza√ß√£o cancelada', 'error');
                        return;
                    }
                    
                    if (!confirm('‚ö†Ô∏è √öLTIMA CONFIRMA√á√ÉO\n\nTem certeza? Esta a√ß√£o n√£o pode ser desfeita!')) {
                        showNotification('Sincroniza√ß√£o cancelada', 'error');
                        return;
                    }
                    
                    // Importar dados
                    if (data.dados.entregas) {
                        entregas = data.dados.entregas;
                        saveData();
                    }
                    
                    if (data.dados.estoque) {
                        estoque = data.dados.estoque;
                        saveEstoque();
                    }
                    
                    if (data.dados.empresas) {
                        empresas = data.dados.empresas;
                        saveEmpresas();
                    }
                    
                    if (data.dados.config) {
                        config = data.dados.config;
                        localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
                        loadConfig();
                    }
                    
                    if (data.dados.usuarios && data.dados.usuarios.length > 0) {
                        // Mesclar usu√°rios mantendo admin local
                        const usuariosAtuais = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
                        const adminLocal = usuariosAtuais.find(u => u.username === 'admin');
                        const usuariosImportados = data.dados.usuarios.filter(u => u.username !== 'admin');
                        
                        const usuariosMesclados = adminLocal ? [adminLocal, ...usuariosImportados] : data.dados.usuarios;
                        localStorage.setItem(USERS_KEY, JSON.stringify(usuariosMesclados));
                    }
                    
                    updateUI();
                    updateEmpresasUI();
                    updateEstoqueUI();
                    
                    // Esconder banner de sincroniza√ß√£o
                    fecharBannerSync();
                    
                    // Ir para aba de funcion√°rios para mostrar os dados importados
                    showTab('funcionarios');
                    
                    showNotification('Sincroniza√ß√£o conclu√≠da com sucesso!', 'success');
                    
                } catch(err) {
                    console.error('Erro na sincroniza√ß√£o:', err);
                    showNotification('Arquivo de sincroniza√ß√£o inv√°lido', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // ==================== FORMATA√á√ÉO ====================
        function formatCPF(input) {
            let v = input.value.replace(/\D/g, '').slice(0, 11);
            v = v.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            input.value = v;
        }
        
        function formatCNPJ(input) {
            let v = input.value.replace(/\D/g, '').slice(0, 14);
            v = v.replace(/^(\d{2})(\d)/, '$1.$2').replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3').replace(/\.(\d{3})(\d)/, '.$1/$2').replace(/(\d{4})(\d)/, '$1-$2');
            input.value = v;
        }
        
        // ==================== BUSCA DE EMPRESA ====================
        
        function buscarEmpresa(texto) {
            const lista = document.getElementById('autocomplete-empresa');
            if (!lista) return;
            
            if (texto.length < 2) {
                lista.classList.add('hidden');
                return;
            }
            
            const textoLower = texto.toLowerCase();
            const matches = empresas.filter(e => 
                e.razao.toLowerCase().includes(textoLower) ||
                (e.fantasia && e.fantasia.toLowerCase().includes(textoLower)) ||
                e.cnpj.includes(texto)
            );
            
            if (matches.length === 0) {
                lista.classList.add('hidden');
                return;
            }
            
            lista.innerHTML = matches.map(e => `
                <div class="autocomplete-item" onclick="selecionarEmpresa('${e.cnpj}')">
                    <strong>${e.fantasia || e.razao}</strong>
                    <small style="color:#64748b;display:block;">${e.cnpj}</small>
                </div>
            `).join('');
            lista.classList.remove('hidden');
        }
        
        function mostrarEmpresas() {
            const lista = document.getElementById('autocomplete-empresa');
            if (!lista || empresas.length === 0) return;
            
            lista.innerHTML = empresas.slice(0, 10).map(e => `
                <div class="autocomplete-item" onclick="selecionarEmpresa('${e.cnpj}')">
                    <strong>${e.fantasia || e.razao}</strong>
                    <small style="color:#64748b;display:block;">${e.cnpj}</small>
                </div>
            `).join('');
            lista.classList.remove('hidden');
        }
        
        function selecionarEmpresa(cnpj) {
            const emp = empresas.find(e => e.cnpj === cnpj);
            if (!emp) return;
            
            document.getElementById('empresa').value = emp.fantasia || emp.razao;
            document.getElementById('cnpj').value = emp.cnpj;
            document.getElementById('autocomplete-empresa').classList.add('hidden');
        }
        
        // Fechar autocomplete de empresa ao clicar fora
        document.addEventListener('click', function(e) {
            const lista = document.getElementById('autocomplete-empresa');
            if (lista && !e.target.closest('#empresa') && !e.target.closest('#autocomplete-empresa')) {
                lista.classList.add('hidden');
            }
        });
        
        // ====================
        function searchFuncionario(cpf) {
            const clean = cpf.replace(/\D/g, '');
            const list = document.getElementById('autocomplete-list');
            
            if (clean.length < 3) {
                list.classList.add('hidden');
                resetPhotoSection();
                return;
            }
            
            const funcionarios = {};
            entregas.forEach(e => {
                if (!funcionarios[e.cpf]) funcionarios[e.cpf] = e;
            });
            
            const matches = Object.values(funcionarios).filter(f => 
                f.cpf.replace(/\D/g, '').includes(clean) || f.trabalhador.toLowerCase().includes(cpf.toLowerCase())
            );
            
            if (matches.length === 0) {
                list.classList.add('hidden');
                resetPhotoSection();
                return;
            }
            
            list.innerHTML = matches.slice(0, 5).map(f => `
                <div class="autocomplete-item" onclick="selectFuncionario('${f.cpf}')">
                    ${f.fotoFacial ? `<img src="${f.fotoFacial}" alt="">` : '<div style="width:40px;height:50px;background:#2d4a6f;border-radius:6px;"></div>'}
                    <div>
                        <div style="font-weight:500;color:#e2e8f0;">${f.trabalhador}</div>
                        <div style="font-size:0.85rem;color:#64748b;">${f.cpf}</div>
                    </div>
                </div>
            `).join('');
            
            list.classList.remove('hidden');
        }
        
        function selectFuncionario(cpf) {
            const f = entregas.find(e => e.cpf === cpf);
            if (f) {
                document.getElementById('cpf').value = f.cpf;
                document.getElementById('trabalhador').value = f.trabalhador;
                document.getElementById('empresa').value = f.empresa;
                document.getElementById('cnpj').value = f.cnpj;
                document.getElementById('funcao').value = f.funcao || '';
                document.getElementById('setor').value = f.setor || '';
                
                if (f.fotoFacial) {
                    currentFuncionarioPhoto = f.fotoFacial;
                    capturedPhotoData = f.fotoFacial;
                    document.getElementById('captured-photo').src = f.fotoFacial;
                    document.getElementById('photo-options').classList.add('hidden');
                    document.getElementById('photo-preview-area').classList.remove('hidden');
                    document.getElementById('biometria-section').classList.add('success');
                }
            }
            document.getElementById('autocomplete-list').classList.add('hidden');
        }
        
        function resetPhotoSection() {
            currentFuncionarioPhoto = null;
            capturedPhotoData = null;
            document.getElementById('photo-options').classList.remove('hidden');
            document.getElementById('camera-area').classList.add('hidden');
            document.getElementById('photo-preview-area').classList.add('hidden');
            document.getElementById('biometria-section').className = 'biometria-section';
        }
        
        async function startCamera() {
            document.getElementById('photo-options').classList.add('hidden');
            document.getElementById('camera-area').classList.remove('hidden');
            document.getElementById('camera-error').classList.add('hidden');
            document.getElementById('btn-capture').classList.remove('hidden');
            
            const video = document.getElementById('camera-video');
            
            // Verificar se API est√° dispon√≠vel
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                mostrarErroCameraNova('Seu navegador n√£o suporta acesso √† c√¢mera. Use a op√ß√£o "Carregar Foto".');
                return;
            }
            
            try {
                // Parar stream anterior se existir
                stopCamera();
                
                // Tentar diferentes configura√ß√µes de c√¢mera
                const configuracoes = [
                    // Configura√ß√£o 1: C√¢mera frontal (celular)
                    { video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } } },
                    // Configura√ß√£o 2: C√¢mera traseira (celular)
                    { video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } } },
                    // Configura√ß√£o 3: Qualquer c√¢mera dispon√≠vel
                    { video: true },
                    // Configura√ß√£o 4: M√≠nima
                    { video: { width: 320, height: 240 } }
                ];
                
                let streamObtido = null;
                let erroFinal = null;
                
                for (const config of configuracoes) {
                    try {
                        streamObtido = await navigator.mediaDevices.getUserMedia(config);
                        break; // Sucesso, sair do loop
                    } catch (err) {
                        erroFinal = err;
                        console.log('Tentativa falhou:', config, err.name);
                    }
                }
                
                if (!streamObtido) {
                    throw erroFinal || new Error('N√£o foi poss√≠vel acessar a c√¢mera');
                }
                
                videoStream = streamObtido;
                video.srcObject = videoStream;
                
                // Aguardar v√≠deo carregar
                video.onloadedmetadata = function() {
                    video.play().catch(e => console.log('Autoplay bloqueado:', e));
                };
                
                showNotification('C√¢mera ativada!', 'success');
                
            } catch (error) {
                console.error('Erro c√¢mera:', error);
                
                let mensagem = 'Erro ao acessar a c√¢mera.';
                
                switch (error.name) {
                    case 'NotAllowedError':
                    case 'PermissionDeniedError':
                        mensagem = 'Permiss√£o negada. Clique no √≠cone de c√¢mera/cadeado na barra de endere√ßo e permita o acesso.';
                        break;
                    case 'NotFoundError':
                    case 'DevicesNotFoundError':
                        mensagem = 'Nenhuma c√¢mera encontrada no dispositivo.';
                        break;
                    case 'NotReadableError':
                    case 'TrackStartError':
                        mensagem = 'A c√¢mera est√° sendo usada por outro aplicativo. Feche outros apps e tente novamente.';
                        break;
                    case 'OverconstrainedError':
                        mensagem = 'Configura√ß√£o de c√¢mera n√£o suportada.';
                        break;
                    case 'NotSupportedError':
                        mensagem = 'C√¢mera n√£o suportada neste navegador.';
                        break;
                    case 'TypeError':
                        mensagem = 'Erro de configura√ß√£o da c√¢mera.';
                        break;
                    default:
                        if (location.protocol === 'file:') {
                            mensagem = 'Arquivos abertos localmente (file://) t√™m restri√ß√µes de c√¢mera em alguns navegadores.';
                        } else {
                            mensagem = error.message || 'Erro desconhecido ao acessar a c√¢mera.';
                        }
                }
                
                mostrarErroCameraNova(mensagem);
            }
        }
        
        function mostrarErroCameraNova(mensagem) {
            document.getElementById('camera-error-text').textContent = mensagem;
            document.getElementById('camera-error').classList.remove('hidden');
            document.getElementById('btn-capture').classList.add('hidden');
        }
        
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            const video = document.getElementById('camera-video');
            if (video) {
                video.srcObject = null;
            }
        }
        
        function capturePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const ctx = canvas.getContext('2d');
            
            // Verificar se v√≠deo est√° tocando
            if (video.readyState < 2) {
                showNotification('Aguarde a c√¢mera carregar...', 'error');
                return;
            }
            
            // Usar dimens√µes reais do v√≠deo
            const width = video.videoWidth || 640;
            const height = video.videoHeight || 480;
            
            canvas.width = width;
            canvas.height = height;
            
            // Espelhar imagem (c√¢mera frontal)
            ctx.translate(width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, width, height);
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            
            capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            
            stopCamera();
            
            document.getElementById('captured-photo').src = capturedPhotoData;
            document.getElementById('camera-area').classList.add('hidden');
            document.getElementById('photo-preview-area').classList.remove('hidden');
            document.getElementById('biometria-section').classList.add('success');
            
            showNotification('Foto capturada!', 'success');
        }
        
        function cancelCamera() {
            stopCamera();
            document.getElementById('camera-area').classList.add('hidden');
            document.getElementById('photo-options').classList.remove('hidden');
        }
        
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Verificar se √© imagem
            if (!file.type.startsWith('image/')) {
                showNotification('Selecione um arquivo de imagem', 'error');
                return;
            }
            
            // Verificar tamanho (m√°x 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('Arquivo muito grande (m√°x 10MB)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    
                    // Limitar tamanho m√°ximo mantendo propor√ß√£o
                    const maxSize = 800;
                    if (w > maxSize || h > maxSize) {
                        if (w > h) { 
                            h = Math.round((h / w) * maxSize); 
                            w = maxSize; 
                        } else { 
                            w = Math.round((w / h) * maxSize); 
                            h = maxSize; 
                        }
                    }
                    
                    canvas.width = w;
                    canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    
                    capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('captured-photo').src = capturedPhotoData;
                    document.getElementById('photo-options').classList.add('hidden');
                    document.getElementById('camera-area').classList.add('hidden');
                    document.getElementById('photo-preview-area').classList.remove('hidden');
                    document.getElementById('biometria-section').classList.add('success');
                    
                    showNotification('Foto carregada!', 'success');
                };
                img.onerror = function() {
                    showNotification('Erro ao carregar imagem', 'error');
                };
                img.src = e.target.result;
            };
            reader.onerror = function() {
                showNotification('Erro ao ler arquivo', 'error');
            };
            reader.readAsDataURL(file);
            
            event.target.value = '';
        }
        
        function removePhoto() {
            capturedPhotoData = null;
            currentFuncionarioPhoto = null;
            document.getElementById('photo-preview-area').classList.add('hidden');
            document.getElementById('photo-options').classList.remove('hidden');
            document.getElementById('biometria-section').classList.remove('success');
        }
        
        function initSignaturePad() {
            const canvas = document.getElementById('signature-canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.touches ? e.touches[0].clientX : e.clientX;
                const y = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: (x - rect.left) * (canvas.width / rect.width),
                    y: (y - rect.top) * (canvas.height / rect.height)
                };
            }
            
            function start(e) { e.preventDefault(); isDrawing = true; lastPos = getPos(e); }
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastPos.x, lastPos.y);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                lastPos = pos;
            }
            function stop() { isDrawing = false; }
            
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stop);
            canvas.addEventListener('mouseleave', stop);
            canvas.addEventListener('touchstart', start);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stop);
        }
        
        function clearSignature() {
            const canvas = document.getElementById('signature-canvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#000000';
            signatureData = null;
            document.getElementById('signature-preview').classList.remove('show');
        }
        
        function confirmSignature() {
            signatureData = document.getElementById('signature-canvas').toDataURL('image/png');
            document.getElementById('signature-img').src = signatureData;
            document.getElementById('signature-preview').classList.add('show');
            showNotification('Assinatura confirmada!', 'success');
        }
        
        function handleSubmit(e) {
            e.preventDefault();
            
            if (!signatureData) {
                showNotification('Colete a assinatura!', 'error');
                return;
            }
            
            // Registrar data e hora exata da assinatura
            const agora = new Date();
            
            const entrega = {
                id: Date.now().toString(),
                trabalhador: document.getElementById('trabalhador').value,
                cpf: document.getElementById('cpf').value,
                empresa: document.getElementById('empresa').value,
                cnpj: document.getElementById('cnpj').value,
                funcao: document.getElementById('funcao').value,
                setor: document.getElementById('setor').value,
                descricaoEPI: document.getElementById('descricaoEPI').value,
                numeroCA: document.getElementById('numeroCA').value,
                dataEntrega: document.getElementById('dataEntrega').value,
                quantidade: document.getElementById('quantidade').value || '1',
                observacoes: document.getElementById('observacoes').value,
                assinatura: signatureData,
                dataHoraAssinatura: agora.toISOString(), // Data e hora da assinatura
                fotoFacial: capturedPhotoData,
                dataRegistro: agora.toISOString()
            };
            
            entregas.unshift(entrega);
            
            // Baixar do estoque automaticamente (passando CNPJ da empresa)
            baixarEstoqueEntrega(entrega.numeroCA, parseInt(entrega.quantidade) || 1, entrega.cnpj);
            
            if (saveData()) {
                generatePDF(entrega.cpf);
                showNotification('Registrado! PDF gerado.', 'success');
                
                document.getElementById('descricaoEPI').value = '';
                document.getElementById('numeroCA').value = '';
                document.getElementById('quantidade').value = '1';
                document.getElementById('observacoes').value = '';
                document.getElementById('dataEntrega').value = new Date().toISOString().split('T')[0];
                document.getElementById('estoque-disponivel').innerHTML = '';
                clearSignature();
                updateUI();
                updateEstoqueUI();
            } else {
                showNotification('Erro ao salvar!', 'error');
            }
        }
        
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file || file.size > 500000) { showNotification('M√°x 500KB', 'error'); return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                config.logo = e.target.result;
                localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
                document.getElementById('logo-preview').src = config.logo;
                document.getElementById('logo-preview').classList.remove('hidden');
                document.getElementById('logo-placeholder').classList.add('hidden');
                document.getElementById('logo-upload').classList.add('has-logo');
                document.getElementById('btn-remove-logo').classList.remove('hidden');
                showNotification('Logo salva!', 'success');
            };
            reader.readAsDataURL(file);
        }
        
        function removeLogo() {
            config.logo = null;
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            document.getElementById('logo-preview').classList.add('hidden');
            document.getElementById('logo-placeholder').classList.remove('hidden');
            document.getElementById('logo-upload').classList.remove('has-logo');
            document.getElementById('btn-remove-logo').classList.add('hidden');
            showNotification('Logo removida', 'success');
        }
        
        function updateFuncionariosList() {
            const search = document.getElementById('search-funcionario')?.value.toLowerCase() || '';
            const filterEmp = document.getElementById('filter-empresa')?.value || '';
            
            // Filtrar por empresa do usu√°rio logado (se n√£o for dev)
            let entregasFiltradas = entregas;
            
            if (currentUser && currentUser.empresaVinculada && currentUser.role !== 'dev') {
                // Usu√°rio vinculado a empresa espec√≠fica
                entregasFiltradas = entregas.filter(e => e.cnpj === currentUser.empresaVinculada);
            } else if (empresaAtual) {
                // Filtro manual por empresa ativa (admin)
                entregasFiltradas = entregas.filter(e => e.cnpj === empresaAtual.cnpj);
            }
            
            const map = {};
            entregasFiltradas.forEach(e => {
                if (!map[e.cpf]) map[e.cpf] = { ...e, entregas: [], emUso: 0, devolvidos: 0 };
                map[e.cpf].entregas.push(e);
                if (e.devolvido) {
                    map[e.cpf].devolvidos++;
                } else {
                    map[e.cpf].emUso++;
                }
                if (!map[e.cpf].fotoFacial && e.fotoFacial) map[e.cpf].fotoFacial = e.fotoFacial;
            });
            
            let funcs = Object.values(map).filter(f => {
                const matchS = f.trabalhador.toLowerCase().includes(search) || f.cpf.includes(search);
                const matchE = !filterEmp || f.empresa === filterEmp;
                return matchS && matchE;
            });
            
            const container = document.getElementById('funcionarios-list');
            const empty = document.getElementById('empty-state-func');
            
            if (funcs.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            container.innerHTML = funcs.map(f => {
                // Buscar cores da empresa
                const emp = getEmpresaPorCNPJ(f.cnpj);
                const paleta = PALETAS_CORES[emp?.paleta] || PALETAS_CORES.azul;
                
                return `
                <div class="funcionario-card" style="border-left:4px solid rgb(${paleta.secundaria.join(',')});">
                    <div class="funcionario-header">
                        <div class="funcionario-info">
                            ${f.fotoFacial ? 
                                `<img src="${f.fotoFacial}" class="funcionario-photo">` : 
                                `<div class="funcionario-photo no-photo"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>`
                            }
                            <div class="funcionario-details">
                                <h3>${f.trabalhador}</h3>
                                <p>${f.cpf} | ${f.empresa}</p>
                                <p style="font-size:0.75rem;color:#64748b;">${f.funcao || '-'} | ${f.setor || '-'}</p>
                            </div>
                        </div>
                        <div class="funcionario-stats">
                            <div class="stat-item">
                                <div class="value" style="color:rgb(${paleta.secundaria.join(',')});">${f.entregas.length}</div>
                                <div class="label">Total</div>
                            </div>
                            <div class="stat-item">
                                <div class="value" style="color:#10b981;">${f.emUso}</div>
                                <div class="label">Em Uso</div>
                            </div>
                            <div class="stat-item">
                                <div class="value" style="color:#f59e0b;">${f.devolvidos}</div>
                                <div class="label">Devolvidos</div>
                            </div>
                        </div>
                    </div>
                    <div class="funcionario-actions">
                        <button class="btn-primary" onclick="generatePDF('${f.cpf}')">üìÑ PDF</button>
                        <button class="btn-secondary" onclick="showHistorico('${f.cpf}')">üìã Hist√≥rico</button>
                        <button class="btn-danger" onclick="deleteFuncionario('${f.cpf}')">üóëÔ∏è</button>
                    </div>
                </div>
            `}).join('');
        }
        
        function filterFuncionarios() { updateFuncionariosList(); }
        
        function updateEmpresaFilter() {
            const empresas = [...new Set(entregas.map(e => e.empresa))];
            const select = document.getElementById('filter-empresa');
            const val = select.value;
            select.innerHTML = '<option value="">Todas</option>' + empresas.map(e => `<option value="${e}">${e}</option>`).join('');
            select.value = val;
        }
        
        // Gerar PDF com assinatura por entrega
        function generatePDF(cpf) {
            const funcs = entregas.filter(e => e.cpf === cpf);
            if (funcs.length === 0) return;
            
            const f = funcs[0];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            let y = margin;
            
            // Buscar cores da empresa
            const empresaData = getEmpresaPorCNPJ(f.cnpj);
            const paletaKey = empresaData?.paleta || 'azul';
            const paleta = PALETAS_CORES[paletaKey] || PALETAS_CORES.azul;
            
            // Cores do tema (baseadas na empresa)
            const azulEscuro = paleta.primaria;
            const azulMedio = paleta.secundaria;
            const azulClaro = paleta.accent;
            const cinzaEscuro = paleta.texto;
            const cinzaClaro = [100, 116, 139];
            
            // Logo da empresa (prioridade: empresa cadastrada > config global)
            const logoEmpresa = empresaData?.logo || config.logo;
            
            function addHeader() {
                // Faixa superior
                doc.setFillColor(...azulEscuro);
                doc.rect(0, 0, pageWidth, 42, 'F');
                
                // Logo
                let logoWidth = 0;
                if (logoEmpresa) {
                    try { 
                        doc.addImage(logoEmpresa, 'PNG', margin, 6, 30, 30); 
                        logoWidth = 35;
                    } catch(e) {}
                }
                
                // T√≠tulo
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('FICHA DE CONTROLE DE EPI', margin + logoWidth, 18);
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text('Equipamento de Prote√ß√£o Individual - NR 6', margin + logoWidth, 26);
                
                doc.setFontSize(9);
                // Usar nome da empresa cadastrada ou do config
                const nomeEmpresa = empresaData?.razao || empresaData?.fantasia || f.empresa || config.empresa || 'Empresa n√£o configurada';
                doc.text(nomeEmpresa, margin + logoWidth, 34);
                
                // Data de emiss√£o
                doc.setFontSize(8);
                doc.text(`Emitido: ${new Date().toLocaleString('pt-BR')}`, pageWidth - margin, 10, { align: 'right' });
            }
            
            addHeader();
            y = 50;
            
            // Foto do trabalhador
            const foto = funcs.find(e => e.fotoFacial)?.fotoFacial;
            
            // Se√ß√£o: Dados do Trabalhador
            doc.setFillColor(...azulMedio);
            doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('IDENTIFICA√á√ÉO DO TRABALHADOR', margin + 3, y + 5.5);
            y += 12;
            
            // Dados em grid - cada campo em linha separada para evitar sobreposi√ß√£o
            doc.setTextColor(...cinzaEscuro);
            doc.setFontSize(9);
            
            // Nome completo em linha pr√≥pria
            doc.setFont('helvetica', 'bold');
            doc.text('Nome:', margin, y);
            doc.setFont('helvetica', 'normal');
            doc.text(f.trabalhador, margin + 18, y);
            
            y += 6;
            doc.setFont('helvetica', 'bold');
            doc.text('CPF:', margin, y);
            doc.setFont('helvetica', 'normal');
            doc.text(f.cpf, margin + 18, y);
            
            // Foto ao lado dos dados
            if (foto) {
                try { 
                    doc.addImage(foto, 'JPEG', pageWidth - margin - 25, y - 11, 25, 32); 
                    doc.setDrawColor(...azulMedio);
                    doc.setLineWidth(0.5);
                    doc.rect(pageWidth - margin - 25, y - 11, 25, 32);
                } catch(e) {}
            }
            
            y += 6;
            doc.setFont('helvetica', 'bold');
            doc.text('Empresa:', margin, y);
            doc.setFont('helvetica', 'normal');
            doc.text(f.empresa || '-', margin + 22, y);
            
            y += 6;
            doc.setFont('helvetica', 'bold');
            doc.text('CNPJ:', margin, y);
            doc.setFont('helvetica', 'normal');
            doc.text(f.cnpj || '-', margin + 18, y);
            
            y += 6;
            doc.setFont('helvetica', 'bold');
            doc.text('Fun√ß√£o:', margin, y);
            doc.setFont('helvetica', 'normal');
            doc.text(f.funcao || '-', margin + 20, y);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Setor:', margin + 80, y);
            doc.setFont('helvetica', 'normal');
            doc.text(f.setor || '-', margin + 96, y);
            
            y += 12;
            
            // Se√ß√£o: Registro de Entregas
            doc.setFillColor(...azulMedio);
            doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('REGISTRO DE ENTREGAS DE EPI', margin + 3, y + 5.5);
            y += 12;
            
            // Ordenar por data
            const sorted = [...funcs].sort((a, b) => new Date(a.dataEntrega) - new Date(b.dataEntrega));
            
            // Listar cada entrega
            sorted.forEach((entrega, idx) => {
                if (y > pageHeight - 80) {
                    doc.addPage();
                    addHeader();
                    y = 50;
                }
                
                // Box da entrega
                doc.setFillColor(245, 248, 252);
                doc.setDrawColor(...azulClaro);
                doc.setLineWidth(0.3);
                doc.roundedRect(margin, y, pageWidth - margin * 2, 48, 2, 2, 'FD');
                
                // N√∫mero
                doc.setFillColor(...azulMedio);
                doc.circle(margin + 8, y + 8, 5, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(String(idx + 1), margin + 8, y + 9.5, { align: 'center' });
                
                // Descri√ß√£o do EPI
                doc.setTextColor(...azulEscuro);
                doc.setFontSize(10);
                doc.text(entrega.descricaoEPI, margin + 18, y + 9);
                
                // Status de devolu√ß√£o
                if (entrega.devolvido) {
                    doc.setFillColor(16, 185, 129);
                    doc.roundedRect(pageWidth - margin - 25, y + 3, 22, 6, 1, 1, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.text('DEVOLVIDO', pageWidth - margin - 14, y + 7, { align: 'center' });
                }
                
                // Detalhes
                doc.setTextColor(...cinzaEscuro);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                
                const dataEntrega = new Date(entrega.dataEntrega + 'T00:00:00');
                doc.text(`CA: ${entrega.numeroCA}`, margin + 5, y + 18);
                doc.text(`Quantidade: ${entrega.quantidade}`, margin + 45, y + 18);
                doc.text(`Data Entrega: ${dataEntrega.toLocaleDateString('pt-BR')}`, margin + 85, y + 18);
                
                if (entrega.observacoes) {
                    doc.setTextColor(...cinzaClaro);
                    doc.text(`Obs: ${entrega.observacoes.substring(0, 50)}`, margin + 5, y + 24);
                }
                
                // Assinatura
                doc.setTextColor(...cinzaEscuro);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(7);
                doc.text('ASSINATURA DO TRABALHADOR:', margin + 5, y + 32);
                
                if (entrega.assinatura) {
                    try {
                        // Fundo branco para a assinatura
                        doc.setFillColor(255, 255, 255);
                        doc.rect(margin + 5, y + 33, 47, 14, 'F');
                        doc.addImage(entrega.assinatura, 'PNG', margin + 5, y + 33, 45, 13);
                    } catch(e) {}
                }
                
                // Data/hora da assinatura
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...cinzaClaro);
                const dataAssinatura = new Date(entrega.dataHoraAssinatura || entrega.dataRegistro);
                doc.text(`Assinado em: ${dataAssinatura.toLocaleDateString('pt-BR')} √†s ${dataAssinatura.toLocaleTimeString('pt-BR')}`, margin + 55, y + 40);
                
                y += 52;
            });
            
            // Se√ß√£o de Devolu√ß√µes
            const devolucoes = sorted.filter(e => e.devolvido);
            
            if (devolucoes.length > 0) {
                if (y > pageHeight - 80) {
                    doc.addPage();
                    addHeader();
                    y = 50;
                }
                
                y += 5;
                doc.setFillColor(245, 158, 11); // Laranja para devolu√ß√µes
                doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
                doc.setTextColor(30, 58, 95);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(`HIST√ìRICO DE DEVOLU√á√ïES (${devolucoes.length})`, margin + 3, y + 5.5);
                y += 12;
                
                const motivos = {
                    'troca': 'Troca por desgaste/dano',
                    'vencimento': 'Vencimento do CA',
                    'desligamento': 'Desligamento',
                    'mudanca_funcao': 'Mudan√ßa de fun√ß√£o',
                    'inadequado': 'EPI inadequado',
                    'outro': 'Outro'
                };
                
                const estados = {
                    'bom': 'Bom estado',
                    'danificado': 'Danificado',
                    'desgastado': 'Desgastado',
                    'descarte': 'Para descarte'
                };
                
                devolucoes.forEach((entrega, idx) => {
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        addHeader();
                        y = 50;
                    }
                    
                    // Box da devolu√ß√£o
                    doc.setFillColor(255, 251, 235); // Fundo amarelo claro
                    doc.setDrawColor(245, 158, 11);
                    doc.setLineWidth(0.3);
                    doc.roundedRect(margin, y, pageWidth - margin * 2, 35, 2, 2, 'FD');
                    
                    // Descri√ß√£o do EPI
                    doc.setTextColor(...azulEscuro);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(entrega.descricaoEPI, margin + 5, y + 7);
                    
                    // Badge devolvido
                    doc.setFillColor(245, 158, 11);
                    doc.roundedRect(pageWidth - margin - 28, y + 2, 25, 6, 1, 1, 'F');
                    doc.setTextColor(30, 58, 95);
                    doc.setFontSize(6);
                    doc.text('DEVOLVIDO', pageWidth - margin - 15.5, y + 6, { align: 'center' });
                    
                    // Detalhes
                    doc.setTextColor(...cinzaEscuro);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    
                    const dataEntrega = new Date(entrega.dataEntrega + 'T00:00:00');
                    const dataDev = entrega.devolucao ? new Date(entrega.devolucao.dataDevolucao) : null;
                    
                    doc.text(`CA: ${entrega.numeroCA}`, margin + 5, y + 14);
                    doc.text(`Entrega: ${dataEntrega.toLocaleDateString('pt-BR')}`, margin + 45, y + 14);
                    doc.text(`Devolu√ß√£o: ${dataDev ? dataDev.toLocaleDateString('pt-BR') : '-'}`, margin + 95, y + 14);
                    
                    doc.text(`Motivo: ${entrega.devolucao ? (motivos[entrega.devolucao.motivo] || entrega.devolucao.motivo) : '-'}`, margin + 5, y + 21);
                    doc.text(`Estado: ${entrega.devolucao ? (estados[entrega.devolucao.estado] || entrega.devolucao.estado) : '-'}`, margin + 95, y + 21);
                    
                    // Assinatura de devolu√ß√£o
                    if (entrega.devolucao?.assinaturaDevolucao) {
                        try {
                            // Fundo branco para a assinatura
                            doc.setFillColor(255, 255, 255);
                            doc.rect(margin + 5, y + 22, 32, 12, 'F');
                            doc.addImage(entrega.devolucao.assinaturaDevolucao, 'PNG', margin + 5, y + 23, 30, 10);
                        } catch(e) {}
                    }
                    
                    const dataAssinaturaDev = entrega.devolucao?.dataHoraDevolucao ? new Date(entrega.devolucao.dataHoraDevolucao) : null;
                    doc.setFontSize(6);
                    doc.setTextColor(...cinzaClaro);
                    doc.text(`Assinado: ${dataAssinaturaDev ? dataAssinaturaDev.toLocaleDateString('pt-BR') + ' ' + dataAssinaturaDev.toLocaleTimeString('pt-BR') : '-'}`, margin + 40, y + 31);
                    
                    y += 38;
                });
            }
            
            // Declara√ß√£o conforme NR-06
            if (y > pageHeight - 120) {
                doc.addPage();
                addHeader();
                y = 50;
            }
            
            y += 5;
            doc.setFillColor(...azulEscuro);
            doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('TERMO DE RESPONSABILIDADE - NR 06', margin + 3, y + 5.5);
            y += 14;
            
            doc.setTextColor(...cinzaEscuro);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            
            // Par√°grafo inicial
            const intro = 'DECLARO, para os devidos fins, que recebi gratuitamente os Equipamentos de Prote√ß√£o Individual (EPIs) acima relacionados, em perfeito estado de conserva√ß√£o e funcionamento, e COMPROMETO-ME a:';
            const introLines = doc.splitTextToSize(intro, pageWidth - margin * 2);
            doc.text(introLines, margin, y);
            y += introLines.length * 4.5 + 4;
            
            // Lista de compromissos com indenta√ß√£o
            const compromissos = [
                'Utilizar os EPIs apenas para a finalidade a que se destinam, durante toda a jornada de trabalho;',
                'Responsabilizar-me pela guarda, conserva√ß√£o e higieniza√ß√£o dos equipamentos;',
                'Comunicar imediatamente ao empregador qualquer altera√ß√£o que torne o EPI impr√≥prio para uso;',
                'Cumprir as determina√ß√µes do empregador sobre o uso adequado dos equipamentos;',
                'N√£o modificar, alterar ou danificar intencionalmente os EPIs recebidos;',
                'Devolver os EPIs ao empregador quando solicitado ou ao t√©rmino do contrato de trabalho.'
            ];
            
            compromissos.forEach(item => {
                doc.setFont('helvetica', 'bold');
                doc.text('‚Ä¢', margin + 5, y);
                doc.setFont('helvetica', 'normal');
                const itemLines = doc.splitTextToSize(item, pageWidth - margin * 2 - 12);
                doc.text(itemLines, margin + 10, y);
                y += itemLines.length * 4 + 2;
            });
            
            y += 4;
            
            // Par√°grafo sobre recusa
            doc.setFont('helvetica', 'normal');
            const recusa = 'Estou ciente de que a recusa injustificada ao uso dos EPIs constitui ato faltoso, conforme art. 158 da CLT e item 6.7.1 da NR 06, podendo acarretar san√ß√µes disciplinares.';
            const recusaLines = doc.splitTextToSize(recusa, pageWidth - margin * 2);
            doc.text(recusaLines, margin, y);
            y += recusaLines.length * 4.5 + 4;
            
            // Par√°grafo sobre treinamento
            const treinamento = 'Declaro ainda ter recebido treinamento sobre o uso correto, guarda e conserva√ß√£o dos EPIs, bem como sobre suas limita√ß√µes de prote√ß√£o, conforme estabelecido na Norma Regulamentadora n¬∫ 06.';
            const treinamentoLines = doc.splitTextToSize(treinamento, pageWidth - margin * 2);
            doc.text(treinamentoLines, margin, y);
            y += treinamentoLines.length * 4.5 + 8;
            
            // Linha de assinatura
            doc.setDrawColor(...azulMedio);
            doc.setLineWidth(0.3);
            doc.line(margin, y, margin + 70, y);
            doc.setFontSize(8);
            doc.setTextColor(...cinzaClaro);
            doc.text(`${f.trabalhador}`, margin, y + 5);
            doc.text(`CPF: ${f.cpf}`, margin, y + 10);
            
            // Rodap√© em todas as p√°ginas
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                
                // Faixa inferior
                doc.setFillColor(...azulEscuro);
                doc.rect(0, pageHeight - 18, pageWidth, 18, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('RC Engenharia Sa√∫de e Seguran√ßa Ocupacional', pageWidth / 2, pageHeight - 12, { align: 'center' });
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text('¬© 2026 - Todos os direitos reservados', pageWidth / 2, pageHeight - 7, { align: 'center' });
                
                doc.text(`P√°gina ${i}/${totalPages}`, margin, pageHeight - 7);
                doc.text(`${new Date().toLocaleString('pt-BR')}`, pageWidth - margin, pageHeight - 7, { align: 'right' });
            }
            
            doc.save(`EPI_${f.trabalhador.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('PDF gerado!', 'success');
        }
        
        function showHistorico(cpf) {
            const funcs = entregas.filter(e => e.cpf === cpf);
            if (funcs.length === 0) return;
            
            const f = funcs[0];
            const foto = funcs.find(e => e.fotoFacial)?.fotoFacial;
            
            document.getElementById('modal-titulo').textContent = f.trabalhador;
            
            const sorted = [...funcs].sort((a, b) => new Date(b.dataEntrega) - new Date(a.dataEntrega));
            const entregasAtivas = sorted.filter(e => !e.devolvido);
            const devolucoes = sorted.filter(e => e.devolvido);
            
            const motivos = {
                'troca': 'Troca por desgaste/dano',
                'vencimento': 'Vencimento do CA',
                'desligamento': 'Desligamento do funcion√°rio',
                'mudanca_funcao': 'Mudan√ßa de fun√ß√£o',
                'inadequado': 'EPI inadequado',
                'outro': 'Outro'
            };
            
            const estados = {
                'bom': 'Bom estado',
                'danificado': 'Danificado',
                'desgastado': 'Desgastado',
                'descarte': 'Para descarte'
            };
            
            document.getElementById('modal-content').innerHTML = `
                <div style="display:flex;gap:1rem;padding:1rem;background:#0f172a;border-radius:8px;margin-bottom:1.5rem;align-items:center;flex-wrap:wrap;">
                    ${foto ? `
                        <div style="text-align:center;">
                            <img src="${foto}" style="width:80px;height:100px;object-fit:cover;border-radius:8px;border:2px solid #10b981;">
                            <p style="font-size:0.7rem;color:#64748b;margin-top:0.5rem;">
                                ${new Date(funcs.find(e => e.fotoFacial).dataRegistro).toLocaleString('pt-BR')}
                            </p>
                        </div>
                    ` : ''}
                    <div style="flex:1;">
                        <p><strong>CPF:</strong> ${f.cpf}</p>
                        <p><strong>Empresa:</strong> ${f.empresa}</p>
                        <p><strong>Fun√ß√£o:</strong> ${f.funcao || '-'} | <strong>Setor:</strong> ${f.setor || '-'}</p>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;text-align:center;">
                        <div style="background:#1e3a5f;padding:0.5rem;border-radius:6px;">
                            <div style="font-size:1.25rem;font-weight:700;color:#2563eb;">${funcs.length}</div>
                            <div style="font-size:0.65rem;color:#64748b;">TOTAL</div>
                        </div>
                        <div style="background:#1e3a5f;padding:0.5rem;border-radius:6px;">
                            <div style="font-size:1.25rem;font-weight:700;color:#10b981;">${entregasAtivas.length}</div>
                            <div style="font-size:0.65rem;color:#64748b;">EM USO</div>
                        </div>
                        <div style="background:#1e3a5f;padding:0.5rem;border-radius:6px;">
                            <div style="font-size:1.25rem;font-weight:700;color:#f59e0b;">${devolucoes.length}</div>
                            <div style="font-size:0.65rem;color:#64748b;">DEVOLVIDOS</div>
                        </div>
                    </div>
                </div>
                
                <!-- EPIs em Uso -->
                <h4 style="color:#10b981;margin-bottom:1rem;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:0.5rem;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    EPIs EM USO (${entregasAtivas.length})
                </h4>
                
                <div style="max-height:250px;overflow-y:auto;margin-bottom:1.5rem;">
                    ${entregasAtivas.length === 0 ? '<p style="color:#64748b;text-align:center;padding:1rem;">Nenhum EPI em uso</p>' : 
                    entregasAtivas.map((e, i) => {
                        const dataAssinatura = new Date(e.dataHoraAssinatura || e.dataRegistro);
                        return `
                            <div class="historico-item" style="border-left:3px solid #10b981;">
                                <div class="historico-header">
                                    <div>
                                        <span class="historico-epi">${e.descricaoEPI}</span>
                                        <span class="badge-ca" style="margin-left:0.5rem;">CA ${e.numeroCA}</span>
                                    </div>
                                    <div style="display:flex;align-items:center;gap:0.5rem;">
                                        <span class="historico-data">${formatDate(e.dataEntrega)}</span>
                                        <button onclick="deleteEntregaIndividual('${e.id}')" style="background:#ef4444;color:white;border:none;padding:0.25rem 0.5rem;border-radius:4px;cursor:pointer;font-size:0.7rem;" title="Excluir esta entrega">‚úï</button>
                                    </div>
                                </div>
                                <div class="historico-detalhes">
                                    Quantidade: ${e.quantidade} | ${e.observacoes || 'Sem observa√ß√µes'}
                                </div>
                                <div class="historico-assinatura">
                                    ${e.assinatura ? `<img src="${e.assinatura}" alt="Assinatura">` : '<span style="color:#ef4444;">Sem assinatura</span>'}
                                    <div class="historico-assinatura-info">
                                        <strong>‚úì Assinado em:</strong>
                                        ${dataAssinatura.toLocaleDateString('pt-BR')} √†s ${dataAssinatura.toLocaleTimeString('pt-BR')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Hist√≥rico de Devolu√ß√µes -->
                <h4 style="color:#f59e0b;margin-bottom:1rem;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:0.5rem;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5"/>
                    </svg>
                    HIST√ìRICO DE DEVOLU√á√ïES (${devolucoes.length})
                </h4>
                
                <div style="max-height:250px;overflow-y:auto;">
                    ${devolucoes.length === 0 ? '<p style="color:#64748b;text-align:center;padding:1rem;">Nenhuma devolu√ß√£o registrada</p>' : 
                    devolucoes.map(e => {
                        const dataDev = e.devolucao ? new Date(e.devolucao.dataDevolucao) : null;
                        const dataAssinaturaDev = e.devolucao?.dataHoraDevolucao ? new Date(e.devolucao.dataHoraDevolucao) : null;
                        return `
                            <div class="historico-item" style="border-left:3px solid #f59e0b;background:rgba(245,158,11,0.05);">
                                <div class="historico-header">
                                    <div>
                                        <span class="historico-epi">${e.descricaoEPI}</span>
                                        <span style="background:#f59e0b;color:#1e3a5f;padding:0.15rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:600;margin-left:0.5rem;">DEVOLVIDO</span>
                                    </div>
                                </div>
                                <div class="historico-detalhes" style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-top:0.5rem;">
                                    <div>
                                        <span style="color:#64748b;font-size:0.75rem;">Entrega:</span>
                                        <span style="color:#e2e8f0;">${formatDate(e.dataEntrega)}</span>
                                    </div>
                                    <div>
                                        <span style="color:#64748b;font-size:0.75rem;">Devolu√ß√£o:</span>
                                        <span style="color:#f59e0b;font-weight:600;">${dataDev ? dataDev.toLocaleDateString('pt-BR') : '-'}</span>
                                    </div>
                                    <div>
                                        <span style="color:#64748b;font-size:0.75rem;">Motivo:</span>
                                        <span style="color:#e2e8f0;">${e.devolucao ? (motivos[e.devolucao.motivo] || e.devolucao.motivo) : '-'}</span>
                                    </div>
                                    <div>
                                        <span style="color:#64748b;font-size:0.75rem;">Estado:</span>
                                        <span style="color:#e2e8f0;">${e.devolucao ? (estados[e.devolucao.estado] || e.devolucao.estado) : '-'}</span>
                                    </div>
                                </div>
                                ${e.devolucao?.observacoesDevolucao ? `
                                    <div style="margin-top:0.5rem;font-size:0.8rem;color:#94a3b8;">
                                        <strong>Obs:</strong> ${e.devolucao.observacoesDevolucao}
                                    </div>
                                ` : ''}
                                ${e.devolucao?.assinaturaDevolucao ? `
                                    <div class="historico-assinatura" style="margin-top:0.75rem;">
                                        <img src="${e.devolucao.assinaturaDevolucao}" alt="Assinatura Devolu√ß√£o" style="border:1px solid #f59e0b;">
                                        <div class="historico-assinatura-info">
                                            <strong style="color:#f59e0b;">‚úì Devolu√ß√£o assinada em:</strong>
                                            ${dataAssinaturaDev ? dataAssinaturaDev.toLocaleDateString('pt-BR') + ' √†s ' + dataAssinaturaDev.toLocaleTimeString('pt-BR') : '-'}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="display:flex;gap:0.5rem;margin-top:1.5rem;flex-wrap:wrap;">
                    <button class="btn-primary" onclick="generatePDF('${cpf}')" style="flex:1;">
                        üìÑ Gerar PDF Completo
                    </button>
                    <button class="btn-danger" onclick="deleteFuncionario('${cpf}')" style="flex:1;">
                        üóëÔ∏è Excluir Funcion√°rio
                    </button>
                </div>
            `;
            document.getElementById('modal-historico').classList.add('show');
        }
        
        function closeModal(e) {
            if (e.target.id === 'modal-historico') e.target.classList.remove('show');
        }
        
        function deleteFuncionario(cpf) {
            const f = entregas.find(e => e.cpf === cpf);
            const totalEntregas = entregas.filter(e => e.cpf === cpf).length;
            
            // Primeira confirma√ß√£o
            if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a excluir:\n\nüë§ ${f.trabalhador}\nüìã ${totalEntregas} entrega(s) de EPI\n\nDeseja continuar?`)) return;
            
            // Segunda confirma√ß√£o
            if (!confirm(`üî¥ CONFIRMA√á√ÉO FINAL\n\nTem CERTEZA que deseja excluir permanentemente?\n\nEsta a√ß√£o N√ÉO pode ser desfeita!`)) return;
            
            // Terceira verifica√ß√£o - digitar nome
            const nomeDigitado = prompt(`Para confirmar a exclus√£o, digite o nome do funcion√°rio:\n\n"${f.trabalhador}"`);
            
            if (!nomeDigitado) {
                showNotification('Exclus√£o cancelada', 'error');
                return;
            }
            
            if (nomeDigitado.trim().toLowerCase() !== f.trabalhador.trim().toLowerCase()) {
                showNotification('Nome incorreto. Exclus√£o cancelada.', 'error');
                return;
            }
            
            entregas = entregas.filter(e => e.cpf !== cpf);
            if (saveData()) { 
                showNotification('Funcion√°rio exclu√≠do', 'success'); 
                updateUI(); 
                // Fechar modal se estiver aberto
                document.getElementById('modal-historico').classList.remove('show');
            }
        }
        
        function deleteEntregaIndividual(id) {
            const entrega = entregas.find(e => e.id === id);
            if (!entrega) return;
            
            // Primeira confirma√ß√£o
            if (!confirm(`‚ö†Ô∏è Excluir esta entrega?\n\nüì¶ ${entrega.descricaoEPI}\nüìÖ ${formatDate(entrega.dataEntrega)}\n\nA assinatura tamb√©m ser√° exclu√≠da.`)) return;
            
            // Segunda confirma√ß√£o
            if (!confirm(`üî¥ CONFIRMA√á√ÉO FINAL\n\nTem certeza? Esta a√ß√£o n√£o pode ser desfeita!`)) return;
            
            entregas = entregas.filter(e => e.id !== id);
            if (saveData()) {
                showNotification('Entrega exclu√≠da', 'success');
                updateUI();
                // Atualizar modal se aberto
                const cpf = entrega.cpf;
                if (entregas.some(e => e.cpf === cpf)) {
                    showHistorico(cpf);
                } else {
                    document.getElementById('modal-historico').classList.remove('show');
                }
            }
        }
        
        function exportAllToCSV() {
            if (entregas.length === 0) { showNotification('Nada para exportar', 'error'); return; }
            
            const h = ['Data Entrega', 'Data/Hora Assinatura', 'Nome', 'CPF', 'Empresa', 'EPI', 'CA', 'Qtd'];
            const r = entregas.map(e => {
                const dt = new Date(e.dataHoraAssinatura || e.dataRegistro);
                return [e.dataEntrega, dt.toLocaleString('pt-BR'), e.trabalhador, e.cpf, e.empresa, e.descricaoEPI, e.numeroCA, e.quantidade];
            });
            const csv = [h, ...r].map(row => row.map(c => `"${c}"`).join(';')).join('\n');
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' }));
            a.download = `epi_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showNotification('Exportado!', 'success');
        }
        
        function clearAllData() {
            const totalEntregas = entregas.length;
            const totalFuncionarios = new Set(entregas.map(e => e.cpf)).size;
            const totalEstoque = estoque.length;
            
            if (totalEntregas === 0 && totalEstoque === 0) {
                showNotification('N√£o h√° dados para apagar', 'error');
                return;
            }
            
            // Primeira confirma√ß√£o
            if (!confirm(`üö® ATEN√á√ÉO M√ÅXIMA!\n\nVoc√™ est√° prestes a APAGAR PERMANENTEMENTE:\n\nüìã ${totalEntregas} entrega(s) de EPI\nüë• ${totalFuncionarios} funcion√°rio(s)\nüì¶ ${totalEstoque} item(ns) de estoque\n‚úçÔ∏è Todas as assinaturas\nüì∑ Todas as fotos\n\nDeseja continuar?`)) return;
            
            // Segunda confirma√ß√£o
            if (!confirm(`‚õî √öLTIMA CHANCE!\n\nTodos os dados ser√£o PERDIDOS PARA SEMPRE!\n\nN√£o ser√° poss√≠vel recuperar!\n\nTem CERTEZA ABSOLUTA?`)) return;
            
            // Terceira verifica√ß√£o - digitar c√≥digo
            const codigo = prompt(`üîê VERIFICA√á√ÉO DE SEGURAN√áA\n\nPara confirmar a exclus√£o TOTAL, digite:\n\n"APAGAR TUDO"\n\n(exatamente como mostrado acima)`);
            
            if (!codigo) {
                showNotification('Opera√ß√£o cancelada', 'error');
                return;
            }
            
            if (codigo.trim().toUpperCase() !== 'APAGAR TUDO') {
                showNotification('C√≥digo incorreto. Opera√ß√£o cancelada.', 'error');
                return;
            }
            
            // Quarta verifica√ß√£o - confirma√ß√£o num√©rica
            const numeroAleatorio = Math.floor(1000 + Math.random() * 9000);
            const numeroDigitado = prompt(`üî¢ √öLTIMA VERIFICA√á√ÉO\n\nDigite o n√∫mero abaixo para confirmar:\n\n${numeroAleatorio}`);
            
            if (!numeroDigitado || numeroDigitado.trim() !== numeroAleatorio.toString()) {
                showNotification('N√∫mero incorreto. Opera√ß√£o cancelada.', 'error');
                return;
            }
            
            // Fazer backup antes de apagar
            const backup = JSON.stringify({ entregas, estoque, config });
            console.log('BACKUP DOS DADOS (copie se necess√°rio):', backup);
            
            entregas = [];
            estoque = [];
            saveData();
            saveEstoque();
            updateUI();
            updateEstoqueUI();
            showNotification('Todos os dados foram apagados', 'success');
        }
        
        function exportBackup() {
            if (entregas.length === 0 && estoque.length === 0 && empresas.length === 0) {
                showNotification('N√£o h√° dados para backup', 'error');
                return;
            }
            
            const backup = {
                versao: '5.0',
                dataExportacao: new Date().toISOString(),
                totalEntregas: entregas.length,
                totalFuncionarios: new Set(entregas.map(e => e.cpf)).size,
                totalEstoque: estoque.length,
                totalEmpresas: empresas.length,
                config: config,
                entregas: entregas,
                estoque: estoque,
                empresas: empresas
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_epi_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification(`Backup exportado: ${entregas.length} entregas, ${estoque.length} itens, ${empresas.length} empresas`, 'success');
        }
        
        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.entregas || !Array.isArray(backup.entregas)) {
                        throw new Error('Formato inv√°lido');
                    }
                    
                    const estoqueInfo = backup.estoque ? `\nItens Estoque: ${backup.estoque.length}` : '';
                    const empresasInfo = backup.empresas ? `\nEmpresas: ${backup.empresas.length}` : '';
                    const msg = `üì¶ IMPORTAR BACKUP\n\nArquivo: ${file.name}\nData: ${backup.dataExportacao ? new Date(backup.dataExportacao).toLocaleString('pt-BR') : 'Desconhecida'}\nEntregas: ${backup.entregas.length}${estoqueInfo}${empresasInfo}\n\nIsso IR√Å SUBSTITUIR todos os dados atuais!\n\nDeseja continuar?`;
                    
                    if (!confirm(msg)) {
                        showNotification('Importa√ß√£o cancelada', 'error');
                        return;
                    }
                    
                    if (!confirm('‚ö†Ô∏è Tem certeza? Os dados atuais ser√£o perdidos!')) {
                        showNotification('Importa√ß√£o cancelada', 'error');
                        return;
                    }
                    
                    entregas = backup.entregas;
                    
                    if (backup.estoque && Array.isArray(backup.estoque)) {
                        estoque = backup.estoque;
                        saveEstoque();
                    }
                    
                    if (backup.empresas && Array.isArray(backup.empresas)) {
                        empresas = backup.empresas;
                        saveEmpresas();
                    }
                    
                    if (backup.config) {
                        config = backup.config;
                        localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
                        loadConfig();
                    }
                    
                    saveData();
                    updateUI();
                    updateEstoqueUI();
                    updateEmpresasUI();
                    
                    showNotification(`Backup importado: ${entregas.length} entregas, ${estoque.length} itens, ${empresas.length} empresas`, 'success');
                    
                } catch (err) {
                    console.error('Erro ao importar:', err);
                    showNotification('Arquivo de backup inv√°lido', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // ==================== FUN√á√ïES DE DEVOLU√á√ÉO ====================
        
        let signaturePadDevolucao = null;
        let signatureDataDevolucao = null;
        let selectedEntregaDevolucao = null;
        
        function initSignatureDevolucao() {
            const canvas = document.getElementById('signature-devolucao');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0, lastY = 0;
            
            // Fundo branco e tra√ßo preto
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                if (e.touches) {
                    return { x: (e.touches[0].clientX - rect.left) * scaleX, y: (e.touches[0].clientY - rect.top) * scaleY };
                }
                return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
            }
            
            function startDraw(e) { 
                e.preventDefault();
                isDrawing = true; 
                const pos = getPos(e); 
                lastX = pos.x; 
                lastY = pos.y; 
            }
            
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                lastX = pos.x;
                lastY = pos.y;
            }
            
            function stopDraw() { isDrawing = false; }
            
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            canvas.addEventListener('touchstart', startDraw);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDraw);
            
            signaturePadDevolucao = { canvas, ctx };
        }
        
        function clearSignatureDevolucao() {
            if (!signaturePadDevolucao) return;
            const { canvas, ctx } = signaturePadDevolucao;
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#000000';
            signatureDataDevolucao = null;
            document.getElementById('signature-preview-dev').style.display = 'none';
        }
        
        function confirmSignatureDevolucao() {
            if (!signaturePadDevolucao) return;
            signatureDataDevolucao = signaturePadDevolucao.canvas.toDataURL('image/png');
            document.getElementById('signature-img-dev').src = signatureDataDevolucao;
            document.getElementById('signature-preview-dev').style.display = 'block';
            showNotification('Assinatura de devolu√ß√£o confirmada!', 'success');
        }
        
        function buscarFuncionarioDevolucao(cpf) {
            const lista = document.getElementById('autocomplete-devolucao');
            const cpfLimpo = cpf.replace(/\D/g, '');
            
            if (cpfLimpo.length < 3) {
                lista.classList.add('hidden');
                return;
            }
            
            const funcionarios = [...new Map(entregas.map(e => [e.cpf, e])).values()];
            const matches = funcionarios.filter(f => f.cpf.replace(/\D/g, '').includes(cpfLimpo));
            
            if (matches.length === 0) {
                lista.classList.add('hidden');
                return;
            }
            
            lista.innerHTML = matches.slice(0, 5).map(f => `
                <div class="autocomplete-item" onclick="selecionarFuncionarioDevolucao('${f.cpf}')">
                    ${f.fotoFacial ? `<img src="${f.fotoFacial}" alt="">` : '<div style="width:40px;height:50px;background:#2d4a6f;border-radius:6px;"></div>'}
                    <div>
                        <div style="font-weight:500;color:#e2e8f0;">${f.trabalhador}</div>
                        <div style="font-size:0.85rem;color:#64748b;">${f.cpf}</div>
                    </div>
                </div>
            `).join('');
            
            lista.classList.remove('hidden');
        }
        
        function selecionarFuncionarioDevolucao(cpf) {
            const f = entregas.find(e => e.cpf === cpf);
            if (f) {
                document.getElementById('dev-cpf').value = f.cpf;
                document.getElementById('dev-trabalhador').value = f.trabalhador;
                
                // Listar EPIs entregues a este funcion√°rio (n√£o devolvidos)
                const episFuncionario = entregas.filter(e => e.cpf === cpf && !e.devolvido);
                const selectEPI = document.getElementById('dev-epi');
                selectEPI.innerHTML = '<option value="">Selecione o EPI entregue</option>';
                
                episFuncionario.forEach(e => {
                    selectEPI.innerHTML += `<option value="${e.id}">${e.descricaoEPI} - CA ${e.numeroCA} (Entregue: ${formatDate(e.dataEntrega)})</option>`;
                });
            }
            document.getElementById('autocomplete-devolucao').classList.add('hidden');
        }
        
        function selecionarEPIDevolucao() {
            const id = document.getElementById('dev-epi').value;
            selectedEntregaDevolucao = entregas.find(e => e.id === id);
        }
        
        function handleDevolucao(e) {
            e.preventDefault();
            
            if (!signatureDataDevolucao) {
                showNotification('Confirme a assinatura de devolu√ß√£o!', 'error');
                return;
            }
            
            const entregaId = document.getElementById('dev-epi').value;
            const entrega = entregas.find(e => e.id === entregaId);
            
            if (!entrega) {
                showNotification('Selecione um EPI para devolver!', 'error');
                return;
            }
            
            const devolucao = {
                dataDevolucao: document.getElementById('dev-data').value,
                motivo: document.getElementById('dev-motivo').value,
                estado: document.getElementById('dev-estado').value,
                observacoesDevolucao: document.getElementById('dev-observacoes').value,
                assinaturaDevolucao: signatureDataDevolucao,
                dataHoraDevolucao: new Date().toISOString()
            };
            
            // Marcar entrega como devolvida
            entrega.devolvido = true;
            entrega.devolucao = devolucao;
            
            // Retornar ao estoque se solicitado
            if (document.getElementById('dev-retornar').value === 'sim') {
                // Buscar EPI da empresa espec√≠fica primeiro
                let epi = estoque.find(e => e.ca === entrega.numeroCA && e.cnpj === entrega.cnpj);
                
                // Se n√£o encontrar da empresa, buscar de qualquer uma (compatibilidade)
                if (!epi) {
                    epi = estoque.find(e => e.ca === entrega.numeroCA);
                }
                
                if (epi) {
                    epi.quantidade += parseInt(entrega.quantidade) || 1;
                    epi.historico.push({
                        tipo: 'entrada',
                        quantidade: parseInt(entrega.quantidade) || 1,
                        data: new Date().toISOString(),
                        obs: `Devolu√ß√£o - ${entrega.trabalhador}`
                    });
                    saveEstoque();
                }
            }
            
            if (saveData()) {
                generatePDFDevolucao(entrega);
                showNotification('Devolu√ß√£o registrada! PDF gerado.', 'success');
                
                // Limpar formul√°rio
                document.getElementById('form-devolucao').reset();
                document.getElementById('dev-data').value = new Date().toISOString().split('T')[0];
                document.getElementById('dev-epi').innerHTML = '<option value="">Selecione o EPI entregue</option>';
                clearSignatureDevolucao();
                updateUI();
            }
        }
        
        function generatePDFDevolucao(entrega) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            let y = margin;
            
            // Buscar cores da empresa
            const empresaData = getEmpresaPorCNPJ(entrega.cnpj);
            const paletaKey = empresaData?.paleta || 'azul';
            const paleta = PALETAS_CORES[paletaKey] || PALETAS_CORES.azul;
            
            // Cores do tema (baseadas na empresa)
            const azulEscuro = paleta.primaria;
            const azulMedio = paleta.secundaria;
            const verde = [16, 185, 129];
            
            // Logo da empresa
            const logoEmpresa = empresaData?.logo || config.logo;
            
            // Cabe√ßalho
            doc.setFillColor(...azulEscuro);
            doc.rect(0, 0, pageWidth, 45, 'F');
            
            if (logoEmpresa) {
                try { doc.addImage(logoEmpresa, 'PNG', margin, 8, 30, 30); } catch(e) {}
            }
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('TERMO DE DEVOLU√á√ÉO DE EPI', logoEmpresa ? 55 : margin, 20);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const nomeEmpresa = empresaData?.razao || empresaData?.fantasia || entrega.empresa || config.empresa || 'Empresa n√£o configurada';
            doc.text(nomeEmpresa, logoEmpresa ? 55 : margin, 28);
            doc.text(`Emitido em: ${new Date().toLocaleString('pt-BR')}`, logoEmpresa ? 55 : margin, 35);
            
            y = 55;
            
            // Dados do funcion√°rio
            doc.setFillColor(...azulMedio);
            doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('DADOS DO TRABALHADOR', margin + 3, y + 5.5);
            y += 12;
            
            doc.setTextColor(50, 50, 50);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            doc.text(`Nome: ${entrega.trabalhador}`, margin, y);
            doc.text(`CPF: ${entrega.cpf}`, pageWidth/2, y);
            y += 6;
            doc.text(`Fun√ß√£o: ${entrega.funcao || '-'}`, margin, y);
            doc.text(`Setor: ${entrega.setor || '-'}`, pageWidth/2, y);
            y += 6;
            doc.text(`Empresa: ${entrega.empresa}`, margin, y);
            y += 12;
            
            // EPI Devolvido
            doc.setFillColor(...verde);
            doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.text('EPI DEVOLVIDO', margin + 3, y + 5.5);
            y += 12;
            
            doc.setTextColor(50, 50, 50);
            doc.setFont('helvetica', 'normal');
            doc.text(`Descri√ß√£o: ${entrega.descricaoEPI}`, margin, y);
            y += 6;
            doc.text(`CA: ${entrega.numeroCA}`, margin, y);
            doc.text(`Quantidade: ${entrega.quantidade}`, pageWidth/2, y);
            y += 6;
            doc.text(`Data da Entrega: ${formatDate(entrega.dataEntrega)}`, margin, y);
            doc.text(`Data da Devolu√ß√£o: ${formatDate(entrega.devolucao.dataDevolucao)}`, pageWidth/2, y);
            y += 6;
            
            const motivos = {
                'troca': 'Troca por desgaste/dano',
                'vencimento': 'Vencimento do CA',
                'desligamento': 'Desligamento do funcion√°rio',
                'mudanca_funcao': 'Mudan√ßa de fun√ß√£o',
                'inadequado': 'EPI inadequado',
                'outro': 'Outro'
            };
            
            const estados = {
                'bom': 'Bom estado (reutiliz√°vel)',
                'danificado': 'Danificado',
                'desgastado': 'Desgastado',
                'descarte': 'Para descarte'
            };
            
            doc.text(`Motivo: ${motivos[entrega.devolucao.motivo] || entrega.devolucao.motivo}`, margin, y);
            y += 6;
            doc.text(`Estado do EPI: ${estados[entrega.devolucao.estado] || entrega.devolucao.estado}`, margin, y);
            y += 6;
            if (entrega.devolucao.observacoesDevolucao) {
                doc.text(`Observa√ß√µes: ${entrega.devolucao.observacoesDevolucao}`, margin, y);
                y += 6;
            }
            
            y += 10;
            
            // Assinatura
            doc.setDrawColor(...azulMedio);
            doc.setLineWidth(0.5);
            doc.rect(margin, y, pageWidth - margin * 2, 45);
            
            doc.setTextColor(...azulMedio);
            doc.setFont('helvetica', 'bold');
            doc.text('CONFIRMA√á√ÉO DE DEVOLU√á√ÉO', margin + 3, y + 6);
            
            doc.setTextColor(50, 50, 50);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Declaro ter devolvido o EPI acima descrito, estando ciente de que a empresa proceder√°', margin + 3, y + 14);
            doc.text('com a destina√ß√£o adequada conforme o estado do equipamento.', margin + 3, y + 19);
            
            if (entrega.devolucao.assinaturaDevolucao) {
                try { 
                    // Fundo branco para a assinatura
                    doc.setFillColor(255, 255, 255);
                    doc.rect(margin + 5, y + 22, 52, 20, 'F');
                    doc.addImage(entrega.devolucao.assinaturaDevolucao, 'PNG', margin + 5, y + 23, 50, 18); 
                } catch(e) {}
            }
            
            const dataAssinatura = new Date(entrega.devolucao.dataHoraDevolucao);
            doc.setFontSize(8);
            doc.text(`Assinado em: ${dataAssinatura.toLocaleDateString('pt-BR')} √†s ${dataAssinatura.toLocaleTimeString('pt-BR')}`, margin + 5, y + 43);
            
            // Rodap√©
            doc.setFillColor(...azulEscuro);
            doc.rect(0, pageHeight - 20, pageWidth, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('RC Engenharia Sa√∫de e Seguran√ßa Ocupacional', pageWidth/2, pageHeight - 12, { align: 'center' });
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text('¬© 2026 - Todos os direitos reservados', pageWidth/2, pageHeight - 6, { align: 'center' });
            
            doc.save(`devolucao_epi_${entrega.cpf.replace(/\D/g, '')}_${Date.now()}.pdf`);
        }
        
        // Fun√ß√£o para formatar data
        function formatDate(d) { 
            return new Date(d).toLocaleDateString('pt-BR'); 
        }
        
        // ==================== FUN√á√ÉO DE NOTIFICA√á√ÉO ====================
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            if (!notification || !notificationText) {
                console.log('Notifica√ß√£o:', message);
                return;
            }
            
            // Remover classes anteriores
            notification.classList.remove('success', 'error', 'info', 'show');
            
            // Adicionar classe do tipo
            notification.classList.add(type);
            
            // Definir mensagem
            notificationText.textContent = message;
            
            // Mostrar notifica√ß√£o
            notification.classList.add('show');
            
            // Esconder ap√≥s 4 segundos
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
        
    </script>
</body>
</html>